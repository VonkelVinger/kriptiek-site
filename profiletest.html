<!DOCTYPE html>
<html lang="af">
<head>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-S9V4CMP1FP"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-S9V4CMP1FP');
</script>

<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>My Profiel – Kriptiek</title>

<!-- Favicons -->
<link rel="icon" href="/assets/favicon.ico?v=2" type="image/x-icon" />
<link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png?v=3">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png?v=3">
<link rel="apple-touch-icon" href="/assets/apple-touch-icon.png?v=3">
<link rel="manifest" href="/assets/site.webmanifest?v=3">

<!-- Styles -->
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&display=swap" rel="stylesheet" />
<style>
  body { font-family: 'Montserrat', sans-serif; }
  .mono{ font-variant-numeric: tabular-nums; }

  /* --- Header/logo --- */
  .logo-container {
    position: relative; display: flex; justify-content: center; align-items: center;
    width: fit-content; margin: 1rem auto; padding: 1rem; border-radius: 1rem; background-color: white; overflow: hidden;
    isolation: isolate;
  }
  .logo-container::before{
    content:""; position:absolute; inset:-2px; border-radius:1rem;
    background:conic-gradient(from 180deg at 50% 50%, #1e3a8a, #334155, #1e3a8a);
    animation:spin 14s linear infinite; z-index:0; padding:2px;
    mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
    -webkit-mask-composite: xor; mask-composite: exclude;
  }
  @keyframes spin{ to{ transform:rotate(1turn); } }
  @media (prefers-reduced-motion: reduce){ .logo-container::before{ animation:none; } }

  .crossword-grid { display: grid; grid-template-columns: repeat(8, minmax(40px, 1fr)); gap: 4px; position: relative; z-index: 10; }
  .letter-box {
    width: 50px; height: 50px; display: flex; justify-content: center; align-items: center;
    background-color: #374151; color: white; font-size: 1.8rem; font-weight: bold; border: 2px solid #1f2937; border-radius: 0.375rem;
    text-transform: uppercase; box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.2);
  }
  .flipped-k { transform: scaleX(-1); }

  .background-crossword {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: grid;
    grid-template-columns: repeat(auto-fill, minmax(30px, 1fr)); grid-template-rows: repeat(auto-fill, minmax(30px, 1fr));
    opacity: 0.5; z-index: 1; pointer-events: none; animation: bgFloat 30s linear infinite;
  }
  @keyframes bgFloat{ 0%{ transform:translateY(0); } 50%{ transform:translateY(-12px); } 100%{ transform:translateY(0); } }
  @media (prefers-reduced-motion: reduce){ .background-crossword{ animation:none; } }

  .bg-letter-box { display: flex; justify-content: center; align-items: center; font-size: 1.1rem; font-weight: bold; color: #9ca3af; border: 1px solid #e5e7eb; background-color: transparent; user-select: none; }

  /* Buttons / pills */
  .kbtn{ display:inline-flex; align-items:center; justify-content:center; gap:.5rem; padding:.65rem 1rem; border-radius:.9rem; background:#1d4ed8; color:#fff; font-weight:800; box-shadow:0 10px 24px rgba(29,78,216,.25); }
  .kbtn:hover{ background:#1e40af; }
  .kbtn-red{ background:#dc2626; } .kbtn-red:hover{ background:#b91c1c; }

  .pill { display:inline-flex; align-items:center; gap:.6rem; padding:.6rem 1.1rem; border-radius:999px; font-weight:800; color:#fff; white-space:nowrap; line-height:1.15;
          box-shadow: 0 6px 14px rgba(0,0,0,.18), inset 0 1px 0 rgba(255,255,255,.25); }
  .pill-sm { font-size:.95rem; padding:.55rem 1rem; }
  .pill-lg { font-size:1.15rem; padding:.75rem 1.25rem; }

  .pill-blue { background:linear-gradient(90deg,#1d4ed8,#1e40af); }
  .pill-orange { background: linear-gradient(180deg, #FB7A12 0%, #D65A0A 100%); }
  .pill-green { background: linear-gradient(180deg, #22C55E 0%, #0EA55B 100%); }
  .pill-green-dark { background: linear-gradient(180deg, #0F766E 0%, #065F46 100%); }

  /* Cards */
  .card{ background:#fff; border-radius:1rem; box-shadow:0 8px 18px rgba(0,0,0,.08); }
  .mini{ background:#f8fafc; border:1px solid #e5e7eb; border-radius:.75rem; padding:12px; text-align:center; }

  /* Table & bars */
  .table{ width:100%; border-collapse:separate; border-spacing:0; }
  .table th,.table td{ padding:.6rem .75rem; border-bottom:1px solid #e5e7eb; }
  .table th{ text-align:left; font-weight:700; color:#334155; background:#f8fafc; position:sticky; top:0; }
  .barRow{ display:grid; grid-template-columns:1.5rem 1fr auto; gap:.5rem; align-items:center; }
  .bar{ height:14px; background:linear-gradient(90deg,#1d4ed8,#1e40af); border-radius:7px; }

  /* Supporter banner (base + color variants) */
  .supporter-banner{
    display:flex; align-items:center; justify-content:center; width:100%;
    color:#fff; font-weight:800; padding:.6rem 1rem; border-radius:999px; text-decoration:none;
    box-shadow: 0 6px 14px rgba(0,0,0,.18), inset 0 1px 0 rgba(255,255,255,.25);
  }
  .supporter-banner-green{ background: linear-gradient(180deg, #22C55E 0%, #0EA55B 100%); }
  .supporter-banner-red{   background: linear-gradient(180deg, #DC2626 0%, #B91C1C 100%); }

  /* Equal tops */
  .top-card { min-height:320px; }
  @media (max-width: 640px){ .top-card{ min-height:unset; } }
</style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">
  <header class="bg-white shadow p-4">
    <div class="logo-container">
      <div id="backgroundCrossword" class="background-crossword"></div>
      <div class="crossword-grid">
        <div class="letter-box flipped-k">K</div><div class="letter-box flipped-k">R</div><div class="letter-box">I</div>
        <div class="letter-box flipped-k">P</div><div class="letter-box">T</div><div class="letter-box">I</div>
        <div class="letter-box flipped-k">E</div><div class="letter-box">K</div>
      </div>
    </div>
  </header>

  <div class="max-w-6xl mx-auto px-4 pt-2 text-center text-2xl font-bold text-[#1e3a8a]">
    WELKOM TERUG, <span id="wbName">GEBRUIKER</span>
  </div>

  <main class="flex-grow p-4 pb-16">
    <div class="max-w-6xl mx-auto grid md:grid-cols-2 gap-6 items-start">
      <!-- LEFT -->
      <section class="card p-5 md:p-6 top-card">
        <a id="supporterBanner" href="https://buymeacoffee.com/kriptiek" target="_blank" rel="noopener"
           class="supporter-banner supporter-banner-red mb-4"
           aria-label="Word ’n ondersteuner (Buy Me a Coffee)">
          <span id="supporterBannerTxt">Kliek hier om 'n betalende ondersteuner te word</span>
        </a>

        <h2 class="text-lg font-bold mb-2">Profiel</h2>
        <p id="errBanner" class="hidden text-sm mb-3 px-3 py-2 rounded bg-red-50 text-red-800" role="alert"></p>

        <form id="profileForm" class="space-y-4" novalidate>
          <div>
            <label for="nameInput" class="block text-sm font-semibold text-gray-700">Naam (kan ’n skuilnaam wees)</label>
            <input id="nameInput" type="text" minlength="2" maxlength="40" required class="mt-1 w-full border border-gray-300 rounded p-2" value="Speler"/>
          </div>
          <div>
            <label for="emailInput" class="block text-sm font-semibold text-gray-700">E-posadres</label>
            <input id="emailInput" type="email" required aria-describedby="emailHelp" class="mt-1 w-full border border-gray-300 rounded p-2" value="speler@example.com"/>
            <p id="emailHelp" class="text-xs text-gray-500 mt-1"><strong>Let wel:</strong> Jou e-pos word nie geverifieer nie, maar jy het dit nodig vir wagwoordherstel of navrae oor jou rekening.</p>
          </div>

          <div class="flex flex-wrap items-center gap-2">
            <button type="submit" class="kbtn" id="saveBtn">BÊRE</button>
            <button id="resetPwBtn" type="button" class="kbtn bg-slate-800 hover:bg-slate-900">VRA NUWE WAGWOORD</button>
            <button id="deleteBtn" type="button" class="kbtn kbtn-red">VERWYDER MY REKENING</button>
          </div>
          <p id="formMsg" class="text-sm mt-2 hidden" aria-live="polite" role="status"></p>
          <p id="deleteMsg" class="text-sm mt-2 hidden" aria-live="polite" role="status"></p>
        </form>
      </section>

      <!-- RIGHT -->
      <section class="card p-5 md:p-6 top-card">
        <div class="mb-4"><span id="pillOverall" class="pill pill-lg pill-blue" role="status">JOU KRIPTIEK-TELLING: 0</span></div>
        <div class="flex flex-wrap gap-2 mb-6 items-start">
          <span id="pillDilemmaLive" class="pill pill-lg pill-orange" role="status">JOU DILEMMA-TELLING: 0</span>
          <span class="pill pill-lg pill-green">JOU BLITSTIEK-TELLING: BINNEKORT</span>
          <span class="pill pill-lg pill-green-dark">JOU SLIMSTIEK-TELLING: BINNEKORT</span>
        </div>
        <h3 class="text-2xl md:text-[1.7rem] font-extrabold text-slate-900 mb-1">Hoe werk die Kriptiek-telling?</h3>
        <p class="text-sm text-slate-600">
          Jou Kriptiek-telling is die som van jou tellings vir Dilemma, Slimstiek en Blitstiek, maar tans is nog net eersgenoemde geaktiveer.
          Vir eers is jou Kriptiek-telling dus dieselfde as jou Dilemma-telling. Later sal Slimstiek, Blitstiek en ander speletjies ook bykom, wat allerhande lekker nuwe moontlikhede skep. En onthou, jy kry ook 10% ekstra by al jou punte as jy Kriptiek met $2 per maand of meer ondersteun.
        </p>
      </section>
    </div>

    <!-- DILEMMA -->
    <div class="max-w-6xl mx-auto grid md:grid-cols-2 gap-6 mt-6">
      <section class="card p-5 md:p-6">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-xl font-extrabold text-slate-900">Jou Dilemma-telling</h2>
          <span id="streakChip" class="hidden px-2.5 py-1 rounded-full font-bold text-indigo-900" style="background:#e0e7ff">+10% lopie</span>
        </div>

        <div class="bg-indigo-50 border border-indigo-200 rounded-xl p-4 mb-4">
          <div class="text-sm text-indigo-900/80">Laas bereken op: <span id="calcTime" class="mono">—</span></div>
          <div class="mt-2 flex items-end gap-4">
            <div>
              <div class="text-4xl md:text-5xl font-extrabold mono text-indigo-900" id="totalPoints">0</div>
              <div class="text-xs uppercase tracking-wide text-indigo-900/70">Totale DILEMMA-telling</div>
            </div>
            <div class="ml-auto text-right">
              <div class="text-xs text-indigo-900/70">Vermenigvuldiger</div>
              <div class="text-xl font-extrabold mono" id="multiplierLabel">×1.00</div>
            </div>
          </div>
        </div>

        <p class="text-sm leading-6 text-slate-600 mb-4">
          Hoe minder raaiskote jy nodig het, hoe meer punte kry jy. Daar is ook bonuspunte as jy
          <strong>vyf of meer Dilemmas opeenvolgend kan oplos</strong>, asook ’n
          <strong>10%-bonus vir betalende ondersteuners in die afgelope 30 dae</strong>.
        </p>

        <div class="overflow-auto max-h-[420px] rounded-xl border border-slate-200 bg-white">
          <table class="table text-sm w-full">
            <thead>
              <tr><th>Komponent</th><th class="text-right">Aantal</th><th class="text-right">Reël</th><th class="text-right">Punte</th></tr>
            </thead>
            <tbody id="breakdownBody"></tbody>
            <tfoot>
              <tr>
                <td class="font-bold">Subtotaal</td><td></td><td></td>
                <td class="text-right font-extrabold mono" id="subtotalCell">0</td>
              </tr>
              <tr>
                <td class="font-bold">Lopie-bonus</td><td></td>
                <td class="text-right whitespace-nowrap" id="lopieMeta">—</td>
                <td class="text-right font-extrabold mono" id="lopieBonusCell">0</td>
              </tr>
              <tr>
                <td class="font-bold">Ondersteuner-bonus</td><td></td>
                <td class="text-right whitespace-nowrap" id="supporterMeta">—</td>
                <td class="text-right font-extrabold mono" id="supporterBonusCell">0</td>
              </tr>
              <tr>
                <td class="font-extrabold text-slate-900">Totaal</td><td></td><td></td>
                <td class="text-right font-extrabold mono text-indigo-900" id="totalCell">0</td>
              </tr>
            </tfoot>
          </table>
        </div>
      </section>

      <section class="card p-5 md:p-6">
        <h2 class="text-xl font-extrabold text-slate-900 mb-3">Jou Dilemma-statistiek</h2>
        <div class="grid grid-cols-4 gap-2 mb-4">
          <div class="mini"><div id="playedStat" class="text-3xl font-extrabold mono">0</div><div class="text-xs text-slate-500 mt-1">Dilemmas gespeel</div></div>
          <div class="mini"><div id="winrateStat" class="text-3xl font-extrabold mono">0%</div><div class="text-xs text-slate-500 mt-1">Sukseskoers</div></div>
          <div class="mini"><div id="curStreak" class="text-3xl font-extrabold mono">0</div><div class="text-xs text-slate-500 mt-1">Huidige lopie</div></div>
          <div class="mini"><div id="bestStreak" class="text-3xl font-extrabold mono">0</div><div class="text-xs text-slate-500 mt-1">Beste lopie</div></div>
        </div>

        <h3 class="text-sm font-bold text-slate-700 mb-2">Suksesverdeling</h3>
        <div id="distWrap" class="space-y-2"></div>
      </section>
    </div>
  </main>

  <footer class="bg-white shadow p-4 text-center text-sm text-gray-500">
    &copy; 2025 Kriptiek. Alle regte voorbehou. |
    <a href="/index.html" class="underline px-1.5">Tuis</a> |
    <a href="/forum.html" class="underline px-1.5">Gesels saam</a> |
    <a href="/privacy.html" class="underline px-1.5">Privaatheidsbeleid</a> |
    <a href="/terms.html" class="underline px-1.5">Voorwaardes</a> |
    <a href="/faq.html" class="underline px-1.5">Gereelde vrae</a> |
    <a href="/about.html" class="underline px-1.5">Oor Kriptiek</a> |
    <a href="/contact.html" class="underline px-1.5">Kontak ons</a>
  </footer>

  <!-- Header background letter grid -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const backgroundCrossword = document.getElementById('backgroundCrossword');
      const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
      const rand = n => Math.floor(Math.random()*n);
      function getRandomLetter(){ return letters[rand(letters.length)]; }

      function generateBackgroundGrid() {
        if (!backgroundCrossword) return;
        backgroundCrossword.innerHTML = '';
        const numRows = Math.ceil(backgroundCrossword.offsetHeight / 30);
        const numCols = Math.ceil(backgroundCrossword.offsetWidth / 30);
        const totalCells = (numRows * numCols) || 300;
        for (let i = 0; i < totalCells; i++) {
          const bg = document.createElement('div');
          bg.className = 'bg-letter-box';
          bg.textContent = getRandomLetter();
          backgroundCrossword.appendChild(bg);
        }
      }
      generateBackgroundGrid();

      let gridTimer;
      window.addEventListener('resize', () => {
        clearTimeout(gridTimer);
        gridTimer = setTimeout(generateBackgroundGrid, 150);
      });
    });
  </script>

  <!-- LIVE: Firebase Auth + Firestore integration -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, updateEmail, updateProfile,
      sendPasswordResetEmail, deleteUser
    } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc,
      collection, query, orderBy, limit, getDocs, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

    // Same config as index.html
    const firebaseConfig = {
      apiKey: "AIzaSyDH-nVvGkdaheH7pvRHH0M9TbW2f98lMGQ",
      authDomain: "kriptiek-c9ea2.firebaseapp.com",
      projectId: "kriptiek-c9ea2",
      storageBucket: "kriptiek-c9ea2.appspot.com",
      messagingSenderId: "620450620939",
      appId: "1:620450620939:web:e93a18ac23b53b33db890e"
    };

    // ---- constants (match your scoring) ----
    const BASE_POINTS = { 1:150, 2:135, 3:120, 4:110, 5:105, 6:100, fail:-50 };
    const STREAK_THRESHOLD = 5;
    const STREAK_MULTIPLIER = 1.10;
    const SUPPORTER_MULTIPLIER = 1.10;

    // ---- helpers / DOM ----
    const $ = (id) => document.getElementById(id);
    const fmt = (n) => (typeof n === "number" ? n.toLocaleString("af-ZA") : n);

    const wbName = $("wbName");
    const supporterBanner = $("supporterBanner");
    const supporterBannerTxt = $("supporterBannerTxt");
    const errBanner = $("errBanner");
    const formMsg = $("formMsg");
    const deleteMsg = $("deleteMsg");

    const totalPointsEl = $("totalPoints"), subtotalCell = $("subtotalCell"), totalCell = $("totalCell");
    const breakdownBody = $("breakdownBody"), distWrap = $("distWrap");
    const playedStat = $("playedStat"), winrateStat = $("winrateStat");
    const curStreakEl = $("curStreak"), bestStreakEl = $("bestStreak");
    const streakChip = $("streakChip"), multiplierLabel = $("multiplierLabel"), calcTime = $("calcTime");
    const lopieMeta = $("lopieMeta"), supporterMeta = $("supporterMeta");
    const pillOverall = $("pillOverall"), pillDilemmaLive = $("pillDilemmaLive");

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // -------- gate: must be signed in --------
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        const ret = encodeURIComponent("/profile.html");
        window.location.href = `/login.html?return=${ret}`;
        return;
      }
      try {
        await hydrateProfile(user);
        await loadAndRenderDilemma(user.uid);
        wireFormHandlers(user);
      } catch (e) {
        console.error(e);
        showError("Kon nie data laai nie. Probeer asb. weer.");
      }
    });

    function showError(msg) {
      errBanner.textContent = msg;
      errBanner.classList.remove("hidden");
    }

    // -------- profile load/write --------
    async function hydrateProfile(user) {
      const uref = doc(db, "users", user.uid);
      const snap = await getDoc(uref);

      let userName = user.displayName || "Gebruiker";
      let supporterActive = false;

      if (snap.exists()) {
        const d = snap.data();
        if (d?.userName) userName = d.userName;
        if (d?.supporterActive === true) supporterActive = true;
        if (d?.supporterUntil?.toMillis && d.supporterUntil.toMillis() > Date.now()) supporterActive = true;
      } else {
        await setDoc(uref, {
          userName: userName,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp(),
        }, { merge: true });
      }

      wbName.textContent = (userName || "GEBRUIKER").toUpperCase();

      // NEW: toggle banner wording & color
      if (supporterActive) {
        supporterBanner.classList.remove("supporter-banner-red");
        supporterBanner.classList.add("supporter-banner-green");
        supporterBanner.setAttribute("aria-label", "Dankie dat jy 'n betalende ondersteuner is");
        supporterBannerTxt.textContent = "Betalende ondersteuner — dankie!";
      } else {
        supporterBanner.classList.remove("supporter-banner-green");
        supporterBanner.classList.add("supporter-banner-red");
        supporterBanner.setAttribute("aria-label", "Word ’n ondersteuner (Buy Me a Coffee)");
        supporterBannerTxt.textContent = "Kliek hier om 'n betalende ondersteuner te word";
      }

      $("nameInput").value = userName || "";
      $("emailInput").value = user.email || "";
    }

    function wireFormHandlers(user) {
      $("profileForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const name = $("nameInput").value.trim().slice(0, 40);
        const email = $("emailInput").value.trim();

        try {
          if (name && name !== (user.displayName || "")) {
            await updateProfile(user, { displayName: name });
            await updateDoc(doc(db, "users", user.uid), {
              userName: name,
              updatedAt: serverTimestamp(),
            });
          }
          if (email && email !== (user.email || "")) {
            await updateEmail(user, email);
          }
          formMsg.textContent = "Profiel gestoor.";
          formMsg.className = "text-sm mt-2 text-green-600";
          formMsg.classList.remove("hidden");
        } catch (err) {
          console.error(err);
          let m = "Kon nie jou profiel opdateer nie.";
          if (String(err.code || "").includes("requires-recent-login")) {
            m = "Vir sekuriteit: Meld asseblief weer aan om jou e-pos te kan verander.";
          }
          formMsg.textContent = m;
          formMsg.className = "text-sm mt-2 text-red-600";
          formMsg.classList.remove("hidden");
        }
      });

      $("resetPwBtn").addEventListener("click", async () => {
        try {
          await sendPasswordResetEmail(auth, user.email);
          formMsg.textContent = "’n Wagwoordherstel-skakel is per e-pos gestuur.";
          formMsg.className = "text-sm mt-2 text-green-600";
        } catch (err) {
          console.error(err);
          formMsg.textContent = "Kon nie wagwoordherstel stuur nie.";
          formMsg.className = "text-sm mt-2 text-red-600";
        }
        formMsg.classList.remove("hidden");
      });

      $("deleteBtn").addEventListener("click", async () => {
        if (!confirm("Is jy seker? Jou rekening sal verwyder word.")) return;
        try {
          await deleteUser(user); // may require recent login
          deleteMsg.textContent = "Rekening verwyder.";
          deleteMsg.className = "text-sm mt-2 text-green-600";
          deleteMsg.classList.remove("hidden");
          setTimeout(() => (window.location.href = "/"), 800);
        } catch (err) {
          console.error(err);
          let m = "Kon nie jou rekening verwyder nie.";
          if (String(err.code || "").includes("requires-recent-login")) {
            m = "Vir sekuriteit: Meld asseblief weer aan en probeer dan weer.";
          }
          deleteMsg.textContent = m;
          deleteMsg.className = "text-sm mt-2 text-red-600";
          deleteMsg.classList.remove("hidden");
        }
      });
    }

    // -------- Dilemma data: compute and render --------
    async function loadAndRenderDilemma(uid) {
      const uref = doc(db, "users", uid);
      const uSnap = await getDoc(uref);

      let supporterActive = false;
      if (uSnap.exists()) {
        const d = uSnap.data();
        if (d?.supporterActive === true) supporterActive = true;
        if (d?.supporterUntil?.toMillis && d.supporterUntil.toMillis() > Date.now()) supporterActive = true;
      }

      const playsRef = collection(db, "userGames", uid, "plays");
      const q = query(playsRef, orderBy("finishedAt", "desc"), limit(200));
      const snap = await getDocs(q);

      const plays = [];
      snap.forEach((docSnap) => {
        const d = docSnap.data();
        const gameId = docSnap.id; // "GameYYYY-MM-DD"
        const date = gameId.replace(/^Game/, "");
        plays.push({
          date,
          win: d?.result === "win" || d?.finished === true,
          guesses: Number(d?.guesses || 0),
        });
      });

      computeAndRender(plays, supporterActive);
    }

    function computeAndRender(plays, supporterActive) {
      const byDate = new Map();
      plays.slice().reverse().forEach((p) => byDate.set(p.date, p));

      const dates = Array.from(byDate.keys()).sort();
      let cur = 0, best = 0, prev = null;
      for (const d of dates) {
        const consec = prev && (new Date(d) - new Date(prev) === 24 * 60 * 60 * 1000);
        if (!consec) cur = 0;
        const p = byDate.get(d);
        if (p?.win) { cur++; best = Math.max(best, cur); } else { cur = 0; }
        prev = d;
      }

      const dist = { 1:0, 2:0, 3:0, 4:0, 5:0, 6:0, fail:0 };
      for (const p of byDate.values()) {
        if (p.win) {
          const g = Math.min(Math.max(1, p.guesses || 6), 6);
          dist[g] += 1;
        } else {
          dist.fail += 1;
        }
      }

      const subtotal =
        dist[1]*BASE_POINTS[1] + dist[2]*BASE_POINTS[2] + dist[3]*BASE_POINTS[3] +
        dist[4]*BASE_POINTS[4] + dist[5]*BASE_POINTS[5] + dist[6]*BASE_POINTS[6] +
        dist.fail*BASE_POINTS.fail;

      const streakMult = cur >= STREAK_THRESHOLD ? STREAK_MULTIPLIER : 1;
      const supporterMult = supporterActive ? SUPPORTER_MULTIPLIER : 1;
      const streakBonus = Math.round(subtotal * (streakMult - 1));
      const supporterBonus = Math.round((subtotal + streakBonus) * (supporterMult - 1));
      const total = subtotal + streakBonus + supporterBonus;

      const totalPlayed = dates.length;
      const wins = totalPlayed - dist.fail;
      const winrate = totalPlayed ? Math.round((wins / totalPlayed) * 100) : 0;

      playedStat.textContent = totalPlayed;
      winrateStat.textContent = `${winrate}%`;
      curStreakEl.textContent = cur;
      bestStreakEl.textContent = best;

      const rows = [
        {label: `In 1 raaiskoot opgelos`, qty: dist[1], per: BASE_POINTS[1]},
        {label: `In 2 raaiskote opgelos`,  qty: dist[2], per: BASE_POINTS[2]},
        {label: `In 3 raaiskote opgelos`,  qty: dist[3], per: BASE_POINTS[3]},
        {label: `In 4 raaiskote opgelos`,  qty: dist[4], per: BASE_POINTS[4]},
        {label: `In 5 raaiskote opgelos`,  qty: dist[5], per: BASE_POINTS[5]},
        {label: `In 6 raaiskote opgelos`,  qty: dist[6], per: BASE_POINTS[6]},
        {label: `Onopgelos`,               qty: dist.fail, per: BASE_POINTS.fail},
      ];
      breakdownBody.innerHTML = rows.map(r => {
        const pts = r.qty * r.per;
        return `<tr>
          <td>${r.label}</td>
          <td class="text-right mono">${fmt(r.qty)}</td>
          <td class="text-right mono">${fmt(r.qty)} × ${fmt(r.per)}</td>
          <td class="text-right mono ${pts>=0?'text-emerald-700':'text-red-700'}">${fmt(pts)}</td>
        </tr>`;
      }).join("");

      const pairs = [['1',dist[1]],['2',dist[2]],['3',dist[3]],['4',dist[4]],['5',dist[5]],['6',dist[6]],['X',dist.fail]];
      const maxv = Math.max(1, ...pairs.map(p => p[1]));
      distWrap.innerHTML = pairs.map(([lb,val]) => {
        const w = val === 0 ? 0 : Math.max(6, Math.round((val/maxv)*100));
        return `<div class="barRow"><div class="text-xs font-bold text-slate-500">${lb}</div><div class="bar" style="width:${w}%"></div><div class="mono text-sm font-extrabold">${fmt(val)}</div></div>`;
      }).join("");

      subtotalCell.textContent = fmt(subtotal);
      $("lopieBonusCell").textContent = fmt(streakBonus);
      $("supporterBonusCell").textContent = fmt(supporterBonus);
      totalCell.textContent = fmt(total);

      if (streakMult > 1) {
        streakChip.classList.remove("hidden");
        lopieMeta.innerHTML = `Lopie: ${cur} op ’n ry <span class="text-slate-400">(×${STREAK_MULTIPLIER.toFixed(2)})</span>`;
      } else {
        streakChip.classList.add("hidden");
        lopieMeta.innerHTML = `Geen <span class="text-slate-400">(huidige lopie: ${cur})</span>`;
      }
      supporterMeta.textContent = supporterActive ? `×${SUPPORTER_MULTIPLIER.toFixed(2)}` : "Geen";

      const combinedMult = streakMult * supporterMult;
      multiplierLabel.textContent = `×${combinedMult.toFixed(2)}`;

      calcTime.textContent = new Date().toLocaleString("af-ZA");
      pillOverall.textContent     = `JOU KRIPTIEK-TELLING: ${fmt(total)}`;
      pillDilemmaLive.textContent = `JOU DILEMMA-TELLING: ${fmt(total)}`;
      totalPointsEl.textContent   = fmt(total);
    }
  </script>
</body>
</html>
