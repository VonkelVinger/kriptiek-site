<!DOCTYPE html>
<html lang="af">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Profieltoets – Kriptiek</title>

  <link rel="icon" href="/assets/favicon.ico" type="image/x-icon" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&display=swap" rel="stylesheet" />
  <style>
    body { font-family: 'Montserrat', sans-serif; }
    .mono { font-variant-numeric: tabular-nums; }

    /* Pills */
    .pill { display:inline-block; padding:8px 18px; border-radius:9999px; font-weight:700; font-size:14px; line-height:20px; }
    .pill-blue { background:#1e3a8a; color:#fff; }

    /* Badges */
    .badge { padding:4px 10px; border-radius:9999px; font-size:12px; font-weight:700; }
    .badge-green { background:#059669; color:#fff; }
    .badge-gray { background:#e5e7eb; color:#374151; }

    /* Bars for dist */
    .stat { display:grid; grid-template-columns:auto 1fr auto; gap:.5rem .75rem; align-items:center; }
    .bar { height: 22px; background:#1d4ed8; border-radius:4px; transition:width .4s ease; }

    /* Game block wrapper (so we can add Blitstiek/Slimstiek later) */
    .game-block { background:#fff; border-radius: .75rem; box-shadow: 0 1px 2px rgba(0,0,0,.05); }
    .game-block .gb-head { padding: 14px 20px; border-bottom: 1px solid #e5e7eb; display:flex; align-items:center; justify-content:space-between; }
    .game-block .gb-body { padding: 16px 20px; }
    .subtle { color:#6b7280; }

    /* Mini cards inside a block */
    .mini { background:#f9fafb; border:1px solid #e5e7eb; border-radius:.5rem; padding:12px; }

    /* Three-column analyser table */
    .ana-grid { display:grid; grid-template-columns: 7fr 3fr 2fr; gap:.25rem .75rem; align-items:center; }
    .ana-head { color:#6b7280; font-size:12px; }
    .ana-num { text-align:right; }
    .ana-total { grid-column:1 / -1; display:flex; justify-content:space-between; align-items:center; background:#fef9c3; border:1px solid #fde68a; border-radius:.5rem; padding:.5rem .75rem; font-weight:700; margin-top:.25rem; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">
  <header class="bg-white shadow p-4 text-center">
    <h1 class="text-xl font-bold text-[#1e3a8a]">Jou Kriptiek-profiel (TOETS)</h1>
    <p class="text-xs text-gray-500 mt-1">Hierdie blad wys ’n voorskou van die Dilemma-telling. Geen skrywes word gedoen nie.</p>
  </header>

  <main class="flex-grow p-4">
    <!-- SECTION 1: General profile (left) + overall pill + delete (right) -->
    <div class="max-w-5xl mx-auto grid md:grid-cols-2 gap-6 items-stretch">
      <!-- LEFT: Profile card -->
      <section class="bg-white shadow rounded-xl p-5 flex flex-col h-full">
        <div class="flex items-center justify-between mb-1">
          <h2 class="text-lg font-bold">Profiel</h2>
          <!-- Prominent Ondersteuner-status -->
          <span id="supporterBadgeTop" class="badge badge-gray whitespace-nowrap">Ondersteuner: onbekend</span>
        </div>

        <p id="statusBanner" class="hidden text-sm mb-3 px-3 py-2 rounded bg-yellow-50 text-yellow-800">
          Jou rekening is gemerk vir verwydering. Kontak ons as dit ’n fout is.
        </p>

        <form id="profileForm" class="space-y-4 flex-1">
          <div>
            <label class="block text-sm font-semibold text-gray-700">Naam (kan 'n skuilnaam wees)</label>
            <input id="nameInput" type="text" minlength="2" maxlength="40" required
                   class="mt-1 w-full border border-gray-300 rounded p-2"/>
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700">E-posadres</label>
            <input id="emailInput" type="email" required
                   class="mt-1 w-full border border-gray-300 rounded p-2"/>
            <p class="text-xs text-gray-500 mt-1">Let wel: Jou e-posadres word nie geverifieer nie, maar jy sal dit nodig kry as jy jou wagwoord verloor het of navrae oor jou rekening het.</p>
          </div>

        <!-- Status line under form (mirrors the top badge; stays subtle) -->
        <div class="flex items-center gap-2 text-sm subtle">
          <span>Jou status:</span>
          <span id="supporterBadgeInline" class="badge badge-gray">Ondersteuner: onbekend</span>
        </div>

          <!-- Action row pinned to the bottom -->
          <div class="mt-auto flex flex-wrap items-center gap-2">
            <button type="submit" class="bg-gray-800 hover:bg-gray-900 text-white px-4 py-2 rounded">BÊRE</button>
            <button id="resetPwBtn" type="button" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
              VRA NUWE WAGWOORD
            </button>
          </div>
          <p id="formMsg" class="text-sm mt-2 hidden"></p>
        </form>
      </section>

      <!-- RIGHT: column with small KRIPTIEK pill + delete -->
      <div class="flex flex-col h-full">
        <section class="bg-white shadow rounded-xl p-5 flex items-center justify-center">
          <span id="pillOverall" class="pill pill-blue whitespace-nowrap">JOU KRIPTIEK-TELLING: 0</span>
        </section>

        <section class="bg-white shadow rounded-xl p-5 flex flex-col flex-1 mt-6">
          <h3 class="text-lg font-bold mb-2">Verwyder my rekening</h3>
          <p class="text-sm text-gray-600 mb-3">
            Kliek op die rooi knoppie onder om te vra dat jou rekening <span class="font-semibold">gedeaktiveer word.</span>
            Dit sal ’n verwyderingsversoek indien, waarna jou toegang onmiddellik geblokkeer sal word.
            Die laaste stap word op die bediener gedoen.
          </p>
          <div class="mt-auto">
            <button id="deleteBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">
              VERWYDER MY REKENING
            </button>
            <p id="deleteMsg" class="text-sm mt-2 hidden"></p>
          </div>
        </section>
      </div>
    </div>

    <!-- SECTION 2: Dilemma-telling (summary + analysis + stats) -->
    <div class="max-w-5xl mx-auto grid md:grid-cols-2 gap-6 mt-6">
      <!-- LEFT: Game block - Dilemma -->
      <section class="game-block dilemma">
        <div class="gb-head">
          <div class="flex items-center gap-3">
            <h2 class="text-lg font-bold">Jou Dilemma-telling <span class="text-xs subtle">(BETA)</span></h2>
            <span id="supporterBadgeD" class="badge badge-gray hidden">Nie-betalende ondersteuner</span>
          </div>
          <span id="pillDilemma" class="pill pill-blue whitespace-nowrap">DILEMMA-TELLING: 0</span>
        </div>

        <div class="gb-body">
          <!-- Summary row -->
          <div class="mini mb-4">
            <div class="text-2xl font-bold mono" id="dilemmaTotal">0</div>
            <div class="text-xs subtle" id="visibilityLine">Laas bereken: —</div>
          </div>

          <!-- Ontleding -->
          <h3 class="font-semibold mb-2">Ontleding</h3>
          <div class="ana-grid text-sm">
            <div class="ana-head">Komponent</div>
            <div class="ana-head ana-num">Aantal / Reël</div>
            <div class="ana-head ana-num">Punte</div>

            <div>Wenpunte (1 raai × 150)</div> <div id="c1"  class="ana-num mono">0 × 150</div> <div id="sc1"  class="ana-num mono">0</div>
            <div>Wenpunte (2 raai × 135)</div> <div id="c2"  class="ana-num mono">0 × 135</div> <div id="sc2"  class="ana-num mono">0</div>
            <div>Wenpunte (3 raai × 120)</div> <div id="c3"  class="ana-num mono">0 × 120</div> <div id="sc3"  class="ana-num mono">0</div>
            <div>Wenpunte (4 raai × 110)</div> <div id="c4"  class="ana-num mono">0 × 110</div> <div id="sc4"  class="ana-num mono">0</div>
            <div>Wenpunte (5 raai × 105)</div> <div id="c5"  class="ana-num mono">0 × 105</div> <div id="sc5"  class="ana-num mono">0</div>
            <div>Wenpunte (6 raai × 100)</div> <div id="c6"  class="ana-num mono">0 × 100</div> <div id="sc6"  class="ana-num mono">0</div>

            <div>Verliespunte (gespeel maar verloor)</div> <div id="cL" class="ana-num mono">0 × 20</div> <div id="scL" class="ana-num mono">0</div>
            <div>Streek-bonus (+5 × min(lopie, 5) per dag)</div> <div id="cStreak"   class="ana-num mono">—</div> <div id="scStreak"   class="ana-num mono">0</div>
            <div>Argief-bonus (+15 per oorwinning; kap +60/weke)</div> <div id="cArchive" class="ana-num mono">—</div> <div id="scArchive" class="ana-num mono">0</div>
            <div>Konsistensie (⌊(wen% − 50)/5⌋)</div> <div id="cCons" class="ana-num mono">—</div> <div id="scCons" class="ana-num mono">0</div>

            <div class="ana-total">
              <span>Totaal (sonder betaal-bonus en Top-10)</span>
              <span id="scTotal" class="mono">0</span>
            </div>
          </div>

          <details class="mt-4">
            <summary class="cursor-pointer text-sm text-blue-700">Hoe ons tel (kliek om oop te maak)</summary>
            <div class="text-sm text-gray-700 mt-2 space-y-2">
              <p><strong>Wenpunte:</strong> 1 raai=150; 2=135; 3=120; 4=110; 5=105; 6=100.</p>
              <p><strong>Verliespunte:</strong> +20 as jy speel maar nie raai nie.</p>
              <p><strong>Streek-bonus:</strong> +5 per agtereenvolgende oorwinning (kap op 5/dag).</p>
              <p><strong>Argief-bonus:</strong> +15 vir elke ouer spel wat jy vandag inhaal; kap +60 per kalenderweek.</p>
              <p><strong>Konsistensie:</strong> +1 vir elke 5% bo 50% wenkoers.</p>
              <p><strong>Betaal-bonus:</strong> Ondersteuners kry +10% op nuwe punte vanaf die lanseerdatum. (Nie in hierdie voorskou ingesluit nie.)</p>
              <p><strong>Top-10 bonus:</strong> +10 vir spelers in die finale top-10 van die dag (vasgestel 23:59 SAST). (Nie terugwerkend bereken in hierdie voorskou nie.)</p>
              <p class="text-gray-600">Om as ’n <strong>betalende ondersteuner</strong> te kwalifiseer: <strong>$2 per maand</strong> (rollende 30 dae).</p>
            </div>
          </details>
        </div>
      </section>

      <!-- RIGHT: Stats card (kept, restyled to match) -->
      <section class="game-block">
        <div class="gb-head">
          <h2 class="text-lg font-bold">Jou Dilemma-statistiek</h2>
        </div>
        <div class="gb-body">
          <div class="grid grid-cols-2 gap-3 text-center mb-4">
            <div class="mini">
              <div class="text-2xl font-bold mono" id="gamesPlayed">0</div>
              <div class="text-xs subtle">Dilemmas gespeel</div>
            </div>
            <div class="mini">
              <div class="text-2xl font-bold mono" id="successRate">0%</div>
              <div class="text-xs subtle">Sukseskoers</div>
            </div>
            <div class="mini">
              <div class="text-2xl font-bold mono" id="streak">0</div>
              <div class="text-xs subtle">Huidige lopie</div>
            </div>
            <div class="mini">
              <div class="text-2xl font-bold mono" id="bestStreak">0</div>
              <div class="text-xs subtle">Beste lopie</div>
            </div>
          </div>

          <h3 class="font-semibold mb-2">Suksesverdeling</h3>
          <div id="distList" class="space-y-2"></div>
        </div>
      </section>
    </div>
  </main>

  <footer class="bg-white shadow p-4 text-center text-sm text-gray-500">
    &copy; 2025 Kriptiek · <a href="/index.html" class="underline">Tuis</a> |
    <a href="/forum.html" class="underline">Gesels saam</a> |
    <a href="/privacy.html" class="underline">Privaatheidsbeleid</a> |
    <a href="/terms.html" class="underline">Voorwaardes</a> |
    <a href="/faq.html" class="underline">Gereelde vrae</a> |
    <a href="/about.html" class="underline">Oor Kriptiek</a> |
    <a href="/contact.html" class="underline">Kontak ons</a>
  </footer>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, updateEmail, sendPasswordResetEmail, signOut } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, serverTimestamp, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

    // Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDH-nVvGkdaheH7pvRHH0M9TbW2f98lMGQ",
      authDomain: "kriptiek-c9ea2.firebaseapp.com",
      projectId: "kriptiek-c9ea2",
      storageBucket: "kriptiek-c9ea2.appspot.com",
      messagingSenderId: "620450620939",
      appId: "1:620450620939:web:e93a18ac23b53b33db890e"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Refs
    const nameInput = document.getElementById('nameInput');
    const emailInput = document.getElementById('emailInput');
    const resetPwBtn = document.getElementById('resetPwBtn');
    const formMsg = document.getElementById('formMsg');
    const deleteMsg = document.getElementById('deleteMsg');
    const statusBanner = document.getElementById('statusBanner');

    const supporterBadgeTop = document.getElementById('supporterBadgeTop');
    const supporterBadgeInline = document.getElementById('supporterBadgeInline');
    const supporterBadgeD = document.getElementById('supporterBadgeD');

    const pillDilemma = document.getElementById('pillDilemma');
    const pillOverall  = document.getElementById('pillOverall');

    // Scoring preview config
    const D_POINTS = [150,135,120,110,105,100];
    const LOSS_POINTS = 20;
    const STREAK_UNIT = 5;
    const ARCHIVE_UNIT = 15;
    const ARCHIVE_WEEKLY_CAP = 60;

    const fmt = (n)=> (typeof n === 'number') ? n.toLocaleString('af-ZA') : String(n);

    function parseGameDateFromId(id){
      try{
        const dstr = id.startsWith("Game") ? id.slice(4) : id;
        const [y,m,d] = dstr.split("-").map(n=>parseInt(n,10));
        return new Date(y, (m-1), d, 12, 0, 0);
      }catch{ return null; }
    }
    function todayKey(){
      const n = new Date();
      return `${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,'0')}-${String(n.getDate()).padStart(2,'0')}`;
    }
    function weekKey(dt){
      const t = new Date(dt.getTime());
      const day = (t.getDay()+6)%7; t.setDate(t.getDate()-day + 3);
      const firstThu = new Date(t.getFullYear(),0,4);
      return `${t.getFullYear()}-W${String(1 + Math.floor((t - firstThu)/86400000/7)).padStart(2,'0')}`;
    }

    function computePreviewScore({userData, plays}) {
      const dist = userData.guessDist || {};
      const winsByGuessCounts = [0,0,0,0,0,0,0];
      for (let i=1;i<=6;i++) winsByGuessCounts[i] = Number(dist[String(i)]||0);

      const sorted = [...plays].sort((a,b)=>{
        const ad=a.dateObj?.getTime()||0, bd=b.dateObj?.getTime()||0;
        return ad===bd ? (a.id||'').localeCompare(b.id||'') : ad-bd;
      });

      const tKey = todayKey();
      let tempStreak=0, streakBonus=0, lossCount=0;
      const archiveWinsByWeek = new Map();

      for (const p of sorted){
        const isWin  = (p.result==='win') || (!!p.guesses && p.finished);
        const isLoss = !isWin && p.finished;

        if (isWin){
          tempStreak += 1;
          streakBonus += STREAK_UNIT * Math.min(tempStreak, 5);
          const gKey = `${p.dateObj.getFullYear()}-${String(p.dateObj.getMonth()+1).padStart(2,'0')}-${String(p.dateObj.getDate()).padStart(2,'0')}`;
          if (gKey < tKey){
            const wk = weekKey(p.dateObj);
            archiveWinsByWeek.set(wk, (archiveWinsByWeek.get(wk)||0) + 1);
          }
        } else if (isLoss){
          tempStreak = 0;
          lossCount += 1;
        }
      }

      let archiveBonus = 0, archiveExpl = [];
      for (const [wk,count] of archiveWinsByWeek.entries()){
        const add = Math.min(count * ARCHIVE_UNIT, ARCHIVE_WEEKLY_CAP);
        archiveBonus += add;
        archiveExpl.push(`${count} win${count===1?'':'s'} in ${wk} → +${add}`);
      }

      let winPoints = 0, winByGuessPts = [];
      for (let g=1; g<=6; g++){
        const pts = winsByGuessCounts[g] * D_POINTS[g-1];
        winByGuessPts[g] = pts;
        winPoints += pts;
      }

      const lossPoints = lossCount * LOSS_POINTS;

      const gamesPlayed = Number(userData.gamesPlayed || 0);
      const wins = Number(userData.wins || 0);
      const winPct = gamesPlayed ? Math.round((wins/gamesPlayed)*100) : 0;
      const consistency = Math.max(0, Math.floor((winPct - 50)/5));

      const subtotal = winPoints + lossPoints + streakBonus + archiveBonus + consistency;

      return {
        winsByGuessCounts, winByGuessPts,
        lossCount, lossPoints,
        streakBonus,
        archiveBonus, archiveExpl,
        consistency, winPct,
        subtotal
      };
    }

    function setSupporterBadges({active, label}){
      const clsOn  = 'badge-green', clsOff = 'badge-gray';
      const nodes = [supporterBadgeTop, supporterBadgeInline, supporterBadgeD];
      nodes.forEach(n=>{
        if (!n) return;
        n.textContent = active ? 'Betalende ondersteuner' : 'Nie-betalende ondersteuner';
        n.classList.remove(active ? clsOff : clsOn);
        n.classList.add(active ? clsOn : clsOff);
        n.classList.remove('hidden');
      });
    }

    function isSupporterActive(userDoc){
      // Support either of these fields:
      // - supporterUntil: Firestore Timestamp / Date in the future
      // - supporterUsd30d: number > 0 (rolling 30d)
      // - supporterActive: boolean (explicit)
      const now = new Date();
      const u = userDoc || {};
      if (typeof u.supporterActive === 'boolean') return u.supporterActive;

      let until = null;
      if (u.supporterUntil?.toDate) until = u.supporterUntil.toDate();
      else if (u.supporterUntil instanceof Date) until = u.supporterUntil;

      if (until && until > now) return true;
      if (typeof u.supporterUsd30d === 'number' && u.supporterUsd30d > 0) return true;
      return false;
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        localStorage.setItem('redirectAfterLogin','/profiletest.html');
        window.location.href = '/login.html';
        return;
      }

      // Prefill
      emailInput.value = user.email || '';
      const cachedName = localStorage.getItem('userName') || '';
      if (cachedName) nameInput.value = cachedName;

      // Ensure user doc exists
      const userRef = doc(db, 'users', user.uid);
      const snap = await getDoc(userRef);
      if (!snap.exists()) {
        await setDoc(userRef, {
          userName: cachedName || 'Speler',
          email: user.email || '',
          gamesPlayed: 0, wins: 0, streak: 0, bestStreak: 0,
          guessDist: { "1":0, "2":0, "3":0, "4":0, "5":0, "6":0 },
          supporterActive: false,
          status: "active",
          createdAt: serverTimestamp(), updatedAt: serverTimestamp()
        }, { merge: true });
      }
      const data = (await getDoc(userRef)).data() || {};

      // Deactivation UI
      if (data.status && data.status !== 'active') {
        statusBanner.classList.remove('hidden');
        nameInput.disabled = true; emailInput.disabled = true; resetPwBtn.disabled = true;
        document.querySelector('#profileForm button[type="submit"]').disabled = true;
      }

      // Supporter status (top + section badges)
      setSupporterBadges({ active: isSupporterActive(data) });

      // Stats (if present)
      const gamesPlayed = data.gamesPlayed || 0;
      const wins = data.wins || 0;
      const successRate = gamesPlayed ? Math.round((wins/gamesPlayed)*100) : 0;
      const gpEl = document.getElementById('gamesPlayed');
      if (gpEl) {
        gpEl.textContent = gamesPlayed;
        document.getElementById('successRate').textContent = `${successRate}%`;
        document.getElementById('streak').textContent = data.streak || 0;
        document.getElementById('bestStreak').textContent = data.bestStreak || 0;
      }

      // Plays for preview
      const playsSnap = await getDocs(collection(db, 'userGames', user.uid, 'plays'));
      const plays = [];
      playsSnap.forEach(d => {
        const x = d.data() || {};
        const dt = x.finishedAt?.toDate?.() || x.finishedAt || parseGameDateFromId(d.id) || new Date();
        plays.push({ id:d.id, finished:!!x.finished, result:x.result||null, guesses:x.guesses||null, dateObj:(dt instanceof Date)?dt:new Date(dt) });
      });

      const preview = computePreviewScore({userData: data, plays});

      // Fill breakdown + totals (+ counts column)
      for (let g=1; g<=6; g++){
        const count = preview.winsByGuessCounts[g] || 0;
        document.getElementById(`c${g}`).textContent  = `${fmt(count)} × ${D_POINTS[g-1]}`;
        document.getElementById(`sc${g}`).textContent = fmt(preview.winByGuessPts[g] || 0);
      }
      document.getElementById('cL').textContent       = `${fmt(preview.lossCount)} × ${LOSS_POINTS}`;
      document.getElementById('scL').textContent      = fmt(preview.lossPoints);
      document.getElementById('cStreak').textContent  = preview.streakBonus ? 'som van dagbonusse' : '—';
      document.getElementById('scStreak').textContent = fmt(preview.streakBonus);
      document.getElementById('cArchive').textContent = preview.archiveBonus ? (preview.archiveExpl[0] || '—') : '—';
      document.getElementById('scArchive').textContent = fmt(preview.archiveBonus);
      document.getElementById('cCons').textContent    = `${fmt(preview.winPct)}% wenkoers`;
      document.getElementById('scCons').textContent   = fmt(preview.consistency);

      document.getElementById('scTotal').textContent  = fmt(preview.subtotal);
      document.getElementById('dilemmaTotal').textContent = fmt(preview.subtotal);

      // Pills
      pillDilemma.textContent = `DILEMMA-TELLING: ${fmt(preview.subtotal)}`;
      pillOverall.textContent  = `JOU KRIPTIEK-TELLING: ${fmt(preview.subtotal)}`;

      // Last computed line
      const now = new Date();
      document.getElementById('visibilityLine').textContent =
        `Laas bereken: ${now.toLocaleDateString('af-ZA')} ${now.toLocaleTimeString('af-ZA', {hour:'2-digit', minute:'2-digit'})}`;

      // Success distribution
      function renderDist(dist) {
        const container = document.getElementById('distList');
        if (!container) return;
        container.innerHTML = "";
        const totalWins = Object.values(dist || {}).reduce((a,b)=>a+(b||0),0) || 0;
        for (let i=1;i<=6;i++){
          const n = (dist && dist[String(i)]) || 0;
          const pct = totalWins ? Math.round((n/totalWins)*100) : 0;
          const row = document.createElement('div');
          row.className = "stat";
          row.innerHTML = `
            <div class="text-sm text-gray-600 w-5">${i}</div>
            <div class="w-full"><div class="bar" style="width:${Math.max(pct, 5)}%"></div></div>
            <div class="text-sm text-gray-600 text-right mono w-10">${fmt(n)}</div>
          `;
          container.appendChild(row);
        }
      }
      renderDist(data.guessDist || {});
    });

    // Save profile
    document.getElementById('profileForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const user = auth.currentUser; if (!user) return;

      const name = nameInput.value.trim();
      const newEmail = emailInput.value.trim();
      if (name.length < 2){
        formMsg.textContent = "Naam te kort.";
        formMsg.className = "text-sm mt-2 text-red-600";
        formMsg.classList.remove('hidden');
        return;
      }

      try {
        if (newEmail && newEmail !== (user.email || '')) await updateEmail(user, newEmail);
        const payload = { userName:name, email:newEmail || user.email || '', updatedAt: serverTimestamp() };
        await setDoc(doc(db,'users', user.uid), payload, { merge:true });
        await setDoc(doc(db,'registrations', user.uid), { ...payload, userId: user.uid }, { merge:true });
        localStorage.setItem('userName', name);
        formMsg.textContent = "Profiel gestoor.";
        formMsg.className = "text-sm mt-2 text-green-600";
        formMsg.classList.remove('hidden');
      } catch (err) {
        formMsg.textContent = "Kon nie stoor nie: " + err.message;
        formMsg.className = "text-sm mt-2 text-red-600";
        formMsg.classList.remove('hidden');
      }
    });

    // Reset password
    document.getElementById('resetPwBtn').addEventListener('click', async ()=>{
      const user = auth.currentUser;
      if (!user || !user.email){
        formMsg.textContent = "Geen e-pos gevind vir jou rekening nie.";
        formMsg.className = "text-sm mt-2 text-red-600";
        formMsg.classList.remove('hidden');
        return;
      }
      try {
        await sendPasswordResetEmail(auth, user.email, { url: 'https://www.kriptiek.com/login.html', handleCodeInApp: false });
        formMsg.textContent = "Wagwoordherstel-e-pos is gestuur (kyk ook jou spam).";
        formMsg.className = "text-sm mt-2 text-green-600";
        formMsg.classList.remove('hidden');
      } catch (err) {
        formMsg.textContent = "Kon nie e-pos stuur nie: " + err.message;
        formMsg.className = "text-sm mt-2 text-red-600";
        formMsg.classList.remove('hidden');
      }
    });

    // Soft-delete
    document.getElementById('deleteBtn').addEventListener('click', async ()=>{
      const user = auth.currentUser; if (!user) return;
      if (!confirm("Is jy seker? Jou rekening word gedeaktiveer en vir verwydering ingedien.")) return;
      try {
        await setDoc(doc(db,'users', user.uid), { status:"deletion_requested", updatedAt: serverTimestamp() }, { merge:true });
        await setDoc(doc(db,'deletionRequests', user.uid), { requestedAt: serverTimestamp(), uid:user.uid, email:user.email || null }, { merge:true });
        deleteMsg.textContent = "Versoek gestuur. Jy sal nou afgemeld word.";
        deleteMsg.className = "text-sm mt-2 text-green-600";
        deleteMsg.classList.remove('hidden');
        await signOut(auth);
        setTimeout(()=>{ window.location.href = "/index.html"; }, 800);
      } catch (err) {
        deleteMsg.textContent = "Kon nie versoek stuur nie: " + err.message;
        deleteMsg.className = "text-sm mt-2 text-red-600";
        deleteMsg.classList.remove('hidden');
      }
    });
  </script>
</body>
</html>
