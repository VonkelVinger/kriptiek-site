<!DOCTYPE html>
<html lang="af">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-S9V4CMP1FP"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-S9V4CMP1FP');
  </script>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no" />
  <title>My Profiel – Kriptiek</title>

  <link rel="icon" href="/assets/favicon.ico" type="image/x-icon" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&display=swap" rel="stylesheet" />
  <style>
    :root { --k-blue:#1d4ed8; --k-blue-d:#1e40af; --k-ink:#0b1020; }
    body { font-family:'Montserrat',sans-serif; background:#f8fafc; color:#0f172a; }
    .mono{ font-variant-numeric: tabular-nums; }
    .card{ background:#fff; border-radius:1rem; box-shadow:0 8px 24px rgba(2,6,23,.06); }
    .chip{ display:inline-flex; align-items:center; gap:.5rem; padding:.25rem .6rem; border-radius:999px; background:#eef2ff; color:#1e3a8a; font-weight:700; }
    .title{ letter-spacing:.2px; }
    .gridStat{ display:grid; grid-template-columns:repeat(4,minmax(0,1fr)); gap:.75rem; }
    .statBox{ background:#f1f5f9; border:1px solid #e5e7eb; border-radius:.8rem; padding:.9rem .9rem .8rem; text-align:center; }
    .barRow{ display:grid; grid-template-columns: 1.5rem 1fr auto; gap:.5rem; align-items:center; }
    .bar{ height:14px; background:linear-gradient(90deg,var(--k-blue),var(--k-blue-d)); border-radius:6px; }
    .kbadge{ background:#0ea5e9; color:#022c22; }
    .pill{ border-radius:999px; }
    .kbtn{ display:inline-flex; align-items:center; justify-content:center; gap:.5rem; padding:.65rem .9rem; border-radius:.9rem; background:var(--k-blue); color:#fff; font-weight:700; box-shadow:0 6px 16px rgba(29,78,216,.25); }
    .kbtn:hover{ background:var(--k-blue-d); }
    .table{ width:100%; border-collapse:separate; border-spacing:0; }
    .table th,.table td{ padding:.6rem .75rem; border-bottom:1px solid #e5e7eb; }
    .table th{ text-align:left; font-weight:700; color:#334155; background:#f8fafc; position:sticky; top:0; }
    .good{ color:#065f46; }
    .bad{ color:#991b1b; }
  </style>
</head>
<body>
  <header class="max-w-5xl mx-auto px-4 pt-6">
    <div class="flex items-center justify-between">
      <h1 class="title text-2xl md:text-3xl font-extrabold text-slate-900">
        My Profiel
      </h1>
      <div id="authBar" class="flex items-center gap-2">
        <button id="btnLogin" class="kbtn hidden">Meld aan</button>
        <button id="btnLogout" class="kbtn hidden bg-slate-800 hover:bg-slate-900">Meld af</button>
      </div>
    </div>
  </header>

  <main class="max-w-5xl mx-auto px-4 pb-16">
    <!-- DILEMMA SECTION -->
    <section class="mt-6 grid md:grid-cols-2 gap-4">
      <!-- Left: Score + explanation + table -->
      <div class="card p-4 md:p-6">
        <div class="flex items-center justify-between mb-3">
          <h2 class="title text-xl font-extrabold text-slate-900">DILEMMA-telling</h2>
          <span id="streakChip" class="chip hidden">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3 7h7l-5.5 4.5L18 21l-6-4-6 4 1.5-7.5L2 9h7z"/></svg>
            +10% lopie
          </span>
        </div>

        <div class="bg-indigo-50 border border-indigo-200 rounded-xl p-4 mb-4">
          <div class="text-sm text-indigo-900/80">Laas bereken: <span id="calcTime" class="mono">–</span></div>
          <div class="mt-2 flex items-end gap-4">
            <div>
              <div class="text-4xl md:text-5xl font-extrabold mono text-indigo-900" id="totalPoints">0</div>
              <div class="text-xs uppercase tracking-wide text-indigo-900/70">Totale DILEMMA-telling</div>
            </div>
            <div class="ml-auto text-right">
              <div class="text-xs text-indigo-900/70">Multiplier</div>
              <div class="text-xl font-extrabold mono" id="multiplierLabel">×1.00</div>
            </div>
          </div>
        </div>

        <p class="text-sm leading-6 text-slate-600 mb-4">
          Jou telling is nou eenvoudig: elke opgeloste Dilemma gee punte volgens hoeveel raaiskote jy gebruik het.
          <strong>Geen</strong> punte vir streaks of win-persentasies – <em>behalwe</em> ’n ligte bonus:
          as jou <strong>huidige</strong> daaglikse wen-lopie <strong>5 of meer</strong> is, kry jy ’n
          <strong>+10%</strong> vermenigvuldiger. Elke Dilemma tel slegs <strong>een keer</strong>, oud of nuut.
        </p>

        <div class="overflow-x-auto rounded-xl border border-slate-200">
          <table class="table text-sm">
            <thead>
              <tr>
                <th>Komponent</th>
                <th class="text-right">Aantal</th>
                <th class="text-right">Reël</th>
                <th class="text-right">Punte</th>
              </tr>
            </thead>
            <tbody id="breakdownBody">
              <!-- rows injected -->
            </tbody>
            <tfoot>
              <tr>
                <td class="font-bold">Subtotaal</td>
                <td></td><td></td>
                <td class="text-right font-extrabold mono" id="subtotalCell">0</td>
              </tr>
              <tr>
                <td class="font-bold">Lopie-bonus (+10% vanaf 5)</td>
                <td></td><td class="text-right" id="lopieMeta">—</td>
                <td class="text-right font-extrabold mono" id="lopieBonusCell">0</td>
              </tr>
              <tr>
                <td class="font-extrabold text-slate-900">Totaal</td>
                <td></td><td></td>
                <td class="text-right font-extrabold mono text-indigo-900" id="totalCell">0</td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>

      <!-- Right: Stats + distribution -->
      <div class="card p-4 md:p-6">
        <h2 class="title text-xl font-extrabold text-slate-900 mb-3">Jou Dilemma-statistiek</h2>

        <div class="gridStat mb-4">
          <div class="statBox">
            <div class="text-xs text-slate-500 mb-1">Dilemmas gespeel</div>
            <div id="playedStat" class="text-3xl font-extrabold mono">0</div>
          </div>
          <div class="statBox">
            <div class="text-xs text-slate-500 mb-1">Sukseskoers</div>
            <div id="winrateStat" class="text-3xl font-extrabold mono">0%</div>
          </div>
          <div class="statBox">
            <div class="text-xs text-slate-500 mb-1">Huidige lopie</div>
            <div id="curStreak" class="text-3xl font-extrabold mono">0</div>
          </div>
          <div class="statBox">
            <div class="text-xs text-slate-500 mb-1">Beste lopie</div>
            <div id="bestStreak" class="text-3xl font-extrabold mono">0</div>
          </div>
        </div>

        <h3 class="text-sm font-bold text-slate-700 mb-2">Suksesverdeling</h3>
        <div id="distWrap" class="space-y-2">
          <!-- bars injected -->
        </div>

        <div class="mt-5 flex items-center gap-2">
          <button id="btnRefresh" class="kbtn">Herlaai uit Firestore</button>
          <span id="hint" class="text-xs text-slate-500">Aanmeld nodig om data te laai.</span>
        </div>
      </div>
    </section>
  </main>

  <!-- Firebase (modular SDK) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signOut } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";
    import { getFirestore, doc, getDoc, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

    // TODO: Paste your real config
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      appId: "YOUR_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ---- UI elements
    const el = (id)=>document.getElementById(id);
    const totalPointsEl = el('totalPoints');
    const subtotalCell = el('subtotalCell');
    const lopieBonusCell = el('lopieBonusCell');
    const totalCell = el('totalCell');
    const breakdownBody = el('breakdownBody');
    const distWrap = el('distWrap');
    const playedStat = el('playedStat');
    const winrateStat = el('winrateStat');
    const curStreakEl = el('curStreak');
    const bestStreakEl = el('bestStreak');
    const streakChip = el('streakChip');
    const multiplierLabel = el('multiplierLabel');
    const calcTime = el('calcTime');
    const lopieMeta = el('lopieMeta');
    const hint = el('hint');

    // Auth buttons
    const btnLogin = el('btnLogin');
    const btnLogout = el('btnLogout');
    const btnRefresh = el('btnRefresh');

    btnLogin.addEventListener('click', async ()=>{
      try{
        await signInWithPopup(auth, new GoogleAuthProvider());
      }catch(e){ console.error(e); }
    });
    btnLogout.addEventListener('click', async ()=>{ await signOut(auth); });
    btnRefresh.addEventListener('click', ()=>{ if(auth.currentUser) loadAll(); });

    onAuthStateChanged(auth, (user)=>{
      btnLogin.classList.toggle('hidden', !!user);
      btnLogout.classList.toggle('hidden', !user);
      hint.textContent = user ? 'Data gelaai vanaf Firestore.' : 'Aanmeld nodig om data te laai.';
      if(user) loadAll(); else resetUI();
    });

    function resetUI(){
      totalPointsEl.textContent = subtotalCell.textContent = lopieBonusCell.textContent = totalCell.textContent = '0';
      playedStat.textContent = '0'; winrateStat.textContent = '0%';
      curStreakEl.textContent = bestStreakEl.textContent = '0';
      breakdownBody.innerHTML = ''; distWrap.innerHTML = '';
      multiplierLabel.textContent = '×1.00'; streakChip.classList.add('hidden'); lopieMeta.textContent='—';
      calcTime.textContent = '—';
    }

    // ---- Scoring constants (simplified)
    const BASE_POINTS = { 1:150, 2:135, 3:120, 4:110, 5:105, 6:100, fail:-50 };
    const STREAK_THRESHOLD = 5;
    const STREAK_MULTIPLIER = 1.10; // +10% once streak >= 5

    function zaDay(ts){
      // Convert ms timestamp to YYYY-MM-DD in Africa/Johannesburg (UTC+2)
      const d = new Date(ts);
      // Use locale to shift; safer approach: compute UTC then add 2 hours (ignoring DST for ZA)
      const u = new Date(d.getTime() + 2*60*60*1000);
      return u.toISOString().slice(0,10);
    }

    async function loadAll(){
      const uid = auth.currentUser.uid;
      // Read all plays for this user
      const playsRef = collection(db, `userGames/${uid}/plays`);
      const snaps = await getDocs(playsRef);

      // Build per-game unique map (only one score per gameId)
      const byGame = new Map();
      snaps.forEach(docSnap=>{
        const x = docSnap.data();
        if(!x || !x.finishedAt) return;
        // treat any gameId that starts with 'Game' as Dilemma (per Kriptiek baseline)
        const gameId = docSnap.id;
        if(!/^Game\d{4}-\d{2}-\d{2}$/.test(gameId)) return; // ignore non-Dilemma entries
        if(!byGame.has(gameId)) byGame.set(gameId, x);
      });

      // Build arrays by date
      const plays = [];
      byGame.forEach((x,gameId)=>{
        const date = zaDay(x.finishedAt);
        const win = x.result === 'win';
        const guesses = x.guesses || 0;
        plays.push({gameId,date,win,guesses});
      });

      // Sort by date ascending
      plays.sort((a,b)=> a.date.localeCompare(b.date));

      // Stats
      const totalPlayed = plays.length;
      const wins = plays.filter(p=>p.win).length;
      const winrate = totalPlayed ? Math.round((wins/totalPlayed)*100) : 0;

      // Distribution 1..6 + fail
      const dist = {1:0,2:0,3:0,4:0,5:0,6:0,fail:0};
      for(const p of plays){
        if(p.win){
          const g = Math.min(Math.max(1,p.guesses||6),6);
          dist[g] += 1;
        }else{
          dist.fail += 1;
        }
      }

      // Current+best daily win-streak (calendar-day continuity)
      let cur = 0, best = 0;
      let prevDate = null;
      const hasMap = new Map(); // date -> win?
      plays.forEach(p=> hasMap.set(p.date, p.win));
      // Walk through sorted unique dates:
      const uniqDates = [...new Set(plays.map(p=>p.date))].sort();
      for(const d of uniqDates){
        const isConsecutive = prevDate && (new Date(d) - new Date(prevDate) === 24*60*60*1000);
        if(!isConsecutive){ cur = 0; }
        if(hasMap.get(d) === true){
          cur += 1; best = Math.max(best, cur);
        }else{ cur = 0; }
        prevDate = d;
      }
      const currentStreak = cur;

      // Scoring
      const subtotal =
        dist[1]*BASE_POINTS[1] +
        dist[2]*BASE_POINTS[2] +
        dist[3]*BASE_POINTS[3] +
        dist[4]*BASE_POINTS[4] +
        dist[5]*BASE_POINTS[5] +
        dist[6]*BASE_POINTS[6] +
        dist.fail*BASE_POINTS.fail;

      const multiplier = currentStreak >= STREAK_THRESHOLD ? STREAK_MULTIPLIER : 1;
      const lopieBonus = Math.round(subtotal * (multiplier - 1));
      const total = subtotal + lopieBonus;

      // Render top numbers
      totalPointsEl.textContent = total.toLocaleString('af-ZA');
      subtotalCell.textContent = subtotal.toLocaleString('af-ZA');
      lopieBonusCell.textContent = lopieBonus.toLocaleString('af-ZA');
      totalCell.textContent = total.toLocaleString('af-ZA');
      multiplierLabel.textContent = `×${multiplier.toFixed(2)}`;
      if(multiplier>1){
        streakChip.classList.remove('hidden');
        lopieMeta.textContent = `${currentStreak} op ’n ry`;
      }else{
        streakChip.classList.add('hidden');
        lopieMeta.textContent = `${currentStreak} (geen bonus)`;
      }
      calcTime.textContent = new Date().toLocaleString('af-ZA');

      // Render stats
      playedStat.textContent = totalPlayed;
      winrateStat.textContent = `${winrate}%`;
      curStreakEl.textContent = currentStreak;
      bestStreakEl.textContent = best;

      // Breakdown rows
      const rows = [
        {label:`Dilemmas in 1 raai opgelos (1 × ${BASE_POINTS[1]})`, qty: dist[1], rule:`1 × ${BASE_POINTS[1]}`, pts: dist[1]*BASE_POINTS[1]},
        {label:`Dilemmas in 2 raaie opgelos (2 × ${BASE_POINTS[2]})`, qty: dist[2], rule:`2 × ${BASE_POINTS[2]}`, pts: dist[2]*BASE_POINTS[2]},
        {label:`Dilemmas in 3 raaie opgelos (3 × ${BASE_POINTS[3]})`, qty: dist[3], rule:`3 × ${BASE_POINTS[3]}`, pts: dist[3]*BASE_POINTS[3]},
        {label:`Dilemmas in 4 raaie opgelos (4 × ${BASE_POINTS[4]})`, qty: dist[4], rule:`4 × ${BASE_POINTS[4]}`, pts: dist[4]*BASE_POINTS[4]},
        {label:`Dilemmas in 5 raaie opgelos (5 × ${BASE_POINTS[5]})`, qty: dist[5], rule:`5 × ${BASE_POINTS[5]}`, pts: dist[5]*BASE_POINTS[5]},
        {label:`Dilemmas in 6 raaie opgelos (6 × ${BASE_POINTS[6]})`, qty: dist[6], rule:`6 × ${BASE_POINTS[6]}`, pts: dist[6]*BASE_POINTS[6]},
        {label:`Dilemmas onopgelos (${BASE_POINTS.fail})`, qty: dist.fail, rule:`${dist.fail} × ${BASE_POINTS.fail}`, pts: dist.fail*BASE_POINTS.fail}
      ];
      breakdownBody.innerHTML = rows.map(r=>`
        <tr>
          <td>${r.label}</td>
          <td class="text-right mono">${r.qty}</td>
          <td class="text-right mono">${r.rule}</td>
          <td class="text-right mono ${r.pts>=0?'good':'bad'}">${r.pts.toLocaleString('af-ZA')}</td>
        </tr>
      `).join('');

      // Distribution bars
      const distPairs = [
        ['1', dist[1]], ['2', dist[2]], ['3', dist[3]],
        ['4', dist[4]], ['5', dist[5]], ['6', dist[6]], ['X', dist.fail]
      ];
      const maxv = Math.max(1, ...distPairs.map(p=>p[1]));
      distWrap.innerHTML = distPairs.map(([label,val])=>{
        const w = Math.max(6, Math.round((val/maxv)*100));
        return `
          <div class="barRow">
            <div class="text-xs font-bold text-slate-500">${label}</div>
            <div class="bar" style="width:${w}%"></div>
            <div class="mono text-sm font-extrabold">${val}</div>
          </div>
        `;
      }).join('');
    }
  </script>
</body>
</html>
