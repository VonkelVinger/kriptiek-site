<!DOCTYPE html>
<html lang="af">
<head>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-S9V4CMP1FP"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-S9V4CMP1FP');
</script>

<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>My Profiel – Kriptiek</title>

<!-- Favicons -->
<link rel="icon" href="/assets/favicon.ico?v=2" type="image/x-icon" />
<link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png?v=3">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png?v=3">
<link rel="apple-touch-icon" href="/assets/apple-touch-icon.png?v=3">
<link rel="manifest" href="/assets/site.webmanifest?v=3">

<!-- Styles -->
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&display=swap" rel="stylesheet" />
<style>
  body { font-family: 'Montserrat', sans-serif; }
  .mono{ font-variant-numeric: tabular-nums; }

  /* --- Header/logo (same as index.html) --- */
  .logo-container {
    position: relative; display: flex; justify-content: center; align-items: center;
    width: fit-content; margin: 1rem auto; padding: 1rem; border-radius: 1rem; background-color: white; overflow: hidden;
    isolation: isolate;
  }
  .logo-container::before{
    content:""; position:absolute; inset:-2px; border-radius:1rem;
    background:conic-gradient(from 180deg at 50% 50%, #1e3a8a, #334155, #1e3a8a);
    animation:spin 14s linear infinite; z-index:0; padding:2px;
    mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
    -webkit-mask-composite: xor; mask-composite: exclude;
  }
  @keyframes spin{ to{ transform:rotate(1turn); } }
  @media (prefers-reduced-motion: reduce){ .logo-container::before{ animation:none; } }

  .crossword-grid { display: grid; grid-template-columns: repeat(8, minmax(40px, 1fr)); gap: 4px; position: relative; z-index: 10; }
  .letter-box {
    width: 50px; height: 50px; display: flex; justify-content: center; align-items: center;
    background-color: #374151; color: white; font-size: 1.8rem; font-weight: bold; border: 2px solid #1f2937; border-radius: 0.375rem;
    text-transform: uppercase; box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.2);
  }
  .flipped-k { transform: scaleX(-1); }

  .background-crossword {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: grid;
    grid-template-columns: repeat(auto-fill, minmax(30px, 1fr)); grid-template-rows: repeat(auto-fill, minmax(30px, 1fr));
    opacity: 0.5; z-index: 1; pointer-events: none; animation: bgFloat 30s linear infinite;
  }
  @keyframes bgFloat{ 0%{ transform:translateY(0); } 50%{ transform:translateY(-12px); } 100%{ transform:translateY(0); } }

  .bg-letter-box { display: flex; justify-content: center; align-items: center; font-size: 1.1rem; font-weight: bold; color: #9ca3af; border: 1px solid #e5e7eb; background-color: transparent; user-select: none; }

  /* Buttons / pills */
  .kbtn{ display:inline-flex; align-items:center; justify-content:center; gap:.5rem; padding:.65rem 1rem; border-radius:.9rem; background:#1d4ed8; color:#fff; font-weight:800; box-shadow:0 10px 24px rgba(29,78,216,.35); }
  .kbtn:hover{ background:#1e40af; }
  .kbtn-red{ background:#dc2626; } .kbtn-red:hover{ background:#b91c1c; }

  .pill { display:inline-flex; align-items:center; gap:.6rem; padding:.6rem 1.1rem; border-radius:999px; font-weight:800; color:#fff; white-space:nowrap; line-height:1.15;
          box-shadow: 0 6px 14px rgba(0,0,0,.18), inset 0 1px 0 rgba(255,255,255,.25); }
  .pill-sm { font-size:.95rem; padding:.55rem 1rem; }
  .pill-lg { font-size:1.15rem; padding:.75rem 1.25rem; }   /* larger, more capsule-like */

  .pill-blue {
    background:linear-gradient(90deg,#1d4ed8,#1e40af);
  }

  /* >>> Updated to match your tiles <<< */
  .pill-orange {
    background: linear-gradient(180deg, #FB7A12 0%, #D65A0A 100%);
  }
  .pill-green {
    background: linear-gradient(180deg, #22C55E 0%, #0EA55B 100%);
  }
  .pill-green-dark {
    background: linear-gradient(180deg, #0F766E 0%, #065F46 100%);
  }

  /* Cards */
  .card{ background:#fff; border-radius:1rem; box-shadow:0 8px 18px rgba(0,0,0,.08); }
  .mini{ background:#f8fafc; border:1px solid #e5e7eb; border-radius:.75rem; padding:12px; text-align:center; }

  /* Table & bars */
  .table{ width:100%; border-collapse:separate; border-spacing:0; }
  .table th,.table td{ padding:.6rem .75rem; border-bottom:1px solid #e5e7eb; }
  .table th{ text-align:left; font-weight:700; color:#334155; background:#f8fafc; position:sticky; top:0; }
  .barRow{ display:grid; grid-template-columns:1.5rem 1fr auto; gap:.5rem; align-items:center; }
  .bar{ height:14px; background:linear-gradient(90deg,#1d4ed8,#1e40af); border-radius:7px; }
  .good{ color:#065f46; } .bad{ color:#991b1b; }

  /* Supporter banner (left card) */
  .supporter-banner{ display:flex; align-items:center; justify-content:center; width:100%;
    background:#16a34a; color:#fff; font-weight:800; padding:.6rem 1rem; border-radius:999px; }

  /* Equal bottoms: give both top cards a shared min height */
  .top-card { min-height: 360px; }
</style>
</head>

<body class="bg-gray-100 min-h-screen flex flex-col">
  <!-- Header -->
  <header class="bg-white shadow p-4">
    <div class="logo-container">
      <div id="backgroundCrossword" class="background-crossword"></div>
      <div class="crossword-grid">
        <div class="letter-box flipped-k">K</div>
        <div class="letter-box flipped-k">R</div>
        <div class="letter-box">I</div>
        <div class="letter-box flipped-k">P</div>
        <div class="letter-box">T</div>
        <div class="letter-box">I</div>
        <div class="letter-box flipped-k">E</div>
        <div class="letter-box">K</div>
      </div>
    </div>
  </header>

  <!-- Auth row: only "Meld aan" -->
  <div class="max-w-6xl mx-auto px-4 pt-3 flex items-center justify-end gap-3">
    <button id="btnLogin" class="kbtn">Meld aan</button>
  </div>

  <!-- Welcome-back line -->
  <div id="welcomeLine" class="max-w-6xl mx-auto px-4 pt-2 text-center text-2xl font-bold text-[#1e3a8a] hidden">
    WELKOM TERUG, <span id="wbName">GEBRUIKER</span>
  </div>

  <main class="flex-grow p-4 pb-16">
    <!-- Profile + overall -->
    <div class="max-w-6xl mx-auto grid md:grid-cols-2 gap-6 items-start">
      <!-- LEFT: Profile -->
      <section class="card p-5 md:p-6 top-card">
        <div class="supporter-banner mb-4">
          <span id="supporterBannerTxt">Nie-betalende ondersteuner</span>
        </div>

        <h2 class="text-lg font-bold mb-2">Profiel</h2>
        <p id="statusBanner" class="hidden text-sm mb-3 px-3 py-2 rounded bg-yellow-50 text-yellow-800">
          Jou rekening is gemerk vir verwydering. Kontak ons as dit ’n fout is.
        </p>

        <form id="profileForm" class="space-y-4">
          <div>
            <label class="block text-sm font-semibold text-gray-700">Naam (kan ’n skuilnaam wees)</label>
            <input id="nameInput" type="text" minlength="2" maxlength="40" required
                   class="mt-1 w-full border border-gray-300 rounded p-2"/>
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700">E-posadres</label>
            <input id="emailInput" type="email" required
                   class="mt-1 w-full border border-gray-300 rounded p-2"/>
            <p class="text-xs text-gray-500 mt-1">
              <strong>Let wel:</strong> Jou e-pos word nie geverifieer nie, maar jy het dit nodig vir wagwoordherstel of navrae oor jou rekening.
            </p>
          </div>

          <!-- Action row -->
          <div class="flex flex-wrap items-center gap-2">
            <button type="submit" class="kbtn">BÊRE</button>
            <button id="resetPwBtn" type="button" class="kbtn bg-slate-800 hover:bg-slate-900">VRA NUWE WAGWOORD</button>
            <button id="deleteBtn" type="button" class="kbtn kbtn-red">VERWYDER MY REKENING</button>
          </div>
          <p id="formMsg" class="text-sm mt-2 hidden"></p>
          <p id="deleteMsg" class="text-sm mt-2 hidden"></p>
        </form>
      </section>

      <!-- RIGHT: Pills + explainer -->
      <section class="card p-5 md:p-6 top-card">
        <div class="mb-4">
          <span id="pillOverall" class="pill pill-lg pill-blue">JOU KRIPTIEK-TELLING: 0</span>
        </div>

        <div class="flex flex-col gap-3 mb-5 items-start">
          <span id="pillDilemmaLive" class="pill pill-lg pill-orange self-start">DILEMMA-TELLING: 0</span>
          <span class="pill pill-lg pill-green self-start">BLITSTIEK-TELLING: BINNEKORT</span>
          <span class="pill pill-lg pill-green-dark self-start">SLIMSTIEK-TELLING: BINNEKORT</span>
        </div>

        <h3 class="text-2xl md:text-[1.7rem] font-extrabold text-slate-900 mb-1">Hoe werk die Kriptiek-telling?</h3>
        <p class="text-sm text-slate-600">
          Jou Kriptiek-telling is op die oomblik nog dieselfde as jou Dilemma-telling, wat elke dag aanpas afhangende van hoe goed jy speel. Later sal ons ook begin met 'n Slimstiek-telling en 'n Blitstiek-telling, wat saam jou Kriptiek-telling sal vorm. Kyk onder hoe jou telling vir Dilemma saamgestel word, en later dieselfde met Slimstiek en Blitstiek.
        </p>
      </section>
    </div>

    <!-- DILEMMA -->
    <div class="max-w-6xl mx-auto grid md:grid-cols-2 gap-6 mt-6">
      <section class="card p-5 md:p-6">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-xl font-extrabold text-slate-900">DILEMMA-telling</h2>
          <span id="streakChip" class="hidden px-2.5 py-1 rounded-full font-bold text-indigo-900" style="background:#e0e7ff">+10% lopie</span>
        </div>

        <div class="bg-indigo-50 border border-indigo-200 rounded-xl p-4 mb-4">
          <div class="text-sm text-indigo-900/80">Laas bereken: <span id="calcTime" class="mono">—</span></div>
          <div class="mt-2 flex items-end gap-4">
            <div>
              <div class="text-4xl md:text-5xl font-extrabold mono text-indigo-900" id="totalPoints">0</div>
              <div class="text-xs uppercase tracking-wide text-indigo-900/70">Totale DILEMMA-telling</div>
            </div>
            <div class="ml-auto text-right">
              <div class="text-xs text-indigo-900/70">Multiplier</div>
              <div class="text-xl font-extrabold mono" id="multiplierLabel">×1.00</div>
            </div>
          </div>
        </div>

        <p class="text-sm leading-6 text-slate-600 mb-4">
          Eenvoudige reël: punte kom slegs van hoeveel raaiskote jy nodig het. <strong>Geen</strong> punte vir
          streaks of wen-% – <em>behalwe</em> ’n ligte bonus: as jou <strong>huidige</strong> daaglikse wen-lopie
          <strong>5 of meer</strong> is, kry jy ’n <strong>+10%</strong> vermenigvuldiger. Elke Dilemma tel net <strong>een keer</strong>.
        </p>

        <div class="overflow-x-auto rounded-xl border border-slate-200">
          <table class="table text-sm">
            <thead>
              <tr>
                <th>Komponent</th>
                <th class="text-right">Aantal</th>
                <th class="text-right">Reël</th>
                <th class="text-right">Punte</th>
              </tr>
            </thead>
            <tbody id="breakdownBody"></tbody>
            <tfoot>
              <tr>
                <td class="font-bold">Subtotaal</td><td></td><td></td>
                <td class="text-right font-extrabold mono" id="subtotalCell">0</td>
              </tr>
              <tr>
                <td class="font-bold">Lopie-bonus (+10% vanaf 5)</td>
                <td></td><td class="text-right" id="lopieMeta">—</td>
                <td class="text-right font-extrabold mono" id="lopieBonusCell">0</td>
              </tr>
              <tr>
                <td class="font-extrabold text-slate-900">Totaal</td><td></td><td></td>
                <td class="text-right font-extrabold mono text-indigo-900" id="totalCell">0</td>
              </tr>
            </tfoot>
          </table>
        </div>
      </section>

      <section class="card p-5 md:p-6">
        <h2 class="text-xl font-extrabold text-slate-900 mb-3">Jou Dilemma-statistiek</h2>
        <div class="grid grid-cols-4 gap-2 mb-4">
          <div class="mini"><div id="playedStat" class="text-3xl font-extrabold mono">0</div><div class="text-xs text-slate-500 mt-1">Dilemmas gespeel</div></div>
          <div class="mini"><div id="winrateStat" class="text-3xl font-extrabold mono">0%</div><div class="text-xs text-slate-500 mt-1">Sukseskoers</div></div>
          <div class="mini"><div id="curStreak" class="text-3xl font-extrabold mono">0</div><div class="text-xs text-slate-500 mt-1">Huidige lopie</div></div>
          <div class="mini"><div id="bestStreak" class="text-3xl font-extrabold mono">0</div><div class="text-xs text-slate-500 mt-1">Beste lopie</div></div>
        </div>

        <h3 class="text-sm font-bold text-slate-700 mb-2">Suksesverdeling</h3>
        <div id="distWrap" class="space-y-2"></div>

        <div class="mt-5 flex items-center gap-2">
          <button id="btnRefresh" class="kbtn">Herlaai uit Firestore</button>
          <span id="hint" class="text-xs text-slate-500">Aanmeld nodig om data te laai.</span>
        </div>
      </section>
    </div>

    <!-- Placeholders for future games -->
    <div class="max-w-6xl mx-auto grid md:grid-cols-2 gap-6 mt-6">
      <section class="card p-5 md:p-6">
        <h2 class="text-lg font-bold text-slate-900">Blitstiek-telling</h2>
        <div class="mt-3 border-2 border-dashed rounded-xl text-slate-400 font-bold flex items-center justify-center h-28">BINNEKORT</div>
      </section>
      <section class="card p-5 md:p-6">
        <h2 class="text-lg font-bold text-slate-900">Slimstiek-telling</h2>
        <div class="mt-3 border-2 border-dashed rounded-xl text-slate-400 font-bold flex items-center justify-center h-28">BINNEKORT</div>
      </section>
    </div>
  </main>

  <!-- Footer -->
  <footer class="bg-white shadow p-4 text-center text-sm text-gray-500">
    &copy; 2025 Kriptiek. Alle regte voorbehou. |
    <a href="/profile.html" class="underline">My profiel</a> |
    <a href="/forum.html" class="underline">Gesels saam</a> |
    <a href="/privacy.html" class="underline">Privaatheidsbeleid</a> |
    <a href="/terms.html" class="underline">Voorwaardes</a> |
    <a href="/faq.html" class="underline">Gereelde vrae</a> |
    <a href="/about.html" class="underline">Oor Kriptiek</a> |
    <a href="/contact.html" class="underline">Kontak ons</a>
  </footer>

  <!-- Header background letter grid -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const backgroundCrossword = document.getElementById('backgroundCrossword');
      const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
      function getRandomLetter() { return letters[Math.floor(Math.random() * letters.length)]; }
      function generateBackgroundGrid() {
        if (!backgroundCrossword) return;
        backgroundCrossword.innerHTML = '';
        const numRows = Math.ceil(backgroundCrossword.offsetHeight / 30);
        const numCols = Math.ceil(backgroundCrossword.offsetWidth / 30);
        const totalCells = (numRows * numCols) || 300;
        for (let i = 0; i < totalCells; i++) {
          const bg = document.createElement('div');
          bg.className = 'bg-letter-box';
          bg.textContent = getRandomLetter();
          backgroundCrossword.appendChild(bg);
        }
      }
      generateBackgroundGrid();
      window.addEventListener('resize', generateBackgroundGrid);
    });
  </script>

  <!-- Firebase + Page Logic (unchanged) -->
  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, updateEmail, sendPasswordResetEmail, signOut } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, serverTimestamp, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDH-nVvGkdaheH7pvRHH0M9TbW2f98lMGQ",
      authDomain: "kriptiek-c9ea2.firebaseapp.com",
      projectId: "kriptiek-c9ea2",
      storageBucket: "kriptiek-c9ea2.appspot.com",
      messagingSenderId: "620450620939",
      appId: "1:620450620939:web:e93a18ac23b53b33db890e"
    };

    const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // UI refs
    const $ = id => document.getElementById(id);
    const btnLogin = $('btnLogin');
    const welcomeLine = $('welcomeLine');
    const wbName = $('wbName');

    const nameInput = $('nameInput'), emailInput = $('emailInput'), resetPwBtn = $('resetPwBtn');
    const formMsg = $('formMsg'), deleteMsg = $('deleteMsg'), statusBanner = $('statusBanner');
    const supporterBannerTxt = $('supporterBannerTxt');

    const pillOverall = $('pillOverall');
    const pillDilemmaLive = $('pillDilemmaLive');

    const totalPointsEl = $('totalPoints'), subtotalCell = $('subtotalCell'), lopieBonusCell = $('lopieBonusCell'), totalCell = $('totalCell');
    const breakdownBody = $('breakdownBody'), distWrap = $('distWrap');
    const playedStat = $('playedStat'), winrateStat = $('winrateStat'), curStreakEl = $('curStreak'), bestStreakEl = $('bestStreak');
    const streakChip = $('streakChip'), multiplierLabel = $('multiplierLabel'), calcTime = $('calcTime'), lopieMeta = $('lopieMeta');
    const hint = $('hint');
    const btnRefresh = $('btnRefresh');

    btnLogin.addEventListener('click', async ()=>{ try{ await signInWithPopup(auth, new GoogleAuthProvider()); }catch(e){} });
    btnRefresh?.addEventListener('click', ()=>{ if(auth.currentUser) loadDilemma(); });

    onAuthStateChanged(auth, async (user)=>{
      btnLogin.classList.toggle('hidden', !!user);

      if (user){
        const storedName = (localStorage.getItem('userName') || '').trim();
        const fallback = (user.email || '').split('@')[0] || 'gebruiker';
        wbName.textContent = (storedName || fallback).toUpperCase();
        welcomeLine.classList.remove('hidden');
      } else {
        welcomeLine.classList.add('hidden');
        return;
      }

      // Ensure doc and prefill
      const userRef = doc(db,'users', user.uid);
      const snap = await getDoc(userRef);
      if (!snap.exists()) {
        await setDoc(userRef, {
          userName: (localStorage.getItem('userName')||'Speler'),
          email: user.email || '',
          gamesPlayed: 0, wins: 0, streak: 0, bestStreak: 0,
          guessDist: { "1":0, "2":0, "3":0, "4":0, "5":0, "6":0 },
          supporterActive: false,
          status: "active",
          createdAt: serverTimestamp(), updatedAt: serverTimestamp()
        }, { merge: true });
      }
      const data = (await getDoc(userRef)).data() || {};

      nameInput.value = data.userName || (localStorage.getItem('userName')||'');
      emailInput.value = data.email || user.email || '';

      if (data.status && data.status !== 'active') {
        statusBanner.classList.remove('hidden');
        nameInput.disabled = true; emailInput.disabled = true; resetPwBtn.disabled = true;
        document.querySelector('#profileForm button[type="submit"]').disabled = true;
      }

      supporterBannerTxt.textContent = isSupporterActive(data) ? 'Betalende ondersteuner' : 'Nie-betalende ondersteuner';

      await loadDilemma();
    });

    function isSupporterActive(u){
      const now = new Date();
      if (typeof u.supporterActive === 'boolean') return u.supporterActive;
      let until = null;
      if (u.supporterUntil?.toDate) until = u.supporterUntil.toDate();
      else if (u.supporterUntil instanceof Date) until = u.supporterUntil;
      if (until && until > now) return true;
      if (typeof u.supporterUsd30d === 'number' && u.supporterUsd30d > 0) return true;
      return false;
    }

    /* ---- Simplified scoring (+10% when streak >= 5) ---- */
    const BASE_POINTS = { 1:150, 2:135, 3:120, 4:110, 5:105, 6:100, fail:-50 };
    const STREAK_THRESHOLD = 5;
    const STREAK_MULTIPLIER = 1.10;

    function zaDay(ts){
      const d = new Date(ts);
      const u = new Date(d.getTime() + 2*60*60*1000); // UTC+2
      return u.toISOString().slice(0,10);
    }

    async function loadDilemma(){
      const uid = (await getAuth().currentUser).uid;
      const playsSnap = await getDocs(collection(db,'userGames',uid,'plays'));

      const map = new Map();
      playsSnap.forEach(docSnap=>{
        const x = docSnap.data();
        if(!x || !x.finishedAt) return;
        const id = docSnap.id;
        if(!/^Game\d{4}-\d{2}-\d{2}$/.test(id)) return;
        if(!map.has(id)) map.set(id,x);
      });

      const plays=[];
      map.forEach((x,id)=>{
        const ms = x.finishedAt?.toMillis ? x.finishedAt.toMillis() : x.finishedAt;
        plays.push({gameId:id, date:zaDay(ms), win:(x.result==='win'), guesses:x.guesses||0});
      });
      plays.sort((a,b)=> a.date.localeCompare(b.date));

      const totalPlayed = plays.length;
      const wins = plays.filter(p=>p.win).length;
      const winrate = totalPlayed ? Math.round((wins/totalPlayed)*100) : 0;

      const dist = {1:0,2:0,3:0,4:0,5:0,6:0,fail:0};
      for(const p of plays){
        if(p.win){
          const g = Math.min(Math.max(1,p.guesses||6),6);
          dist[g] += 1;
        } else {
          dist.fail += 1;
        }
      }

      // Daily streak
      let cur=0,best=0,prev=null;
      const byDate=new Map(); plays.forEach(p=>byDate.set(p.date,p.win));
      const dates=[...new Set(plays.map(p=>p.date))].sort();
      for(const d of dates){
        const consec = prev && (new Date(d) - new Date(prev) === 24*60*60*1000);
        if(!consec) cur=0;
        if(byDate.get(d)===true){ cur++; best=Math.max(best,cur); } else { cur=0; }
        prev=d;
      }

      const subtotal =
        dist[1]*BASE_POINTS[1] + dist[2]*BASE_POINTS[2] + dist[3]*BASE_POINTS[3] +
        dist[4]*BASE_POINTS[4] + dist[5]*BASE_POINTS[5] + dist[6]*BASE_POINTS[6] +
        dist.fail*BASE_POINTS.fail;

      const mult = cur>=STREAK_THRESHOLD ? STREAK_MULTIPLIER : 1;
      const bonus = Math.round(subtotal*(mult-1));
      const total = subtotal + bonus;

      // Stats & breakdown
      document.getElementById('playedStat').textContent = totalPlayed;
      document.getElementById('winrateStat').textContent = `${winrate}%`;
      document.getElementById('curStreak').textContent = cur;
      document.getElementById('bestStreak').textContent = best;

      const rows=[
        {label:`Dilemmas in 1 raai opgelos (1 × ${BASE_POINTS[1]})`, qty:dist[1], rule:`1 × ${BASE_POINTS[1]}`, pts:dist[1]*BASE_POINTS[1]},
        {label:`Dilemmas in 2 raaie opgelos (2 × ${BASE_POINTS[2]})`, qty:dist[2], rule:`2 × ${BASE_POINTS[2]}`, pts:dist[2]*BASE_POINTS[2]},
        {label:`Dilemmas in 3 raaie opgelos (3 × ${BASE_POINTS[3]})`, qty:dist[3], rule:`3 × ${BASE_POINTS[3]}`, pts:dist[3]*BASE_POINTS[3]},
        {label:`Dilemmas in 4 raaie opgelos (4 × ${BASE_POINTS[4]})`, qty:dist[4], rule:`4 × ${BASE_POINTS[4]}`, pts:dist[4]*BASE_POINTS[4]},
        {label:`Dilemmas in 5 raaie opgelos (5 × ${BASE_POINTS[5]})`, qty:dist[5], rule:`5 × ${BASE_POINTS[5]}`, pts:dist[5]*BASE_POINTS[5]},
        {label:`Dilemmas in 6 raaie opgelos (6 × ${BASE_POINTS[6]})`, qty:dist[6], rule:`6 × ${BASE_POINTS[6]}`, pts:dist[6]*BASE_POINTS[6]},
        {label:`Dilemmas onopgelos (${BASE_POINTS.fail})`, qty:dist.fail, rule:`${dist.fail} × ${BASE_POINTS.fail}`, pts:dist.fail*BASE_POINTS.fail}
      ];
      document.getElementById('breakdownBody').innerHTML = rows.map(r=>`
        <tr>
          <td>${r.label}</td>
          <td class="text-right mono">${r.qty}</td>
          <td class="text-right mono">${r.rule}</td>
          <td class="text-right mono ${r.pts>=0?'good':'bad'}">${r.pts.toLocaleString('af-ZA')}</td>
        </tr>
      `).join('');

      // Distribution bars
      const pairs=[['1',dist[1]],['2',dist[2]],['3',dist[3]],['4',dist[4]],['5',dist[5]],['6',dist[6]],['X',dist.fail]];
      const maxv=Math.max(1,...pairs.map(p=>p[1]));
      document.getElementById('distWrap').innerHTML=pairs.map(([lb,val])=>{
        const w=Math.max(6,Math.round((val/maxv)*100));
        return `<div class="barRow"><div class="text-xs font-bold text-slate-500">${lb}</div><div class="bar" style="width:${w}%"></div><div class="mono text-sm font-extrabold">${val}</div></div>`;
      }).join('');

      // Totals + pills + streak UI
      document.getElementById('totalPoints').textContent = total.toLocaleString('af-ZA');
      document.getElementById('subtotalCell').textContent = subtotal.toLocaleString('af-ZA');
      document.getElementById('lopieBonusCell').textContent = bonus.toLocaleString('af-ZA');
      document.getElementById('totalCell').textContent = total.toLocaleString('af-ZA');
      document.getElementById('multiplierLabel').textContent = `×${mult.toFixed(2)}`;
      const chip = document.getElementById('streakChip');
      const meta = document.getElementById('lopieMeta');
      if(mult>1){ chip.classList.remove('hidden'); meta.textContent=`${cur} op ’n ry`; }
      else{ chip.classList.add('hidden'); meta.textContent=`${cur} (geen bonus)`; }
      document.getElementById('calcTime').textContent = new Date().toLocaleString('af-ZA');

      pillOverall.textContent = `JOU KRIPTIEK-TELLING: ${total.toLocaleString('af-ZA')}`;
      pillDilemmaLive.textContent = `DILEMMA-TELLING: ${total.toLocaleString('af-ZA')}`;
    }

    // Save profile
    document.getElementById('profileForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const auth = (await import('https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js')).getAuth();
      const user = auth.currentUser; if (!user) return;

      const name = document.getElementById('nameInput').value.trim();
      const newEmail = document.getElementById('emailInput').value.trim();
      const formMsg = document.getElementById('formMsg');

      if (name.length < 2){
        formMsg.textContent = "Naam te kort.";
        formMsg.className = "text-sm mt-2 text-red-600";
        formMsg.classList.remove('hidden');
        return;
      }

      try{
        const { updateEmail } = await import('https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js');
        if (newEmail && newEmail !== (user.email || '')) await updateEmail(user, newEmail);
        const { setDoc, doc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js');
        await setDoc(doc(db,'users', user.uid), { userName:name, email:newEmail || user.email || '', updatedAt: serverTimestamp() }, { merge:true });
        await setDoc(doc(db,'registrations', user.uid), { userName:name, email:newEmail || user.email || '', userId:user.uid }, { merge:true });
        localStorage.setItem('userName', name);
        formMsg.textContent = "Profiel gestoor.";
        formMsg.className = "text-sm mt-2 text-green-600";
        formMsg.classList.remove('hidden');
      }catch(err){
        formMsg.textContent = "Kon nie stoor nie: " + err.message;
        formMsg.className = "text-sm mt-2 text-red-600";
        formMsg.classList.remove('hidden');
      }
    });

    // Reset password
    document.getElementById('resetPwBtn').addEventListener('click', async ()=>{
      const { getAuth, sendPasswordResetEmail } = await import('https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js');
      const auth = getAuth();
      const user = auth.currentUser;
      const formMsg = document.getElementById('formMsg');
      if (!user || !user.email){
        formMsg.textContent = "Geen e-pos gevind vir jou rekening nie.";
        formMsg.className = "text-sm mt-2 text-red-600";
        formMsg.classList.remove('hidden');
        return;
      }
      try{
        await sendPasswordResetEmail(auth, user.email, { url: 'https://www.kriptiek.com/login.html', handleCodeInApp: false });
        formMsg.textContent = "Wagwoordherstel-e-pos is gestuur (kyk ook jou spam).";
        formMsg.className = "text-sm mt-2 text-green-600";
        formMsg.classList.remove('hidden');
      }catch(err){
        formMsg.textContent = "Kon nie e-pos stuur nie: " + err.message;
        formMsg.className = "text-sm mt-2 text-red-600";
        formMsg.classList.remove('hidden');
      }
    });

    // Soft-delete
    document.getElementById('deleteBtn').addEventListener('click', async ()=>{
      const { getAuth, signOut } = await import('https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js');
      const auth = getAuth(); const user = auth.currentUser; if (!user) return;
      if (!confirm("Is jy seker? Jou rekening word gedeaktiveer en vir verwydering ingedien.")) return;
      try{
        const { setDoc, doc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js');
        await setDoc(doc(db,'users', user.uid), { status:"deletion_requested", updatedAt: serverTimestamp() }, { merge:true });
        await setDoc(doc(db,'deletionRequests', user.uid), { requestedAt: serverTimestamp(), uid:user.uid, email:user.email || null }, { merge:true });
        const msg = document.getElementById('deleteMsg');
        msg.textContent = "Versoek gestuur. Jy sal nou afgemeld word.";
        msg.className = "text-sm mt-2 text-green-600";
        msg.classList.remove('hidden');
        await signOut(auth);
        setTimeout(()=>{ window.location.href = "/index.html"; }, 800);
      }catch(err){
        const msg = document.getElementById('deleteMsg');
        msg.textContent = "Kon nie versoek stuur nie: " + err.message;
        msg.className = "text-sm mt-2 text-red-600";
        msg.classList.remove('hidden');
      }
    });
  </script>
</body>
</html>
