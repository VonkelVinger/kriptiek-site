<!DOCTYPE html>
<html lang="af">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Registreer – Kriptiek</title>

  <!-- Tailwind & Font -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&display=swap" rel="stylesheet" />

  <style>
    :root { --brand:#1e3a8a; }
    body { font-family: 'Montserrat', sans-serif; }
    .logo-grid { display:grid; grid-template-columns: repeat(9, 1fr); gap:4px; }
    .logo-cell {
      width:28px;height:28px;display:flex;align-items:center;justify-content:center;
      background:#0b2459;color:#dbeafe;border-radius:6px;font-weight:700;
      transform: rotateX(0deg); transition: transform .6s;
    }
    .logo-cell.flip { transform: rotateX(180deg); }
    .bg-letters::before{
      content:"";position:fixed;inset:0;pointer-events:none;opacity:.05;background:
      radial-gradient(circle at 20% 30%, #1e3a8a 0 1px, transparent 2px) 0 0/40px 40px,
      radial-gradient(circle at 80% 70%, #1e3a8a 0 1px, transparent 2px) 20px 20px/40px 40px;
      z-index:0;
    }
  </style>
</head>

<body class="min-h-screen flex flex-col bg-gray-50 bg-letters">

  <!-- Header -->
  <header class="sticky top-0 z-10 bg-white/90 backdrop-blur border-b border-gray-100">
    <div class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between">
      <a href="/index.html" class="flex items-center space-x-3 group">
        <div class="logo-grid">
          <div class="logo-cell">K</div><div class="logo-cell">R</div><div class="logo-cell">I</div>
          <div class="logo-cell">P</div><div class="logo-cell">T</div><div class="logo-cell">I</div>
          <div class="logo-cell">E</div><div class="logo-cell">K</div><div class="logo-cell flip">•</div>
        </div>
        <span class="text-xl font-extrabold tracking-wide text-[color:var(--brand)]">KRIPTIEK</span>
      </a>
      <nav class="hidden sm:flex items-center gap-4 text-sm">
        <a href="/index.html" class="text-gray-700 hover:text-[color:var(--brand)]">Tuis</a>
        <a href="/dilemmagame.html" class="text-gray-700 hover:text-[color:var(--brand)]">DILEMMA</a>
        <a href="/dilemma-argief.html" class="text-gray-700 hover:text-[color:var(--brand)]">Argief</a>
        <a href="/forum.html" class="text-gray-700 hover:text-[color:var(--brand)]">Gesels saam</a>
        <a id="nav-register" href="/register.html?new=1" class="text-gray-700 hover:text-[color:var(--brand)]">Registreer</a>
        <a id="nav-login" href="/login.html" class="text-gray-700 hover:text-[color:var(--brand)]">Meld aan</a>
        <button id="nav-logout" class="hidden text-gray-700 hover:text-red-700">Meld af</button>
      </nav>
    </div>
  </header>

  <!-- Main -->
  <main class="flex-1">
    <div class="max-w-md mx-auto px-4 py-10 relative z-10">
      <div class="bg-white shadow-xl rounded-2xl p-6 border border-gray-100">
        <h1 class="text-2xl font-bold text-center text-[color:var(--brand)] mb-2">Registreer</h1>
        <p class="text-center text-gray-600 mb-6">Skep ’n rekening om te speel en jou vordering te bewaar.</p>

        <div id="alertBox" class="hidden mb-4 rounded-lg border px-3 py-2 text-sm"></div>

        <form id="registerForm" class="space-y-4">
          <label class="block">
            <span class="text-gray-700 font-semibold">Naam (kan ’n skuilnaam wees)</span>
            <input type="text" id="userName" required maxlength="40" minlength="2"
                   class="mt-1 block w-full border border-gray-300 rounded-lg p-2.5 focus:outline-none focus:ring-2 focus:ring-[color:var(--brand)]" />
          </label>
          <label class="block">
            <span class="text-gray-700 font-semibold">E-posadres</span>
            <input type="email" id="email" required
                   class="mt-1 block w-full border border-gray-300 rounded-lg p-2.5 focus:outline-none focus:ring-2 focus:ring-[color:var(--brand)]" />
          </label>
          <label class="block">
            <span class="text-gray-700 font-semibold">Wagwoord</span>
            <input type="password" id="password" required
                   class="mt-1 block w-full border border-gray-300 rounded-lg p-2.5 focus:outline-none focus:ring-2 focus:ring-[color:var(--brand)]" />
          </label>

          <button id="registerBtn" type="submit"
                  class="w-full bg-gray-900 hover:bg-black text-white py-2.5 rounded-lg transition disabled:opacity-60 disabled:cursor-not-allowed">
            REGISTREER
          </button>

          <p class="text-sm text-center mt-2">
            Reeds ’n rekening?
            <a href="/login.html" class="text-[color:var(--brand)] underline">Meld aan</a>
          </p>
        </form>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="mt-auto bg-white border-t border-gray-100">
    <div class="max-w-5xl mx-auto px-4 py-6 text-sm text-gray-600 flex flex-col sm:flex-row items-center justify-between gap-3">
      <p>&copy; <span id="year"></span> Kriptiek. Alle regte voorbehou.</p>
      <div class="flex items-center gap-4">
        <a href="/index.html#speletjies" class="hover:text-[color:var(--brand)]">Speletjies</a>
        <a href="/privacy.html" class="hover:text-[color:var(--brand)]">Privaatheid</a>
        <a href="/terms.html" class="hover:text-[color:var(--brand)]">Bepalings</a>
      </div>
    </div>
  </footer>

  <!-- Firebase + Register Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import {
      getAuth,
      createUserWithEmailAndPassword,
      updateProfile,
      setPersistence,
      browserLocalPersistence,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
    import {
      getFirestore,
      doc,
      setDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDH-nVvGkdaheH7pvRHH0M9TbW2f98lMGQ",
      authDomain: "kriptiek-c9ea2.firebaseapp.com",
      projectId: "kriptiek-c9ea2",
      storageBucket: "kriptiek-c9ea2.appspot.com",
      messagingSenderId: "620450620939",
      appId: "1:620450620939:web:e93a18ac23b53b33db890e"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // "force new" mode
    const forceNew = new URL(location.href).searchParams.get("new") === "1";
    if (forceNew) {
      try { await signOut(auth); } catch {}
      try { localStorage.clear(); sessionStorage.clear(); } catch {}
      await new Promise(r => setTimeout(r, 150));
    }

    const el = (id) => document.getElementById(id);
    const showAlert = (msg, kind = "error") => {
      const box = el("alertBox");
      box.classList.remove("hidden");
      box.textContent = msg;
      box.className = "mb-4 rounded-lg border px-3 py-2 text-sm " +
        (kind === "ok" ? "border-green-300 bg-green-50 text-green-800" : "border-red-300 bg-red-50 text-red-800");
    };

    try { await setPersistence(auth, browserLocalPersistence); } catch {}

    // Header toggle only (no auto-redirect)
    const updateHeader = (user) => {
      const reg = document.getElementById("nav-register");
      const log = document.getElementById("nav-login");
      const out = document.getElementById("nav-logout");
      if (user) { reg?.classList.add("hidden"); log?.classList.add("hidden"); out?.classList.remove("hidden"); }
      else { reg?.classList.remove("hidden"); log?.classList.remove("hidden"); out?.classList.add("hidden"); }
    };
    onAuthStateChanged(auth, updateHeader);

    // Register flow
    el("registerForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      el("alertBox").classList.add("hidden");
      el("registerBtn").disabled = true;

      const userName = el("userName").value.trim();
      const email = el("email").value.trim();
      const password = el("password").value;

      if (userName.length < 2) { showAlert("Jou naam moet minstens 2 karakters wees."); el("registerBtn").disabled = false; return; }

      try {
        const cred = await createUserWithEmailAndPassword(auth, email, password);
        const user = cred.user;

        try { await updateProfile(user, { displayName: userName }); } catch {}

        await setDoc(doc(db, "users", user.uid), {
          userName,
          email,
          status: "active",
          gamesPlayed: 0,
          wins: 0,
          streak: 0,
          bestStreak: 0,
          guessDist: [0,0,0,0,0,0],
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        }, { merge: true });

        await setDoc(doc(db, "registrations", user.uid), {
          userName, email, userId: user.uid, timestamp: serverTimestamp()
        }, { merge: true });

        localStorage.setItem("userName", userName);
        localStorage.setItem("userId", user.uid);
        localStorage.setItem("userEmail", email);

        showAlert("Welkom by Kriptiek!", "ok");
        window.location.href = "/index.html";
      } catch (err) {
        console.error("Registration error:", err);
        showAlert("Kon nie registreer nie: " + (err?.message || err));
      } finally {
        el("registerBtn").disabled = false;
      }
    });

    // Header "Meld af"
    el("nav-logout")?.addEventListener("click", async () => {
      try { await signOut(auth); } finally {
        localStorage.clear(); sessionStorage.clear();
        setTimeout(() => { window.location.href = "/index.html"; }, 120);
      }
    });

    // Footer year
    document.getElementById("year").textContent = new Date().getFullYear();

    // Simple logo animation
    setInterval(() => {
      document.querySelectorAll(".logo-cell").forEach((c, i) => {
        setTimeout(() => c.classList.toggle("flip"), i * 30);
      });
    }, 4000);
  </script>
</body>
</html>
