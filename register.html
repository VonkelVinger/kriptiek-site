<!DOCTYPE html>
<html lang="af">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>REGISTREER – Kriptiek</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&display=swap" rel="stylesheet">
  <style> body { font-family: 'Montserrat', sans-serif; } </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
  <div class="bg-white shadow-lg rounded-xl p-6 w-full max-w-md">
    <h2 class="text-xl font-bold text-center mb-6 text-[#1e3a8a]">Registreer</h2>

    <form id="registerForm" class="space-y-4">
      <label class="block">
        <span class="text-gray-700 font-semibold">Naam (kan 'n skuilnaam wees)</span>
        <input type="text" id="userName" required maxlength="40"
               class="mt-1 block w-full border border-gray-300 rounded p-2" />
      </label>
      <label class="block">
        <span class="text-gray-700 font-semibold">E-posadres</span>
        <input type="email" id="email" required class="mt-1 block w-full border border-gray-300 rounded p-2" />
      </label>
      <label class="block">
        <span class="text-gray-700 font-semibold">Wagwoord</span>
        <input type="password" id="password" required class="mt-1 block w-full border border-gray-300 rounded p-2" />
      </label>
      <button type="submit" class="w-full bg-gray-800 hover:bg-gray-900 text-white py-2 px-4 rounded transition">REGISTREER</button>
    </form>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDH-nVvGkdaheH7pvRHH0M9TbW2f98lMGQ",
      authDomain: "kriptiek-c9ea2.firebaseapp.com",
      projectId: "kriptiek-c9ea2",
      storageBucket: "kriptiek-c9ea2.appspot.com",
      messagingSenderId: "620450620939",
      appId: "1:620450620939:web:e93a18ac23b53b33db890e"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const form = document.getElementById('registerForm');
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const userName = document.getElementById('userName').value.trim();
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;

      // ✅ Simple name rule
      if (userName.length < 2) { alert("Jou naam moet minstens 2 karakters wees."); return; }
      if (!email || !password) { alert("Vul asseblief al die velde in."); return; }

      try {
        const cred = await createUserWithEmailAndPassword(auth, email, password);
        const user = cred.user;

        try {
          // Keep existing collection + fields
          await setDoc(doc(db, "registrations", user.uid), {
            userName, email, userId: user.uid, timestamp: serverTimestamp()
          });

          // Cache for gameplay
          localStorage.setItem("userName", userName);
          localStorage.setItem("userId", user.uid);
          localStorage.setItem("userEmail", email);

          alert("Welkom by Kriptiek!");
          window.location.href = "/index.html";
        } catch (firestoreError) {
          console.error("Firestore write failed:", firestoreError);
          await user.delete(); // Roll back the user creation
          alert("Registrasie het misluk: " + firestoreError.message);
        }
      } catch (authError) {
        console.error("Auth error:", authError);
        alert("Kon nie registreer nie: " + authError.message);
      }
    });
  </script>
</body>
</html>
