<!DOCTYPE html>
<html lang="af">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin – Ondersteuners</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&display=swap" rel="stylesheet"/>
  <style>body{font-family:'Montserrat',sans-serif;background:#f8fafc}</style>
</head>
<body class="min-h-screen p-4">
  <main class="max-w-xl mx-auto bg-white rounded-xl shadow p-4">
    <h1 class="text-xl font-bold mb-2 text-[#1e3a8a]">Admin: Betalende ondersteuners</h1>
    <p id="gate" class="text-sm text-red-700 bg-red-50 rounded p-2 mb-4 hidden">Toegang geweier.</p>

    <div id="panel" class="space-y-4 hidden">
      <div class="flex items-center gap-2">
        <a href="/profiletest.html" class="text-blue-700 underline text-sm">Gaan na profiletest.html</a>
      </div>

      <div class="bg-gray-50 rounded p-3">
        <h2 class="font-semibold mb-2">Handmatig stel</h2>
        <label class="text-sm block">Gebruiker se UID</label>
        <input id="uidInput" class="w-full border rounded p-2 mb-2" placeholder="Plak UID hier"/>
        <div class="flex flex-wrap items-center gap-2">
          <label class="text-sm flex items-center gap-2">
            <input id="isPaid" type="checkbox" class="h-4 w-4"> Is betaalde ondersteuner
          </label>
          <label class="text-sm">Betaal geldig tot:
            <input id="paidUntil" type="date" class="border rounded p-1 ml-1">
          </label>
        </div>
        <div class="flex flex-wrap gap-2 mt-3">
          <button id="loadBtn" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded">LAI</button>
          <button id="saveBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded">STOOR</button>
          <button id="clearBtn" class="bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-1 rounded">Maak onbetaald</button>
        </div>
        <p id="msg" class="text-sm mt-2"></p>
      </div>

      <div class="bg-gray-50 rounded p-3">
        <h2 class="font-semibold mb-2">Vinnig: Maak MÝ ’n ondersteuner (30 dae)</h2>
        <button id="makeMeBtn" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded">MERK MY AS BETAAL vir 30 dae</button>
        <p class="text-xs text-gray-600 mt-1">Gebruik dit om gou te toets op <code>profiletest.html</code>.</p>
      </div>
    </div>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, serverTimestamp, Timestamp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

    // CONFIG
    const ADMIN_UID = "jI7f0Wk4MqfPq7p69vjl8OlJUvS2";

    const firebaseConfig = {
      apiKey: "AIzaSyDH-nVvGkdaheH7pvRHH0M9TbW2f98lMGQ",
      authDomain: "kriptiek-c9ea2.firebaseapp.com",
      projectId: "kriptiek-c9ea2",
      storageBucket: "kriptiek-c9ea2.appspot.com",
      messagingSenderId: "620450620939",
      appId: "1:620450620939:web:e93a18ac23b53b33db890e"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const gate = document.getElementById('gate');
    const panel = document.getElementById('panel');
    const uidInput = document.getElementById('uidInput');
    const isPaid = document.getElementById('isPaid');
    const paidUntil = document.getElementById('paidUntil');
    const msg = document.getElementById('msg');

    const loadBtn = document.getElementById('loadBtn');
    const saveBtn = document.getElementById('saveBtn');
    const clearBtn = document.getElementById('clearBtn');
    const makeMeBtn = document.getElementById('makeMeBtn');

    onAuthStateChanged(auth, async (user)=>{
      if (!user) {
        window.location.href = "/login.html?return=/admin-supporters.html";
        return;
      }
      if (user.uid !== ADMIN_UID) {
        gate.classList.remove('hidden');
        return;
      }
      panel.classList.remove('hidden');
      uidInput.value = user.uid; // prefill for convenience

      loadBtn.onclick = async ()=>{
        msg.textContent = "";
        const uid = uidInput.value.trim();
        if (!uid) { msg.textContent = "Geen UID."; msg.className="text-red-600"; return; }
        const snap = await getDoc(doc(db,'users', uid));
        if (!snap.exists()){ msg.textContent="Geen userdoc."; msg.className="text-red-600"; return; }
        const data = snap.data()||{};
        const s = data.support||{};
        isPaid.checked = !!s.isPaid;
        if (s.paidUntil?.toDate){
          const dt = s.paidUntil.toDate();
          paidUntil.value = dt.toISOString().slice(0,10);
        } else {
          paidUntil.value = "";
        }
        msg.textContent = "Gelaai.";
        msg.className="text-green-600";
      };

      saveBtn.onclick = async ()=>{
        msg.textContent = "";
        const uid = uidInput.value.trim();
        if (!uid) { msg.textContent = "Geen UID."; msg.className="text-red-600"; return; }
        let untilVal = paidUntil.value ? Timestamp.fromDate(new Date(paidUntil.value+"T23:59:59")) : null;
        await setDoc(doc(db,'users', uid), {
          support: {
            isPaid: !!isPaid.checked,
            paidUntil: untilVal
          },
          updatedAt: serverTimestamp()
        }, { merge: true });
        msg.textContent = "Gestoor.";
        msg.className="text-green-600";
      };

      clearBtn.onclick = async ()=>{
        const uid = uidInput.value.trim();
        if (!uid) { msg.textContent = "Geen UID."; msg.className="text-red-600"; return; }
        await setDoc(doc(db,'users', uid), {
          support: { isPaid: false, paidUntil: null },
          updatedAt: serverTimestamp()
        }, { merge: true });
        isPaid.checked = false; paidUntil.value="";
        msg.textContent = "Merk as onbetaald voltooi.";
        msg.className="text-green-600";
      };

      makeMeBtn.onclick = async ()=>{
        const uid = user.uid;
        uidInput.value = uid;
        const until = new Date();
        until.setDate(until.getDate()+30);
        await setDoc(doc(db,'users', uid), {
          support: { isPaid: true, paidUntil: Timestamp.fromDate(until) },
          updatedAt: serverTimestamp()
        }, { merge: true });
        msg.textContent = "Jy is vir 30 dae as ondersteuner gemerk.";
        msg.className="text-green-600";
      };
    });
  </script>
</body>
</html>
