<!DOCTYPE html>
<html lang="af">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin – Ondersteuners</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&display=swap" rel="stylesheet"/>
  <style>
    body{font-family:'Montserrat',sans-serif;background:#f8fafc}
    .mono{font-variant-numeric:tabular-nums}
    .btn{padding:.5rem .75rem;border-radius:.5rem;color:#fff}
  </style>
</head>
<body class="min-h-screen p-4">
  <main class="max-w-xl mx-auto bg-white rounded-xl shadow p-4">
    <h1 class="text-xl font-bold mb-2 text-[#1e3a8a]">Admin: Betalende ondersteuners</h1>
    <p id="gate" class="text-sm text-red-700 bg-red-50 rounded p-2 mb-4 hidden">Toegang geweier.</p>

    <div id="panel" class="space-y-5 hidden">
      <div class="flex items-center gap-3 text-sm">
        <a href="/profile.html" class="text-blue-700 underline">Gaan na profile.html</a>
      </div>

      <!-- Lookup -->
      <section class="bg-gray-50 rounded p-3">
        <h2 class="font-semibold mb-2">Soek gebruiker</h2>
        <div class="grid grid-cols-1 gap-2">
          <label class="text-sm">Soek per e-pos (presiese pas):</label>
          <div class="flex gap-2">
            <input id="emailInput" type="email" placeholder="naam@domein.com" class="flex-1 border rounded p-2"/>
            <button id="searchEmailBtn" class="btn bg-blue-600 hover:bg-blue-700">SOEK OP E-POS</button>
          </div>

          <div class="text-xs text-gray-600">Of laai per UID:</div>
          <div class="flex gap-2">
            <input id="uidInput" placeholder="Plak UID" class="flex-1 border rounded p-2"/>
            <button id="loadUidBtn" class="btn bg-gray-600 hover:bg-gray-700">LAAI PER UID</button>
          </div>
        </div>

        <div id="resultsWrap" class="mt-3 hidden">
          <div class="text-sm font-semibold mb-1">Meer as een resultaat — kies een:</div>
          <ul id="resultsList" class="text-sm space-y-1"></ul>
        </div>

        <p id="lookupMsg" class="text-sm mt-2"></p>
      </section>

      <!-- Edit -->
      <section class="bg-gray-50 rounded p-3">
        <h2 class="font-semibold mb-2">Merk as ondersteuner</h2>
        <div class="text-sm mb-2">
          <div>Gekose UID: <span id="currentUid" class="mono">—</span></div>
          <div>Naam: <span id="currentName">—</span></div>
          <div>E-pos: <span id="currentEmail">—</span></div>
        </div>

        <div class="flex flex-wrap items-center gap-3">
          <label class="text-sm flex items-center gap-2">
            <input id="isPaid" type="checkbox" class="h-4 w-4"> Is betaalde ondersteuner
          </label>
          <label class="text-sm">Geldig tot:
            <input id="paidUntil" type="date" class="border rounded p-1 ml-1">
          </label>
        </div>

        <div class="flex flex-wrap gap-2 mt-3">
          <button id="saveBtn" class="btn bg-green-600 hover:bg-green-700">STOOR</button>
          <button id="clearBtn" class="btn bg-yellow-600 hover:bg-yellow-700">MAAK ONBETAALD</button>
        </div>
        <p id="msg" class="text-sm mt-2"></p>
      </section>

      <!-- Quick self-mark for testing -->
      <section class="bg-gray-50 rounded p-3">
        <h2 class="font-semibold mb-2">Vinnig: Maak MÝ ’n ondersteuner (30 dae)</h2>
        <button id="makeMeBtn" class="btn bg-purple-600 hover:bg-purple-700">MERK MY AS BETAAL</button>
        <p class="text-xs text-gray-600 mt-1">Gebruik dit om gou te toets op <code>profile.html</code>.</p>
      </section>
    </div>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, serverTimestamp, Timestamp,
      collection, query, where, getDocs
    } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

    // =========================
    // CONFIG
    // =========================
    const ADMIN_UID = "jI7f0Wk4MqfPq7p69vjl8OlJUvS2";
    // If you keep a public mirror of users, set its collection name here.
    // Set to null/"" to disable that fallback.
    const PUBLIC_MIRROR_COLLECTION = "publicUsers";

    const firebaseConfig = {
      apiKey: "AIzaSyDH-nVvGkdaheH7pvRHH0M9TbW2f98lMGQ",
      authDomain: "kriptiek-c9ea2.firebaseapp.com",
      projectId: "kriptiek-c9ea2",
      storageBucket: "kriptiek-c9ea2.appspot.com",
      messagingSenderId: "620450620939",
      appId: "1:620450620939:web:e93a18ac23b53b33db890e"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // =========================
    // UI refs
    // =========================
    const gate = document.getElementById('gate');
    const panel = document.getElementById('panel');
    const emailInput = document.getElementById('emailInput');
    const searchEmailBtn = document.getElementById('searchEmailBtn');
    const uidInput = document.getElementById('uidInput');
    const loadUidBtn = document.getElementById('loadUidBtn');
    const resultsWrap = document.getElementById('resultsWrap');
    const resultsList = document.getElementById('resultsList');
    const lookupMsg = document.getElementById('lookupMsg');

    const currentUid = document.getElementById('currentUid');
    const currentName = document.getElementById('currentName');
    const currentEmail = document.getElementById('currentEmail');
    const isPaid = document.getElementById('isPaid');
    const paidUntil = document.getElementById('paidUntil');
    const saveBtn = document.getElementById('saveBtn');
    const clearBtn = document.getElementById('clearBtn');
    const msg = document.getElementById('msg');
    const makeMeBtn = document.getElementById('makeMeBtn');

    let selectedUid = null;

    // =========================
    // Auth gate
    // =========================
    onAuthStateChanged(auth, async (user)=>{
      if (!user) {
        // NOTE: Return URL now correctly points back to THIS file name.
        window.location.href = "/login.html?return=/admin.supporters.html";
        return;
      }
      if (user.uid !== ADMIN_UID) {
        gate.classList.remove('hidden');
        return;
      }
      panel.classList.remove('hidden');
    });

    // =========================
    // Helpers
    // =========================
    function showLookup(text, cls="text-gray-700") {
      lookupMsg.textContent = text;
      lookupMsg.className = `text-sm mt-2 ${cls}`;
    }
    function showMsg(text, cls="text-gray-700") {
      msg.textContent = text;
      msg.className = `text-sm mt-2 ${cls}`;
    }
    function clearSelectionUI() {
      selectedUid = null;
      currentUid.textContent = "—";
      currentName.textContent = "—";
      currentEmail.textContent = "—";
      isPaid.checked = false;
      paidUntil.value = "";
    }

    // =========================
    // Load by UID (robust)
    // =========================
    async function loadUser(uid){
      showLookup("");
      resultsWrap.classList.add('hidden');
      clearSelectionUI();

      if (!uid) return;

      try {
        const snap = await getDoc(doc(db,'users', uid));
        if (!snap.exists()){
          showLookup("Geen userdoc vir dié UID nie.", "text-red-600");
          return;
        }
        selectedUid = uid;
        currentUid.textContent = uid;
        const data = snap.data()||{};
        currentName.textContent = data.userName || "—";
        currentEmail.textContent = data.email || "—";

        const s = data.support || {};
        isPaid.checked = !!s.isPaid;
        if (s.paidUntil?.toDate){
          const dt = s.paidUntil.toDate();
          paidUntil.value = dt.toISOString().slice(0,10);
        }
        showLookup("Gelaai.", "text-green-600");
      } catch (err) {
        console.error(err);
        if (err?.code === "permission-denied") {
          showLookup("Geen toestemming om die gebruiker te lees nie (permission-denied).", "text-red-600");
        } else {
          showLookup("Kon nie gebruiker laai nie: " + (err.message || err), "text-red-600");
        }
      }
    }

    // =========================
    // Search by email (emailLower first, fallback to email & public mirror)
    // =========================
    async function searchByEmail(email){
      showLookup("");
      resultsList.innerHTML = "";
      resultsWrap.classList.add('hidden');

      const raw = (email||"").trim();
      if (!raw){
        showLookup("Tik ’n e-posadres.", "text-red-600"); return;
      }

      const needle = raw.toLowerCase();
      let hits = [];

      try {
        // Preferred: users.emailLower
        const q1 = query(collection(db,'users'), where('emailLower','==', needle));
        let snap = await getDocs(q1);
        snap.forEach(d => hits.push({ uid: d.id, ...d.data() }));

        // Fallback: users.email (legacy)
        if (hits.length === 0) {
          const q2 = query(collection(db,'users'), where('email','==', raw));
          snap = await getDocs(q2);
          snap.forEach(d => hits.push({ uid: d.id, ...d.data() }));
        }

        // Optional fallback: public mirror collection (resolve UID)
        if (hits.length === 0 && PUBLIC_MIRROR_COLLECTION) {
          try {
            const q3 = query(collection(db, PUBLIC_MIRROR_COLLECTION), where('emailLower','==', needle));
            const snap2 = await getDocs(q3);
            snap2.forEach(d => hits.push({ uid: d.id, ...d.data() }));
          } catch (mirrorErr) {
            console.warn("Mirror lookup failed:", mirrorErr);
          }
        }

        if (hits.length === 0){
          showLookup("Geen gebruiker met daardie e-pos gevind nie.", "text-red-600");
          return;
        }

        if (hits.length === 1){
          uidInput.value = hits[0].uid;
          await loadUser(hits[0].uid);
          return;
        }

        // Multiple: chooser
        resultsWrap.classList.remove('hidden');
        resultsList.innerHTML = hits.map(h => `
          <li class="flex items-center justify-between bg-white border rounded p-2">
            <div class="text-sm">
              <div><span class="font-semibold">${h.userName || "—"}</span> · <span class="mono">${h.uid}</span></div>
              <div class="text-xs text-gray-600">${h.email || ""}</div>
            </div>
            <button data-uid="${h.uid}" class="px-2 py-1 rounded bg-blue-600 text-white text-xs">KIES</button>
          </li>
        `).join('');
        resultsList.querySelectorAll('button[data-uid]').forEach(btn => {
          btn.addEventListener('click', async () => {
            const uid = btn.getAttribute('data-uid');
            uidInput.value = uid;
            await loadUser(uid);
            resultsWrap.classList.add('hidden');
          });
        });
        showLookup(`${hits.length} resultate — kies een.`, "text-yellow-700");

      } catch (err) {
        console.error(err);
        if (err?.code === 'permission-denied') {
          showLookup("Geen toestemming om die gebruikerslys te lees nie (permission-denied).", "text-red-600");
        } else {
          showLookup("Kon nie soek nie: " + (err.message || err), "text-red-600");
        }
      }
    }

    // =========================
    // Events
    // =========================
    searchEmailBtn.addEventListener('click', async ()=> {
      await searchByEmail(emailInput.value);
    });
    emailInput.addEventListener('keydown', async (e)=>{
      if (e.key === 'Enter') {
        e.preventDefault();
        await searchByEmail(emailInput.value);
      }
    });

    loadUidBtn.addEventListener('click', async ()=> {
      await loadUser(uidInput.value.trim());
    });
    uidInput.addEventListener('keydown', async (e)=>{
      if (e.key === 'Enter') {
        e.preventDefault();
        await loadUser(uidInput.value.trim());
      }
    });

    saveBtn.addEventListener('click', async ()=> {
      if (!selectedUid){
        showMsg("Geen gebruiker gelaai nie.", "text-red-600"); return;
      }
      try {
        let untilVal = paidUntil.value ? Timestamp.fromDate(new Date(paidUntil.value+"T23:59:59")) : null;
        await setDoc(doc(db,'users', selectedUid), {
          support: { isPaid: !!isPaid.checked, paidUntil: untilVal },
          updatedAt: serverTimestamp()
        }, { merge: true });
        showMsg("Gestoor.", "text-green-600");
      } catch (err) {
        console.error(err);
        showMsg("Kon nie stoor nie: " + (err.message || err), "text-red-600");
      }
    });

    clearBtn.addEventListener('click', async ()=> {
      if (!selectedUid){
        showMsg("Geen gebruiker gelaai nie.", "text-red-600"); return;
      }
      try {
        await setDoc(doc(db,'users', selectedUid), {
          support: { isPaid: false, paidUntil: null },
          updatedAt: serverTimestamp()
        }, { merge: true });
        isPaid.checked = false; paidUntil.value = "";
        showMsg("Merk as onbetaald voltooi.", "text-green-600");
      } catch (err) {
        console.error(err);
        showMsg("Kon nie opdateer nie: " + (err.message || err), "text-red-600");
      }
    });

    makeMeBtn.addEventListener('click', async ()=> {
      const user = auth.currentUser;
      if (!user) return;
      try {
        const until = new Date();
        until.setDate(until.getDate()+30);
        // Also ensure email/emailLower exist on your user doc for future searches:
        const payload = {
          support: { isPaid: true, paidUntil: Timestamp.fromDate(until) },
          updatedAt: serverTimestamp()
        };
        if (user.email) {
          payload.email = user.email;
          payload.emailLower = user.email.toLowerCase();
        }
        await setDoc(doc(db,'users', user.uid), payload, { merge: true });
        uidInput.value = user.uid;
        await loadUser(user.uid);
        showMsg("Jy is vir 30 dae as ondersteuner gemerk.", "text-green-600");
      } catch (err) {
        console.error(err);
        showMsg("Kon nie jou status opdateer nie: " + (err.message || err), "text-red-600");
      }
    });
  </script>
</body>
</html>
