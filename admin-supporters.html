<!DOCTYPE html>
<html lang="af">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin – Ondersteuners</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&display=swap" rel="stylesheet"/>
  <style>
    body{font-family:'Montserrat',sans-serif;background:#f8fafc}
    .mono{font-variant-numeric:tabular-nums}
    .btn{padding:.5rem .75rem;border-radius:.5rem;color:#fff}
  </style>
</head>
<body class="min-h-screen p-4">
  <main class="max-w-xl mx-auto bg-white rounded-xl shadow p-4">
    <h1 class="text-xl font-bold mb-2 text-[#1e3a8a]">Admin: Betalende ondersteuners</h1>
    <p id="gate" class="text-sm text-red-700 bg-red-50 rounded p-2 mb-4 hidden">Toegang geweier.</p>

    <div id="panel" class="space-y-5 hidden">
      <div class="flex items-center gap-3 text-sm">
        <a href="/profile.html" class="text-blue-700 underline">Gaan na My Profiel</a>
      </div>

      <!-- Lookup -->
      <section class="bg-gray-50 rounded p-3">
        <h2 class="font-semibold mb-2">Soek gebruiker</h2>

        <div class="grid grid-cols-1 gap-2">
          <label class="text-sm">Soek per e-pos (presiese pas):</label>
          <div class="flex gap-2">
            <input id="emailInput" type="email" placeholder="naam@domein.com" class="flex-1 border rounded p-2"/>
            <button id="searchEmailBtn" class="btn bg-blue-600 hover:bg-blue-700">SOEK OP E-POS</button>
          </div>

          <div class="text-xs text-gray-600">Of werk direk met UID:</div>
          <div class="flex gap-2">
            <input id="uidInput" placeholder="Plak UID" class="flex-1 border rounded p-2"/>
            <button id="loadUidBtn" class="btn bg-gray-600 hover:bg-gray-700">LAAI PER UID</button>
          </div>
          <details class="text-xs text-gray-600 mt-1">
            <summary class="cursor-pointer select-none">Waar kry ek ’n UID?</summary>
            <div class="mt-1">
              • Firebase Console → Authentication → Users → **Add user** (sit e-pos + tydelike wagwoord).<br/>
              • Na byvoeging, **kopieer die UID** uit die lys en plak dit hier bo.
            </div>
          </details>
        </div>

        <div id="resultsWrap" class="mt-3 hidden">
          <div class="text-sm font-semibold mb-1">Meer as een resultaat — kies een:</div>
          <ul id="resultsList" class="text-sm space-y-1"></ul>
        </div>

        <p id="lookupMsg" class="text-sm mt-2"></p>
      </section>

      <!-- Edit: Supporter flags -->
      <section class="bg-gray-50 rounded p-3">
        <h2 class="font-semibold mb-2">Merk as ondersteuner</h2>
        <p class="text-xs text-gray-600 mb-2">
          Tip: Jy kan net <b>UID + e-pos</b> invul en dan <b>STOOR</b> klik — dit skep die <code>/users/</code> dokument as dit nog nie bestaan nie.
        </p>

        <div class="text-sm mb-2">
          <div>Gekose UID: <span id="currentUid" class="mono">—</span></div>
          <div>Naam: <span id="currentName">—</span></div>
          <div>E-pos: <span id="currentEmail">—</span></div>
        </div>

        <div class="flex flex-wrap items-center gap-3">
          <label class="text-sm flex items-center gap-2">
            <input id="isPaid" type="checkbox" class="h-4 w-4"> Is betaalde ondersteuner
          </label>
          <label class="text-sm">Geldig tot:
            <input id="paidUntil" type="date" class="border rounded p-1 ml-1">
          </label>
        </div>

        <div class="flex flex-wrap gap-2 mt-3">
          <button id="saveBtn" class="btn bg-green-600 hover:bg-green-700">STOOR</button>
          <button id="clearBtn" class="btn bg-yellow-600 hover:bg-yellow-700">MAAK ONBETAALD</button>
        </div>
        <p id="msg" class="text-sm mt-2"></p>
      </section>

      <!-- Change username -->
      <section class="bg-gray-50 rounded p-3">
        <h2 class="font-semibold mb-2">Verander gebruikersnaam</h2>
        <div class="grid grid-cols-1 gap-2">
          <input id="newName" type="text" class="border rounded p-2" placeholder="Nuwe naam… (bv. Lenieblou)"/>
          <div class="flex gap-2">
            <button id="changeNameBtn" class="btn bg-blue-600 hover:bg-blue-700">OPDATEER NAAM</button>
            <button id="copyNameToMirrorBtn" class="btn bg-slate-600 hover:bg-slate-700">SINKRONISEER SPIËGEL</button>
          </div>
          <p class="text-xs text-gray-600">
            Let wel: Hierdie bladsy pas <code>users/{uid}.userName</code> aan. As jy ook Firebase Auth se
            <code>displayName</code> wil bywerk, activeer later die (opsionele) Cloud Function roep hieronder in die kode.
          </p>
        </div>
      </section>

      <!-- Quick self-mark for testing -->
      <section class="bg-gray-50 rounded p-3">
        <h2 class="font-semibold mb-2">Vinnig: Maak MÝ ’n ondersteuner (30 dae)</h2>
        <button id="makeMeBtn" class="btn bg-purple-600 hover:bg-purple-700">MERK MY AS BETAAL</button>
        <p class="text-xs text-gray-600 mt-1">Gebruik dit om gou te toets op <code>profile.html</code>.</p>
      </section>
    </div>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, serverTimestamp, Timestamp,
      collection, query, where, getDocs, updateDoc
    } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
    // If you add a callable later to update Auth displayName, also import:
    // import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-functions.js";

    // =========================
    // CONFIG
    // =========================
    const ADMIN_UID = "jI7f0Wk4MqfPq7p69vjl8OlJUvS2";
    const PUBLIC_MIRROR_COLLECTION = "publicUsers"; // set "" to disable

    const firebaseConfig = {
      apiKey: "AIzaSyDH-nVvGkdaheH7pvRHH0M9TbW2f98lMGQ",
      authDomain: "kriptiek-c9ea2.firebaseapp.com",
      projectId: "kriptiek-c9ea2",
      storageBucket: "kriptiek-c9ea2.appspot.com",
      messagingSenderId: "620450620939",
      appId: "1:620450620939:web:e93a18ac23b53b33db890e"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    // const functions = getFunctions(app); // enable when you add a callable

    // =========================
    // UI refs
    // =========================
    const gate = document.getElementById('gate');
    const panel = document.getElementById('panel');
    const emailInput = document.getElementById('emailInput');
    const searchEmailBtn = document.getElementById('searchEmailBtn');
    const uidInput = document.getElementById('uidInput');
    const loadUidBtn = document.getElementById('loadUidBtn');
    const resultsWrap = document.getElementById('resultsWrap');
    const resultsList = document.getElementById('resultsList');
    const lookupMsg = document.getElementById('lookupMsg');

    const currentUid = document.getElementById('currentUid');
    const currentName = document.getElementById('currentName');
    const currentEmail = document.getElementById('currentEmail');
    const isPaid = document.getElementById('isPaid');
    const paidUntil = document.getElementById('paidUntil');
    const saveBtn = document.getElementById('saveBtn');
    const clearBtn = document.getElementById('clearBtn');
    const msg = document.getElementById('msg');

    const newName = document.getElementById('newName');
    const changeNameBtn = document.getElementById('changeNameBtn');
    const copyNameToMirrorBtn = document.getElementById('copyNameToMirrorBtn');

    const makeMeBtn = document.getElementById('makeMeBtn');

    let selectedUid = null;

    // =========================
    // Auth gate
    // =========================
    onAuthStateChanged(auth, async (user)=>{
      if (!user) {
        // fixed redirect path (dash, not dot)
        window.location.href = "/login.html?return=/admin-supporters.html";
        return;
      }
      if (user.uid !== ADMIN_UID) {
        gate.classList.remove('hidden');
        return;
      }
      panel.classList.remove('hidden');
    });

    // =========================
    // Helpers
    // =========================
    function showLookup(text, cls="text-gray-700") {
      lookupMsg.textContent = text;
      lookupMsg.className = `text-sm mt-2 ${cls}`;
    }
    function showMsg(text, cls="text-gray-700") {
      msg.textContent = text;
      msg.className = `text-sm mt-2 ${cls}`;
    }
    function clearSelectionUI() {
      selectedUid = null;
      currentUid.textContent = "—";
      currentName.textContent = "—";
      currentEmail.textContent = "—";
      isPaid.checked = false;
      paidUntil.value = "";
      newName.value = "";
    }
    function getTypedEmail() {
      const raw = (emailInput.value || "").trim();
      return raw || null;
    }
    function validUid(val){
      return typeof val === 'string' && val.length >= 10; // simple sanity check
    }

    // =========================
    // Load by UID (robust)
    // =========================
    async function loadUser(uid){
      showLookup("");
      resultsWrap.classList.add('hidden');
      clearSelectionUI();

      if (!uid) return;

      try {
        const snap = await getDoc(doc(db,'users', uid));
        if (!snap.exists()){
          showLookup("Geen userdoc vir dié UID nie.", "text-red-600");
          // still set the UID display so admin can create/update
          currentUid.textContent = uid;
          selectedUid = uid;
          return;
        }
        selectedUid = uid;
        currentUid.textContent = uid;
        const data = snap.data()||{};
        currentName.textContent = data.userName || "—";
        currentEmail.textContent = data.email || "—";
        newName.value = data.userName || "";

        const s = data.support || {};
        isPaid.checked = !!s.isPaid;
        if (s.paidUntil?.toDate){
          const dt = s.paidUntil.toDate();
          paidUntil.value = dt.toISOString().slice(0,10);
        }
        showLookup("Gelaai.", "text-green-600");
      } catch (err) {
        console.error(err);
        if (err?.code === "permission-denied") {
          showLookup("Geen toestemming om die gebruiker te lees nie (permission-denied).", "text-red-600");
        } else {
          showLookup("Kon nie gebruiker laai nie: " + (err.message || err), "text-red-600");
        }
      }
    }

    // =========================
    // Search by email with multi-source fallback
    // =========================
    async function searchByEmail(email){
      showLookup("");
      resultsList.innerHTML = "";
      resultsWrap.classList.add('hidden');

      const raw = (email||"").trim();
      if (!raw){
        showLookup("Tik ’n e-posadres.", "text-red-600"); return;
      }

      const needle = raw.toLowerCase();
      let hits = [];

      try {
        // 1) users.emailLower
        const q1 = query(collection(db,'users'), where('emailLower','==', needle));
        let snap = await getDocs(q1);
        snap.forEach(d => hits.push({ uid: d.id, source:'users', ...d.data() }));

        // 2) users.email (legacy)
        if (hits.length === 0) {
          const q2 = query(collection(db,'users'), where('email','==', raw));
          snap = await getDocs(q2);
          snap.forEach(d => hits.push({ uid: d.id, source:'users', ...d.data() }));
        }

        // 3) public mirror (optional)
        if (hits.length === 0 && PUBLIC_MIRROR_COLLECTION) {
          try {
            const q3 = query(collection(db, PUBLIC_MIRROR_COLLECTION), where('emailLower','==', needle));
            const snap2 = await getDocs(q3);
            snap2.forEach(d => hits.push({ uid: d.id, source:'public', ...d.data() }));
          } catch {}
        }

        // 4) registrations (older flow)
        if (hits.length === 0) {
          try {
            const regRef = collection(db, 'registrations');
            let rsnap = await getDocs(query(regRef, where('emailLower','==', needle)));
            if (rsnap.empty) rsnap = await getDocs(query(regRef, where('email','==', raw)));
            rsnap.forEach(d => hits.push({ uid: d.id, source:'registrations', ...d.data() }));
          } catch {}
        }

        if (hits.length === 0){
          showLookup("Geen gebruiker met daardie e-pos gevind nie.", "text-red-600");
          return;
        }

        if (hits.length === 1){
          uidInput.value = hits[0].uid;
          await loadUser(hits[0].uid);
          return;
        }

        // Multiple: chooser
        resultsWrap.classList.remove('hidden');
        resultsList.innerHTML = hits.map(h => `
          <li class="flex items-center justify-between bg-white border rounded p-2">
            <div class="text-sm">
              <div><span class="font-semibold">${h.userName || "—"}</span> · <span class="mono">${h.uid}</span></div>
              <div class="text-xs text-gray-600">${h.email || ""}</div>
              <div class="text-[10px] text-gray-400">bron: ${h.source || "onbekend"}</div>
            </div>
            <button data-uid="${h.uid}" class="px-2 py-1 rounded bg-blue-600 text-white text-xs">KIES</button>
          </li>
        `).join('');
        resultsList.querySelectorAll('button[data-uid]').forEach(btn => {
          btn.addEventListener('click', async () => {
            const uid = btn.getAttribute('data-uid');
            uidInput.value = uid;
            await loadUser(uid);
            resultsWrap.classList.add('hidden');
          });
        });
        showLookup(`${hits.length} resultate — kies een.`, "text-yellow-700");

      } catch (err) {
        console.error(err);
        if (err?.code === 'permission-denied') {
          showLookup("Geen toestemming om die gebruikerslys te lees nie (permission-denied).", "text-red-600");
        } else {
          showLookup("Kon nie soek nie: " + (err.message || err), "text-red-600");
        }
      }
    }

    // =========================
    // Events (lookup)
    // =========================
    searchEmailBtn.addEventListener('click', async ()=> {
      await searchByEmail(emailInput.value);
    });
    emailInput.addEventListener('keydown', async (e)=>{
      if (e.key === 'Enter') {
        e.preventDefault();
        await searchByEmail(emailInput.value);
      }
    });

    loadUidBtn.addEventListener('click', async ()=> {
      await loadUser(uidInput.value.trim());
    });
    uidInput.addEventListener('keydown', async (e)=>{
      if (e.key === 'Enter') {
        e.preventDefault();
        await loadUser(uidInput.value.trim());
      }
    });

    // =========================
    // Save / Clear supporter flags
    // =========================
    saveBtn.addEventListener('click', async ()=> {
      try {
        const uid = selectedUid || (uidInput.value || "").trim();
        if (!validUid(uid)){
          showMsg("Tik eers ’n geldige UID in (of laai een).", "text-red-600"); return;
        }

        let untilVal = paidUntil.value ? Timestamp.fromDate(new Date(paidUntil.value+"T23:59:59")) : null;
        const payload = {
          support: { isPaid: !!isPaid.checked, paidUntil: untilVal },
          updatedAt: serverTimestamp()
        };

        const typed = getTypedEmail();
        if (typed) {
          payload.email = typed;
          payload.emailLower = typed.toLowerCase();
        }

        await setDoc(doc(db,'users', uid), payload, { merge: true });

        // optional mirror
        if (PUBLIC_MIRROR_COLLECTION) {
          await setDoc(doc(db, PUBLIC_MIRROR_COLLECTION, uid), {
            support: payload.support,
            email: payload.email || currentEmail.textContent || null,
            emailLower: (payload.email || currentEmail.textContent || "").toLowerCase() || null,
            userName: currentName.textContent || null,
            updatedAt: serverTimestamp()
          }, { merge: true });
        }

        await loadUser(uid);
        uidInput.value = uid;
        showMsg("Gestoor.", "text-green-600");
      } catch (err) {
        console.error(err);
        showMsg("Kon nie stoor nie: " + (err.message || err), "text-red-600");
      }
    });

    clearBtn.addEventListener('click', async ()=> {
      try {
        const uid = selectedUid || (uidInput.value || "").trim();
        if (!validUid(uid)){
          showMsg("Tik eers ’n geldige UID in (of laai een).", "text-red-600"); return;
        }
        await setDoc(doc(db,'users', uid), {
          support: { isPaid: false, paidUntil: null },
          updatedAt: serverTimestamp()
        }, { merge: true });

        if (PUBLIC_MIRROR_COLLECTION) {
          await setDoc(doc(db, PUBLIC_MIRROR_COLLECTION, uid), {
            support: { isPaid: false, paidUntil: null },
            updatedAt: serverTimestamp()
          }, { merge: true });
        }

        isPaid.checked = false; paidUntil.value="";
        await loadUser(uid);
        showMsg("Merk as onbetaald voltooi.", "text-green-600");
      } catch (err) {
        console.error(err);
        showMsg("Kon nie opdateer nie: " + (err.message || err), "text-red-600");
      }
    });

    // =========================
    // Change username
    // =========================
    async function changeUserName(uid, newUserName){
      if (!validUid(uid)) {
        showMsg("Geen geldige UID nie.", "text-red-600"); return;
      }
      const trimmed = (newUserName || "").trim();
      if (!trimmed) {
        showMsg("Tik ’n nuwe naam.", "text-red-600"); return;
      }
      try {
        await setDoc(doc(db, 'users', uid), {
          userName: trimmed,
          updatedAt: serverTimestamp()
        }, { merge: true });

        // OPTIONAL: also update a public mirror
        if (PUBLIC_MIRROR_COLLECTION) {
          await setDoc(doc(db, PUBLIC_MIRROR_COLLECTION, uid), {
            userName: trimmed,
            updatedAt: serverTimestamp()
          }, { merge: true });
        }

        // OPTIONAL: if you add a callable to update Auth displayName, enable this:
        /*
        const call = httpsCallable(functions, 'updateUserDisplayName');
        await call({ uid, newName: trimmed });
        */

        await loadUser(uid);
        showMsg("Gebruikersnaam opgedateer.", "text-green-600");
      } catch (err) {
        console.error(err);
        showMsg("Kon nie gebruikersnaam opdateer nie: " + (err.message || err), "text-red-600");
      }
    }

    changeNameBtn.addEventListener('click', async ()=>{
      const uid = selectedUid || (uidInput.value || "").trim();
      await changeUserName(uid, newName.value);
    });

    copyNameToMirrorBtn.addEventListener('click', async ()=>{
      try {
        const uid = selectedUid || (uidInput.value || "").trim();
        if (!validUid(uid)) {
          showMsg("Geen geldige UID nie.", "text-red-600"); return;
        }
        const snap = await getDoc(doc(db,'users', uid));
        const nm = (snap.exists() && snap.data().userName) ? snap.data().userName : (newName.value || "").trim();
        if (!nm) { showMsg("Geen naam om te sinkroniseer nie.", "text-red-600"); return; }
        if (PUBLIC_MIRROR_COLLECTION) {
          await setDoc(doc(db, PUBLIC_MIRROR_COLLECTION, uid), {
            userName: nm,
            updatedAt: serverTimestamp()
          }, { merge: true });
          showMsg("Spieël opgedateer.", "text-green-600");
        } else {
          showMsg("Geen spieël-versameling ingestel nie.", "text-yellow-700");
        }
      } catch (err) {
        console.error(err);
        showMsg("Kon nie spieël opdateer nie: " + (err.message || err), "text-red-600");
      }
    });

    // =========================
    // Self test helper
    // =========================
    makeMeBtn.addEventListener('click', async ()=> {
      const user = auth.currentUser;
      if (!user) return;
      try {
        const until = new Date();
        until.setDate(until.getDate()+30);
        const payload = {
          support: { isPaid: true, paidUntil: Timestamp.fromDate(until) },
          updatedAt: serverTimestamp()
        };
        if (user.email) {
          payload.email = user.email;
          payload.emailLower = user.email.toLowerCase();
        }
        await setDoc(doc(db,'users', user.uid), payload, { merge: true });

        if (PUBLIC_MIRROR_COLLECTION) {
          await setDoc(doc(db, PUBLIC_MIRROR_COLLECTION, user.uid), {
            support: payload.support,
            email: payload.email || null,
            emailLower: payload.emailLower || null,
            userName: null,
            updatedAt: serverTimestamp()
          }, { merge: true });
        }

        uidInput.value = user.uid;
        await loadUser(user.uid);
        showMsg("Jy is vir 30 dae as ondersteuner gemerk.", "text-green-600");
      } catch (err) {
        console.error(err);
        showMsg("Kon nie jou status opdateer nie: " + (err.message || err), "text-red-600");
      }
    });
  </script>
</body>
</html>
