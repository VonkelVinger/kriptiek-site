<script>
/* ===== Slimstiek points engine (minimal-diff) =====
   Assumes your Blitstiek page already provides:
   - target word: window.K.daily.load()  -> { date, word }
   - leaderboard add: window.K.lb.add(game, date, payload)
   - leaderboard list: window.K.lb.list(game, date)  (for render)
   - DOM ids/classes already present from Blitstiek
   If you don’t have K.*, keep localStorage fallback below.
*/

/* ---------- DOM references (re-use Blitstiek’s selectors) ---------- */
const gridEl   = document.getElementById('grid');
const scoreEl  = document.getElementById('score');     // stat band value
const comboEl  = document.getElementById('combo');     // stat band value
const timeEl   = document.getElementById('elapsed');   // stat band value
const lbBody   = document.querySelector('#lb tbody');
const targetEl = document.getElementById('target-word');

const btnStart = document.getElementById('start');
const btnPause = document.getElementById('pause');
const btnLeft  = document.getElementById('left');
const btnRight = document.getElementById('right');
const btnDown  = document.getElementById('down');
const btnShare = document.getElementById('share');
const btnProf  = document.getElementById('profile');

/* ---------- Game state ---------- */
const W=8, H=10;
const COLORS = ['#0ea5e9','#f97316','#22c55e','#f59e0b','#a855f7','#0e7490','#7dd3fc'];
const LETTERS='BCDFGHJKLMNPQRSTVWXZ', VOWELS='AEIOUY';

let TARGET='WOORD', GAME_ID='';
let grid=[], cur=null, next=null;
let seconds=0, paused=false, over=false, tick=null, fall=null;
let score=0, combo=1;

const q=(x,y)=>gridEl.querySelector(`.cell[data-x="${x}"][data-y="${y}"]`);
const fmt=s=>`${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
const base=()=>Math.max(0, 1200 - 18*seconds);   // time-decay base per spec

function hud(){
  scoreEl.textContent = String(score + base());
  comboEl.textContent = 'x' + (Number.isInteger(combo)?combo:combo.toFixed(2)).replace(/\.00$/,'');
  timeEl.textContent  = fmt(seconds);
}

function buildTarget(){
  targetEl.innerHTML='';
  TARGET.split('').forEach(c=>{
    const s=document.createElement('span');
    s.className='tch'; s.textContent=c; targetEl.appendChild(s);
  });
}

function initGrid(){
  gridEl.innerHTML='';
  grid = Array.from({length:H},()=>Array(W).fill(null));
  for(let y=0;y<H;y++) for(let x=0;x<W;x++){
    const d=document.createElement('div');
    d.className='cell'; d.dataset.x=x; d.dataset.y=y; gridEl.appendChild(d);
  }
}

/* ---------- Blocks ---------- */
const create=()=>({
  x:Math.floor(W/2), y:0,
  color:COLORS[Math.random()*COLORS.length|0],
  letter:(Math.random()<.3?VOWELS:LETTERS)[Math.random()*VOWELS.length|0]
});
function draw(b){ if(!b||b.x<0||b.x>=W||b.y<0||b.y>=H) return; const e=q(b.x,b.y); e.classList.add('filled'); e.style.background=b.color; e.textContent=b.letter; }
function clear(b){ if(!b||b.x<0||b.x>=W||b.y<0||b.y>=H) return; const e=q(b.x,b.y); e.className='cell'; e.style.background=''; e.textContent=''; }
const hit=b=>!b||b.x<0||b.x>=W||b.y>=H||(b.y>=0&&grid[b.y][b.x]);

async function move(dx,dy){
  if(!cur||paused||over) return;
  clear(cur); const t={...cur,x:cur.x+dx,y:cur.y+dy};
  if(!hit(t)){ cur=t; draw(cur); }
  else if(dy>0){ draw(cur); place(); } else draw(cur);
}
function drop(){ if(!cur||paused||over) return; clear(cur); while(cur.y<H-1 && !hit({...cur,y:cur.y+1})) cur.y++; place(); }

function inTarget(ch){ return TARGET.includes(ch); }

async function place(){
  if(!cur||cur.y<0) return;
  grid[cur.y][cur.x]={...cur}; draw(cur);
  await matches(); await win();
  cur=next; next=create(); draw(cur);
  if(hit(next)) end(false);
}

async function matches(){
  const kill=new Set();
  for(let y=0;y<H;y++) for(let x=0;x<W;x++){
    const c=grid[y][x]; if(!c||inTarget(c.letter)) continue;
    for(const [dx,dy] of [[1,0],[0,1],[-1,0],[0,-1]]){
      const nx=x+dx, ny=y+dy;
      if(nx>=0&&nx<W&&ny>=0&&ny<H){
        const n=grid[ny][nx];
        if(n&&!inTarget(n.letter)&&(n.letter===c.letter||n.color===c.color)){
          kill.add(`${x},${y}`); kill.add(`${nx},${ny}`);
        }
      }
    }
  }
  if(!kill.size) return;

  // +15 per pair, scaled by combo; combo grows in quarters up to x9
  const popped=kill.size, add=15*Math.ceil(popped/2);
  score += add * combo;
  combo = Math.min(9, combo + .25);

  await Promise.all([...kill].map(p=>new Promise(r=>{
    const [x,y]=p.split(',').map(Number), e=q(x,y);
    if(e){ e.classList.add('pop'); setTimeout(()=>{ grid[y][x]=null; clear({x,y}); r(); }, 120); }
    else r();
  })));

  // gravity
  for(let x=0;x<W;x++){
    let w=H-1;
    for(let y=H-1;y>=0;y--){
      if(grid[y][x]){
        if(y!==w){ grid[w][x]=grid[y][x]; grid[y][x]=null; clear({x,y}); draw({...grid[w][x],x,y:w}); }
        w--;
      }
    }
  }
  hud();
}

async function win(){
  for(let y=0;y<H;y++) for(let x=0;x<=W-TARGET.length;x++){
    let ok=true;
    for(let i=0;i<TARGET.length;i++){
      if(!grid[y][x+i]||grid[y][x+i].letter!==TARGET[i]){ ok=false; break; }
    }
    if(ok){
      score += Math.round(250*combo); // finish bonus
      hud();
      for(let i=0;i<TARGET.length;i++){ const e=q(x+i,y); if(e) e.style.transform='scale(1.1)'; }
      await new Promise(r=>setTimeout(r,400));
      return end(true);
    }
  }
}

/* ---------- Loops ---------- */
function start(){
  stop(); seconds=0; score=0; combo=1; over=false; paused=false;
  initGrid(); cur=create(); next=create(); draw(cur); hud();
  tick=setInterval(()=>{ if(!paused&&!over){ seconds++; hud(); } },1000);
  fall=setInterval(()=>{ if(!paused&&!over) move(0,1); },1000);
}
function stop(){ if(tick) clearInterval(tick); if(fall) clearInterval(fall); }

/* ---------- Overlay + submit ---------- */
function openOverlay(inner){ const w=document.createElement('div'); w.className='overlay'; w.innerHTML=`<div class="modal">${inner}</div>`; document.body.appendChild(w); return w.querySelector('.modal'); }
function closeOverlay(){ const o=document.querySelector('.overlay'); if(o) o.remove(); }

async function submitScore(final){
  const name = (document.getElementById('nameIn').value || 'Anoniem').slice(0,24);
  if (window.K && window.K.lb && typeof window.K.lb.add==='function') {
    await window.K.lb.add('slimstiek', GAME_ID, { name, points: final });
  } else {
    // local fallback
    const key='slimstiek_'+GAME_ID, rows=JSON.parse(localStorage.getItem(key)||'[]');
    rows.push({name,points:final,ts:Date.now()});
    rows.sort((a,b)=>b.points-a.points);
    localStorage.setItem(key, JSON.stringify(rows.slice(0,50)));
  }
  renderLB();
  closeOverlay();
}

function showWin(final){
  const html=`
    <h3>Mooi! Jou telling vir <b>${TARGET}</b> is <b>${final}</b></h3>
    <p>Vul jou naam vir die leierbord of deel dit.</p>
    <input id="nameIn" placeholder="Jou naam" maxlength="24">
    <div class="grid">
      <button id="submit" class="btn teal">Dien in</button>
      <button id="share2" class="btn">Deel</button>
      <button id="again" class="btn full">Speel weer</button>
    </div>`;
  const m=openOverlay(html);
  m.querySelector('#again').onclick=()=>{ closeOverlay(); start(); };
  m.querySelector('#share2').onclick=()=>share(score+base());
  m.querySelector('#submit').onclick=()=>submitScore(score+base());
}

function end(win){
  over=true; stop();
  if(win) return showWin(score+base());
  const m=openOverlay(`<h3>Speletjie verby</h3><p>Die rooster is vol. Jou telling: <b>${score+base()}</b></p><div class="grid"><button id="again" class="btn teal full">Probeer weer</button></div>`);
  m.querySelector('#again').onclick=()=>{ closeOverlay(); start(); };
}

/* ---------- Buttons (reuse Blitstiek UI) ---------- */
btnStart.onclick=start;
btnPause.onclick=()=>{ if(over) return; paused=!paused; btnPause.textContent=paused?'Hervat':'Pouse'; };
btnLeft.onclick =()=>move(-1,0);
btnRight.onclick=()=>move(1,0);
btnDown.onclick =drop;

document.addEventListener('keydown',e=>{
  if(e.key==='ArrowLeft') move(-1,0);
  if(e.key==='ArrowRight') move(1,0);
  if(e.key==='ArrowDown') move(0,1);
  if(e.key===' '){ e.preventDefault(); drop(); }
});

/* ---------- Share & My Profiel (same hooks) ---------- */
function share(final){
  const msg=`Ek het ${TARGET} in Slimstiek voltooi vir ${final} punte — kan jy my klop?`;
  const url=location.href.split('?')[0], text=`${msg} ${url}`;
  if(navigator.share){ navigator.share({text:url?text:msg,url}).catch(()=>navigator.clipboard.writeText(text)); }
  else navigator.clipboard.writeText(text);
}
btnShare.onclick=()=>share(score+base());

btnProf.onclick=()=>{
  try{
    if(window.kriptiek && typeof window.kriptiek.addToProfile==='function'){
      window.kriptiek.addToProfile({ app:'Slimstiek', day:GAME_ID, word:TARGET, score:score+base() });
    }
    alert('Bygevoeg by My Profiel ✅');
  }catch(e){}
};

/* ---------- Leaderboard render (reuse your K.lb if present) ---------- */
function renderLB(){
  let rows=[];
  if (window.K && window.K.lb && typeof window.K.lb.list==='function') {
    rows = (window.K.lb.list('slimstiek', GAME_ID) || []).sort((a,b)=>b.points-a.points);
  } else {
    rows = JSON.parse(localStorage.getItem('slimstiek_'+GAME_ID)||'[]').sort((a,b)=>b.points-a.points);
  }
  lbBody.innerHTML=''; let r=1;
  rows.slice(0,10).forEach(x=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r++}</td><td>${x.name}</td><td>${x.points}</td>`;
    lbBody.appendChild(tr);
  });
}

/* ---------- Boot (use your daily loader if available) ---------- */
(async function boot(){
  if (window.K && window.K.daily && typeof window.K.daily.load==='function'){
    const { date, word } = await window.K.daily.load();   // shared with Blitstiek
    GAME_ID = date; TARGET = (word||'WOORD').toUpperCase();
  } else {
    const qs=new URLSearchParams(location.search);
    GAME_ID = qs.get('date') || new Date().toISOString().slice(0,10);
    TARGET  = (qs.get('word') || 'WOORD').toUpperCase().replace(/[^A-Z]/g,'');
  }
  // Build target and grid, leave “Begin” to start—just like Blitstiek.
  targetEl.innerHTML=''; TARGET.split('').forEach(c=>{const s=document.createElement('span'); s.className='tch'; s.textContent=c; targetEl.appendChild(s);});
  initGrid(); renderLB(); hud();
})();
</script>
