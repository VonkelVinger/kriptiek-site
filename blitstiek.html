<!DOCTYPE html>
<html lang="af">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
  <title>BLITSTIEK – Kriptiek</title>

  <!-- Tailwind + Montserrat -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700;800&display=swap" rel="stylesheet" />

  <style>
    :root{
      --brand:#1e3a8a;        /* navy */
      --tile:#0b4a43;         /* dark teal for grid */
      --text:#0f172a;
    }
    html,body{height:100%}
    body{font-family:'Montserrat',system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif;color:var(--text);background:#f3f4f6}

    /* Header letter tiles */
    .hdr-tile{
      width:40px;height:40px;border-radius:.5rem;background:#374151;color:#fff;
      display:inline-flex;align-items:center;justify-content:center;font-weight:800;letter-spacing:.5px;
      box-shadow:inset 0 -2px 0 rgba(0,0,0,.25);
    }

    /* Action bar images look like your tiles */
    .btn-img{border-radius:12px;box-shadow:0 6px 15px rgba(0,0,0,.25)}
    .btn-img:hover{transform:translateY(-1px);filter:brightness(1.02)}
    .btn-img:active{transform:translateY(0);filter:brightness(.98)}

    /* Popup (Kriptiek look) */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;z-index:1000}
    .modal-card{
      max-width:560px;margin:8vh auto;background:#0f172a;color:#fff;border-radius:16px;
      box-shadow:0 20px 60px rgba(0,0,0,.35);overflow:hidden
    }
    .modal-head{padding:20px 24px;background:linear-gradient(160deg,#1e3a8a,#111827)}
    .modal-body{padding:22px 24px;background:#0f172a}
    .k-cta{padding:12px 16px;border-radius:10px;font-weight:800}
  </style>
</head>
<body class="min-h-screen">
  <main class="max-w-3xl mx-auto px-4 md:px-6 py-6">
    <!-- Header -->
    <div class="flex items-center justify-center gap-2 mb-2">
      <span class="hdr-tile">B</span><span class="hdr-tile">L</span><span class="hdr-tile">I</span>
      <span class="hdr-tile">T</span><span class="hdr-tile">S</span><span class="hdr-tile">T</span>
      <span class="hdr-tile">I</span><span class="hdr-tile">E</span><span class="hdr-tile">K</span>
    </div>
    <!-- (R only) small welcome; hidden for N-R -->
    <div id="welcomeUser" class="text-center text-slate-500 text-sm font-semibold hidden"></div>

    <!-- Target word (optional) -->
    <h2 class="text-center text-2xl md:text-3xl font-extrabold tracking-wide mt-4">TEIKENWOORD:</h2>
    <div id="targetWord" class="mt-3 flex items-center justify-center gap-2">
      <!-- your engine can populate/replace these -->
      <span class="px-3 py-1.5 rounded-md bg-[var(--tile)] text-white font-bold">K</span>
      <span class="px-3 py-1.5 rounded-md bg-[var(--tile)] text-white font-bold">W</span>
      <span class="px-3 py-1.5 rounded-md bg-[var(--tile)] text-white font-bold">A</span>
      <span class="px-3 py-1.5 rounded-md bg-[var(--tile)] text-white font-bold">D</span>
      <span class="px-3 py-1.5 rounded-md bg-[var(--tile)] text-white font-bold">R</span>
      <span class="px-3 py-1.5 rounded-md bg-[var(--tile)] text-white font-bold">A</span>
      <span class="px-3 py-1.5 rounded-md bg-[var(--tile)] text-white font-bold">A</span>
      <span class="px-3 py-1.5 rounded-md bg-[var(--tile)] text-white font-bold">T</span>
    </div>

    <!-- Grid stub (keep your existing board here) -->
    <section class="mt-6 flex justify-center">
      <div id="gameGrid" class="bg-[var(--tile)] w-[620px] h-[240px] rounded-lg"></div>
    </section>

    <!-- Controls -->
    <section class="mt-6 flex items-center justify-center gap-6">
      <div class="flex gap-4">
        <button id="ctlLeft"  class="w-20 h-20 rounded-xl bg-[var(--brand)]/80 text-white font-extrabold text-2xl">◀</button>
        <button id="ctlDown"  class="w-20 h-20 rounded-xl bg-[var(--brand)]/80 text-white font-extrabold text-2xl">▼</button>
        <button id="ctlRight" class="w-20 h-20 rounded-xl bg-[var(--brand)]/80 text-white font-extrabold text-2xl">▶</button>
      </div>
    </section>

    <!-- Start / Pause -->
    <section class="mt-4 flex items-center justify-center gap-4">
      <button id="btnStart" class="px-6 py-2 rounded-xl bg-blue-900 text-white font-extrabold shadow">BEGIN</button>
      <button id="btnPause" class="px-6 py-2 rounded-xl bg-slate-500 text-white font-extrabold shadow">POUSE</button>
    </section>

    <!-- Timers -->
    <section class="mt-4 flex items-center justify-center gap-6">
      <div class="px-4 py-2 rounded-lg bg-emerald-900 text-white font-extrabold shadow">
        Jou tyd: <span id="yourTime">00:00</span>
      </div>
      <div class="px-4 py-2 rounded-lg bg-emerald-900 text-white font-extrabold shadow">
        Beste tyd: <span id="bestTime">01:00</span>
      </div>
    </section>

    <!-- Action bar (replaces old guest note) -->
    <section id="actionBar" class="max-w-xl mx-auto mt-5 flex items-center justify-center gap-3">
      <!-- N-R shows this -->
      <a id="btnRegister" href="/register.html" onclick="return blx.goRegister(event)" class="hidden">
        <img class="btn-img" src="/assets/K_REGISTREER_12SEP.png" alt="Registreer" width="150" height="150">
      </a>

      <!-- R shows this -->
      <a id="btnGesels" href="/forum.html" class="hidden">
        <img class="btn-img" src="/assets/K_GESELS_12SEP.png" alt="Gesels" width="150" height="150">
      </a>

      <!-- Both see Share -->
      <button id="btnShare" type="button" onclick="blx.shareCurrent()" title="Deel"
              class="opacity-0 pointer-events-none">
        <img class="btn-img" src="/assets/SHARE_12SEP.png" alt="Deel" width="150" height="150">
      </button>
    </section>
  </main>

  <!-- Popup gate -->
  <div id="nrGate" class="modal-backdrop" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-head">
        <div class="text-white font-extrabold tracking-wide">WELKOM BY BLITSTIEK</div>
        <div class="text-slate-200/90 mt-1 font-semibold">Kies hoe jy wil begin</div>
      </div>
      <div class="modal-body">
        <ol class="list-decimal ml-5 leading-6">
          <li class="mb-2">
            Speel eers Blitstiek as ’n <em>ongeregistreerde</em> speler met beperkte funksies.
          </li>
          <li>
            <a href="/register.html" class="underline text-sky-300" onclick="return blx.goRegister(event)">
              Registreer
            </a> sodat jy volle toegang kry tot alles op Kriptiek, insluitend Blitstiek.
          </li>
        </ol>
        <div class="flex gap-3 mt-4 flex-wrap">
          <button onclick="blx.chooseGuest()" class="k-cta bg-emerald-500 text-white flex-1 min-w-[160px]">Speel nou (N-R)</button>
          <button onclick="blx.goRegister()" class="k-cta bg-amber-400 text-slate-900 flex-1 min-w-[160px]">Registreer</button>
        </div>
      </div>
    </div>
  </div>
  <!-- ===== Minimal timer & engine hooks (keep your own engine; just call the hooks) ===== -->
  <script>
    // Utility: format mm:ss
    const fmt = (ms)=>{ const s=Math.floor(ms/1000),m=Math.floor(s/60); return `${String(m).padStart(2,'0')}:${String(s%60).padStart(2,'0')}` };

    // Daily ID: from ?d=YYYY-MM-DD or today
    const urlD = new URL(location.href).searchParams.get('d');
    const today = (urlD || new Date().toISOString().slice(0,10));
    window.blitstiekGameId = `Game${today}`;

    // Simple timer (use your own if you have one)
    let t0=0, tInt=null, elapsed=0;
    function startTimer(){
      if(tInt) return;
      t0 = performance.now() - elapsed;
      tInt = setInterval(()=>{ elapsed = performance.now()-t0; document.getElementById('yourTime').textContent = fmt(elapsed); }, 200);
    }
    function pauseTimer(){ if(tInt){ clearInterval(tInt); tInt=null; } }
    function resetTimer(){ pauseTimer(); elapsed=0; document.getElementById('yourTime').textContent='00:00'; }

    document.getElementById('btnStart').addEventListener('click', startTimer);
    document.getElementById('btnPause').addEventListener('click', pauseTimer);

    // === Hooks your engine should call ===
    // When a run finishes successfully:
    window.blitstiekFinish = function(timeMs){
      // If you have your own timer, pass its ms here; else we use 'elapsed'
      const ms = timeMs ?? elapsed;
      window.blitstiekTimeMs = ms;
      blx.onGameFinished();  // will show popup for N-R and handle writes for R
    };
    // When the user starts over:
    window.blitstiekRestart = function(){
      resetTimer();
      blx.onGameRestart();
    };

    // Example: you can wire arrow buttons to your engine here
    document.getElementById('ctlLeft').addEventListener('click', ()=>{/* your moveLeft() */});
    document.getElementById('ctlDown').addEventListener('click', ()=>{/* your drop() */});
    document.getElementById('ctlRight').addEventListener('click', ()=>{/* your moveRight() */});
  </script>
  <!-- ===== NR/R Flow + Auth + Share + Optional Firestore ===== -->
  <script>
    // Soft-detect Firebase (works even if not present)
    const hasFb = !!(window.firebase && (firebase.auth || window.auth));
    const auth = hasFb ? (firebase.auth ? firebase.auth() : window.auth) : null;
    const db   = hasFb && firebase.firestore ? firebase.firestore() : (window.db || null);

    // Global state
    window.blitstiekTimeMs = null;
    window.blitstiekFinished = false;

    const blx = {
      els:{},
      user:null,
      init(){
        this.els.welcomeUser = document.getElementById('welcomeUser');
        this.els.nrGate = document.getElementById('nrGate');
        this.els.btnRegister = document.getElementById('btnRegister');
        this.els.btnGesels = document.getElementById('btnGesels');
        this.els.btnShare = document.getElementById('btnShare');

        // Share button available for all
        this.els.btnShare.style.opacity='1';
        this.els.btnShare.style.pointerEvents='auto';

        // Auth listener (if available)
        if(auth && auth.onAuthStateChanged){
          auth.onAuthStateChanged(u=>{
            this.onAuth(u);
            if(u){ this.tryBackfill(); }
          });
        }else{
          this.onAuth(null); // guest
        }

        // Show gate to guests on first load
        if(!this.isSignedIn()) this.showGate();

        // If returned from register, just continue
        if(sessionStorage.getItem('blx:returned')==='1'){
          sessionStorage.removeItem('blx:returned');
          this.hideGate();
        }
      },

      onAuth(user){
        this.user = user || null;
        // Welcome line
        if(this.user && (this.user.displayName || this.user.email)){
          const name = (this.user.displayName || (this.user.email||'').split('@')[0]).toUpperCase();
          this.els.welcomeUser.textContent = `WELKOM TERUG, ${name}`;
          this.els.welcomeUser.classList.remove('hidden');
        }else{
          this.els.welcomeUser.classList.add('hidden');
        }
        // Toggle action bar items
        const signed = this.isSignedIn();
        this.els.btnRegister.classList.toggle('hidden', signed);
        this.els.btnGesels.classList.toggle('hidden', !signed);
      },

      isSignedIn(){ return !!this.user; },

      showGate(){ this.els.nrGate.style.display='block'; this.els.nrGate.setAttribute('aria-hidden','false'); },
      hideGate(){ this.els.nrGate.style.display='none'; this.els.nrGate.setAttribute('aria-hidden','true'); },

      chooseGuest(){ this.hideGate(); },

      goRegister(e){
        if(e) e.preventDefault();
        const ret = location.pathname + location.search;
        sessionStorage.setItem('blx:return', ret);
        const url = new URL('/register.html', location.origin);
        url.searchParams.set('return', ret);
        location.href = url.toString();
        return false;
      },

      onGameFinished(){
        window.blitstiekFinished = true;
        // Save locally for guests (for backfill, optional)
        if(!this.isSignedIn()){
          const key = `blitstiek:${window.blitstiekGameId}`;
          const payload = { timeMs: window.blitstiekTimeMs, finishedAt: Date.now(), synced:false };
          localStorage.setItem(key, JSON.stringify(payload));
          // Re-open gate to nudge registration
          this.showGate();
          return;
        }
        // Signed in → write to Firestore if available
        this.writeResult().catch(()=>{ /* ignore */ });
      },

      onGameRestart(){
        window.blitstiekFinished = false;
        if(!this.isSignedIn()) this.showGate();
      },

      async writeResult(){
        if(!(db && this.user)) return;
        const gameId = window.blitstiekGameId;
        const uid = this.user.uid;
        const ref = db.collection('games').doc(gameId).collection('leaderboard').doc(uid);
        const data = {
          userName: (this.user.displayName || (this.user.email||'').split('@')[0] || 'Speler'),
          timeMs: Number(window.blitstiekTimeMs||0),
          updatedAt: firebase.firestore ? firebase.firestore.FieldValue.serverTimestamp() : new Date()
        };
        await ref.set(data, { merge:true });
      },

      async tryBackfill(){
        if(!(db && this.user)) return;
        const key = `blitstiek:${window.blitstiekGameId}`;
        const raw = localStorage.getItem(key);
        if(!raw) return;
        const obj = JSON.parse(raw);
        if(!obj || obj.synced) return;
        // Write and mark synced
        window.blitstiekTimeMs = obj.timeMs;
        await this.writeResult().catch(()=>{});
        obj.synced = true;
        localStorage.setItem(key, JSON.stringify(obj));
      },

      async shareCurrent(){
        // Build link to this exact daily game
        const date = window.blitstiekGameId.replace(/^Game/,'');
        const url = new URL(location.origin + '/blitstiek.html');
        url.searchParams.set('d', date);

        const withTime = this.isSignedIn() && window.blitstiekFinished && Number.isFinite(window.blitstiekTimeMs);
        const msg = withTime
          ? `Ek het vandag se BLITSTIEK voltooi in ${fmt(window.blitstiekTimeMs)}! Speel dieselfde spel hier: ${url}`
          : `Kom speel vandag se BLITSTIEK op Kriptiek: ${url}`;

        const title = 'BLITSTIEK – Kriptiek';

        // Try attach the green tile image (mobile support)
        let files = [];
        try{
          const res = await fetch('/assets/BLITSTIEK_12SEP.png');
          const blob = await res.blob();
          files = [new File([blob],'BLITSTIEK.png',{type:blob.type})];
        }catch(_){}

        try{
          if(navigator.canShare && files.length && navigator.canShare({files})){
            await navigator.share({ title, text: msg, files });
            return;
          }
          if(navigator.share){
            await navigator.share({ title, text: msg, url: url.toString() });
            return;
          }
        }catch(_){/* user cancelled */}

        // Fallbacks
        try{
          await navigator.clipboard.writeText(msg);
          alert('Skakel gekopieer! Plak dit in WhatsApp/boodskap om te deel.');
        }catch(_){
          prompt('Kopieer en deel:', msg);
        }
      }
    };

    window.blx = blx;

    // Init after DOM ready
    document.addEventListener('DOMContentLoaded', ()=> blx.init());

    // (Optional) register.html return helper:
    // On register.html, after successful auth, add:
    // const ret = new URLSearchParams(location.search).get('return') || sessionStorage.getItem('blx:return');
    // if(ret){ sessionStorage.setItem('blx:returned','1'); location.href = ret; }
  </script>
</body>
</html>
