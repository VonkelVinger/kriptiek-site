<!DOCTYPE html>
<html lang="af">
<head>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-S9V4CMP1FP"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-S9V4CMP1FP');
  </script>

  <!-- AdSense verification (FIXED URL) -->
  <script async
    src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8199352351586797"
    crossorigin="anonymous"></script>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
  <title>BLITSTIEK ‚Äì Kriptiek</title>

  <!-- Open Graph / Twitter -->
  <link rel="canonical" href="https://www.kriptiek.com/blitstiek.html" />
  <meta property="og:title" content="BLITSTIEK ‚Äì Kriptiek" />
  <meta property="og:description" content="Kom speel vandag se BLITSTIEK op Kriptiek." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://www.kriptiek.com/blitstiek.html" />
  <meta property="og:image" content="https://www.kriptiek.com/assets/BLITSTIEK_12SEP.png" />
  <meta property="og:image:alt" content="BLITSTIEK knoppie (groen)" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="BLITSTIEK ‚Äì Kriptiek" />
  <meta name="twitter:description" content="Kom speel vandag se BLITSTIEK op Kriptiek." />
  <meta name="twitter:image" content="https://www.kriptiek.com/assets/BLITSTIEK_12SEP.png" />

  <!-- Tailwind + font -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&display=swap" rel="stylesheet" />

  <style>
    :root{
      --brand:#1e3a8a;
      --cell-bg:#004d40;
      --gridW:320px;
      --cell-font:16px;
      --cellSize:32px;
      --line:1px;
    }
    html,body{height:100%}
    body{
      font-family:'Montserrat',system-ui,Segoe UI,Roboto,Arial,sans-serif;
      background:#f9fafb;
      color:#1f2937;
    }

    /* HEADER */
    header{
      background:#fff;
      box-shadow:0 2px 4px rgba(0,0,0,.08);
      padding:1rem;
      text-align:center;
      position:relative;
    }
    .logo-container{
      display:flex;
      justify-content:center;
      align-items:center;
      margin-bottom:10px;
    }
    .logo-container .letter-box{
      width:40px;height:40px;margin:2px;
      display:flex;justify-content:center;align-items:center;
      background:#374151;color:#fff;
      font-size:1.2rem;font-weight:700;border-radius:6px;
    }
    .welcome{font-size:.9rem;color:#6b7280}

    .card{
      background:#fff;
      border:1px solid #e5e7eb;
      border-radius:16px;
      box-shadow:0 2px 8px rgba(0,0,0,.05);
    }
    .headline{
      text-align:center;
      font-size:1.125rem;
      font-weight:700;
      color:#374151;
      margin:16px 0 8px;
    }

    /* Game area wrapper: centred column, ads float left/right on large screens */
    .game-layout{
      width:100%;
      max-width:720px;
      margin:0 auto;
      position:relative;
    }

    /* Target chips */
    #targetWrap{
      width:100%;
      max-width:var(--gridW);
      margin:0 auto 8px;
      display:flex;
      justify-content:center;
    }
    #target{
      display:inline-flex;
      gap:1px;
      background:var(--cell-bg);
      color:#fff;
      padding:2px;
      border-radius:6px;
      min-height:34px;
      align-items:center;
    }
    #target span{
      width:30px;height:30px;
      display:grid;place-items:center;
      font-weight:800;
      border:1px solid rgba(255,255,255,.12);
    }

    /* GRID */
    #grid{
      position:relative;
      display:grid;
      grid-template-columns:repeat(8,1fr);
      grid-template-rows:repeat(10,1fr);
      gap:0;
      background:#fff;
      border:var(--line) solid #0c4a3e;
      border-radius:8px;
      overflow:hidden;
      width:var(--gridW);
      height:400px;
      margin:10px auto 8px;
    }
    #grid::after{
      content:'';
      position:absolute;
      inset:0;
      pointer-events:none;
      z-index:5;
      background:
        repeating-linear-gradient(to right,
          transparent 0 calc(var(--cellSize) - var(--line)),
          rgba(255,255,255,.28) 0 var(--cellSize)),
        repeating-linear-gradient(to bottom,
          transparent 0 calc(var(--cellSize) - var(--line)),
          rgba(255,255,255,.28) 0 var(--cellSize));
    }
    .cell{
      position:relative;
      background:var(--cell-bg);
      transition:transform .15s ease-out,opacity .15s ease-out;
    }
    .cell.f{
      display:grid;place-items:center;
      color:#fff;font-weight:800;
      font-size:var(--cell-font);
      text-shadow:0 1px 1px rgba(0,0,0,.35);
    }
    .cell.pop{transform:scale(1.15);opacity:0;}

    /* Modal */
    #over{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background:rgba(0,0,0,.55);
      z-index:50;
    }
    .modal{
      background:#fff;
      border-radius:16px;
      box-shadow:0 20px 50px rgba(0,0,0,.2);
      width:min(92%,520px);
      padding:18px;
      text-align:center;
      border:1px solid #e5e7eb;
    }
    .btn{
      background:#1e3a8a;
      color:#fff;
      font-weight:700;
      padding:10px 16px;
      border-radius:10px;
    }
    .btn.gray{background:#6b7280}
    .btn:disabled{opacity:.6;cursor:not-allowed;}

    /* Controls */
    .controls{width:100%;max-width:calc(var(--gridW));margin:8px auto 0;}
    .arrow-row{display:grid;grid-template-columns:repeat(3,1fr);gap:.5rem;}
    .dir-btn{
      width:100%;
      aspect-ratio:1/1;
      min-width:56px;min-height:56px;
      display:flex;align-items:center;justify-content:center;
      background:#053a6b;color:#fff;
      border-radius:14px;
      font-weight:800;font-size:24px;
    }
    @media (min-width:460px){
      .dir-btn{min-width:64px;min-height:64px;font-size:26px}
    }
    @media (min-width:640px){
      .dir-btn{min-width:72px;min-height:72px;font-size:28px}
    }

    .pill{
      background:#0c4a3e;
      color:#fff;
      font-weight:700;
      padding:6px 10px;
      border-radius:8px;
      text-align:center;
    }
    #leaderboardList li{
      padding:.35rem .5rem;
      border-radius:.375rem;
      display:flex;
      gap:.5rem;
      align-items:center;
      justify-content:space-between;
    }
    #leaderboardList li:nth-child(odd){background:#f3f4f6;}
    #leaderboardList li:first-child{
      background:#d1fae5;
      font-weight:700;
    }

       /* Medalje key + badge pills */
    #medalKey{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background:rgba(0,0,0,.55);
      z-index:55;
    }
    .badge-pill{
      display:inline-flex;
      align-items:center;
      border:1px solid #e5e7eb;
      background:#f1f5f9;
      color:#334155;
      font-weight:800;
      border-radius:999px;
      padding:.15rem .5rem;
      font-size:10px;
      line-height:1;
    }


    /* Share dropdown */
    .share-menu-local{
      background:#fff;
      border:1px solid #e5e7eb;
      box-shadow:0 8px 24px rgba(0,0,0,.12);
      border-radius:.5rem;
      width:240px;
      padding:.5rem;
      z-index:3000;
      line-height:1.25;
    }
    .share-menu-local button{
      width:100%;
      text-align:left;
      padding:.5rem .75rem;
      border-radius:.375rem;
      font-weight:600;
      line-height:1.25rem;
      display:flex;
      align-items:center;
      gap:.5rem;
      white-space:nowrap;
    }
    .share-menu-local button:hover{background:#f3f4f6;}

    /* ACTION BARS */
    .action-grid{
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:.5rem;
      justify-items:center;
      align-items:center;
    }
    .action-grid > a,
    .action-grid > button{
      display:grid;place-items:center;
      width:100%;aspect-ratio:1/1;
      max-width:120px;
      padding:0;margin:0;
      background:transparent !important;
      border:0;border-radius:0;line-height:0;
      box-shadow:none;cursor:pointer;
    }
    .btn-img{
      width:100%;height:100%;
      display:block;object-fit:contain;
      border-radius:0;
      box-shadow:0 6px 15px rgba(0,0,0,.25);
    }
    .btn-img:hover{
      transform:translateY(-1px);
      filter:brightness(1.02);
    }
    .btn-img:active{
      transform:translateY(0);
      filter:brightness(.98);
    }

    /* N-R gate */
    #nrGate{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background:rgba(0,0,0,.55);
      z-index:60;
    }
  </style>
</head>
<body class="min-h-screen flex flex-col">
  <!-- HEADER -->
  <header>
    <div class="logo-container" aria-label="BLITSTIEK">
      <div class="letter-box">B</div><div class="letter-box">L</div>
      <div class="letter-box">I</div><div class="letter-box">T</div>
      <div class="letter-box">S</div><div class="letter-box">T</div>
      <div class="letter-box">I</div><div class="letter-box">E</div>
      <div class="letter-box">K</div>
    </div>
    <p class="welcome" id="welcomeLine">
      Welkom terug, <span id="playerName" class="font-semibold text-green-700">Speler</span>!
    </p>
  </header>

  <main class="flex-1">
    <div class="max-w-5xl mx-auto px-4 py-4">

      <!-- Game layout: centred column; desktop Brandkop ads float left/right -->
      <div class="game-layout">
        <!-- DESKTOP Brandkop ad, left -->
        <div id="desktopAdLeft" class="hidden lg:block absolute -left-[340px]">
          <div class="bg-white shadow-md rounded-lg p-2 flex flex-col items-center border border-slate-200">
            <div class="text-[10px] tracking-[0.2em] text-slate-500 uppercase mb-1 text-center">
              ADVERTENSIE
            </div>
            <a href="https://www.brandkopnc.co.za/" target="_blank" rel="noopener"
               class="inline-block rounded overflow-hidden">
              <img
                src="/assets/brandkop-300x250.png"
                alt="Brandkop advertensie"
                class="block w-[300px] max-w-full h-auto">
            </a>
          </div>
        </div>

        <!-- DESKTOP Brandkop ad, right -->
        <div id="desktopAdRight" class="hidden lg:block absolute -right-[340px]">
          <div class="bg-white shadow-md rounded-lg p-2 flex flex-col items-center border border-slate-200">
            <div class="text-[10px] tracking-[0.2em] text-slate-500 uppercase mb-1 text-center">
              ADVERTENSIE
            </div>
            <a href="https://www.brandkopnc.co.za/" target="_blank" rel="noopener"
               class="inline-block rounded overflow-hidden">
              <img
                src="/assets/brandkop-300x250.png"
                alt="Brandkop advertensie"
                class="block w-[300px] max-w-full h-auto">
            </a>
          </div>
        </div>

        <!-- Main game column (centred) -->
        <div class="max-w-xl mx-auto">
          <div class="headline">TEIKENWOORD:</div>
          <div id="targetWrap"><div id="target"><span>‚Äî</span></div></div>

          <!-- GAME card -->
          <section class="card p-4">
            <div class="relative">
              <div id="grid"></div>

              <!-- Success modal -->
              <div id="over">
                <div class="modal">
                  <p id="winMsg" class="mb-3 text-base"></p>
                  <div class="actions" style="display:flex;gap:.75rem;justify-content:center;margin-top:12px;">
                    <button id="modalShareBtn" type="button" class="btn">DEEL</button>
                    <button id="modalCloseBtn" type="button" class="btn gray">SLUIT</button>
                  </div>
                  <div id="shareMenu" class="hidden share-menu-local mx-auto mt-2">
                    <div class="px-2 pb-1 text-xs uppercase tracking-wide text-gray-500">Deel via</div>
                    <div class="space-y-1">
                      <button id="mWhatsApp" type="button">WhatsApp</button>
                      <button id="mCopy" type="button">Kopieer skakel</button>
                      <button id="mSystem" type="button">Stelsel-deel</button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- N-R gate -->
              <div id="nrGate">
                <div class="modal">
                  <h3 class="text-lg font-extrabold mb-1">WELKOM BY BLITSTIEK OP KRIPTIEK</h3>
                  <p class="text-sm text-gray-600 mb-3">Jou opsies:</p>
                  <div class="text-left space-y-2 text-gray-700">
                    <p><strong>1)</strong> Speel Blitstiek as 'n ongeregistreerde speler met beperkte funksies.</p>
                    <p><strong>2)</strong>
                      <a href="/register.html" class="underline" id="gateRegLink">Registreer</a>
                      sodat jy volle toegang tot alles op Kriptiek kan kry, insluitend Blitstiek.
                    </p>
                  </div>
                  <div class="flex gap-2 justify-center mt-4">
                    <button id="gateGuestBtn" class="btn">Speel sonder om te registreer</button>
                    <button id="gateRegBtn"   class="btn gray">Registreer</button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Arrows -->
            <div class="controls mt-3">
              <div class="arrow-row">
                <button id="btnLeft"  class="dir-btn" aria-label="Links">‚óÄ</button>
                <button id="btnDown"  class="dir-btn" aria-label="Laat val">‚ñº</button>
                <button id="btnRight" class="dir-btn" aria-label="Regs">‚ñ∂</button>
              </div>
            </div>

            <!-- Start/Pause + Sticky share -->
            <div class="controls mt-3 flex items-center justify-center gap-2">
              <button id="btnStart" class="btn">BEGIN</button>
              <button id="btnPause" class="btn gray">POUSE</button>

              <div class="relative">
                <button id="stickyShareBtn" class="btn hidden">DEEL</button>
                <div id="stickyShareMenu" class="hidden share-menu-local absolute left-1/2 -translate-x-1/2 mt-2">
                  <div class="px-2 pb-1 text-xs uppercase tracking-wide text-gray-500">Deel via</div>
                  <div class="space-y-1">
                    <button id="sWhatsApp" type="button">WhatsApp</button>
                    <button id="sCopy" type="button">Kopieer skakel</button>
                    <button id="sSystem" type="button">Stelsel-deel</button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Timers -->
            <div class="controls grid grid-cols-2 gap-2 mt-3">
              <div id="timeBox" class="pill">Jou tyd: <b>00:00</b></div>
              <div id="bestBox" class="pill">Beste tyd: <b>--:--</b></div>
            </div>

            <!-- ACTION BARS -->
            <div class="controls mt-3" id="actionBars">
              <!-- Guests -->
              <div id="barNR" class="action-grid">
                <a href="/register.html" title="Registreer">
                  <img class="btn-img" src="/assets/K_REGISTREER_12SEP.png" alt="Registreer" width="120" height="120">
                </a>
                <a href="/forum.html" title="Gesels saam">
                  <img class="btn-img" src="/assets/K_GESELS_12SEP.png" alt="Gesels" width="120" height="120">
                </a>
                <div class="relative share-tile-wrap">
                  <button type="button" class="share-tile" title="Deel">
                    <img class="btn-img" src="/assets/SHARE_12SEP.png" alt="Deel" width="120" height="120">
                  </button>
                  <div class="hidden share-menu-local absolute left-1/2 -translate-x-1/2 mt-2">
                    <div class="px-2 pb-1 text-xs uppercase tracking-wide text-gray-500">Deel via</div>
                    <div class="space-y-1">
                      <button class="wa"  type="button">WhatsApp</button>
                      <button class="copy" type="button">Kopieer skakel</button>
                      <button class="sys"  type="button">Stelsel-deel</button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Registered -->
              <div id="barR" class="action-grid hidden">
                <a href="/forum.html" title="Gesels saam">
                  <img class="btn-img" src="/assets/K_GESELS_12SEP.png" alt="Gesels" width="120" height="120">
                </a>
                <a href="/blitstiek-argief.html" title="Blitstiek-argief">
                  <img class="btn-img" src="/assets/B_ARGIEF_12SEP.png" alt="B Argief" width="120" height="120">
                </a>
                <div class="relative share-tile-wrap">
                  <button type="button" class="share-tile" title="Deel">
                    <img class="btn-img" src="/assets/SHARE_12SEP.png" alt="Deel" width="120" height="120">
                  </button>
                  <div class="hidden share-menu-local absolute left-1/2 -translate-x-1/2 mt-2">
                    <div class="px-2 pb-1 text-xs uppercase tracking-wide text-gray-500">Deel via</div>
                    <div class="space-y-1">
                      <button class="wa"  type="button">WhatsApp</button>
                      <button class="copy" type="button">Kopieer skakel</button>
                      <button class="sys"  type="button">Stelsel-deel</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>
        </div><!-- /main game column -->
      </div><!-- /game-layout -->

      <!-- Centred column for all content below the game (FIXED WIDTH) -->
      <div class="max-w-xl mx-auto">

        <!-- HOE OM TE SPEEL -->
        <section class="mt-4 bg-white rounded shadow p-4">
          <h2 class="text-xl font-bold mb-2">HOE OM TE SPEEL</h2>
          <ol class="space-y-3 text-gray-700 leading-relaxed">
            <li>
              <p class="font-semibold">1. Doel</p>
              <p>Probeer om die <strong>teikenwoord</strong> boaan so vinnig as moontlik te vorm deur die vallende blokke, elkeen met 'n lukrake letter en kleur, links en regs te skuif voordat hulle onder land. Die teikenwoord moet in <strong>dieselfde horisontale ry</strong> gevorm word, sonder gapings of verkeerde letters. Laat val onnodige letters eenkant, of gebruik die blokre√´ls onder om hulle te laat verdwyn. Daar is <strong>elke dag ‚Äôn nuwe woord</strong>, wat soms minder maar nooit meer as 8 letters sal h√™ nie.</p>
            </li>
            <li>
              <p class="font-semibold">2. Kontroles</p>
              <p><strong>Fisieke toetsbord:</strong> Gebruik die pyltjies op jou toetsbord om die blokke links en regs te skuif, en die spasiebalk om die blok dadelik tot onder te laat val.</p>
              <p><strong>Raakskerm:</strong> Gebruik die pyltjies op die skerm om die blokke links en regs te skuif, en die af-pyltjie om die blok dadelik tot onder te laat val.</p>
            </li>
            <li>
              <p class="font-semibold">3. Wat gebeur wanneer blokke aan mekaar raak?</p>
              <ul class="list-disc pl-6">
                <li><strong>Dieselfde letter:</strong> As twee blokke met dieselfde LETTER langs of op mekaar tot stilstand kom, verdwyn albei.</li>
                <li><strong>Dieselfde kleur:</strong> As twee blokke met dieselfde KLEUR langs of op mekaar tot stilstand kom, verdwyn albei.</li>
                <li><strong>MAAR:</strong> 'n Blok met 'n letter wat in die teikenwoord is, verdwyn nooit nie.</li>
              </ul>
            </li>
            <li>
              <p class="font-semibold">4. Leierbord</p>
              <p>As jou tyd vinnig genoeg is, verskyn jou naam op die <strong>leierbord</strong>. Gebruik <strong>DEEL</strong> om jou vriende uit te daag en jou tyd te wys.</p>
            </li>
          </ol>
        </section>

        <!-- Buy Me a Coffee CTA (moved into HTML, centred) -->
        <section class="my-4">
          <div class="rounded-xl border border-slate-200 bg-white/90 shadow p-4 text-slate-800 text-center">
            <a href="https://www.buymeacoffee.com/kriptiek" target="_blank" rel="noopener"
               onclick="window.gtag && window.gtag('event','bmac_click',{from:'blitstiek-leaderboard'})"
               class="inline-flex items-center justify-center px-5 py-3 bg-yellow-500 hover:bg-yellow-600 text-white font-bold rounded-xl shadow-md transition duration-200"
               aria-label="Help ons om Kriptiek gratis te hou">
              <span>HELP ONS OM KRIPTIEK GRATIS TE HOU</span>
            </a>
          </div>
        </section>

        <!-- MOBILE Brandkop ad (centred, hidden on lg+) -->
        <section class="my-4 lg:hidden">
          <div class="flex justify-center">
            <div class="bg-white shadow-md rounded-lg p-2 flex flex-col items-center border border-slate-200">
              <div class="text-[10px] tracking-[0.2em] text-slate-500 uppercase mb-1 text-center">
                ADVERTENSIE
              </div>
              <a href="https://www.brandkopnc.co.za/" target="_blank" rel="noopener"
                 class="inline-block rounded overflow-hidden">
                <img
                  src="/assets/brandkop-300x250.png"
                  alt="Brandkop advertensie"
                  class="block w-[300px] max-w-full h-auto">
              </a>
            </div>
          </div>
        </section>

              <!-- LEADERBOARD -->
        <section class="card mt-6 p-4">
          <div class="flex items-center justify-between mb-2 gap-2">
            <h2 class="text-xl font-bold">VANDAG SE TOP-10 (die afsnypunt is om 23:55)</h2>
            <button id="medalKeyBtn" type="button"
              class="text-xs font-extrabold tracking-wide text-slate-600 hover:text-slate-800 underline">
              SLEUTEL
            </button>
          </div>

          <ul id="leaderboardList" class="text-gray-700 text-left"><li>Laai...</li></ul>

          <!-- MEDALJE SLEUTEL -->
          <div id="medalKey" aria-hidden="true">
            <div class="modal">
              <h3 class="text-lg font-extrabold mb-2">MEDALJE-SLEUTEL</h3>

              <div class="text-left text-sm text-gray-700 space-y-2 leading-relaxed">
                <p><span class="font-extrabold">‚≠ê</span> <strong>Ondersteuner</strong> (betaalde ondersteuner)</p>
                <p><span class="font-extrabold">üéÆ</span> <strong>Spele</strong>: hoeveel BLITSTIEK-dae jy al met ‚Äôn tyd voltooi het</p>
                <p><span class="font-extrabold">‚è±</span> <strong>Onder 1 minuut</strong>: hoeveel dae jy BLITSTIEK in minder as 1 minuut voltooi het</p>
              </div>

              <div class="flex justify-center mt-4">
                <button id="medalKeyCloseBtn" type="button" class="btn gray">SLUIT</button>
              </div>
            </div>
          </div>
        </section>


      </div><!-- /centred lower column -->
    </div>
  </main>

  <footer class="bg-white shadow p-4 text-center text-sm text-gray-500">
    &copy; 2025 Kriptiek. Alle regte voorbehou. |
    <a href="/index.html" class="underline">Tuis</a> |
    <a href="/profile.html" class="underline">My profiel</a> |
    <a href="/forum.html" class="underline">Gesels saam</a> |
    <a href="/privacy.html" class="underline">Privaatheidsbeleid</a> |
    <a href="/terms.html" class="underline">Voorwaardes</a> |
    <a href="/faq.html" class="underline">Gereelde vrae</a> |
    <a href="/about.html" class="underline">Oor Kriptiek</a> |
    <a href="/contact.html" class="underline">Kontak ons</a>
  </footer>
  <script type="module">
    // PART 3/5 (module)
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js';
    import {
           initializeFirestore, serverTimestamp, doc, getDoc, setDoc, deleteDoc,
      collection, query, orderBy, limit, getDocs, onSnapshot, where, increment, documentId

    } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js';

    /* ---- Firebase ---- */
    const firebaseConfig = {
      apiKey: "AIzaSyDH-nVvGkdaheH7pvRHH0M9TbW2f98lMGQ",
      authDomain: "kriptiek-c9ea2.firebaseapp.com",
      projectId: "kriptiek-c9ea2",
      storageBucket: "kriptiek-c9ea2.appspot.com",
      messagingSenderId: "620450620939",
      appId: "1:620450620939:web:e93a18ac23b53b33db890e"
    };

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    // Helps on networks/browsers that struggle with QUIC/streams.
    const db = initializeFirestore(app, {
      experimentalForceLongPolling: true,
      useFetchStreams: false
    });

    /* ---- DOM ---- */
    const welcomeLine = document.getElementById('welcomeLine');
    const playerNameEl = document.getElementById('playerName');
    const targetEl   = document.getElementById('target');
    const gridEl     = document.getElementById('grid');
    const over       = document.getElementById('over');
    const winMsg     = document.getElementById('winMsg');
    const modalShareBtn = document.getElementById('modalShareBtn');
    const modalCloseBtn = document.getElementById('modalCloseBtn');
    const shareMenu  = document.getElementById('shareMenu');

    const lbList     = document.getElementById('leaderboardList');
    const medalKeyBtn= document.getElementById('medalKeyBtn');
    const medalKey   = document.getElementById('medalKey');
    const medalKeyCloseBtn = document.getElementById('medalKeyCloseBtn');

    const timeText   = document.querySelector('#timeBox b');
    const bestText   = document.querySelector('#bestBox b');


    const btnLeft = document.getElementById('btnLeft');
    const btnRight= document.getElementById('btnRight');
    const btnDown = document.getElementById('btnDown');
    const btnStart= document.getElementById('btnStart');
    const btnPause= document.getElementById('btnPause');

    const stickyShareBtn   = document.getElementById('stickyShareBtn');
    const stickyShareMenu  = document.getElementById('stickyShareMenu');
    const sWA   = document.getElementById('sWhatsApp');
    const sCopy = document.getElementById('sCopy');
    const sSys  = document.getElementById('sSystem');
    const mWA   = document.getElementById('mWhatsApp');
    const mCopy = document.getElementById('mCopy');
    const mSys  = document.getElementById('mSystem');

    const barNR       = document.getElementById('barNR');
    const barR        = document.getElementById('barR');
    const nrGate      = document.getElementById('nrGate');
    const gateGuestBtn= document.getElementById('gateGuestBtn');
    const gateRegBtn  = document.getElementById('gateRegBtn');
    const gateRegLink = document.getElementById('gateRegLink');

    /* ---- Helpers ---- */
    const pad = n => String(n).padStart(2,'0');
    const fmt = s => s==null ? '--:--' : `${pad(Math.floor(s/60))}:${pad(s%60)}`;
    function nowZa(){
      const n=new Date(); const utc=n.getTime()+n.getTimezoneOffset()*60000;
      return new Date(utc + 120*60000);
    }
    const todayISO = () => { const d=nowZa(); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; };

    const qs = new URLSearchParams(location.search);
    const explicitId = qs.get('gameId');
    const SITE_ORIGIN = location.hostname.endsWith('kriptiek.com') ? location.origin : 'https://www.kriptiek.com';

    /* ---- Share helpers ---- */
    const shareKey = gid => `blitstiekShare:${gid}`;
    let stickyPayload = null;

    function buildShareUrl(gameId){
      const url = new URL('/blitstiek.html', SITE_ORIGIN);
      if (gameId) url.searchParams.set('gameId', gameId);
      return url.toString();
    }
    function shareTextLinkOnly(gid){
      return `Kom speel vandag se BLITSTIEK op Kriptiek: ${buildShareUrl(gid)}`;
    }
    function buildWinShareText(payload){
      const tt   = Number(payload?.time);
      const word = String(payload?.target || TARGET || '‚Äî').toUpperCase();
      return `Ek het ${word} op BLITSTIEK in ${fmt(tt)} gebou: ${buildShareUrl(GAME_ID)}`;
    }
    function currentShareText(){
      return (stickyPayload && Number.isFinite(Number(stickyPayload.time)))
        ? buildWinShareText(stickyPayload)
        : shareTextLinkOnly(GAME_ID);
    }

    /* ---- Leaderboard constants ---- */
    const LB_SIZE = 10;

        function escapeHtml(v){
      return String(v ?? "")
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }

    const BADGE_UNDER_S = 60; // < 1 minuut

    const supporterCache = new Map(); // uid -> boolean (active)

    function uniq(arr){
      return Array.from(new Set((arr || []).filter(Boolean)));
    }
    function chunk(arr, size){
      const out = [];
      for(let i=0;i<arr.length;i+=size) out.push(arr.slice(i,i+size));
      return out;
    }

    async function hydrateSupporterCache(uids){
      const list = uniq(uids);
      const missing = list.filter(uid => !supporterCache.has(uid));
      if(!missing.length) return;

      try{
        const colRef = collection(db,'supporters');
        for(const part of chunk(missing, 10)){
          const qy = query(colRef, where(documentId(), 'in', part));
          const snap = await getDocs(qy);

          // Default missing to false (not supporter)
          part.forEach(uid => supporterCache.set(uid, false));

          // Mark active supporters as true
          snap.docs.forEach(d => {
            const data = d.data() || {};
            supporterCache.set(d.id, data.active === true);
          });
        }
      }catch(e){
        console.warn('SUPPORTER_LOOKUP_FAILED', e);
        // Leave as unknown (no star) if lookup fails
      }
    }

    function renderSupporterStar(isSupporter){
      if (!isSupporter) return '';
      return '<span class="inline-block ml-1 align-middle text-yellow-400" aria-label="Ondersteuner">‚òÖ</span>';
    }

    function safeCount(n){
      const x = Number(n);
      if (!Number.isFinite(x)) return 0;
      return Math.max(0, Math.floor(x));
    }

    function renderBadgePills(playedCount, under1mCount){
      const p = safeCount(playedCount);
      const u = safeCount(under1mCount);

      const pills = [];
      if (p > 0) pills.push(`<span class="badge-pill" title="Spele">üéÆ ${p}</span>`);
      if (u > 0) pills.push(`<span class="badge-pill" title="Onder 1 minuut">‚è± ${u}</span>`);

      if (!pills.length) return '';
      return `<span class="inline-flex items-center gap-1 ml-2 align-middle">${pills.join('')}</span>`;
    }

    function isPastCutoffZa(){
      const d = nowZa();
      const h = d.getHours();
      const m = d.getMinutes();
      return (h > 23) || (h === 23 && m >= 55);
    }

    function canWriteForTodayGame(){
      return !!(user && GAME_ID && TODAY_ID && GAME_ID === TODAY_ID && !isPastCutoffZa());
    }


    /* ---- Mechanics ---- */
    const H = 10, W = 8;
    const COLORS = ['#2196f3','#f44336','#4caf50','#ffc107','#9c27b0','#003366','#009688'];
    const CONS   = 'BCDFGHJKLMNPQRSTVWXZ';
    const VOWS   = 'AEIOUY';

    /* ---- State ---- */
    let user=null;
    let currentUserName='Speler';
    let GAME_ID=null, TARGET='';
    let TODAY_ID=`Game${todayISO()}`;
    let IS_ARCHIVE=false;

    let grid=Array.from({length:H},()=>Array(W).fill(null));
    let cur=null, nxt=null;
    let paused=false, ended=false, moving=false;
    let t=0, tInt=null, gInt=null;
    let lbUnsub=null;

    /* ---- Username ---- */
    async function resolveUserName(u){
      try{
        const uref = doc(db,'users',u.uid);
        const snap = await getDoc(uref);
        if(snap.exists() && snap.data().userName){
          return String(snap.data().userName).slice(0,24);
        }
      }catch{}
      if (u.displayName) return String(u.displayName).slice(0,24);
      if (u.email){
        const local = u.email.split('@')[0];
        return local ? local.slice(0,24) : 'Speler';
      }
      return 'Speler';
    }

    /* ---- Auth ---- */
    onAuthStateChanged(auth, async (u)=>{
      user=u||null;
      if(user){
        currentUserName = await resolveUserName(user);
        playerNameEl.textContent = currentUserName;
        welcomeLine.style.display = '';
        barR.classList.remove('hidden');
        barNR.classList.add('hidden');
        hideNRGate();
      } else {
        currentUserName = 'Speler';
        playerNameEl.textContent = currentUserName;
        welcomeLine.style.display = 'none';
        barNR.classList.remove('hidden');
        barR.classList.add('hidden');
        showNRGate();
      }
    });

    /* ---- Pixel-perfect grid sizing ---- */
    function resizeGrid(){
      const wrap = gridEl.parentElement;
      const availCss = Math.min(320, Math.floor(wrap.clientWidth));
      const dpr = Math.max(1, window.devicePixelRatio || 1);
      const toDp   = vCss => Math.round(vCss * dpr);
      const toCss  = vDp  => vDp / dpr;
      const snapDp = vDp  => Math.floor(vDp / 8) * 8;

      const availDp   = toDp(availCss);
      const snappedDp = Math.max(toDp(240), snapDp(availDp));
      const quantW    = toCss(snappedDp);

      const cellCss = Math.floor(quantW / 8);
      const quantH  = cellCss * 10;

      document.documentElement.style.setProperty('--cellSize', `${cellCss}px`);
      const lineCss = 1 / dpr;
      document.documentElement.style.setProperty('--line', `${lineCss}px`);

      gridEl.style.width  = quantW + 'px';
      gridEl.style.height = quantH + 'px';
      document.documentElement.style.setProperty('--gridW', quantW + 'px');

      const glyph = Math.max(15, Math.min(28, Math.round(cellCss * 0.50)));
      document.documentElement.style.setProperty('--cell-font', glyph + 'px');
    }

    function alignDesktopAds(){
      const layout = document.querySelector('.game-layout');
      const gridEl2 = document.getElementById('grid');
      const leftAd  = document.getElementById('desktopAdLeft');
      const rightAd = document.getElementById('desktopAdRight');
      if (!layout || !gridEl2) return;

      const layoutRect = layout.getBoundingClientRect();
      const gridRect   = gridEl2.getBoundingClientRect();
      const offset     = gridRect.top - layoutRect.top;

      if (offset >= 0 && offset < 2000){
        if (leftAd)  leftAd.style.top  = offset + 'px';
        if (rightAd) rightAd.style.top = offset + 'px';
      }
    }

    function handleResize(){
      resizeGrid();
      alignDesktopAds();
    }
    window.addEventListener('resize', handleResize);
    // PART 4/5 (module continuation)

    /* ---- Grid rendering ---- */
    function drawGrid(){
      gridEl.innerHTML='';
      for(let y=0;y<H;y++) for(let x=0;x<W;x++){
        const d=document.createElement('div'); d.className='cell'; d.dataset.x=x; d.dataset.y=y;
        gridEl.appendChild(d);
      }
      resizeGrid();
      alignDesktopAds();
    }

    function drawBlock(b){
      if(!b||b.x<0||b.x>=W||b.y<0||b.y>=H) return;
      const c=gridEl.querySelector(`.cell[data-x="${b.x}"][data-y="${b.y}"]`);
      if(!c) return;
      c.className='cell f'; c.style.background=b.color; c.textContent=b.letter;
    }

    function clearBlock(b){
      if(!b) return;
      const c=gridEl.querySelector(`.cell[data-x="${b.x}"][data-y="${b.y}"]`);
      if(!c) return;
      c.className='cell'; c.style.background='var(--cell-bg)'; c.textContent='';
    }

    const partOfTarget = L => TARGET.includes(L);
    const collide = b => !b || b.x<0||b.x>=W||b.y>=H || (b.y>=0 && grid[b.y][b.x]);

    function createBlock(){
      const color = COLORS[Math.floor(Math.random()*COLORS.length)];
      const letter = Math.random()<0.3 ? VOWS[Math.floor(Math.random()*VOWS.length)]
                                       : CONS[Math.floor(Math.random()*CONS.length)];
      return { color, letter, x:Math.floor(W/2), y:0 };
    }

    async function move(dx,dy){
      if(!cur||paused||ended||moving) return;
      moving = true;
      clearBlock(cur);
      const test = { ...cur, x:cur.x+dx, y:cur.y+dy };
      if(!collide(test)){ cur=test; drawBlock(cur); }
      else if(dy>0){ drawBlock(cur); place(); }
      else{ drawBlock(cur); }
      moving = false;
    }

    function hardDrop(){
      if(!cur||paused||ended) return;
      clearBlock(cur);
      while(cur.y<H-1 && !collide({...cur,y:cur.y+1})) cur.y++;
      place();
    }

    async function place(){
      if(!cur||cur.y<0) return;
      grid[cur.y][cur.x]={...cur}; drawBlock(cur);
      await matchAndDrop();
      await checkWin();
      cur=nxt; nxt=createBlock();
      if(cur) drawBlock(cur);
    }

    async function matchAndDrop(){
      const del=new Set();
      for(let y=0;y<H;y++) for(let x=0;x<W;x++){
        const a=grid[y][x]; if(!a||partOfTarget(a.letter)) continue;
        for(const [dx,dy] of [[1,0],[0,1],[-1,0],[0,-1]]){
          const nx=x+dx, ny=y+dy; if(nx<0||nx>=W||ny<0||ny>=H) continue;
          const b=grid[ny][nx]; if(!b||partOfTarget(b.letter)) continue;
          if(a.letter===b.letter || a.color===b.color){ del.add(`${x},${y}`); del.add(`${nx},${ny}`); }
        }
      }
      if(!del.size) return;

      await Promise.all(Array.from(del).map(key=>new Promise(res=>{
        const [x,y]=key.split(',').map(Number);
        const c=gridEl.querySelector(`.cell[data-x="${x}"][data-y="${y}"]`);
        if(c){ c.classList.add('pop'); setTimeout(()=>{ c.classList.remove('pop'); res(); },150);} else res();
        grid[y][x]=null;
      })));

      for(let x=0;x<W;x++){
        let wY=H-1;
        for(let y=H-1;y>=0;y--){
          if(grid[y][x]){
            if(y!==wY){ grid[wY][x]=grid[y][x]; grid[y][x]=null; }
            wY--;
          }
        }
      }

      for(let y=0;y<H;y++) for(let x=0;x<W;x++){
        const c=gridEl.querySelector(`.cell[data-x="${x}"][data-y="${y}"]`);
        c.className='cell'; c.style.background='var(--cell-bg)'; c.textContent='';
        if(grid[y][x]) drawBlock({...grid[y][x],x,y});
      }
    }

    async function checkWin(){
      if(!TARGET) return;
      for(let y=0;y<H;y++) for(let x=0;x<=W-TARGET.length;x++){
        let ok=true;
        for(let i=0;i<TARGET.length;i++){
          const g=grid[y][x+i];
          if(!g || g.letter!==TARGET[i]){ ok=false; break; }
        }
        if(ok){
          for(let i=0;i<TARGET.length;i++){
            const c=gridEl.querySelector(`.cell[data-x="${x+i}"][data-y="${y}"]`);
            if(c) c.style.transform='scale(1.05)';
          }
          setTimeout(()=>end(true), 450);
          return;
        }
      }
    }

    function setTime(v){ t=v; timeText.textContent=fmt(v); }

    function start(){
      ended=false;
      over.style.display='none';
      shareMenu.classList.add('hidden');
      stickyShareMenu.classList.add('hidden');
      setTime(0);

      grid=Array.from({length:H},()=>Array(W).fill(null));
      drawGrid();
      cur=createBlock(); nxt=createBlock(); drawBlock(cur);

      paused=false;
      btnPause.textContent='POUSE';

      clearInterval(tInt); clearInterval(gInt);
      gInt=setInterval(()=>{ if(!paused && !ended) move(0,1); },1000);
      tInt=setInterval(()=>{ if(!paused && !ended) setTime(t+1); },1000);
    }

    function togglePause(){
      if(ended) return;
      paused=!paused;
      btnPause.textContent = paused ? 'HERVAT' : 'POUSE';
    }

    /* ---- N-R gate ---- */
    let guestGateBypassOnce = false;
    function showNRGate(){ nrGate.style.display='flex'; }
    function hideNRGate(){ nrGate.style.display='none'; }
    function chooseGuest(){ guestGateBypassOnce = true; hideNRGate(); window.focus?.(); }

    function goRegister(){
      const returnUrl = location.pathname + location.search;
      sessionStorage.setItem('returnAfterAuth', returnUrl);
      location.href = `/register.html?return=${encodeURIComponent(returnUrl)}`;
    }

    gateGuestBtn.addEventListener('click', chooseGuest);
    gateRegBtn  .addEventListener('click', goRegister);
    gateRegLink .addEventListener('click', (e)=>{ e.preventDefault(); goRegister(); });

    btnStart.addEventListener('click', ()=>{
      if(!user && !guestGateBypassOnce){ showNRGate(); return; }
      guestGateBypassOnce=false; window.focus?.(); start();
    });

    /* ---- Keyboard controls ---- */
    window.addEventListener('keydown', (e) => {
      const modalOpen = over && over.style.display === 'flex';
      if (modalOpen) return;

      const tag = (document.activeElement && document.activeElement.tagName) || '';
      if (['INPUT','TEXTAREA','SELECT'].includes(tag)) return;

      const gateOpen = nrGate && nrGate.style.display === 'flex';
      const isGameplayKey = (
        e.key === 'ArrowLeft' || e.key === 'ArrowRight' || e.key === 'ArrowDown' ||
        e.key === ' ' || e.key === 'Spacebar' || e.key === 'p' || e.key === 'P'
      );

      if (gateOpen && isGameplayKey) {
        e.preventDefault();
        chooseGuest();
        if (!cur) start();
      }

      switch (e.key) {
        case 'ArrowLeft':  e.preventDefault(); move(-1, 0); break;
        case 'ArrowRight': e.preventDefault(); move( 1, 0); break;
        case 'ArrowDown':
        case ' ':
        case 'Spacebar':   e.preventDefault(); hardDrop();  break;
        case 'p':
        case 'P':          e.preventDefault(); togglePause(); break;
      }
    });

    btnPause.addEventListener('click', ()=>togglePause());
    btnLeft .addEventListener('click', ()=>move(-1,0));
    btnRight.addEventListener('click', ()=>move(1,0));
    btnDown .addEventListener('click', ()=>hardDrop());
    // PART 5/5 (module continuation)

    /* ---- Share (modal & sticky & tile) ---- */
    function toggleShareMenu(){ shareMenu.classList.toggle('hidden'); }
    modalShareBtn.addEventListener('click', (e)=>{ e.stopPropagation(); toggleShareMenu(); });

    document.addEventListener('click', (e)=>{
      if(shareMenu && !shareMenu.contains(e.target) && e.target!==modalShareBtn){ shareMenu.classList.add('hidden'); }
      if(stickyShareMenu && !stickyShareMenu.contains(e.target) && e.target!==stickyShareBtn){ stickyShareMenu.classList.add('hidden'); }
      document.querySelectorAll('#actionBars .share-menu-local').forEach(m=>{ if(!m.contains(e.target)) m.classList.add('hidden'); });
    });
    window.addEventListener('scroll',  ()=>{ shareMenu.classList.add('hidden'); stickyShareMenu.classList.add('hidden'); document.querySelectorAll('#actionBars .share-menu-local').forEach(m=>m.classList.add('hidden')); });
    window.addEventListener('resize',  ()=>{ shareMenu.classList.add('hidden'); stickyShareMenu.classList.add('hidden'); document.querySelectorAll('#actionBars .share-menu-local').forEach(m=>m.classList.add('hidden')); });

    async function trySystemShare(text){
      try{
        const res = await fetch(`${SITE_ORIGIN}/assets/BLITSTIEK_12SEP.png`);
        const blob = await res.blob();
        const files = [new File([blob],'BLITSTIEK.png',{type:blob.type})];
        if(navigator.canShare && navigator.canShare({files})){
          await navigator.share({ title:'BLITSTIEK ‚Äì Kriptiek', text, files });
          return true;
        }
      }catch{}
      try{
        if(navigator.share){ await navigator.share({ text }); return true; }
      }catch{}
      return false;
    }

    function openWhatsApp(text){
      const url = `https://wa.me/?text=${encodeURIComponent(text)}`;
      const w = window.open(url,'_blank','noopener,noreferrer');
      if(!w && navigator.clipboard){ navigator.clipboard.writeText(text).then(()=>alert("Skakel gekopieer!")); }
    }

    mWA.onclick   = () => { openWhatsApp(currentShareText()); shareMenu.classList.add('hidden'); };
    mCopy.onclick = async () => {
      try{ await navigator.clipboard.writeText(currentShareText()); alert('Skakel gekopieer!'); }catch{}
      shareMenu.classList.add('hidden');
    };
    mSys.onclick  = async () => {
      const ok = await trySystemShare(currentShareText());
      if(!ok) openWhatsApp(currentShareText());
      shareMenu.classList.add('hidden');
    };

    sWA.onclick   = () => { openWhatsApp(currentShareText()); stickyShareMenu.classList.add('hidden'); };
    sCopy.onclick = async () => {
      try{ await navigator.clipboard.writeText(currentShareText()); alert('Skakel gekopieer!'); }catch{}
      stickyShareMenu.classList.add('hidden');
    };
    sSys.onclick  = async () => {
      const ok = await trySystemShare(currentShareText());
      if(!ok) openWhatsApp(currentShareText());
      stickyShareMenu.classList.add('hidden');
    };

    function enableStickyShare(payload){
      stickyPayload = { time: Number(payload?.time ?? t), target: TARGET };
      stickyShareBtn.classList.remove('hidden');
      stickyShareBtn.onclick = (e)=>{ e.stopPropagation(); stickyShareMenu.classList.toggle('hidden'); };
      try{
        localStorage.setItem(shareKey(GAME_ID), JSON.stringify({ ...stickyPayload, at: Date.now() }));
      }catch{}
    }

    function maybeEnableStickyShareFromStorage(){
      try{
        const raw = localStorage.getItem(shareKey(GAME_ID));
        if(!raw) return;
        const saved = JSON.parse(raw);
        if(saved && Number.isFinite(saved.time) && saved.target){
          stickyPayload = { time:saved.time, target:saved.target };
          stickyShareBtn.classList.remove('hidden');
          stickyShareBtn.onclick = (e)=>{ e.stopPropagation(); stickyShareMenu.classList.toggle('hidden'); };
        }
      }catch{}
    }

    function wireShareTile(wrapper){
      const btn  = wrapper.querySelector('.share-tile');
      const menu = wrapper.querySelector('.share-menu-local');
      const wa   = menu.querySelector('button.wa');
      const cp   = menu.querySelector('button.copy');
      const sys  = menu.querySelector('button.sys');
      btn.addEventListener('click', (e)=>{
        e.preventDefault(); e.stopPropagation();
        document.querySelectorAll('#actionBars .share-menu-local').forEach(m=>{ if(m!==menu) m.classList.add('hidden'); });
        menu.classList.toggle('hidden');
      });
      const txt = () => currentShareText();
      wa.onclick = () => { openWhatsApp(txt()); menu.classList.add('hidden'); };
      cp.onclick = async () => { try{ await navigator.clipboard.writeText(txt()); alert('Skakel gekopieer!'); }catch{} menu.classList.add('hidden'); };
      sys.onclick = async () => { const ok = await trySystemShare(txt()); if(!ok) openWhatsApp(txt()); menu.classList.add('hidden'); };
    }

    function initTileShareDropdowns(){
      document.querySelectorAll('.share-tile-wrap').forEach(wireShareTile);
    }
    initTileShareDropdowns();

        /* ---- Medalje sleutel ---- */
    function openMedalKey(){
      if (medalKey) medalKey.style.display = 'flex';
    }
    function closeMedalKey(){
      if (medalKey) medalKey.style.display = 'none';
    }
    if (medalKeyBtn){
      medalKeyBtn.addEventListener('click', (e)=>{ e.stopPropagation(); openMedalKey(); });
    }
    if (medalKeyCloseBtn){
      medalKeyCloseBtn.addEventListener('click', closeMedalKey);
    }
    if (medalKey){
      medalKey.addEventListener('click', (e)=>{ if (e.target === medalKey) closeMedalKey(); });
    }


       /* ---- Leaderboard submit (badges + cutoff gate) ---- */
    async function bumpBadgesAndGetTotals(newTime){
      const userRef = doc(db,'users', user.uid);
      const playRef = doc(db,'userGames', user.uid, 'blitstiekPlays', GAME_ID);

      const under = Number.isFinite(newTime) && newTime < BADGE_UNDER_S;

      try{
        const playSnap = await getDoc(playRef);
        const pdata = playSnap.exists() ? (playSnap.data() || {}) : {};

        const incPlayed = (pdata.countedPlayed !== true);
        const incUnder  = (under && pdata.countedUnder1m !== true);

        const prevBest = Number(pdata.bestTime);
        const bestTime = (!Number.isFinite(prevBest) || newTime < prevBest) ? newTime : prevBest;

        await setDoc(playRef, {
          bestTime,
          countedPlayed: true,
          countedUnder1m: under ? true : (pdata.countedUnder1m === true),
          updatedAt: serverTimestamp()
        }, { merge:true });

        if (incPlayed || incUnder){
          const upd = { updatedAt: serverTimestamp() };
          if (incPlayed) upd.blitstiekPlayedTotal = increment(1);
          if (incUnder)  upd.blitstiekUnder1mTotal = increment(1);
          await setDoc(userRef, upd, { merge:true });
        }

        const uSnap = await getDoc(userRef);
        const udata = uSnap.exists() ? (uSnap.data() || {}) : {};
        return {
          playedTotal: Number(udata.blitstiekPlayedTotal || 0),
          under1mTotal: Number(udata.blitstiekUnder1mTotal || 0)
        };
      }catch(e){
        console.warn('BADGE_UPDATE_FAILED', e);
        return null;
      }
    }

    async function submitTimeToBoard(){
      if(!user) return;

      // Hard gate: only today's game, only before 23:55 (ZA)
      if(!canWriteForTodayGame()) return;

      const name    = currentUserName.slice(0,24);
      const newTime = Number(t);

      const runsCol = collection(db,'blitstiekGames', GAME_ID, 'runs');
      const bestRef = doc(db,'blitstiekGames', GAME_ID, 'leaderboard', user.uid);

      // Update totals (private) and get snapshot counts for this leaderboard row (public)
      const totals = await bumpBadgesAndGetTotals(newTime);

      try{
        const bestSnap = await getDoc(bestRef);
        const prev = bestSnap.exists() ? Number(bestSnap.data().time) : null;
        const improve = (prev == null || !Number.isFinite(prev) || newTime < prev);

        const payload = { userName: name };
        if (improve){
          payload.time = newTime;
          payload.timestamp = serverTimestamp();
        }
        if (totals){
          payload.badgePlayed  = Number(totals.playedTotal || 0);
          payload.badgeUnder1m = Number(totals.under1mTotal || 0);
        }

        await setDoc(bestRef, payload, { merge:true });
      }catch(e){
        console.warn('BEST_UPDATE_FAILED', e);
      }

      try{
        await setDoc(doc(runsCol), {
          uid: user.uid,
          userName: name,
          time: newTime,
          timestamp: serverTimestamp()
        });

        const qy = query(runsCol, where('uid','==', user.uid), orderBy('timestamp','desc'), limit(50));
        const snap = await getDocs(qy);
        const toDelete = snap.docs.slice(10);
        await Promise.all(toDelete.map(d => deleteDoc(d.ref)));
      }catch(e){
        console.warn('RUN_APPEND/TRIM_FAILED', e);
      }
    }

      if(!user) return;
      const name    = currentUserName.slice(0,24);
      const newTime = Number(t);

      const runsCol = collection(db,'blitstiekGames', GAME_ID, 'runs');
      const bestRef = doc(db,'blitstiekGames', GAME_ID, 'leaderboard', user.uid);

      try {
        const bestSnap = await getDoc(bestRef);
        const prev = bestSnap.exists() ? Number(bestSnap.data().time) : null;
        if (prev == null || !Number.isFinite(prev) || newTime < prev){
          await setDoc(bestRef, {
            userName: name,
            time: newTime,
            timestamp: serverTimestamp()
          }, { merge:true });
        } else {
          await setDoc(bestRef, { userName: name }, { merge: true });
        }
      } catch (e) { console.warn('BEST_UPDATE_FAILED', e); }

      try {
        await setDoc(doc(runsCol), {
          uid: user.uid,
          userName: name,
          time: newTime,
          timestamp: serverTimestamp()
        });
        const qy = query(runsCol, where('uid','==', user.uid), orderBy('timestamp','desc'), limit(50));
        const snap = await getDocs(qy);
        const toDelete = snap.docs.slice(10);
        await Promise.all(toDelete.map(d => deleteDoc(d.ref)));
      } catch (e) { console.warn('RUN_APPEND/TRIM_FAILED', e); }
    }

    /* ---- LIVE Leaderboard (supporter star + badge counts) ---- */
    function startLiveLeaderboard(){
      if(lbUnsub) { lbUnsub(); lbUnsub=null; }

      const qy = query(
        collection(db,'blitstiekGames', GAME_ID, 'leaderboard'),
        orderBy('time','asc'),
        limit(25)
      );

      lbUnsub = onSnapshot(qy, (snap)=>{
        void (async ()=>{
          lbList.innerHTML = '';

          if (snap.empty) {
            bestText.textContent='--:--';
            lbList.innerHTML = `<li class="bg-green-100 font-medium"><span>Jy kan eerste op die leierbord wees!</span></li>`;
            return;
          }

          const rows = snap.docs.map(d => ({ id: d.id, ...d.data() }));
          rows.sort((a,b)=>{
            const ta = Number(a.time) || Infinity;
            const tb = Number(b.time) || Infinity;
            if (ta !== tb) return ta - tb;
            const sa = a.timestamp?.toMillis?.() ? a.timestamp.toMillis() : 9e15;
            const sb = b.timestamp?.toMillis?.() ? b.timestamp.toMillis() : 9e15;
            return sa - sb;
          });

          const top = rows.slice(0,LB_SIZE);
          if (top.length) bestText.textContent = fmt(Number(top[0].time));

          await hydrateSupporterCache(top.map(r => r.id));

          top.forEach(v => {
            const you = user && v.id === user.uid ? ' <span class="text-xs text-emerald-700 font-bold">(jy)</span>' : '';
            const safeName = escapeHtml(v.userName || 'Onbekend');

            const isSupporter = supporterCache.get(v.id) === true;
            const star = renderSupporterStar(isSupporter);

            const badges = renderBadgePills(v.badgePlayed, v.badgeUnder1m);

            const li = document.createElement('li');
            li.innerHTML = `<span><strong>${safeName}</strong>${star}${badges}${you}: ${fmt(Number(v.time))}</span><span></span>`;
            lbList.appendChild(li);
          });
        })();
      }, (err) => {
        console.warn('Leaderboard stream error:', err);
        const msg = (err && (err.code || err.message)) ? ` ‚Äì ${err.code||err.message}` : '';
        lbList.innerHTML = `<li class="px-2 py-1 rounded bg-red-50 text-red-700">Kon nie leierbord laai nie${msg}.</li>`;
      });
    }


    /* ---- Dynamic resolver ---- */
    async function resolveGameId(){
      if (explicitId) return explicitId;
      const todayId = `Game${todayISO()}`;
      try {
        const todaySnap = await getDoc(doc(db,'blitstiekGames',todayId));
        if (todaySnap.exists()) return todayId;
      } catch {}
      try {
        const gamesRef = collection(db,'blitstiekGames');
        let q1 = query(gamesRef, where('status','==','active'), orderBy('createdAt','desc'), limit(1));
        let qs1 = await getDocs(q1);
        if (!qs1.empty) return qs1.docs[0].id;
        let q2 = query(gamesRef, orderBy('createdAt','desc'), limit(1));
        let qs2 = await getDocs(q2);
        if (!qs2.empty) return qs2.docs[0].id;
      } catch {}
      return null;
    }

    /* ---- Load game ---- */
    async function loadGame(){
      GAME_ID = await resolveGameId();

      try {
        if (GAME_ID) {
          const urlObj = new URL(window.location.href);
          urlObj.searchParams.set('gameId', GAME_ID);
          urlObj.hash = '';
          const hasQuery = urlObj.searchParams.toString();
          const canonical = hasQuery ? `${urlObj.pathname}?${hasQuery}` : urlObj.pathname;
          const current = window.location.pathname + window.location.search;
          if (current !== canonical) history.replaceState(null, '', canonical);
        }
      } catch {}

      TODAY_ID = `Game${todayISO()}`;
      IS_ARCHIVE = !!(GAME_ID && GAME_ID !== TODAY_ID);

      if(!GAME_ID){
        targetEl.innerHTML = `<span>‚Äî</span>`;
        drawGrid();
        lbList.innerHTML = `<li class="text-red-600">Geen spel beskikbaar nie.</li>`;
        return;
      }

      const snap = await getDoc(doc(db,'blitstiekGames',GAME_ID));
      if(!snap.exists()){
        targetEl.innerHTML = `<span>‚Äî</span>`;
        drawGrid();
        lbList.innerHTML = `<li class="text-red-600">Kon nie spel laai nie.</li>`;
        return;
      }

      const data=snap.data();
      TARGET=(data.word||'').toUpperCase();

      targetEl.innerHTML='';
      (TARGET || '‚Äî').split('').forEach(ch=>{ const s=document.createElement('span'); s.textContent=ch; targetEl.appendChild(s); });

      grid = Array.from({length:H},()=>Array(W).fill(null));
      drawGrid();

      maybeEnableStickyShareFromStorage();

      if(user){
        try{
          const my = await getDoc(doc(db,'blitstiekGames', GAME_ID, 'leaderboard', user.uid));
          if(my.exists()){
            const v = my.data();
            enableStickyShare({ time: v.time, target: TARGET });
          }
        }catch{}
      }

      startLiveLeaderboard();
    }

    /* ---- Finish ---- */
    async function end(win){
      ended=true; clearInterval(tInt); clearInterval(gInt);
      if(!win) return;

      await submitTimeToBoard();
      enableStickyShare({ time: t, target: TARGET });

      winMsg.innerHTML = `Veels geluk, <strong>${currentUserName}</strong>, jy het <strong>${TARGET}</strong> in <strong>${fmt(t)}</strong> voltooi!`;
      over.style.display='flex';
      modalCloseBtn.onclick = ()=>{ over.style.display='none'; };

      if(!user) showNRGate();
    }

    await loadGame();
  </script>

</body>
</html>
