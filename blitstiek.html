<!DOCTYPE html>
<html lang="af">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
  <title>BLITSTIEK · Kriptiek</title>

  <!-- Tailwind + Font -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&display=swap" rel="stylesheet" />

  <style>
    :root{
      --brand-dark:#0f2a43;
      --btn:#003366;
      --board-cell:#004d40;   /* Lexispeed-like cell color */
      --board-line:#004d40;   /* grid border/lines */
    }
    html,body{ height:100%; }
    body{ font-family:'Montserrat',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:#f7fafc; }

    /* Kriptiek tiles (like Dilemma) */
    .logo-tile{ background:#374151; color:#fff; border:2px solid #1f2937; border-radius:.375rem; }
    .flipped-k{ transform:scaleX(-1); }

    /* Cards like Dilemma */
    .card{ background:#fff; border:1px solid #e5e7eb; border-radius:16px; box-shadow:0 2px 8px rgba(0,0,0,.05); }

    /* Pills */
    .pill{ background:#f3f4f6; color:#374151; padding:.4rem .7rem; border-radius:999px; font-weight:600; }

    /* Target tiles */
    #target{ display:flex; gap:1px; background:#004d40; color:#fff; padding:2px; border-radius:6px; }
    #target span{ width:30px; height:30px; display:grid; place-items:center; font-weight:800; border:1px solid rgba(255,255,255,.12); }

    /* Game board — match Lexispeed look */
    #grid{
      display:grid;
      grid-template-columns:repeat(8,1fr);   /* fixed 8×10 */
      grid-template-rows:repeat(10,1fr);
      gap:1px;                               /* visible grid lines */
      background:var(--board-line);
      border:1px solid var(--board-line);
      border-radius:12px;
      overflow:hidden;
      width:100%;
      max-width:360px;                       /* similar to Lexispeed’s 320px max, with a touch of breathing room */
      margin:10px auto;
      aspect-ratio:8/10;
    }
    .cell{
      background:var(--board-cell);
      position:relative;
      transition:transform .15s ease-out, opacity .15s ease-out;
    }
    /* subtle inner border like Lexispeed */
    .cell::after{
      content:'';
      position:absolute; inset:0;
      border:1px solid rgba(255,255,255,.10);
      pointer-events:none;
    }
    .cell.f{
      display:grid; place-items:center;
      color:#fff; font-weight:800; font-size:16px;
      text-shadow: 0 1px 1px rgba(0,0,0,.35);
    }
    .cell.pop{ transform:scale(1.15); opacity:0; }

    /* Overlay */
    #over{ position:absolute; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.6); z-index:40; }
    #over .cardx{ background:#900C3F; color:#fff; padding:18px; border-radius:14px; width:92%; max-width:380px; text-align:center; }

    /* Controls — chunkier buttons, Kriptiek styling */
    .btn{ background:var(--btn); color:#fff; font-weight:700; padding:12px 14px; border-radius:12px; }
    .btn:disabled{ opacity:.5; }
    .dir-btn{ aspect-ratio:1/1; font-size:36px; display:flex; align-items:center; justify-content:center; }

    /* Table polish */
    #lbBody tr{ border-top:1px solid #eef2f7; }
    #lbBody td{ padding:.5rem .75rem; }

    @media (max-width:480px){
      #target span{ width:26px; height:26px; font-size:13px; }
      .btn{ padding:10px 12px; }
      .dir-btn{ font-size:32px; }
    }
  </style>
</head>
<body class="min-h-full flex flex-col">

  <!-- Header (like Dilemma) -->
  <header class="w-full bg-white shadow-sm">
    <div class="max-w-5xl mx-auto px-4 py-4 flex items-center justify-between">
      <a href="/index.html" class="flex items-center gap-3">
        <div class="grid grid-cols-8 gap-1">
          <div class="logo-tile w-7 h-7 grid place-items-center flipped-k">K</div>
          <div class="logo-tile w-7 h-7 grid place-items-center">R</div>
          <div class="logo-tile w-7 h-7 grid place-items-center">I</div>
          <div class="logo-tile w-7 h-7 grid place-items-center">P</div>
          <div class="logo-tile w-7 h-7 grid place-items-center">T</div>
          <div class="logo-tile w-7 h-7 grid place-items-center">I</div>
          <div class="logo-tile w-7 h-7 grid place-items-center">E</div>
          <div class="logo-tile w-7 h-7 grid place-items-center">K</div>
        </div>
        <h1 class="text-xl md:text-2xl font-bold tracking-wide text-[var(--brand-dark)]">BLITSTIEK</h1>
      </a>
      <div class="flex items-center gap-2">
        <a id="loginLink" href="/login.html?new=1" class="text-sm px-3 py-1.5 rounded-md bg-gray-100 hover:bg-gray-200 text-gray-800">Meld aan</a>
        <button id="btnSignOut" class="hidden text-sm px-3 py-1.5 rounded-md bg-gray-100 hover:bg-gray-200 text-gray-800">Meld af</button>
      </div>
    </div>
  </header>

  <main class="flex-1">
    <div class="max-w-3xl mx-auto px-4 py-6">

      <!-- Info pills -->
      <div class="flex flex-wrap items-center gap-2 mb-3">
        <span id="pillId" class="pill">GameID: —</span>
        <span id="pillStatus" class="pill">Status: —</span>
      </div>

      <!-- Target word -->
      <div class="flex items-center gap-2 mb-3">
        <span class="pill">Teikenwoord</span>
        <div id="target"></div>
      </div>

      <!-- GAME card -->
      <section class="card p-4">
        <div class="relative">
          <div id="grid"></div>
          <div id="over"><div class="cardx" id="overCard"></div></div>
        </div>

        <div class="grid grid-cols-3 gap-2 mt-3">
          <button id="btnLeft"  class="btn dir-btn">◀</button>
          <button id="btnDown"  class="btn dir-btn">▼</button>
          <button id="btnRight" class="btn dir-btn">▶</button>
        </div>

        <div class="flex items-center gap-2 mt-3">
          <button id="btnStart" class="btn">BEGIN</button>
          <button id="btnPause" class="btn" style="background:#555">POUSE</button>
          <button id="btnShare" class="btn ml-auto" style="background:#0f766e">DEEL</button>
        </div>

        <div class="grid grid-cols-2 gap-2 mt-3">
          <div id="timeBox" class="text-center font-bold rounded-lg bg-[var(--board-cell)] text-white p-2">Jou tyd: <b>00:00</b></div>
          <div id="bestBox" class="text-center font-bold rounded-lg bg-[var(--board-cell)] text-white p-2">Beste tyd: <b>--:--</b></div>
        </div>

        <p id="authNote" class="hidden mt-3 text-sm text-amber-700 bg-amber-50 border border-amber-200 rounded p-2">
          Meld aan om jou tyd op die leiertafel te stoor.
        </p>
      </section>

      <!-- LEADERBOARD card -->
      <section class="card mt-6">
        <div class="px-5 py-4 border-b">
          <h2 class="text-base font-semibold text-[var(--brand-dark)]">BLITSTIEK Top 10</h2>
        </div>
        <div class="p-4 overflow-x-auto">
          <table class="min-w-full text-left text-sm">
            <thead>
              <tr class="text-gray-500"><th class="py-2 pr-4">#</th><th class="py-2 pr-4">Naam</th><th class="py-2">Tyd</th></tr>
            </thead>
            <tbody id="lbBody">
              <tr><td class="py-2 pr-4">—</td><td class="py-2 pr-4">—</td><td class="py-2">—</td></tr>
            </tbody>
          </table>
        </div>
      </section>
    </div>
  </main>

  <footer class="bg-[var(--brand-dark)] text-white text-center py-6 mt-auto">
    <div class="max-w-5xl mx-auto px-4 text-sm opacity-90">&copy; 2025 Kriptiek. Alle regte voorbehou.</div>
  </footer>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js';
    import {
      getFirestore, serverTimestamp, doc, getDoc, setDoc,
      collection, query, orderBy, limit, getDocs
    } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js';

    // ---- Firebase (same as admindilemma) ----
    const firebaseConfig = {
      apiKey: "AIzaSyDH-nVvGkdaheH7pvRHH0M9TbW2f98lMGQ",
      authDomain: "kriptiek-c9ea2.firebaseapp.com",
      projectId: "kriptiek-c9ea2",
      storageBucket: "kriptiek-c9ea2.appspot.com",
      messagingSenderId: "620450620939",
      appId: "1:620450620939:web:e93a18ac23b53b33db890e"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // ---- DOM refs ----
    const loginLink  = document.getElementById('loginLink');
    const btnSignOut = document.getElementById('btnSignOut');
    const pillId     = document.getElementById('pillId');
    const pillStatus = document.getElementById('pillStatus');
    const targetEl   = document.getElementById('target');
    const gridEl     = document.getElementById('grid');
    const over       = document.getElementById('over');
    const overCard   = document.getElementById('overCard');
    const lbBody     = document.getElementById('lbBody');
    const timeText   = document.querySelector('#timeBox b');
    const bestText   = document.querySelector('#bestBox b');
    const authNote   = document.getElementById('authNote');

    const btnLeft = document.getElementById('btnLeft');
    const btnRight= document.getElementById('btnRight');
    const btnDown = document.getElementById('btnDown');
    const btnStart= document.getElementById('btnStart');
    const btnPause= document.getElementById('btnPause');
    const btnShare= document.getElementById('btnShare');

    // ---- Helpers ----
    const pad = n => String(n).padStart(2,'0');
    const fmt = s => s==null ? '--:--' : `${pad(Math.floor(s/60))}:${pad(s%60)}`;
    const todayISO = () => { const d=new Date(); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; };
    const qs = new URLSearchParams(location.search);
    const explicitId = qs.get('gameId');

    // ---- Gameplay constants (Lexispeed parity) ----
    const H = 10;
    const W = 8;   // fixed 8 like Lexispeed
    const COLORS = ['#2196f3','#f44336','#4caf50','#ffc107','#9c27b0','#003366','#009688'];
    const CONS   = 'BCDFGHJKLMNPQRSTVWXZ';
    const VOWS   = 'AEIOUY';

    // ---- State ----
    let user=null;
    let GAME_ID=null, TARGET='';
    let grid=Array.from({length:H},()=>Array(W).fill(null));
    let cur=null, nxt=null;
    let paused=false, ended=false, moving=false;
    let t=0, tInt=null, gInt=null;

    // ---- Auth ----
    onAuthStateChanged(auth, (u)=>{
      user=u||null;
      if(user){ loginLink.classList.add('hidden'); btnSignOut.classList.remove('hidden'); authNote.classList.add('hidden'); }
      else{     loginLink.classList.remove('hidden'); btnSignOut.classList.add('hidden'); authNote.classList.remove('hidden'); }
    });
    btnSignOut.addEventListener('click', async ()=>{ await signOut(auth); try{localStorage.clear();sessionStorage.clear();}catch{} location.reload(); });

    // ---- Grid rendering ----
    function drawGrid(){
      gridEl.innerHTML='';
      for(let y=0;y<H;y++) for(let x=0;x<W;x++){
        const d=document.createElement('div'); d.className='cell'; d.dataset.x=x; d.dataset.y=y;
        gridEl.appendChild(d);
      }
    }
    function drawBlock(b){
      if(!b||b.x<0||b.x>=W||b.y<0||b.y>=H) return;
      const c=gridEl.querySelector(`.cell[data-x="${b.x}"][data-y="${b.y}"]`);
      if(!c) return;
      c.className='cell f'; c.style.background=b.color; c.textContent=b.letter;
    }
    function clearBlock(b){
      if(!b) return;
      const c=gridEl.querySelector(`.cell[data-x="${b.x}"][data-y="${b.y}"]`);
      if(!c) return;
      c.className='cell'; c.style.background='var(--board-cell)'; c.textContent='';
    }

    // ---- Core mechanics (Lexispeed) ----
    const partOfTarget = L => TARGET.includes(L);
    const collide = b => !b || b.x<0||b.x>=W||b.y>=H || (b.y>=0 && grid[b.y][b.x]);

    function createBlock(){
      const color = COLORS[Math.floor(Math.random()*COLORS.length)];
      const letter = Math.random()<0.3
        ? VOWS[Math.floor(Math.random()*VOWS.length)]
        : CONS[Math.floor(Math.random()*CONS.length)];
      return { color, letter, x:Math.floor(W/2), y:0 };
    }

    async function move(dx,dy){
      if(!cur||paused||ended||moving) return;
      moving = true;
      clearBlock(cur);
      const test = { ...cur, x:cur.x+dx, y:cur.y+dy };
      if(!collide(test)){ cur=test; drawBlock(cur); }
      else if(dy>0){ drawBlock(cur); place(); }
      else{ drawBlock(cur); }
      moving = false;
    }

    function hardDrop(){
      if(!cur||paused||ended) return;
      clearBlock(cur);
      while(cur.y<H-1 && !collide({...cur,y:cur.y+1})) cur.y++;
      place();
    }

    async function place(){
      if(!cur||cur.y<0) return;
      grid[cur.y][cur.x]={...cur}; drawBlock(cur);

      // Remove adjacent matches (letter or color), excluding target letters
      await matchAndDrop();

      // Order like Lexispeed: check spawn-space (fail) first, then win
      checkFail();
      await checkWin();

      cur=nxt; nxt=createBlock();
      if(cur) drawBlock(cur);
    }

    async function matchAndDrop(){
      const del=new Set();
      for(let y=0;y<H;y++) for(let x=0;x<W;x++){
        const a=grid[y][x]; if(!a||partOfTarget(a.letter)) continue;
        for(const [dx,dy] of [[1,0],[0,1],[-1,0],[0,-1]]){
          const nx=x+dx, ny=y+dy; if(nx<0||nx>=W||ny<0||ny>=H) continue;
          const b=grid[ny][nx]; if(!b||partOfTarget(b.letter)) continue;
          if(a.letter===b.letter || a.color===b.color){ del.add(`${x},${y}`); del.add(`${nx},${ny}`); }
        }
      }
      if(!del.size) return;

      await Promise.all(Array.from(del).map(key=>new Promise(res=>{
        const [x,y]=key.split(',').map(Number);
        const c=gridEl.querySelector(`.cell[data-x="${x}"][data-y="${y}"]`);
        if(c){ c.classList.add('pop'); setTimeout(()=>{ c.classList.remove('pop'); res(); },150);} else res();
        grid[y][x]=null;
      })));

      // compact columns
      for(let x=0;x<W;x++){
        let wY=H-1;
        for(let y=H-1;y>=0;y--){
          if(grid[y][x]){
            if(y!==wY){ grid[wY][x]=grid[y][x]; grid[y][x]=null; }
            wY--;
          }
        }
      }
      // redraw
      for(let y=0;y<H;y++) for(let x=0;x<W;x++){
        const c=gridEl.querySelector(`.cell[data-x="${x}"][data-y="${y}"]`);
        c.className='cell'; c.style.background='var(--board-cell)'; c.textContent='';
        if(grid[y][x]) drawBlock({...grid[y][x],x,y});
      }
    }

    // Win = exact horizontal TARGET anywhere
    async function checkWin(){
      for(let y=0;y<H;y++) for(let x=0;x<=W-TARGET.length;x++){
        let ok=true;
        for(let i=0;i<TARGET.length;i++){ const g=grid[y][x+i]; if(!g||g.letter!==TARGET[i]){ ok=false; break; } }
        if(ok){
          for(let i=0;i<TARGET.length;i++){
            const c=gridEl.querySelector(`.cell[data-x="${x+i}"][data-y="${y}"]`);
            if(c) c.style.transform='scale(1.05)';
          }
          setTimeout(()=>end(true), 450);
          return;
        }
      }
    }
    function checkFail(){ if(nxt && collide(nxt)) end(false); }

    // ---- Timer & control ----
    function setTime(v){ t=v; timeText.textContent=fmt(t); }
    function start(){
      ended=false; over.style.display='none'; setTime(0);
      grid=Array.from({length:H},()=>Array(W).fill(null));
      drawGrid();
      cur=createBlock(); nxt=createBlock(); drawBlock(cur);
      paused=false; btnPause.textContent='POUSE';
      clearInterval(tInt); clearInterval(gInt);
      gInt=setInterval(()=>{ if(!paused && !ended) move(0,1); },1000);
      tInt=setInterval(()=>{ if(!paused && !ended) setTime(t+1); },1000);
    }
    function togglePause(){ if(ended) return; paused=!paused; btnPause.textContent = paused ? 'HERVAT' : 'POUSE'; }

    // ---- Overlay + submit ----
    function overlay(html){ overCard.innerHTML=html; over.style.display='flex'; }
    async function submitTime(){
      if(!user) return;
      try{
        const name = user.displayName || user.email || 'Speler';
        await setDoc(doc(db,'blitstiekGames',GAME_ID,'leaderboard',user.uid),{
          userName:String(name).slice(0,24),
          time:Number(t),
          timestamp:serverTimestamp()
        },{ merge:true });
        overlay(`<div class="bg-emerald-50 text-emerald-900 border border-emerald-200 rounded p-2 mb-2 text-sm">Tyd gestoor ✔</div>
                 <button id="closeOver" class="mt-2 px-4 py-2 rounded-xl bg-gray-700 text-white font-bold">SLUIT</button>`);
        document.getElementById('closeOver').addEventListener('click', ()=> over.style.display='none');
        await loadLeaderboard();
      }catch(e){
        overlay(`<div class="bg-amber-50 text-amber-900 border border-amber-200 rounded p-2 mb-2 text-sm">Kon nie stoor nie.</div>
                 <div class="text-xs opacity-80 mb-2">${e?.message||e}</div>
                 <button id="closeErr" class="px-4 py-2 rounded-xl bg-gray-700 text-white font-bold">SLUIT</button>`);
        document.getElementById('closeErr').addEventListener('click', ()=> over.style.display='none');
      }
    }
    function end(win){
      ended=true; clearInterval(tInt); clearInterval(gInt);
      if(win){
        const msg=`Puik! Jou tyd: <b>${fmt(t)}</b> vir <b>${TARGET}</b>.`;
        const saveBtn = user ? `<button id="saveBtn" class="px-4 py-2 rounded-xl bg-[var(--brand-dark)] text-white font-bold">DIEN TYD IN</button>`
                             : `<div class="text-left text-sm bg-amber-50 text-amber-900 border border-amber-200 rounded p-2 mb-2">Meld aan om jou tyd op die leiertafel te stoor.</div>`;
        overlay(`<div class="mb-2">${msg}</div>${saveBtn}
                 <button id="closeBtn" class="mt-2 px-4 py-2 rounded-xl bg-gray-700 text-white font-bold">SLUIT</button>`);
        document.getElementById('closeBtn').addEventListener('click', ()=> over.style.display='none');
        const sb=document.getElementById('saveBtn'); if(sb) sb.addEventListener('click', submitTime);
      } else {
        overlay(`<div class="mb-2 text-lg font-bold">GAME OVER</div>
                 <button id="closeBtn2" class="px-4 py-2 rounded-xl bg-gray-700 text-white font-bold">SLUIT</button>`);
        document.getElementById('closeBtn2').addEventListener('click', ()=> over.style.display='none');
      }
    }

    // ---- Share ----
    function shareUrl(){
      const url = new URL(location.href);
      url.searchParams.set('gameId', GAME_ID);
      return url.toString();
    }
    async function handleShare(){
      const msg = `Ek het ${TARGET} in ${fmt(t)} op BLITSTIEK voltooi! Kan jy my tyd klop? Speel saam: ${shareUrl()}`;
      if(navigator.share){ try{ await navigator.share({ text: msg }); return; }catch{} }
      try{ await navigator.clipboard.writeText(msg); }catch{}
      window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`,'_blank');
    }
    btnShare.addEventListener('click', handleShare);

    // ---- Load game & leaderboard ----
    async function loadGame(){
      GAME_ID = explicitId || `Game${todayISO()}`;
      pillId.textContent = `GameID: ${GAME_ID}`;

      const snap = await getDoc(doc(db,'blitstiekGames',GAME_ID));
      if(!snap.exists()){
        pillStatus.textContent = 'Status: nie gevind';
        targetEl.innerHTML = `<span>—</span>`;
        drawGrid(); // still render 8×10
        return;
      }
      const data=snap.data();
      TARGET=(data.word||'').toUpperCase();
      pillStatus.textContent = `Status: ${data.status || '—'}`;

      // Target chips
      targetEl.innerHTML='';
      TARGET.split('').forEach(ch=>{ const s=document.createElement('span'); s.textContent=ch; targetEl.appendChild(s); });

      // Fixed-width mechanics (8×10), like Lexispeed
      grid = Array.from({length:H},()=>Array(W).fill(null));
      drawGrid();

      await loadLeaderboard();
    }

    async function loadLeaderboard(){
      if(!GAME_ID) return;
      const qy=query(collection(db,'blitstiekGames',GAME_ID,'leaderboard'), orderBy('time','asc'), limit(10));
      const res=await getDocs(qy);
      lbBody.innerHTML='';
      if(res.empty){
        bestText.textContent='--:--';
        lbBody.innerHTML='<tr><td class="py-2 pr-4">—</td><td class="py-2 pr-4">—</td><td class="py-2">—</td></tr>';
        return;
      }
      let r=1;
      res.forEach(d=>{
        const v=d.data();
        if(r===1){ bestText.textContent=fmt(v.time); }
        const tr=document.createElement('tr');
        tr.innerHTML=`<td class="py-2 pr-4">${r}</td><td class="py-2 pr-4">${v.userName||'-'}</td><td class="py-2">${fmt(v.time)}</td>`;
        lbBody.appendChild(tr);
        r++;
      });
    }

    // ---- Controls ----
    btnStart.addEventListener('click', start);
    btnPause.addEventListener('click', ()=>togglePause());
    btnLeft.addEventListener('click', ()=>move(-1,0));
    btnRight.addEventListener('click',()=>move(1,0));
    btnDown.addEventListener('click', ()=>hardDrop());

    document.addEventListener('keydown', (e)=>{
      if(e.key==='ArrowLeft') move(-1,0);
      if(e.key==='ArrowRight') move(1,0);
      if(e.key==='ArrowDown') move(0,1);       // soft step
      if(e.key===' ') { e.preventDefault(); hardDrop(); }  // hard drop
    });

    // ---- Init ----
    await loadGame();
  </script>
</body>
</html>
