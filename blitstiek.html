rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- helpers ---
    function signedIn() { return request.auth != null; }
    function isSelf(uid) { return signedIn() && request.auth.uid == uid; }
    function isAdmin() {
      return signedIn() &&
             (request.auth.uid == "jI7f0Wk4MqfPq7p69vjl8OlJUvS2" || request.auth.token.admin == true);
    }

    // --- admins ---
    match /admins/{uid} {
      allow read: if signedIn();
      allow write: if false;
    }

    // --- games (DILEMMA) ---
    match /games/{gameId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();

      match /leaderboard/{uid} {
        allow read: if true;
        allow create, update: if isSelf(uid) || isAdmin();
        allow delete: if false;
      }
    }

    // --- users ---
    match /users/{uid} {
      allow create: if isSelf(uid);
      allow read, update: if isSelf(uid) || isAdmin();
      allow delete: if false;
    }

    // --- registrations ---
    match /registrations/{uid} {
      allow create, update: if isSelf(uid) || isAdmin();
      allow read: if isSelf(uid) || isAdmin();
      allow delete: if false;
    }

    // --- private per-user gameplay ---
    match /userGames/{uid}/plays/{gameId} {
      allow read, create, update: if isSelf(uid);
      allow delete: if false;
    }

    // --- forum posts & subcollections ---
    match /forumPosts/{postId} {
      allow read: if true;

      allow create: if signedIn()
                    && request.resource.data.authorId == request.auth.uid;

      // full-edit by author
      allow update, delete: if signedIn()
                            && resource.data.authorId == request.auth.uid;

      // Safe counter example kept from your version
      allow update: if signedIn()
                    && request.resource.data.diff(resource.data).changedKeys().hasOnly(['replyCount'])
                    && request.resource.data.replyCount is int
                    && resource.data.replyCount is int
                    && request.resource.data.replyCount >= resource.data.replyCount
                    && request.resource.data.replyCount <= resource.data.replyCount + 1;

      match /replies/{replyId} {
        allow read: if true;
        allow create: if signedIn()
                      && request.resource.data.authorId == request.auth.uid;
        allow update, delete: if signedIn()
                              && resource.data.authorId == request.auth.uid;
      }

      match /likes/{uid} {
        allow read: if true;
        allow create: if signedIn()
                      && uid == request.auth.uid
                      && !exists(/databases/$(database)/documents/forumPosts/$(postId)/likes/$(uid));
        allow update, delete: if false;
      }
    }

    // --- words list ---
    match /words/{wordId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }

    // --- BLITSTIEK ---
    match /blitstiekGames/{gameId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();

      // Per-user best (retained)
      match /leaderboard/{uid} {
        allow read: if true;
        allow create, update: if isSelf(uid) || isAdmin();
        allow delete: if false;
      }

      // NEW: Global board (duplicates allowed)
      match /board/{entryId} {
        allow read: if true;
        allow create: if signedIn()
                      && request.resource.data.uid == request.auth.uid
                      && request.resource.data.userName is string
                      && request.resource.data.time is int
                      && request.resource.data.time >= 0;
        allow update: if false;
        allow delete: if isAdmin();
      }
    }

    // --- deny all else ---
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
