<!DOCTYPE html>
<html lang="af">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-S9V4CMP1FP"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date()); gtag('config', 'G-S9V4CMP1FP');
  </script>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BLITSTIEK – Kriptiek</title>

  <!-- Canonical & Open Graph / Twitter -->
  <link rel="canonical" href="https://www.kriptiek.com/blitstiek.html" />
  <meta property="og:title" content="BLITSTIEK – Kriptiek" />
  <meta property="og:description" content="Speel vandag se BLITSTIEK op Kriptiek." />
  <meta property="og:image" content="https://www.kriptiek.com/assets/BLITSTIEK_12SEP.png" />
  <meta property="og:url" content="https://www.kriptiek.com/blitstiek.html" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:image" content="https://www.kriptiek.com/assets/BLITSTIEK_12SEP.png" />

  <!-- Favicons -->
  <link rel="icon" href="/assets/favicon.ico?v=2" type="image/x-icon" />
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png?v=3">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png?v=3">
  <link rel="apple-touch-icon" href="/assets/apple-touch-icon.png?v=3">
  <link rel="manifest" href="/assets/site.webmanifest?v=3">

  <!-- Styles -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700;800&display=swap" rel="stylesheet" />

  <style>
    body { font-family: 'Montserrat', sans-serif; }
    .mono{ font-variant-numeric: tabular-nums; }

    /* Header logo */
    .logo-container {
      position: relative; display: flex; justify-content: center; align-items: center;
      width: fit-content; margin: 1rem auto; padding: 1rem; border-radius: 1rem; background-color: white; overflow: hidden;
      isolation: isolate;
    }
    .logo-container::before{
      content:""; position:absolute; inset:-2px; border-radius:1rem;
      background:conic-gradient(from 180deg at 50% 50%, #1e3a8a, #334155, #1e3a8a);
      animation:spin 14s linear infinite; z-index:0; padding:2px;
      mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite: xor; mask-composite: exclude;
    }
    @keyframes spin{ to{ transform:rotate(1turn); } }
    @media (prefers-reduced-motion: reduce){ .logo-container::before{ animation:none; } }

    .crossword-grid { display: grid; grid-template-columns: repeat(8, minmax(40px, 1fr)); gap: 4px; position: relative; z-index: 10; }
    .letter-box {
      width: 50px; height: 50px; display:flex; align-items:center; justify-content:center;
      background:#374151; color:#fff; font-size:1.8rem; font-weight:800; border:2px solid #1f2937; border-radius:.375rem;
      text-transform:uppercase; box-shadow: inset 0 0 5px rgba(0,0,0,.2);
    }
    .flipped-k { transform: scaleX(-1); }

    .background-crossword{
      position:absolute; top:0; left:0; width:100%; height:100%;
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(30px, 1fr));
      grid-template-rows: repeat(auto-fill, minmax(30px, 1fr));
      opacity:.5; z-index:1; pointer-events:none;
    }
    .bg-letter-box{
      display:flex; align-items:center; justify-content:center;
      font-size:1.1rem; font-weight:800; color:#9ca3af;
      border:1px solid #e5e7eb; background:transparent; user-select:none;
    }

    /* UI */
    .card{ background:#fff; border-radius:1rem; box-shadow:0 8px 18px rgba(0,0,0,.08); }
    .kbtn{ display:inline-flex; align-items:center; justify-content:center; gap:.5rem; padding:.7rem 1rem; border-radius:1rem; background:#1d4ed8; color:#fff; font-weight:800; box-shadow:0 10px 24px rgba(29,78,216,.25); }
    .kbtn:hover{ background:#1e40af; }
    .kbtn-ghost{ background:#e5e7eb; color:#111827; font-weight:800; border-radius:1rem; padding:.7rem 1rem; }
    .kbtn-ghost:hover{ background:#d1d5db; }
    .pill{ display:inline-flex; align-items:center; gap:.45rem; padding:.4rem .85rem; border-radius:999px; font-weight:900; color:#fff; }
    .pill-green{ background: linear-gradient(180deg, #22C55E 0%, #0EA55B 100%); }
    .pill-yellow{ background: linear-gradient(180deg, #f59e0b 0%, #d97706 100%); }
    .pill-red{ background: linear-gradient(180deg, #ef4444 0%, #b91c1c 100%); }

    /* Grid */
    :root{
      --cols: 8;
      --rows: 10;
      --cell: 38px; /* will be overridden by JS for crisp sizing */
      --gap: 2px;
    }
    .grid-wrap{
      display:flex; justify-content:center;
    }
    .game-grid{
      display:grid;
      grid-template-columns: repeat(var(--cols), var(--cell));
      grid-template-rows: repeat(var(--rows), var(--cell));
      gap: var(--gap);
      background:#0b1220;
      padding:10px;
      border-radius:1rem;
      box-shadow: 0 18px 40px rgba(2,6,23,.25);
      border: 1px solid rgba(30,58,138,.25);
    }
    .cell{
      width:var(--cell); height:var(--cell);
      display:flex; align-items:center; justify-content:center;
      border-radius:.55rem;
      font-weight:900;
      text-transform:uppercase;
      user-select:none;
      letter-spacing:.02em;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.06);
    }
    .cell-empty{ background: rgba(148,163,184,.06); color: rgba(148,163,184,.25); }
    .cell-solid{ color:#0b1220; }

    /* Modal */
    .modal-backdrop{ position:fixed; inset:0; background:rgba(2,6,23,.6); display:flex; align-items:center; justify-content:center; padding:16px; z-index:50; }
    .modal{ width:min(520px, 100%); }
    .hidden{ display:none !important; }

    /* Dropdown */
    .dd{ position:relative; }
    .dd-menu{
      position:absolute; right:0; top:calc(100% + 10px);
      width: min(260px, 90vw);
      background:#fff; border:1px solid #e5e7eb; border-radius:1rem;
      box-shadow: 0 18px 40px rgba(2,6,23,.18);
      overflow:hidden;
      z-index:40;
    }
    .dd-item{ width:100%; text-align:left; padding:.8rem 1rem; font-weight:800; }
    .dd-item:hover{ background:#f1f5f9; }

    /* Support checkpoint */
    .support-box{
      border:1px solid rgba(30,58,138,.18);
      background: linear-gradient(180deg, rgba(255,255,255,1) 0%, rgba(248,250,252,1) 100%);
      border-radius:1rem;
      box-shadow:0 10px 24px rgba(2,6,23,.08);
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">
  <!-- Header -->
  <header class="bg-white shadow p-4">
    <div class="logo-container">
      <div id="backgroundCrossword" class="background-crossword"></div>
      <div class="crossword-grid">
        <div class="letter-box flipped-k">K</div><div class="letter-box flipped-k">R</div><div class="letter-box">I</div>
        <div class="letter-box flipped-k">P</div><div class="letter-box">T</div><div class="letter-box">I</div>
        <div class="letter-box flipped-k">E</div><div class="letter-box">K</div>
      </div>
    </div>
  </header>

  <main class="flex-grow p-4">
    <div class="max-w-6xl mx-auto">
      <!-- Top line -->
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
        <div>
          <div class="text-2xl font-extrabold text-slate-900">BLITSTIEK</div>
          <div id="welcomeLine" class="text-sm text-slate-600 mt-1">Laai…</div>
        </div>

        <div class="flex items-center gap-2">
          <span id="supporterPill" class="pill pill-green hidden">ONDERSTEUNER</span>

          <div id="authBtns" class="flex items-center gap-2 hidden">
            <a class="kbtn-ghost" href="/login.html">Meld aan</a>
            <a class="kbtn" href="/register.html">Registreer</a>
          </div>

          <button id="logoutBtn" class="kbtn-ghost hidden" type="button">Meld af</button>
        </div>
      </div>

      <!-- Alert -->
      <div id="alertBox" class="hidden mb-4 rounded-lg border px-3 py-2 text-sm"></div>

      <!-- Support checkpoint (optional, shown after first completion or by trigger) -->
      <div id="supportGate" class="hidden mb-4 support-box p-4">
        <div class="text-center text-lg font-extrabold text-slate-900">
          Baie dankie dat jy BLITSTIEK speel!
        </div>
        <div class="text-center text-slate-700 mt-2 leading-relaxed">
          As jy kan help om Kriptiek aan die gang te hou, oorweeg asseblief ’n klein bydrae.
          Ondersteuners kry ’n <span class="font-extrabold">ONDERSTEUNER</span>-kenteken op ranglyste.
        </div>

        <div class="mt-4 grid grid-cols-1 sm:grid-cols-3 gap-2">
          <a id="bmacBtn" class="kbtn justify-center" href="https://www.buymeacoffee.com/" target="_blank" rel="noopener">Buy Me a Coffee</a>
          <button id="supportLaterBtn" type="button" class="kbtn-ghost justify-center">Miskien later</button>
          <a class="kbtn-ghost justify-center text-center" href="/about.html">Lees meer</a>
        </div>
      </div>

      <!-- Main layout -->
      <div class="grid grid-cols-1 lg:grid-cols-12 gap-4">
        <!-- Left: actions -->
        <aside class="lg:col-span-3">
          <div class="card p-4">
            <div class="text-sm font-extrabold text-slate-900">Skakels</div>

            <div class="mt-3 grid grid-cols-1 gap-2">
              <a class="kbtn-ghost text-center" href="/forum.html">Gesels saam</a>
              <a class="kbtn-ghost text-center" href="/blitstiek-argief.html">Argief</a>

              <div class="dd">
                <button id="shareBtnTop" type="button" class="kbtn w-full justify-center">Deel</button>
                <div id="shareMenuTop" class="dd-menu hidden">
                  <button class="dd-item" type="button" data-share="whatsapp">WhatsApp</button>
                  <button class="dd-item" type="button" data-share="copy">Kopieer</button>
                  <button class="dd-item" type="button" data-share="system">Stelsel</button>
                </div>
              </div>

              <a class="kbtn-ghost text-center" href="/profile.html">My profiel</a>
            </div>

            <div class="mt-4 text-xs text-slate-500 leading-relaxed">
              Wen deur die teikenwoord in een ry te vorm. Gebruik ← → en <span class="font-extrabold">spasie</span> (hard drop).
            </div>
          </div>
        </aside>

        <!-- Center: game -->
        <section class="lg:col-span-6">
          <div class="card p-4 md:p-5">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
              <div>
                <div class="text-sm text-slate-500">Vandag se teiken</div>
                <div id="targetChips" class="flex flex-wrap gap-2 mt-2"></div>
              </div>

              <div class="flex items-center gap-3">
                <div class="text-right">
                  <div class="text-xs text-slate-500">Jou tyd</div>
                  <div id="yourTime" class="mono text-xl font-extrabold text-slate-900">00:00.0</div>
                </div>
                <div class="text-right">
                  <div class="text-xs text-slate-500">Beste tyd</div>
                  <div id="bestTime" class="mono text-xl font-extrabold text-slate-900">—</div>
                </div>
              </div>
            </div>

            <div class="mt-4 flex items-center gap-2">
              <button id="startBtn" type="button" class="kbtn">Begin</button>
              <button id="pauseBtn" type="button" class="kbtn-ghost hidden">Pouse</button>
              <button id="resetGameBtn" type="button" class="kbtn-ghost">Herbegin</button>

              <div class="ml-auto flex items-center gap-2">
                <button id="leftBtn" type="button" class="kbtn-ghost">←</button>
                <button id="rightBtn" type="button" class="kbtn-ghost">→</button>
                <button id="dropBtn" type="button" class="kbtn">Drop</button>
              </div>
            </div>

            <div class="mt-4 grid-wrap">
              <div id="grid" class="game-grid" aria-label="Blitstiek rooster"></div>
            </div>

            <div id="statusLine" class="mt-4 text-sm font-extrabold text-blue-800 bg-blue-50 border border-blue-200 rounded-lg px-3 py-2">
              Laai spel…
            </div>
          </div>

          <!-- Result modal -->
          <div id="resultModal" class="modal-backdrop hidden" role="dialog" aria-modal="true">
            <div class="modal card p-5">
              <div class="text-xl font-extrabold text-slate-900">Klaar!</div>
              <div id="resultText" class="mt-2 text-slate-700 leading-relaxed"></div>

              <div class="mt-4 flex items-center gap-2">
                <button id="closeResultBtn" class="kbtn-ghost" type="button">Maak toe</button>

                <div class="ml-auto dd">
                  <button id="shareBtnModal" class="kbtn" type="button">Deel</button>
                  <div id="shareMenuModal" class="dd-menu hidden">
                    <button class="dd-item" type="button" data-share="whatsapp">WhatsApp</button>
                    <button class="dd-item" type="button" data-share="copy">Kopieer</button>
                    <button class="dd-item" type="button" data-share="system">Stelsel</button>
                  </div>
                </div>
              </div>

              <div class="mt-3 text-xs text-slate-500">
                Deel jou tyd met vriende. Ondersteuners kry ’n kenteken op ranglyste.
              </div>
            </div>
          </div>

          <!-- Guest gate modal -->
          <div id="guestGate" class="modal-backdrop hidden" role="dialog" aria-modal="true">
            <div class="modal card p-5">
              <div class="text-xl font-extrabold text-slate-900">Meld aan of speel as gas</div>
              <div class="mt-2 text-slate-700 leading-relaxed">
                Jy kan speel as gas (beperkte funksies), of registreer om jou beste tye op die ranglys te stoor.
              </div>

              <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-2">
                <button id="playGuestBtn" type="button" class="kbtn-ghost">Speel as gas</button>
                <a id="goRegisterBtn" class="kbtn text-center" href="/register.html">Registreer</a>
              </div>

              <div class="mt-3 text-xs text-slate-500">
                Jy kan later enige tyd registreer en terugkom.
              </div>
            </div>
          </div>
        </section>
        <!-- Right: leaderboard -->
        <aside class="lg:col-span-3">
          <div class="card p-4">
            <div class="flex items-center justify-between">
              <div class="text-sm font-extrabold text-slate-900">Vandag se bestes</div>
              <button id="refreshBoardBtn" type="button" class="kbtn-ghost px-3 py-2 text-sm">Herlaai</button>
            </div>

            <div class="mt-3 text-xs text-slate-500">
              Ondersteuners word gemerk met ’n kenteken.
            </div>

            <div id="boardList" class="mt-3 space-y-2"></div>
          </div>

          <div class="card p-4 mt-4">
            <div class="text-sm font-extrabold text-slate-900">Spelreëls</div>
            <ul class="mt-2 text-sm text-slate-700 list-disc pl-5 space-y-1">
              <li>Blokke val. Skuif met ← → en gebruik spasie vir ’n hard drop.</li>
              <li>Groepe van dieselfde <span class="font-extrabold">letter+kleur</span> verdwyn (behalwe as die letter in die teikenwoord is).</li>
              <li>Jy wen as die teikenwoord aaneenlopend in enige ry vorm.</li>
            </ul>
          </div>
        </aside>
      </div>
    </div>
  </main>

  <footer class="bg-white shadow p-4 text-center text-sm text-gray-500">
    &copy; 2025 Kriptiek. Alle regte voorbehou. |
    <a href="/privacy.html" class="underline px-1.5">Privaatheidsbeleid</a> |
    <a href="/terms.html" class="underline px-1.5">Voorwaardes</a> |
    <a href="/faq.html" class="underline px-1.5">Gereelde vrae</a> |
    <a href="/about.html" class="underline px-1.5">Oor Kriptiek</a> |
    <a href="/contact.html" class="underline px-1.5">Kontak ons</a>
  </footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, signOut
    } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, addDoc, collection, getDocs,
      query, limit, where
    } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDH-nVvGkdaheH7pvRHH0M9TbW2f98lMGQ",
      authDomain: "kriptiek-c9ea2.firebaseapp.com",
      projectId: "kriptiek-c9ea2",
      storageBucket: "kriptiek-c9ea2.appspot.com",
      messagingSenderId: "620450620939",
      appId: "1:620450620939:web:e93a18ac23b53b33db890e"
    };

    const SITE_ORIGIN = location.origin;
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const $ = (id)=>document.getElementById(id);

    const showAlert = (msg, kind="info")=>{
      const box = $("alertBox");
      box.classList.remove("hidden");
      box.innerHTML = msg;
      box.className = "mb-4 rounded-lg border px-3 py-2 text-sm " + (
        kind==="ok" ? "border-green-300 bg-green-50 text-green-800"
        : kind==="error" ? "border-red-300 bg-red-50 text-red-800"
        : "border-blue-300 bg-blue-50 text-blue-800"
      );
    };
    const hideAlert = ()=>{ $("alertBox").classList.add("hidden"); };

    // Header background letters
    (function headerBG(){
      const el = document.getElementById('backgroundCrossword');
      if (!el) return;
      const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
      function rand() { return letters[Math.floor(Math.random()*letters.length)]; }
      function draw() {
        el.innerHTML = '';
        const numRows = Math.ceil(el.offsetHeight / 30);
        const numCols = Math.ceil(el.offsetWidth / 30);
        const total = (numRows * numCols) || 300;
        for (let i=0;i<total;i++){
          const d=document.createElement('div');
          d.className='bg-letter-box';
          d.textContent=rand();
          el.appendChild(d);
        }
      }
      window.addEventListener('load', draw);
      window.addEventListener('resize', ()=>{ clearTimeout(window.__bgT); window.__bgT=setTimeout(draw,120); });
    })();

    // --- Supporter badge (public) ---
    const supporterCache = new Map(); // uid -> boolean
    async function isSupporter(uid){
      if (!uid) return false;
      if (supporterCache.has(uid)) return supporterCache.get(uid);
      try{
        const snap = await getDoc(doc(db, "supportersPublic", uid));
        const val = !!(snap.exists() && snap.data()?.active === true);
        supporterCache.set(uid, val);
        return val;
      }catch{
        supporterCache.set(uid, false);
        return false;
      }
    }

    // --- Auth state ---
    let currentUser = null;
    let guestMode = false;

    $("logoutBtn").addEventListener("click", async ()=>{
      try { await signOut(auth); } finally {
        try { localStorage.clear(); sessionStorage.clear(); } catch {}
        window.location.href = "/login.html?new=1";
      }
    });

    $("playGuestBtn").addEventListener("click", ()=>{
      guestMode = true;
      $("guestGate").classList.add("hidden");
      renderAuthUI(null);
      initAfterAuth();
    });

    // --- Game constants ---
    const COLS = 8;
    const ROWS = 10;

    const COLORS = [
      { bg:"#60a5fa", fg:"#0b1220" }, // blue
      { bg:"#34d399", fg:"#0b1220" }, // green
      { bg:"#fbbf24", fg:"#0b1220" }, // yellow
      { bg:"#fb7185", fg:"#0b1220" }, // pink
      { bg:"#a78bfa", fg:"#0b1220" }, // purple
    ];

    function pad2(n){ return String(n).padStart(2,"0"); }
    function formatMs(ms){
      if (!isFinite(ms) || ms < 0) return "—";
      const total = Math.floor(ms/100);
      const s = Math.floor(total/10);
      const d = total%10;
      const m = Math.floor(s/60);
      const ss = s%60;
      return `${pad2(m)}:${pad2(ss)}.${d}`;
    }

    function nowZA(){
      // ZA-safe "today" resolver (approx): uses local time but forces Africa/Johannesburg
      const d = new Date();
      const parts = new Intl.DateTimeFormat('en-CA', {
        timeZone: 'Africa/Johannesburg',
        year:'numeric', month:'2-digit', day:'2-digit'
      }).formatToParts(d);
      const y = parts.find(p=>p.type==='year')?.value;
      const m = parts.find(p=>p.type==='month')?.value;
      const da = parts.find(p=>p.type==='day')?.value;
      return `${y}-${m}-${da}`;
    }

    function gameIdForToday(){
      return `Game${nowZA()}`;
    }
    // --- Firestore: resolve GAME_ID + load target ---
    let GAME_ID = null;
    let TARGET = null; // string
    let TARGET_SET = null; // Set of letters

    async function resolveGameId(){
      const todayId = gameIdForToday();
      try{
        const snap = await getDoc(doc(db, "blitstiekGames", todayId));
        if (snap.exists()) return { id: todayId, data: snap.data() || {} };
      }catch{}

      // Fallback 1: any active game (no composite index; we pick best client-side)
      try{
        const col = collection(db, "blitstiekGames");
        const q1 = query(col, where("status", "==", "active"), limit(25));
        const s1 = await getDocs(q1);
        if (!s1.empty) {
          let best = null;
          s1.forEach(d=>{
            const data = d.data() || {};
            const score = Number(data.createdAtMs || 0);
            if (!best || score > best.score) best = { id: d.id, data, score };
          });
          if (best) return { id: best.id, data: best.data };
        }
      }catch{}

      // Fallback 2: newest by createdAtMs (client-side from limited sample)
      try{
        const col = collection(db, "blitstiekGames");
        const q2 = query(col, limit(50));
        const s2 = await getDocs(q2);
        if (!s2.empty) {
          let best = null;
          s2.forEach(d=>{
            const data = d.data() || {};
            const score = Number(data.createdAtMs || 0);
            if (!best || score > best.score) best = { id: d.id, data, score };
          });
          if (best) return { id: best.id, data: best.data };
        }
      }catch{}

      return { id: todayId, data: {} };
    }

    function renderTargetChips(word){
      const el = $("targetChips");
      el.innerHTML = "";
      const letters = String(word || "").toUpperCase().split("");
      letters.forEach(ch=>{
        const span = document.createElement("span");
        span.className = "inline-flex items-center justify-center px-3 py-1 rounded-full bg-slate-100 border border-slate-200 text-slate-900 font-extrabold";
        span.textContent = ch;
        el.appendChild(span);
      });
    }

    // --- Leaderboard ---
    let leaderboard = [];
    async function loadLeaderboard(){
      $("boardList").innerHTML = `<div class="text-sm text-slate-500">Laai ranglys…</div>`;
      leaderboard = [];

      if (!GAME_ID) return;

      try{
        const col = collection(db, "blitstiekGames", GAME_ID, "leaderboard");
        const snap = await getDocs(query(col, limit(25))); // we sort client-side
        const rows = [];
        snap.forEach(d=>{
          const data = d.data() || {};
          rows.push({
            uid: d.id,
            userName: String(data.userName || data.name || "Onbekend"),
            bestMs: Number(data.bestMs ?? data.bestTimeMs ?? data.timeMs ?? NaN),
          });
        });

        rows.sort((a,b)=> (a.bestMs - b.bestMs));
        leaderboard = rows.filter(r=>isFinite(r.bestMs) && r.bestMs > 0).slice(0, 15);

        // Best time at top
        const top = leaderboard[0];
        $("bestTime").textContent = top ? formatMs(top.bestMs) : "—";

        // Render with supporter badges (lazy per row)
        const list = $("boardList");
        list.innerHTML = "";

        if (!leaderboard.length) {
          list.innerHTML = `<div class="text-sm text-slate-500">Nog geen tye vandag nie.</div>`;
          return;
        }

        for (const row of leaderboard) {
          const line = document.createElement("div");
          line.className = "flex items-center justify-between gap-2 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2";

          const left = document.createElement("div");
          left.className = "min-w-0";

          const name = document.createElement("div");
          name.className = "text-sm font-extrabold text-slate-900 truncate";
          name.textContent = row.userName;

          const meta = document.createElement("div");
          meta.className = "text-xs text-slate-500 mono";
          meta.textContent = formatMs(row.bestMs);

          left.appendChild(name);
          left.appendChild(meta);

          const right = document.createElement("div");
          right.className = "flex items-center gap-2 flex-shrink-0";

          const badge = document.createElement("span");
          badge.className = "pill pill-green hidden";
          badge.style.fontSize = "11px";
          badge.style.padding = ".25rem .6rem";
          badge.textContent = "ONDERSTEUNER";

          right.appendChild(badge);

          line.appendChild(left);
          line.appendChild(right);
          list.appendChild(line);

          // resolve supporter badge
          isSupporter(row.uid).then((ok)=>{
            if (ok) badge.classList.remove("hidden");
          });
        }
      }catch(err){
        console.error(err);
        $("boardList").innerHTML = `<div class="text-sm text-red-600">Kon nie ranglys laai nie.</div>`;
      }
    }

    $("refreshBoardBtn").addEventListener("click", ()=> loadLeaderboard());

    // --- UI: auth rendering ---
    async function renderAuthUI(user){
      currentUser = user || null;

      const authBtns = $("authBtns");
      const logoutBtn = $("logoutBtn");
      const supporterPill = $("supporterPill");

      if (currentUser) {
        authBtns.classList.add("hidden");
        logoutBtn.classList.remove("hidden");

        const name = (currentUser.displayName || "").trim();
        $("welcomeLine").textContent = name
          ? `Welkom terug, ${name.toUpperCase()}`
          : `Welkom terug!`;

        // supporter badge
        const ok = await isSupporter(currentUser.uid);
        if (ok) supporterPill.classList.remove("hidden"); else supporterPill.classList.add("hidden");
      } else {
        logoutBtn.classList.add("hidden");

        if (guestMode) {
          authBtns.classList.remove("hidden");
          supporterPill.classList.add("hidden");
          $("welcomeLine").textContent = "Jy speel tans as gas (beperkte funksies).";
        } else {
          authBtns.classList.remove("hidden");
          supporterPill.classList.add("hidden");
          $("welcomeLine").textContent = "Meld aan om jou beste tye op die ranglys te stoor.";
        }
      }
    }

    // --- Dropdown helpers ---
    function closeDropdowns(){
      $("shareMenuTop").classList.add("hidden");
      $("shareMenuModal").classList.add("hidden");
    }
    function setupDropdown(btnId, menuId){
      const btn = $(btnId), menu = $(menuId);
      btn.addEventListener("click", (e)=>{
        e.stopPropagation();
        const isOpen = !menu.classList.contains("hidden");
        closeDropdowns();
        if (!isOpen) menu.classList.remove("hidden");
      });
    }
    setupDropdown("shareBtnTop","shareMenuTop");
    setupDropdown("shareBtnModal","shareMenuModal");

    window.addEventListener("click", closeDropdowns);
    window.addEventListener("scroll", closeDropdowns, { passive:true });
    window.addEventListener("resize", closeDropdowns);

    // --- Share ---
    function buildShareText(){
      const url = `${SITE_ORIGIN}/blitstiek.html`;
      if (!TARGET) return `BLITSTIEK – Kriptiek\n${url}`;

      const t = formatMs(gameState.bestRunMs || gameState.elapsedMs || 0);
      const line = gameState.won
        ? `Ek het BLITSTIEK vandag gewen in ${t}.`
        : `Kom speel vandag se BLITSTIEK.`;

      return `${line}\nTeiken: ${TARGET}\n${url}`;
    }

    async function shareVia(kind){
      const txt = buildShareText();
      const url = `${SITE_ORIGIN}/blitstiek.html`;

      if (kind === "copy") {
        try{
          await navigator.clipboard.writeText(txt);
          showAlert("Gekopieer.", "ok");
        }catch{
          showAlert("Kon nie kopieer nie.", "error");
        }
        return;
      }

      if (kind === "whatsapp") {
        const wa = `https://wa.me/?text=${encodeURIComponent(txt)}`;
        window.open(wa, "_blank", "noopener");
        return;
      }

      // system share
      try{
        if (!navigator.share) {
          showAlert("Stelseldeel is nie beskikbaar op hierdie toestel nie.", "error");
          return;
        }

        // Try attach image
        let files = undefined;
        try{
          const res = await fetch("/assets/BLITSTIEK_12SEP.png", { cache:"no-store" });
          const blob = await res.blob();
          const file = new File([blob], "BLITSTIEK_12SEP.png", { type: blob.type || "image/png" });
          files = [file];
        }catch{}

        const payload = files ? { text: txt, url, files } : { text: txt, url };
        await navigator.share(payload);
      }catch{
        // user canceled or failed
      }
    }

    document.querySelectorAll('[data-share]').forEach(btn=>{
      btn.addEventListener("click", ()=>{
        closeDropdowns();
        shareVia(btn.getAttribute("data-share"));
      });
    });

    $("closeResultBtn").addEventListener("click", ()=> $("resultModal").classList.add("hidden"));
    // --- Game state + rendering ---
    const gridEl = $("grid");

    function computeCellSize(){
      // keep crisp sizing: fit within center column, clamp
      const container = gridEl.parentElement;
      const maxW = Math.min(520, Math.max(320, container.clientWidth - 2));
      const cell = Math.floor((maxW - 20 - (COLS-1)*2) / COLS); // 20 padding + gaps
      document.documentElement.style.setProperty("--cell", `${cell}px`);
    }
    window.addEventListener("resize", ()=>{ clearTimeout(window.__cellT); window.__cellT=setTimeout(computeCellSize, 80); });

    function makeEmptyGrid(){
      const g = [];
      for (let r=0;r<ROWS;r++){
        const row = [];
        for (let c=0;c<COLS;c++) row.push(null);
        g.push(row);
      }
      return g;
    }

    const gameState = {
      running:false,
      paused:false,
      won:false,
      startedAtMs:0,
      elapsedMs:0,
      bestRunMs:0,
      tickTimer:null,
      dropMs:520,
      grid: makeEmptyGrid(),
      falling: null, // {r,c,letter,colorIdx}
    };

    function setStatus(msg){
      $("statusLine").textContent = msg;
    }

    function drawGrid(){
      gridEl.innerHTML = "";
      gridEl.style.setProperty("--cols", COLS);
      gridEl.style.setProperty("--rows", ROWS);

      for (let r=0;r<ROWS;r++){
        for (let c=0;c<COLS;c++){
          const cell = document.createElement("div");
          cell.className = "cell cell-empty";
          const v = gameState.grid[r][c];

          if (v) {
            cell.className = "cell cell-solid";
            cell.style.background = COLORS[v.colorIdx]?.bg || "#94a3b8";
            cell.style.color = COLORS[v.colorIdx]?.fg || "#0b1220";
            cell.textContent = v.letter;
          } else {
            cell.textContent = "";
          }

          gridEl.appendChild(cell);
        }
      }
    }

    function paintFallingOnGrid(){
      // draw base grid then overlay falling
      drawGrid();
      if (!gameState.falling) return;

      const { r, c, letter, colorIdx } = gameState.falling;
      if (r < 0 || r >= ROWS || c < 0 || c >= COLS) return;

      const idx = r*COLS + c;
      const cell = gridEl.children[idx];
      if (!cell) return;

      cell.className = "cell cell-solid";
      cell.style.background = COLORS[colorIdx]?.bg || "#94a3b8";
      cell.style.color = COLORS[colorIdx]?.fg || "#0b1220";
      cell.textContent = letter;
    }

    function randomLetter(){
      const alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
      const allow = TARGET ? (alphabet + TARGET) : alphabet;
      const i = Math.floor(Math.random()*allow.length);
      return allow[i];
    }

    function spawn(){
      const letter = randomLetter();
      const colorIdx = Math.floor(Math.random()*COLORS.length);
      const c = Math.floor(COLS/2);
      const r = 0;

      // If spawn blocked -> reset
      if (gameState.grid[r][c]) {
        setStatus("Rooster vol – herbegin.");
        gameState.running = false;
        gameState.paused = false;
        $("pauseBtn").classList.add("hidden");
        $("startBtn").classList.remove("hidden");
        return;
      }

      gameState.falling = { r, c, letter, colorIdx };
      paintFallingOnGrid();
    }

    function canMove(dr, dc){
      const f = gameState.falling;
      if (!f) return false;
      const nr = f.r + dr;
      const nc = f.c + dc;
      if (nc < 0 || nc >= COLS) return false;
      if (nr < 0 || nr >= ROWS) return false;
      return !gameState.grid[nr][nc];
    }

    function move(dr, dc){
      if (!gameState.running || gameState.paused || gameState.won) return;
      if (!gameState.falling) return;
      if (!canMove(dr, dc)) return;
      gameState.falling.r += dr;
      gameState.falling.c += dc;
      paintFallingOnGrid();
    }

    function lockFalling(){
      const f = gameState.falling;
      if (!f) return;
      gameState.grid[f.r][f.c] = { letter: f.letter, colorIdx: f.colorIdx };
      gameState.falling = null;
    }

    function neighbors4(r,c){
      return [
        [r-1,c],[r+1,c],[r,c-1],[r,c+1]
      ].filter(([rr,cc])=> rr>=0 && rr<ROWS && cc>=0 && cc<COLS);
    }

    function findGroups(){
      const seen = new Set();
      const groups = [];
      for (let r=0;r<ROWS;r++){
        for (let c=0;c<COLS;c++){
          const v = gameState.grid[r][c];
          if (!v) continue;
          const key = `${r},${c}`;
          if (seen.has(key)) continue;

          const stack = [[r,c]];
          const cells = [];
          seen.add(key);

          while (stack.length){
            const [rr,cc] = stack.pop();
            cells.push([rr,cc]);
            for (const [nr,nc] of neighbors4(rr,cc)){
              const vv = gameState.grid[nr][nc];
              if (!vv) continue;
              if (vv.letter !== v.letter) continue;
              if (vv.colorIdx !== v.colorIdx) continue;
              const k = `${nr},${nc}`;
              if (seen.has(k)) continue;
              seen.add(k);
              stack.push([nr,nc]);
            }
          }

          groups.push({ letter: v.letter, colorIdx: v.colorIdx, cells });
        }
      }
      return groups;
    }

    function applyGravity(){
      for (let c=0;c<COLS;c++){
        let write = ROWS-1;
        for (let r=ROWS-1;r>=0;r--){
          const v = gameState.grid[r][c];
          if (v){
            if (write !== r){
              gameState.grid[write][c] = v;
              gameState.grid[r][c] = null;
            }
            write--;
          }
        }
      }
    }
    function clearMatches(){
      // remove groups size>=3, unless letter is in target
      let any = false;
      const groups = findGroups();
      for (const g of groups){
        if (g.cells.length < 3) continue;
        if (TARGET_SET && TARGET_SET.has(g.letter)) continue; // protect target letters
        any = true;
        for (const [r,c] of g.cells) gameState.grid[r][c] = null;
      }
      if (any) applyGravity();
      return any;
    }

    function checkWin(){
      if (!TARGET) return false;
      const t = TARGET.toUpperCase();
      for (let r=0;r<ROWS;r++){
        let row = "";
        for (let c=0;c<COLS;c++){
          row += (gameState.grid[r][c]?.letter || ".");
        }
        if (row.includes(t)) return true;
      }
      return false;
    }

    function updateTimer(){
      if (!gameState.running || gameState.paused || gameState.won) return;
      gameState.elapsedMs = Date.now() - gameState.startedAtMs;
      $("yourTime").textContent = formatMs(gameState.elapsedMs);
    }

    function tick(){
      if (!gameState.running || gameState.paused || gameState.won) return;

      updateTimer();

      if (!gameState.falling) spawn();

      // try move down; if cannot -> lock + clear + win check + spawn
      if (canMove(1,0)) {
        move(1,0);
        return;
      }

      lockFalling();

      // clear chains
      let loops = 0;
      while (clearMatches() && loops < 12) loops++;

      if (checkWin()) {
        finishWin();
        return;
      }

      spawn();
    }

    function hardDrop(){
      if (!gameState.running || gameState.paused || gameState.won) return;
      if (!gameState.falling) return;
      while (canMove(1,0)) gameState.falling.r += 1;
      paintFallingOnGrid();
      // force lock + resolve
      tick();
    }

    function resetGame(keepTarget=true){
      gameState.running=false;
      gameState.paused=false;
      gameState.won=false;
      gameState.startedAtMs=0;
      gameState.elapsedMs=0;
      gameState.grid = makeEmptyGrid();
      gameState.falling=null;

      if (gameState.tickTimer) clearInterval(gameState.tickTimer);
      gameState.tickTimer = null;

      $("yourTime").textContent = "00:00.0";
      $("pauseBtn").classList.add("hidden");
      $("startBtn").classList.remove("hidden");
      setStatus(keepTarget ? "Gereed. Klik Begin." : "Laai…");
      drawGrid();
    }

    function startGame(){
      if (!TARGET) { setStatus("Geen teiken nie."); return; }
      if (gameState.running) return;

      gameState.running=true;
      gameState.paused=false;
      gameState.won=false;
      gameState.startedAtMs = Date.now();
      gameState.elapsedMs = 0;
      $("startBtn").classList.add("hidden");
      $("pauseBtn").classList.remove("hidden");
      setStatus("Speel!");
      spawn();
      gameState.tickTimer = setInterval(tick, gameState.dropMs);
    }

    function togglePause(){
      if (!gameState.running || gameState.won) return;
      gameState.paused = !gameState.paused;
      if (gameState.paused) {
        setStatus("Pouse.");
        $("pauseBtn").textContent = "Gaan voort";
      } else {
        setStatus("Speel!");
        $("pauseBtn").textContent = "Pouse";
        // adjust start time so timer remains correct
        gameState.startedAtMs = Date.now() - gameState.elapsedMs;
      }
    }

    $("startBtn").addEventListener("click", startGame);
    $("pauseBtn").addEventListener("click", togglePause);
    $("resetGameBtn").addEventListener("click", ()=> resetGame(true));
    $("leftBtn").addEventListener("click", ()=> move(0,-1));
    $("rightBtn").addEventListener("click", ()=> move(0,1));
    $("dropBtn").addEventListener("click", hardDrop);

    // Keyboard
    window.addEventListener("keydown", (e)=>{
      if (["ArrowLeft","ArrowRight"," "].includes(e.key)) e.preventDefault();
      if (e.key === "ArrowLeft") move(0,-1);
      if (e.key === "ArrowRight") move(0,1);
      if (e.key === " ") hardDrop();
    }, { passive:false });

    // --- Result + submission ---
    function openResultModal(){
      $("resultModal").classList.remove("hidden");
    }

    async function finishWin(){
      gameState.won = true;
      gameState.running = false;
      if (gameState.tickTimer) clearInterval(gameState.tickTimer);
      gameState.tickTimer = null;

      gameState.bestRunMs = gameState.elapsedMs;
      $("yourTime").textContent = formatMs(gameState.elapsedMs);
      setStatus("Jy het gewen!");

      // Show checkpoint after first completion (local)
      try{
        const key = `blitstiek-${GAME_ID}-done`;
        localStorage.setItem(key, "1");
        // show gate once
        const gateKey = `blitstiek-supportgate-${GAME_ID}`;
        if (!localStorage.getItem(gateKey)) {
          $("supportGate").classList.remove("hidden");
          localStorage.setItem(gateKey, "1");
        }
      }catch{}

      // Modal text
      const t = formatMs(gameState.elapsedMs);
      $("resultText").innerHTML = `Jy het vandag se teiken (<span class="font-extrabold">${TARGET}</span>) gevorm in <span class="font-extrabold">${t}</span>.`;

      // Submit only if signed in (not guest)
      if (currentUser && !guestMode) {
        await submitTimeToBoard(gameState.elapsedMs);
      } else {
        showAlert("Jy speel as gas; jou tyd word nie gestoor nie. Meld aan om op die ranglys te verskyn.", "info");
      }

      openResultModal();
      await loadLeaderboard();
    }

    async function submitTimeToBoard(ms){
      if (!currentUser || !GAME_ID) return;

      const uid = currentUser.uid;
      const name = (currentUser.displayName || "").trim() || "Speler";
      const rowRef = doc(db, "blitstiekGames", GAME_ID, "leaderboard", uid);

      // Read existing best
      let prevBest = Infinity;
      try{
        const snap = await getDoc(rowRef);
        if (snap.exists()) {
          const d = snap.data() || {};
          const x = Number(d.bestMs ?? d.bestTimeMs ?? Infinity);
          if (isFinite(x) && x > 0) prevBest = x;
        }
      }catch{}

      const bestMs = Math.min(prevBest, ms);
      try{
        await setDoc(rowRef, {
          userName: name,
          bestMs,
          updatedAtMs: Date.now()
        }, { merge:true });
      }catch(err){
        console.error(err);
        showAlert("Kon nie jou tyd stoor nie. Kyk Firestore-regte.", "error");
        return;
      }

      // Append run
      try{
        const runsCol = collection(db, "blitstiekGames", GAME_ID, "leaderboard", uid, "runs");
        await addDoc(runsCol, { ms, atMs: Date.now() });
      }catch{
        // ignore run log failure
      }

      showAlert("Jou tyd is op die ranglys gestoor.", "ok");
    }
    // Support gate buttons
    $("supportLaterBtn").addEventListener("click", ()=> $("supportGate").classList.add("hidden"));

    // --- Init after auth/game load ---
    async function initAfterAuth(){
      computeCellSize();
      resetGame(false);

      setStatus("Laai vandag se spel…");

      const resolved = await resolveGameId();
      GAME_ID = resolved.id;

      // Expect game doc to have target (field names supported)
      const data = resolved.data || {};
      TARGET = String(
        data.target || data.word || data.targetWord || data.teiken || data.teikenwoord || ""
      ).toUpperCase().trim();

      if (!TARGET) {
        TARGET = "KRIPTIEK"; // safe fallback so the page doesn't dead-end
        showAlert("Kon nie vandag se teiken laai nie; val terug na ’n veilige teiken.", "error");
      }

      TARGET_SET = new Set(TARGET.split(""));

      renderTargetChips(TARGET);
      resetGame(true);

      // Restore best-time display from leaderboard
      await loadLeaderboard();

      // If already done, show small message + allow play
      try{
        const key = `blitstiek-${GAME_ID}-done`;
        if (localStorage.getItem(key) === "1") {
          setStatus("Jy het vandag reeds gewen. Jy kan weer speel vir pret.");
          // show checkpoint (but not every refresh)
          const gateKey = `blitstiek-supportgate-${GAME_ID}`;
          if (!localStorage.getItem(gateKey)) {
            $("supportGate").classList.remove("hidden");
            localStorage.setItem(gateKey, "1");
          }
        }
      }catch{}

      // Show share tile after first completion (optional)
      // (kept simple here; share is always available)
    }

    // --- Guest gate: show if not signed in and no guest choice yet ---
    function maybeShowGuestGate(){
      if (currentUser) {
        $("guestGate").classList.add("hidden");
        return;
      }
      if (guestMode) {
        $("guestGate").classList.add("hidden");
        return;
      }
      $("guestGate").classList.remove("hidden");
    }

    // --- Auth listener ---
    onAuthStateChanged(auth, async (user)=>{
      hideAlert();
      currentUser = user || null;

      if (currentUser) {
        guestMode = false;
        $("guestGate").classList.add("hidden");
      } else {
        // If we came back from login/register
        try{
          const ret = sessionStorage.getItem("returnAfterAuth") || localStorage.getItem("redirectAfterLogin");
          if (ret === "/blitstiek.html") { /* no-op */ }
        }catch{}
      }

      await renderAuthUI(currentUser);
      maybeShowGuestGate();

      // Always init once (or re-init if auth changes)
      await initAfterAuth();
    });

    // Ensure register link returns here
    (function wireReturnUrls(){
      try{
        sessionStorage.setItem("returnAfterAuth", "/blitstiek.html");
        localStorage.setItem("redirectAfterLogin", "/blitstiek.html");
        const reg = $("goRegisterBtn");
        if (reg) reg.href = "/register.html";
      }catch{}
    })();

    // Initial paint
    drawGrid();
    setStatus("Laai…");
  </script>
</body>
</html>
<!--
NOTAS (vir jou verwysing):
- Hierdie lêer lees Ondersteuner-status uit: supportersPublic/{uid}.active (public-read).
- Jou useradmin.html skryf daardie boolean wanneer jy "Stoor" druk.
- Ranglys: blitstiekGames/{GAME_ID}/leaderboard/{uid} met bestMs en userName.
- "Speel as gas" werk sonder Auth, maar stoor niks na Firestore nie.
-->
