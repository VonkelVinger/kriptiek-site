<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin – Create DILEMMA Game</title>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js';
    import {
      getFirestore, doc, setDoc, getDoc, collection, query, where, getDocs, serverTimestamp
    } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js';
    import {
      getAuth, signInWithEmailAndPassword, onAuthStateChanged
    } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js';

    const firebaseConfig = {
      apiKey: "AIzaSyDH-nVvGkdaheH7pvRHH0M9TbW2f98lMGQ",
      authDomain: "kriptiek-c9ea2.firebaseapp.com",
      projectId: "kriptiek-c9ea2",
      storageBucket: "kriptiek-c9ea2.appspot.com",
      messagingSenderId: "620450620939",
      appId: "1:620450620939:web:e93a18ac23b53b33db890e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const ADMIN_UID = "jI7f0Wk4MqfPq7p69vjl8OlJUvS2";
    const ADMIN_EMAILS = new Set([
      // Add whitelisted admin emails here if using email-based admin in rules
      // "you@yourdomain.com",
    ]);

    function isAdminClient(user) {
      if (!user) return false;
      return user.uid === ADMIN_UID || (user.email && ADMIN_EMAILS.has(user.email));
    }

    const loginForm = document.getElementById('loginForm');
    const adminForm = document.getElementById('adminForm');
    const notAllowed = document.getElementById('notAllowed');

    onAuthStateChanged(auth, (user) => {
      if (isAdminClient(user)) {
        loginForm.style.display = "none";
        adminForm.style.display = "block";
        notAllowed.style.display = "none";
      } else if (user) {
        loginForm.style.display = "none";
        adminForm.style.display = "none";
        notAllowed.style.display = "block";
      } else {
        loginForm.style.display = "block";
        adminForm.style.display = "none";
        notAllowed.style.display = "none";
      }
    });

    window.login = async () => {
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value.trim();
      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (error) {
        alert("Aanmelding het misluk: " + error.message);
      }
    };

    window.saveGame = async () => {
      const date = document.getElementById('date').value;
      const word = document.getElementById('word').value.trim();
      const wordUpper = word.toUpperCase();
      const wordLower = word.toLowerCase();
      const clue = document.getElementById('clue').value.trim();

      if (!date || !wordUpper || !clue) {
        alert("Please complete all fields.");
        return;
      }

      // 1) Check duplicates in /words
      try {
        const wordDocRef = doc(db, 'words', wordLower);
        const wordDoc = await getDoc(wordDocRef);
        if (wordDoc.exists()) {
          alert("That target word has already been used. Choose another word.");
          return;
        }
      } catch (e) {
        console.error("Duplicate check (words) failed:", e);
        alert("Could not verify duplicates right now. Please try again.");
        return;
      }

      // 2) Extra check in /games
      try {
        const dupQ = query(collection(db, 'games'), where('word', '==', wordUpper));
        const dupSnap = await getDocs(dupQ);
        if (!dupSnap.empty) {
          alert("That target word has already been used. Choose another word.");
          return;
        }
      } catch (e) {
        console.warn("Secondary duplicate query failed:", e);
      }

      const gameId = `Game${date}`;

      try {
        await setDoc(doc(db, 'games', gameId), {
          date,
          word: wordUpper,
          clue,
          created: serverTimestamp()
        });

        await setDoc(doc(db, 'words', wordLower), {
          word: wordLower,
          created: serverTimestamp()
        });

        alert(`Game '${gameId}' successfully saved.`);
      } catch (e) {
        console.error("Error writing document:", e);
        alert(`Failed to save game. ${e?.message || ''}`);
      }
    };

    // ---------- Auto-fill the clue field ----------
    const TEMPLATE_PREFIX = "VANDAG SE MISLEIDRAAD: ";

    function updateClueTemplate(force = false) {
      const wordEl = document.getElementById('word');
      const clueEl = document.getElementById('clue');
      if (!wordEl || !clueEl) return;

      const userIsEditing = clueEl.dataset.autofilled === "false";
      if (userIsEditing && !force) return;

      const len = (wordEl.value || "").trim().toUpperCase().length;
      const x = len > 0 ? len : "x";
      if (force || !clueEl.value.trim() || clueEl.dataset.autofilled === "true") {
        clueEl.value = `${TEMPLATE_PREFIX}XXXX (${x} letters).`;
        clueEl.dataset.autofilled = "true";
      }
    }

    function initClueAutofill() {
      const wordEl = document.getElementById('word');
      const clueEl = document.getElementById('clue');
      if (!wordEl || !clueEl) return;

      clueEl.addEventListener("input", () => { clueEl.dataset.autofilled = "false"; });
      wordEl.addEventListener("input", () => updateClueTemplate());
      if (!clueEl.value.trim()) updateClueTemplate(true);
    }

    document.addEventListener("DOMContentLoaded", initClueAutofill);
  </script>
</head>
<body style="font-family: sans-serif; max-width: 600px; margin: 40px auto;">
  <h1>🔐 Admin: Skep Nuwe DILEMMA</h1>

  <div id="loginForm" style="display: none;">
    <p>Meld aan om voort te gaan:</p>
    <input id="email" type="email" placeholder="E-pos" /><br><br>
    <input id="password" type="password" placeholder="Wagwoord" /><br><br>
    <button onclick="login()">Meld aan</button>
  </div>

  <div id="notAllowed" style="display: none; color: red;">
    <p>🚫 Jy is aangemeld, maar het nie toegang nie.</p>
  </div>

  <div id="adminForm" style="display: none;">
    <label>Date (YYYY-MM-DD):<br><input type="date" id="date" required></label><br><br>
    <label>Target Word:<br><input type="text" id="word" maxlength="14" placeholder="bv. DWAALSPOOR" required></label><br><br>
    <label>Leidraad:<br><textarea id="clue" rows="4" style="width: 100%;" placeholder="Tik leidraad hier..." required></textarea></label><br><br>
    <button onclick="saveGame()" style="padding: 10px 20px; font-weight: bold;">STUUR</button>
  </div>
</body>
</html>
