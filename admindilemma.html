<!DOCTYPE html>
<html lang="af">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin – Create DILEMMA Game</title>

  <!-- Tailwind & Font -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&display=swap" rel="stylesheet" />
  <style>
    body { font-family: 'Montserrat', sans-serif; }
  </style>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js';
    import {
      getFirestore, doc, getDoc, setDoc, serverTimestamp,
      collection, query, where, getDocs
    } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js';
    import {
      getAuth, onAuthStateChanged, signOut
    } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js';

    // ---- CONFIG ----
    const firebaseConfig = {
      apiKey: "AIzaSyDH-nVvGkdaheH7pvRHH0M9TbW2f98lMGQ",
      authDomain: "kriptiek-c9ea2.firebaseapp.com",
      projectId: "kriptiek-c9ea2",
      storageBucket: "kriptiek-c9ea2.appspot.com",
      messagingSenderId: "620450620939",
      appId: "1:620450620939:web:e93a18ac23b53b33db890e"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    const auth = getAuth(app);

    // ---- DOM ----
    const statusEl     = document.getElementById('authStatus');
    const logoutBtn    = document.getElementById('logoutBtn');
    const dateInput    = document.getElementById('gameDate');
    const wordInput    = document.getElementById('targetWord');
    const clueInput    = document.getElementById('clue');
    const saveBtn      = document.getElementById('saveBtn');
    const checkBtn     = document.getElementById('checkBtn');
    const resultEl     = document.getElementById('result');
    const linkEl       = document.getElementById('gameLink');

    // ---- Helpers ----
    function todayZA() {
      const now = new Date();
      const p = new Intl.DateTimeFormat('af-ZA', {
        timeZone: 'Africa/Johannesburg',
        year: 'numeric', month: '2-digit', day: '2-digit'
      }).formatToParts(now).reduce((a, x) => (a[x.type] = x.value, a), {});
      return `${p.year}-${p.month}-${p.day}`; // YYYY-MM-DD
    }

    function clearResult() {
      resultEl.textContent = '';
      resultEl.className = '';
      linkEl.textContent = '';
      linkEl.removeAttribute('href');
    }

    function showOk(msg, hrefId=null) {
      resultEl.textContent = msg;
      resultEl.className = 'mt-3 text-green-700 font-semibold';
      if (hrefId) {
        linkEl.textContent = 'Open spelblad';
        linkEl.href = `/dilemmagame.html?gameId=${encodeURIComponent(hrefId)}`;
      }
    }

    function showErr(msg) {
      resultEl.textContent = msg;
      resultEl.className = 'mt-3 text-red-600 font-semibold';
    }

    async function wordExists(wordUpper) {
      // Option A: block reuse by checking games where 'word' equals this value
      const q = query(collection(db, 'games'), where('word', '==', wordUpper));
      const snap = await getDocs(q);
      return !snap.empty;
    }

    async function saveGame() {
      clearResult();

      const dateStr = (dateInput.value || '').trim();
      const wordRaw = (wordInput.value || '').trim();
      const clueRaw = (clueInput.value || '').trim();

      if (!dateStr) { showErr('Kies ’n datum (YYYY-MM-DD).'); return; }
      if (!wordRaw) { showErr('Voer die teikenwoord in.'); return; }
      if (!clueRaw) { showErr('Voer die leidraad in.'); return; }

      const wordUpper = wordRaw.toUpperCase();
      if (!/^[A-ZÁÉÍÓÚÄËÏÖÜÂÊÎÔÛŸ\-]+$/.test(wordUpper)) {
        // Allow basic accented letters & hyphen; adjust as needed for Afrikaans.
        showErr('Die woord moet uit letters bestaan (A–Z, met basiese aksente) en/of ’n koppelteken.');
        return;
      }

      // Duplicate doc ID guard across BOTH formats
      const idPreferred = `Game${dateStr}`;
      const idAlt       = dateStr;

      const [a, b, reuse] = await Promise.all([
        getDoc(doc(db, 'games', idPreferred)),
        getDoc(doc(db, 'games', idAlt)),
        wordExists(wordUpper)
      ]);

      if (a.exists() || b.exists()) {
        const existing = a.exists() ? idPreferred : idAlt;
        showErr(`’n Speletjie vir ${dateStr} bestaan reeds as “${existing}”.`);
        return;
      }
      if (reuse) {
        showErr(`Die woord “${wordUpper}” is reeds gebruik. Kies ’n ander teikenwoord.`);
        return;
      }

      // Payload (write both 'clue' en 'leidraad' vir terugwaartse kompatibiliteit)
      const payload = {
        date: dateStr,
        word: wordUpper,
        clue: clueRaw,
        leidraad: clueRaw,
        status: 'published',
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp(),
        createdBy: auth.currentUser?.uid || null
      };

      try {
        await setDoc(doc(db, 'games', idPreferred), payload, { merge: true });
        showOk(`Gestoor as ${idPreferred}.`, idPreferred);
      } catch (e) {
        console.error(e);
        showErr(`Kon nie stoor nie: ${e?.message || e}`);
      }
    }

    async function checkWordReuseOnly() {
      clearResult();
      const w = (wordInput.value || '').trim().toUpperCase();
      if (!w) { showErr('Geen woord ingevul nie.'); return; }
      try {
        const used = await wordExists(w);
        if (used) showErr(`Die woord “${w}” is reeds gebruik.`);
        else showOk(`“${w}” is nog nie gebruik nie.`);
      } catch (e) {
        console.error(e);
        showErr('Kon nie die woordkontrole uitvoer nie.');
      }
    }

    // ---- Auth state (UI only; rules still enforce admin) ----
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        const token = await user.getIdTokenResult().catch(()=>null);
        const isAdminClaim = !!token?.claims?.admin;
        statusEl.innerHTML = `Aangemeld as <strong>${user.email || user.uid}</strong>${isAdminClaim ? ' (admin)' : ''}.`;
        logoutBtn.classList.remove('hidden');
      } else {
        statusEl.innerHTML = `Nie aangemeld nie. <a href="/login.html" class="underline text-blue-700">Meld aan</a> as admin.`;
        logoutBtn.classList.add('hidden');
      }
    });

    logoutBtn.addEventListener('click', () => signOut(auth));

    // ---- Init form defaults ----
    document.addEventListener('DOMContentLoaded', () => {
      dateInput.value = todayZA();
      wordInput.addEventListener('input', () => { wordInput.value = wordInput.value.toUpperCase(); });
      saveBtn.addEventListener('click', saveGame);
      checkBtn.addEventListener('click', checkWordReuseOnly);
    });
  </script>
</head>
<body class="bg-gray-100 min-h-screen">
  <header class="bg-white shadow p-4">
    <h1 class="text-2xl font-bold text-center">Admin · Create DILEMMA Game</h1>
  </header>

  <main class="max-w-2xl mx-auto p-4">
    <div class="bg-white rounded shadow p-4">
      <div id="authStatus" class="text-sm text-gray-600 mb-3">Kontroleer aanmelding…</div>
      <button id="logoutBtn" class="hidden text-xs px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 mb-4">Meld af</button>

      <div class="grid grid-cols-1 gap-4">
        <label class="block">
          <span class="font-semibold">Datum (YYYY-MM-DD)</span>
          <input id="gameDate" type="date" class="mt-1 w-full border rounded px-3 py-2" />
        </label>

        <label class="block">
          <span class="font-semibold">Teikenwoord</span>
          <input id="targetWord" type="text" class="mt-1 w-full border rounded px-3 py-2 uppercase" placeholder="bv. WATER" />
          <p class="text-xs text-gray-500 mt-1">Word outomaties in hoofletters gestoor.</p>
        </label>

        <label class="block">
          <span class="font-semibold">Leidraad</span>
          <textarea id="clue" rows="3" class="mt-1 w-full border rounded px-3 py-2" placeholder="Skryf hier die leidraad…"></textarea>
        </label>

        <div class="flex gap-3">
          <button id="saveBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">
            Stoor spel
          </button>
          <button id="checkBtn" class="bg-gray-200 text-gray-900 px-4 py-2 rounded hover:bg-gray-300 transition">
            Toets of woord reeds gebruik is
          </button>
        </div>

        <p id="result" class="mt-3"></p>
        <a id="gameLink" class="underline text-blue-700 font-semibold" target="_blank" rel="noopener"></a>

        <hr class="my-4">
        <p class="text-xs text-gray-500">
          Nota: Die dokument-ID word altyd as <code>GameYYYY-MM-DD</code> gestoor, en ’n
          <code>date</code>-veld (YYYY-MM-DD, Africa/Johannesburg) word bygevoeg. Die stooraksie stop as:
          ’n dokument vir die datum reeds bestaan (in enige formaat), of as die teikenwoord reeds gebruik is.
        </p>
      </div>
    </div>
  </main>

  <footer class="bg-white shadow p-4 text-center text-sm text-gray-500">
    &copy; 2025 Kriptiek. Alle regte voorbehou.
  </footer>
</body>
</html>
