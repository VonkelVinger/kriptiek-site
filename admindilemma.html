<!DOCTYPE html>
<html lang="af">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin ‚Äì Create DILEMMA Game</title>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js';
    import {
      getFirestore, doc, setDoc, getDoc, collection, query, where, getDocs, serverTimestamp
    } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js';
    import {
      getAuth, signInWithEmailAndPassword, onAuthStateChanged
    } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js';

    const firebaseConfig = {
      apiKey: "AIzaSyDH-nVvGkdaheH7pvRHH0M9TbW2f98lMGQ",
      authDomain: "kriptiek-c9ea2.firebaseapp.com",
      projectId: "kriptiek-c9ea2",
      storageBucket: "kriptiek-c9ea2.appspot.com",
      messagingSenderId: "620450620939",
      appId: "1:620450620939:web:e93a18ac23b53b33db890e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // --- Admin gating (unchanged) ---
    const ADMIN_UID = "jI7f0Wk4MqfPq7p69vjl8OlJUvS2";
    const ADMIN_EMAILS = new Set([
      // "you@yourdomain.com",
    ]);
    function isAdminClient(user) {
      if (!user) return false;
      return user.uid === ADMIN_UID || (user.email && ADMIN_EMAILS.has(user.email));
    }

    const loginForm = document.getElementById('loginForm');
    const adminForm = document.getElementById('adminForm');
    const notAllowed = document.getElementById('notAllowed');

    onAuthStateChanged(auth, (user) => {
      if (isAdminClient(user)) {
        loginForm.style.display = "none";
        adminForm.style.display = "block";
        notAllowed.style.display = "none";
      } else if (user) {
        loginForm.style.display = "none";
        adminForm.style.display = "none";
        notAllowed.style.display = "block";
      } else {
        loginForm.style.display = "block";
        adminForm.style.display = "none";
        notAllowed.style.display = "none";
      }
    });

    window.login = async () => {
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value.trim();
      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (error) {
        alert("Aanmelding het misluk: " + error.message);
      }
    };

    // --- Date helpers (SAST) ---
    function toSASTDateKey(d = new Date()) {
      const parts = new Intl.DateTimeFormat('en-CA', {
        timeZone: 'Africa/Johannesburg',
        year: 'numeric', month: '2-digit', day: '2-digit'
      }).formatToParts(d);
      const y = parts.find(p => p.type === 'year').value;
      const m = parts.find(p => p.type === 'month').value;
      const da = parts.find(p => p.type === 'day').value;
      return `${y}-${m}-${da}`;
    }

    function todayKeySAST() {
      return toSASTDateKey(new Date());
    }

    // --- Save Game (UPDATED to use dateKey as doc ID) ---
    window.saveGame = async () => {
      const dateInput = document.getElementById('date').value; // yyyy-mm-dd (no time)
      const word = document.getElementById('word').value.trim();
      const wordUpper = word.toUpperCase();
      const wordLower = word.toLowerCase();
      const clue = document.getElementById('clue').value.trim();

      if (!dateInput || !wordUpper || !clue) {
        alert("Vul asseblief al die velde in.");
        return;
      }

      // dateInput from <input type="date"> is already "YYYY-MM-DD".
      // Treat it as a SAST calendar date:
      const dateKey = dateInput;

      // Optional: sanity check (prevent back-dating by mistake)
      const todayKey = todayKeySAST();
      if (dateKey < todayKey) {
        const proceed = confirm(`Let wel: ${dateKey} is in die verlede. Gaan voort?`);
        if (!proceed) return;
      }

      // 1) Check duplicates in /words (exact reuse prevention)
      try {
        const wordDocRef = doc(db, 'words', wordLower);
        const wordDoc = await getDoc(wordDocRef);
        if (wordDoc.exists()) {
          alert("Daardie teikenwoord is reeds gebruik. Kies asseblief 'n ander woord.");
          return;
        }
      } catch (e) {
        console.error("Duplicate check (words) failed:", e);
        alert("Kon nie nou vir duplikate toets nie. Probeer weer.");
        return;
      }

      // 2) Secondary duplicate check in /games by word (belt-and-braces)
      try {
        const dupQ = query(collection(db, 'games'), where('word', '==', wordUpper));
        const dupSnap = await getDocs(dupQ);
        if (!dupSnap.empty) {
          alert("Daardie teikenwoord is reeds gebruik. Kies asseblief 'n ander woord.");
          return;
        }
      } catch (e) {
        console.warn("Secondary duplicate query failed:", e);
      }

      // 3) Prevent accidental overwrite if a game for this date already exists
      try {
        const existing = await getDoc(doc(db, 'games', dateKey));
        if (existing.exists()) {
          alert(`Daar is reeds 'n spel vir ${dateKey}. Kies 'n ander datum of wysig die bestaande inskrywing.`);
          return;
        }
      } catch (e) {
        console.warn("Pre-existence check failed:", e);
      }

      // 4) Write new game with doc ID = dateKey
      try {
        await setDoc(doc(db, 'games', dateKey), {
          dateKey,              // canonical SAST date key that UI pages will query
          word: wordUpper,
          clue,
          created: serverTimestamp()
        });

        // Mark the word as used
        await setDoc(doc(db, 'words', wordLower), {
          word: wordLower,
          usedBy: dateKey,
          created: serverTimestamp()
        });

        alert(`Speletjie vir ${dateKey} gestoor.`);
        // Optional: clear form
        // document.getElementById('adminForm').reset();
      } catch (e) {
        console.error("Error writing document:", e);
        alert(`Kon nie spel stoor nie. ${e?.message || ''}`);
      }
    };

    // ---------- Auto-fill the clue field ----------
    const TEMPLATE_PREFIX = "VANDAG SE MISLEIDRAAD: ";

    function updateClueTemplate(force = false) {
      const wordEl = document.getElementById('word');
      const clueEl = document.getElementById('clue');
      if (!wordEl || !clueEl) return;

      const userIsEditing = clueEl.dataset.autofilled === "false";
      if (userIsEditing && !force) return;

      const len = (wordEl.value || "").trim().toUpperCase().length;
      const x = len > 0 ? len : "x";
      if (force || !clueEl.value.trim() || clueEl.dataset.autofilled === "true") {
        clueEl.value = `${TEMPLATE_PREFIX}XXXX (${x} letters).`;
        clueEl.dataset.autofilled = "true";
      }
    }

    function initClueAutofill() {
      const wordEl = document.getElementById('word');
      const clueEl = document.getElementById('clue');
      if (!wordEl || !clueEl) return;

      clueEl.addEventListener("input", () => { clueEl.dataset.autofilled = "false"; });
      wordEl.addEventListener("input", () => updateClueTemplate());
      if (!clueEl.value.trim()) updateClueTemplate(true);
    }

    document.addEventListener("DOMContentLoaded", initClueAutofill);
  </script>
</head>
<body style="font-family: sans-serif; max-width: 600px; margin: 40px auto;">
  <h1>üîê Admin: Skep Nuwe DILEMMA</h1>

  <div id="loginForm" style="display: none;">
    <p>Meld aan om voort te gaan:</p>
    <input id="email" type="email" placeholder="E-pos" /><br><br>
    <input id="password" type="password" placeholder="Wagwoord" /><br><br>
    <button onclick="login()">Meld aan</button>
  </div>

  <div id="notAllowed" style="display: none; color: red;">
    <p>üö´ Jy is aangemeld, maar het nie toegang nie.</p>
  </div>

  <div id="adminForm" style="display: none;">
    <label>Datum (YYYY-MM-DD):<br><input type="date" id="date" required></label><br><br>
    <label>Teikenwoord:<br><input type="text" id="word" maxlength="14" placeholder="bv. DWAALSPOOR" required></label><br><br>
    <label>Leidraad:<br><textarea id="clue" rows="4" style="width: 100%;" placeholder="Tik leidraad hier..." required></textarea></label><br><br>
    <button onclick="saveGame()" style="padding: 10px 20px; font-weight: bold;">STUUR</button>
  </div>
</body>
</html>
