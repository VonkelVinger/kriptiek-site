<!DOCTYPE html>
<html lang="af">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SLIMSTIEK Argief – Kriptiek</title>

  <!-- Favicon and App Icons -->
  <link rel="icon" href="/assets/favicon.ico?v=2" type="image/x-icon" />
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png?v=3">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png?v=3">
  <link rel="apple-touch-icon" href="/assets/apple-touch-icon.png?v=3">
  <link rel="manifest" href="/assets/site.webmanifest?v=3">

  <!-- Styles -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&display=swap" rel="stylesheet" />
  <style>
    body { font-family: 'Montserrat', sans-serif; background-color: #f8f5f2; }

    /* Calendar */
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      text-align: center;
    }
    .calendar-grid div { padding: 0.5rem; border-radius: 4px; }
    .calendar-grid a {
      display: block;
      padding: 0.5rem;
      border-radius: 4px;
      font-weight: bold;
      text-decoration: none;
      transition: transform 120ms ease, box-shadow 120ms ease, background-color 120ms ease;
      box-sizing: border-box;
      color: #fff;
    }
    .calendar-grid a:hover { transform: translateY(-1px); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .day-header { font-weight: bold; color: #374151; }

    /* Legend swatches */
    .legend-swatch { width: 20px; height: 20px; border-radius: 0.375rem; display: inline-block; box-sizing: border-box; }

    /* Header/logo */
    .logo-container {
      position: relative; display: flex; justify-content: center; align-items: center;
      width: fit-content; margin: 1rem auto; padding: 1rem; border-radius: 1rem; background-color: white; overflow: hidden;
    }
    .crossword-grid { display: grid; grid-template-columns: repeat(8, minmax(40px, 1fr)); gap: 4px; position: relative; z-index: 10; }
    .letter-box {
      width: 50px; height: 50px; display: flex; justify-content: center; align-items: center;
      background-color: #374151; color: white; font-size: 1.8rem; font-weight: bold; border: 2px solid #1f2937; border-radius: 0.375rem;
      text-transform: uppercase; box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.2);
    }
    .background-crossword {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: grid;
      grid-template-columns: repeat(auto-fill, minmax(30px, 1fr)); grid-template-rows: repeat(auto-fill, minmax(30px, 1fr));
      opacity: 0.5; z-index: 1; pointer-events: none;
    }
    .bg-letter { display: flex; justify-content: center; align-items: center; font-size: 1.1rem; font-weight: bold; color: #9ca3af; border: 1px solid #e5e7eb; background-color: transparent; user-select: none; }

    @media (max-width: 768px) {
      .letter-box { width: 40px; height: 40px; font-size: 1.5rem; }
      .crossword-grid { gap: 3px; }
      .logo-container { padding: 1rem; }
      .bg-letter { font-size: 1rem; }
    }
    @media (max-width: 480px) {
      .letter-box { width: 35px; height: 35px; font-size: 1.2rem; }
      .crossword-grid { gap: 2px; }
      .logo-container { padding: 0.75rem; }
      .bg-letter { font-size: 0.9rem; }
    }
  </style>
</head>
<body class="min-h-screen p-4 text-gray-100 bg-[#f8f5f2]">

  <!-- Header/logo -->
  <header class="bg-white shadow p-4 mb-6">
    <div class="logo-container">
      <div id="backgroundCrossword" class="background-crossword"></div>
      <div class="crossword-grid">
        <div class="letter-box" style="transform:scaleX(-1)">K</div>
        <div class="letter-box" style="transform:scaleX(-1)">R</div>
        <div class="letter-box">I</div>
        <div class="letter-box" style="transform:scaleX(-1)">P</div>
        <div class="letter-box">T</div>
        <div class="letter-box">I</div>
        <div class="letter-box" style="transform:scaleX(-1)">E</div>
        <div class="letter-box">K</div>
      </div>
    </div>
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        const backgroundCrossword = document.getElementById('backgroundCrossword');
        const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
        function rand() { return letters[Math.floor(Math.random() * letters.length)]; }
        function drawGrid() {
          backgroundCrossword.innerHTML = '';
          const rows = Math.ceil(backgroundCrossword.offsetHeight / 30);
          const cols = Math.ceil(backgroundCrossword.offsetWidth / 30);
          const total = (rows * cols) || 300;
          for (let i = 0; i < total; i++) {
            const d = document.createElement('div');
            d.className = 'bg-letter';
            d.textContent = rand();
            backgroundCrossword.appendChild(d);
          }
        }
        drawGrid();
        window.addEventListener('resize', drawGrid);
      });
    </script>
  </header>

  <section class="text-center mb-6">
    <h1 class="text-3xl font-bold mb-3 text-[#374151]">Slimstiek-argief</h1>

    <!-- Legend -->
    <div class="max-w-3xl mx-auto text-sm text-gray-700 flex items-center justify-center gap-6">
      <span class="inline-flex items-center gap-2">
        <span class="legend-swatch" style="background-color:#ea580c;"></span>
        Vandag
      </span>
      <span class="inline-flex items-center gap-2">
        <span class="legend-swatch" style="background-color:#374151;"></span>
        Gespeel
      </span>
      <span class="inline-flex items-center gap-2">
        <span class="legend-swatch" style="background-color:#166534;"></span>
        Nog nie gespeel nie
      </span>
    </div>
  </section>

  <main class="max-w-3xl mx-auto">
    <div id="archiveList" class="space-y-10"></div>
    <div id="emptyMsg" class="text-center text-gray-500 hidden">Geen vorige speletjies om te wys nie.</div>

    <div id="monthNav" class="flex justify-between mt-6 hidden">
      <button id="prevMonth" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 text-[#374151]">← Vorige maand</button>
      <button id="nextMonth" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 text-[#374151]">Volgende maand →</button>
    </div>
  </main>

  <footer class="bg-white shadow p-4 text-center text-sm text-gray-500 mt-8">
    &copy; 2025 Kriptiek. Alle regte voorbehou. |
    <a href="/index.html" class="underline">Tuis</a> |
    <a href="/slimstiek.html" class="underline">Terug na Slimstiek</a> |
    <a href="/forum.html" class="underline">Gesels saam</a> |
    <a href="/privacy.html" class="underline">Privaatheidsbeleid</a> |
    <a href="/terms.html" class="underline">Voorwaardes</a> |
    <a href="/faq.html" class="underline">Gereelde vrae</a> |
    <a href="/about.html" class="underline">Oor Kriptiek</a> |
    <a href="/contact.html" class="underline">Kontak ons</a>
  </footer>

  <script type="module">
    // Firebase (optional read)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import {
      getFirestore, collection, getDocs, query, where
    } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDH-nVvGkdaheH7pvRHH0M9TbW2f98lMGQ",
      authDomain: "kriptiek-c9ea2.firebaseapp.com",
      projectId: "kriptiek-c9ea2",
      storageBucket: "kriptiek-c9ea2.appspot.com",
      messagingSenderId: "620450620939",
      appId: "1:620450620939:web:e93a18ac23b53b33db890e"
    };

    let db = null;
    try { db = getFirestore(initializeApp(firebaseConfig)); } catch(e) { /* ok if no FS */ }

    // Colors (match legend)
    const ORANGE = "#ea580c"; // today
    const BLUE   = "#374151"; // played (device)
    const GREEN  = "#166534"; // not played
    const BASE   = "block px-2 py-2 rounded font-bold text-white";

    const ADMIN_UID = "jI7f0Wk4MqfPq7p69vjl8OlJUvS2";

    // ZA "today" (Africa/Johannesburg)
    function todayKeySAST() {
      const parts = new Intl.DateTimeFormat('en-CA', {
        timeZone: 'Africa/Johannesburg',
        year: 'numeric', month: '2-digit', day: '2-digit'
      }).formatToParts(new Date());
      const y = parts.find(p => p.type === 'year').value;
      const m = parts.find(p => p.type === 'month').value;
      const d = parts.find(p => p.type === 'day').value;
      return `${y}-${m}-${d}`;
    }
    const TODAY = todayKeySAST();

    // Device-played detection (localStorage fallback used by Slimstiek)
    function devicePlayed(dateKey) {
      try {
        const arr = JSON.parse(localStorage.getItem(`slimstiekLocalLB:${dateKey}`) || '[]');
        return Array.isArray(arr) && arr.length > 0;
      } catch { return false; }
    }

    // --- Load only admin-created Slimstiek games ---------------------------------
    function extractDateKey(doc) {
      const data = doc.data ? doc.data() : {};
      if (data && typeof data.date === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(data.date)) return data.date;
      if (data && typeof data.gameId === 'string') {
        const m1 = data.gameId.match(/^Game(\d{4}-\d{2}-\d{2})$/);
        if (m1) return m1[1];
        if (/^\d{4}-\d{2}-\d{2}$/.test(data.gameId)) return data.gameId;
      }
      if (doc.id) {
        const m2 = doc.id.match(/^Game(\d{4}-\d{2}-\d{2})$/);
        if (m2) return m2[1];
        if (/^\d{4}-\d{2}-\d{2}$/.test(doc.id)) return doc.id;
      }
      return null;
    }

    async function loadAdminSlimstiekDates() {
      const set = new Set();
      if (!db) return set;

      const col = collection(db, "slimstiekGames");
      const q1 = query(col, where("adminCreated", "==", true));
      const q2 = query(col, where("createdBy", "==", ADMIN_UID));

      const snaps = await Promise.all([getDocs(q1), getDocs(q2)]);
      for (const snap of snaps) {
        snap.forEach(doc => {
          const data = doc.data();
          if ((data?.target || data?.word || "").toUpperCase() === "TUTS") return;
          const dateKey = extractDateKey(doc);
          if (dateKey && dateKey <= TODAY) set.add(dateKey);
        });
      }

      return set;
    }

    // --- Calendar rendering limited to available dates ---------------------------
    let AVAILABLE_DATES = new Set();   // YYYY-MM-DD
    let MIN_DATE = null;
    let MAX_DATE = null;

    function computeMinMax() {
      if (AVAILABLE_DATES.size === 0) { MIN_DATE = MAX_DATE = null; return; }
      const arr = Array.from(AVAILABLE_DATES).sort();
      MIN_DATE = arr[0];
      MAX_DATE = arr[arr.length - 1];
    }

    function monthKeyFromDate(d) {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2,'0');
      return `${y}-${m}`;
    }

    function monthHasAny(mk) {
      for (const d of AVAILABLE_DATES) if (d.slice(0,7) === mk) return true;
      return false;
    }

    function renderMonth(monthKey) {
      const container = document.getElementById("archiveList");
      container.innerHTML = "";

      const [year, month] = monthKey.split("-");
      const monthName = new Date(`${year}-${month}-01`).toLocaleString("af-ZA", { month: "long", year: "numeric" });

      const section = document.createElement("div");

      const heading = document.createElement("h2");
      heading.className = "text-2xl font-semibold text-[#374151] mb-4";
      heading.textContent = monthName;
      section.appendChild(heading);

      const calendar = document.createElement("div");
      calendar.className = "calendar-grid";

      ["Ma","Di","Wo","Do","Vr","Sa","So"].forEach(d => {
        const header = document.createElement("div");
        header.className = "day-header";
        header.textContent = d;
        calendar.appendChild(header);
      });

      const firstDay = new Date(`${year}-${month}-01`);
      const totalDays = new Date(year, month, 0).getDate();
      const startDay = (firstDay.getDay() + 6) % 7; // Monday-start

      for (let i = 0; i < startDay; i++) calendar.appendChild(document.createElement("div"));

      for (let day = 1; day <= totalDays; day++) {
        const dateStr = `${year}-${month}-${String(day).padStart(2, "0")}`;
        const cell = document.createElement("div");
        const isAvailable = AVAILABLE_DATES.has(dateStr);
        const isFuture = dateStr > TODAY;

        if (isAvailable && !isFuture) {
          const a = document.createElement("a");
          a.href = `/slimstiek.html?date=${dateStr}`;
          a.textContent = day;
          a.className = BASE;

          const isPlayed = devicePlayed(dateStr);
          const isToday = dateStr === TODAY;

          if (isToday) {
            a.style.backgroundColor = ORANGE;
          } else if (isPlayed) {
            a.style.backgroundColor = BLUE;
          } else {
            a.style.backgroundColor = GREEN;
          }

          a.setAttribute(
            "aria-label",
            isToday
              ? `Vandag – ${dateStr}`
              : (isPlayed ? `Gespeel op ${dateStr}` : `Nie gespeel op ${dateStr}`)
          );

          cell.appendChild(a);
        } else {
          const span = document.createElement("span");
          span.textContent = day;
          span.className = "text-gray-400";
          cell.appendChild(span);
        }

        calendar.appendChild(cell);
      }

      section.appendChild(calendar);
      container.appendChild(section);
    }

    const monthNav = document.getElementById("monthNav");
    const prevBtn  = document.getElementById("prevMonth");
    const nextBtn  = document.getElementById("nextMonth");

    let current = new Date();

    function updateMonthNavButtons() {
      if (!MIN_DATE) { prevBtn.disabled = true; nextBtn.disabled = true; return; }
      const mk = monthKeyFromDate(current);
      const todayMonth = TODAY.slice(0,7);
      const minYYYYMM = MIN_DATE.slice(0,7);
      prevBtn.disabled = mk <= minYYYYMM;

      const maxYYYYMM = (MAX_DATE || TODAY).slice(0,7);
      const upperBound = maxYYYYMM < todayMonth ? maxYYYYMM : todayMonth;
      nextBtn.disabled = mk >= upperBound;
    }

    function update({allowClamp = true} = {}) {
      const mk = monthKeyFromDate(current);
      if (allowClamp && AVAILABLE_DATES.size > 0 && !monthHasAny(mk)) {
        // move back until you find a month with games (never when empty)
        let tries = 0;
        while (!monthHasAny(monthKeyFromDate(current)) && tries < 36) {
          current.setMonth(current.getMonth() - 1);
          tries++;
        }
      }
      renderMonth(monthKeyFromDate(current));
      monthNav.classList.remove("hidden");
      updateMonthNavButtons();
    }

    prevBtn.addEventListener("click", ()=>{
      current.setMonth(current.getMonth()-1);
      update();
    });
    nextBtn.addEventListener("click", ()=>{
      current.setMonth(current.getMonth()+1);
      update();
    });

    // Init
    (async () => {
      AVAILABLE_DATES = await loadAdminSlimstiekDates();
      computeMinMax();

      const emptyMsg = document.getElementById("emptyMsg");

      if (AVAILABLE_DATES.size === 0) {
        // Show today's month as a skeleton, do not clamp or enable nav
        emptyMsg.classList.remove("hidden");
        current = new Date();                    // keep 2025-09 (today), not 2022
        renderMonth(monthKeyFromDate(current));  // no clamp
        monthNav.classList.add("hidden");        // hide nav (nothing to browse)
        return;
      }

      // Start at the latest available month (<= TODAY)
      current = new Date((MAX_DATE || TODAY).replace(/-/g, "/"));
      emptyMsg.classList.add("hidden");
      update(); // normal clamping allowed
    })();
  </script>
</body>
</html>
