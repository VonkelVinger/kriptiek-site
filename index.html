<!DOCTYPE html>
<html lang="af">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kriptiek</title>

  <!-- Favicon and App Icons -->
  <link rel="icon" href="/assets/favicon.ico?v=2" type="image/x-icon" />
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png?v=3">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png?v=3">
  <link rel="apple-touch-icon" href="/assets/apple-touch-icon.png?v=3">
  <link rel="manifest" href="/assets/site.webmanifest?v=3">

  <!-- Social Share Image -->
  <meta property="og:image" content="https://www.kriptiek.com/assets/share-logo.png?v=1" />
  <meta name="twitter:image" content="https://www.kriptiek.com/assets/share-logo.png?v=1" />
  <meta property="og:title" content="Kriptiek â€“ Tuiste van DILEMMA" />
  <meta property="og:description" content="Speel DILEMMA aanlyn" />
  <meta property="og:url" content="https://www.kriptiek.com/" />
  <meta property="og:type" content="website" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="image" content="https://www.kriptiek.com/assets/share-logo.png?v=1" />

  <!-- Styles -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&display=swap" rel="stylesheet">

  <!-- Firebase boot + global logout -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDH-nVvGkdaheH7pvRHH0M9TbW2f98lMGQ",
      authDomain: "kriptiek-c9ea2.firebaseapp.com",
      projectId: "kriptiek-c9ea2",
      storageBucket: "kriptiek-c9ea2.appspot.com",
      messagingSenderId: "620450620939",
      appId: "1:620450620939:web:e93a18ac23b53b33db890e"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    // Global logout helper (kept; no visible button)
    window.kriptiekLogout = async function () {
      try { await signOut(auth); } finally {
        try { localStorage.clear(); sessionStorage.clear(); } catch {}
        setTimeout(() => { window.location.href = "/index.html"; }, 120);
      }
    };

    // Hardened listener: set/clear localStorage based on real auth state
    document.addEventListener('DOMContentLoaded', () => {
      onAuthStateChanged(auth, (user) => {
        if (user) {
          localStorage.setItem('userRegistered', 'true');
          localStorage.setItem('userId', user.uid);
          localStorage.setItem('userEmail', user.email || "");
          if (user.displayName) localStorage.setItem('userName', user.displayName);
        } else {
          localStorage.removeItem('userRegistered');
          // optional extra cleanup:
          // localStorage.removeItem('userName');
          // localStorage.removeItem('userEmail');
        }
      });
    });
  </script>

  <style>
    body { font-family: 'Montserrat', sans-serif; }
    /* Logo banner */
    .logo-container {
      position: relative; display: flex; justify-content: center; align-items: center;
      width: fit-content; margin: 1rem auto; padding: 1rem; border-radius: 1rem; background-color: white; overflow: hidden;
      isolation: isolate;
    }
    .logo-container::before{
      content:""; position:absolute; inset:-2px; border-radius:1rem;
      background:conic-gradient(from 180deg at 50% 50%, #1e3a8a, #334155, #1e3a8a);
      animation:spin 14s linear infinite; z-index:0; padding:2px;
      mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite: xor; mask-composite: exclude;
    }
    @keyframes spin{ to{ transform:rotate(1turn); } }
    @media (prefers-reduced-motion: reduce){ .logo-container::before{ animation:none; } }

    .crossword-grid { display: grid; grid-template-columns: repeat(8, minmax(40px, 1fr)); gap: 4px; position: relative; z-index: 10; }
    .letter-box {
      width: 50px; height: 50px; display: flex; justify-content: center; align-items: center;
      background-color: #374151; color: white; font-size: 1.8rem; font-weight: bold; border: 2px solid #1f2937; border-radius: 0.375rem;
      text-transform: uppercase; box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.2);
    }
    .flipped-k { transform: scaleX(-1); }

    .background-crossword {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: grid;
      grid-template-columns: repeat(auto-fill, minmax(30px, 1fr)); grid-template-rows: repeat(auto-fill, minmax(30px, 1fr));
      opacity: 0.5; z-index: 1; pointer-events: none; animation: bgFloat 30s linear infinite;
    }
    @keyframes bgFloat{ 0%{ transform:translateY(0); } 50%{ transform:translateY(-12px); } 100%{ transform:translateY(0); } }

    .bg-letter-box { display: flex; justify-content: center; align-items: center; font-size: 1.1rem; font-weight: bold; color: #9ca3af; border: 1px solid #e5e7eb; background-color: transparent; user-select: none; }

    /* Tile hover */
    .tile-img { border-radius: 1rem; box-shadow: 6px 6px 14px rgba(0,0,0,.35); transition: transform .2s ease, box-shadow .2s ease; }
    .tile-img:hover { transform: translateY(-2px); box-shadow: 8px 8px 20px rgba(0,0,0,.4); }

    .dark-blue-text { color: #1e3a8a; font-weight: bold; }
    .message-text { max-width: 520px; margin: 0 auto; text-align: center; }

    @keyframes gentlePulse{ 0%,100%{ transform:scale(1); } 50%{ transform:scale(1.03); } }
    .btn-pulse{ animation:gentlePulse 1.6s ease-in-out 2; }
  </style>
</head>

<body class="bg-gray-100 min-h-screen flex flex-col">
  <header class="bg-white shadow p-4">
    <div class="logo-container">
      <div id="backgroundCrossword" class="background-crossword"></div>
      <div class="crossword-grid">
        <div class="letter-box flipped-k">K</div>
        <div class="letter-box flipped-k">R</div>
        <div class="letter-box">I</div>
        <div class="letter-box flipped-k">P</div>
        <div class="letter-box">T</div>
        <div class="letter-box">I</div>
        <div class="letter-box flipped-k">E</div>
        <div class="letter-box">K</div>
      </div>
    </div>
  </header>

  <main class="flex-grow py-10 sm:py-12 md:py-16 px-6 text-center relative">
    <!-- soft radial spotlight behind hero area -->
    <div class="pointer-events-none absolute inset-0 -z-10 bg-[radial-gradient(80%_50%_at_50%_0%,rgba(30,58,138,.08),transparent_60%)]"></div>

    <p id="heroHeading" class="text-3xl font-bold dark-blue-text mb-4">
      WELKOM BY KRIPTIEK
    </p>

    <p class="message-text">
      Kriptiek.com is die tuiste van DILEMMA en BLITSTIEK en binnekort ook ander Afrikaanse raaisels en woordspeletjies.
      Kies onder wat jy wil doen.
    </p>

    <a id="contactHeroLink" href="/contact.html" class="underline font-bold text-[#1e3a8a]">
      Kontak ons as jy enige probleme ervaar.
    </a>

    <!-- Mount points (kept for behaviour parity) -->
    <div id="dilemma-buttons" class="flex flex-col items-center gap-4 my-6"></div>
    <div id="blitstiek-buttons" class="flex flex-col items-center gap-4 my-6"></div>

    <!-- New tile grid mount -->

    <div id="tiles-grid" class="mt-5 mx-auto max-w-[28rem]"></div>
    <!-- Old Gesels Saam image (kept as fallback; will be hidden for signed-in users to avoid duplication) -->
    <section id="gesels-fallback" class="text-center mt-10">
      <a href="/forum.html" class="block mx-auto w-fit">
        <img src="/assets/gesels-saam.png" alt="Gesels saam" class="tile-img w-40 h-auto" />
      </a>
    </section>
  </main>
  <footer class="bg-white shadow p-4 text-center text-sm text-gray-500">
    &copy; 2025 Kriptiek. Alle regte voorbehou. |
    <a href="/profile.html" class="underline">My profiel</a> |
    <a href="/forum.html" class="underline">Gesels saam</a> |
    <a href="/privacy.html" class="underline">Privaatheidsbeleid</a> |
    <a href="/terms.html" class="underline">Voorwaardes</a> |
    <a href="/faq.html" class="underline">Gereelde vrae</a> |
    <a href="/about.html" class="underline">Oor Kriptiek</a> |
    <a href="/contact.html" class="underline">Kontak ons</a>
  </footer>

  <div id="cookie-banner" class="fixed bottom-0 left-0 w-full bg-white border-t border-gray-300 shadow-md p-4 text-sm text-gray-800 text-center z-50 hidden">
    <p class="mb-2">
      Ons gebruik koekies om jou ervaring te verbeter en die webwerf beter te laat werk.
      Lees meer in ons <a href="/privacy.html" class="underline text-blue-700 font-medium">Privaatheidsbeleid</a>.
    </p>
    <div class="flex justify-center gap-4">
      <button onclick="acceptCookies()" class="bg-blue-600 text-white px-4 py-1 rounded hover:bg-blue-700 transition">Ja, ek aanvaar dit so</button>
      <button onclick="declineCookies()" class="bg-gray-300 text-gray-800 px-4 py-1 rounded hover:bg-gray-400 transition">Nee dankie</button>
    </div>
  </div>

  <!-- Background letter grid + UI logic -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const backgroundCrossword = document.getElementById('backgroundCrossword');
      const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
      function getRandomLetter() { return letters[Math.floor(Math.random() * letters.length)]; }
      function generateBackgroundGrid() {
        backgroundCrossword.innerHTML = '';
        const numRows = Math.ceil(backgroundCrossword.offsetHeight / 30);
        const numCols = Math.ceil(backgroundCrossword.offsetWidth / 30);
        const totalCells = (numRows * numCols) || 300;
        for (let i = 0; i < totalCells; i++) {
          const bg = document.createElement('div');
          bg.className = 'bg-letter-box';
          bg.textContent = getRandomLetter();
          backgroundCrossword.appendChild(bg);
        }
      }
      generateBackgroundGrid();
      window.addEventListener('resize', generateBackgroundGrid);

      const main = document.querySelector('main');
      const introPara = document.querySelector('.message-text');
      const heroContact = document.getElementById('contactHeroLink');
      const dilemmaButtons = document.getElementById('dilemma-buttons');
      const blitstiekButtons = document.getElementById('blitstiek-buttons');
      const tilesGrid = document.getElementById('tiles-grid');
      const geselsFallback = document.getElementById('gesels-fallback');

      // reset mounts
      if (dilemmaButtons) dilemmaButtons.innerHTML = '';
      if (blitstiekButtons) blitstiekButtons.innerHTML = '';
      if (tilesGrid) tilesGrid.innerHTML = '';

      // helper: build a tile <a><img></a>
      const tile = (href, src, alt, id) => {
        const a = document.createElement('a');
        a.href = href || '#';
        if (id) a.id = id;
        const img = document.createElement('img');
        img.src = src; img.alt = alt;
        img.loading = 'lazy';
        img.className = 'tile-img w-40 h-40 sm:w-44 sm:h-44';
        a.appendChild(img);
        return a;
      };

      // cookie banner
      const cookieConsent = localStorage.getItem('cookieConsent');
      if (!cookieConsent) document.getElementById('cookie-banner').classList.remove('hidden');

      function showGuestView() {
        const heroHeading = document.getElementById('heroHeading');
        if (heroHeading) heroHeading.textContent = 'WELKOM BY KRIPTIEK';

        if (introPara) introPara.classList.remove('hidden');
        if (heroContact) heroContact.classList.remove('hidden');

        const message = document.createElement('div');
        message.className = 'text-center text-black font-semibold mb-6';
        message.innerHTML = `
          <div>Jy moet registreer of aanmeld voordat jy kan speel.</div>
          <div class="mt-4">
            <a href="/contact.html" class="underline font-bold text-[#1e3a8a]">
              Kontak ons as jy enige probleme ervaar.
            </a>
          </div>
        `;
        main.insertBefore(message, dilemmaButtons);

        // ensure mounts are visible for the guest card
        if (dilemmaButtons) dilemmaButtons.classList.remove('hidden');
        if (blitstiekButtons) blitstiekButtons.classList.remove('hidden');

        const registerBtn = document.createElement('a');
        registerBtn.href = "/register.html?new=1";
        registerBtn.textContent = "Registreer";
        registerBtn.className = "bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700";

        const loginBtn = document.createElement('a');
        loginBtn.href = "/login.html?new=1";
        loginBtn.textContent = "Meld aan";
        loginBtn.className = "bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700";

        const buttonGroup = document.createElement('div');
        buttonGroup.className = 'flex gap-4 justify-center';
        buttonGroup.appendChild(registerBtn);
        buttonGroup.appendChild(loginBtn);

        const card = document.createElement('div');
        card.className = 'mx-auto max-w-xl rounded-2xl bg-white/70 backdrop-blur shadow-sm ring-1 ring-gray-200 p-4';
        card.appendChild(buttonGroup);
        dilemmaButtons.appendChild(card);

        if (geselsFallback) geselsFallback.classList.remove('hidden');
      }

      function showSignedInView() {
        // hide the empty button mounts to remove the gap you saw
        if (dilemmaButtons) dilemmaButtons.classList.add('hidden');
        if (blitstiekButtons) blitstiekButtons.classList.add('hidden');

        // name resolution
        const storedName = (localStorage.getItem('userName') || '').trim();
        const storedEmail = (localStorage.getItem('userEmail') || '').trim();
        const fallbackName = storedEmail ? storedEmail.split('@')[0] : 'gebruiker';
        const playerName = storedName || fallbackName;

        // Change blue heading; no separate black greeting injected
        const heroHeading = document.getElementById('heroHeading');
        if (heroHeading) {
          heroHeading.innerHTML = `WELKOM TERUG, <strong>${playerName.toUpperCase()}</strong>`;
        }

        // Build 2-col tile grid
        const grid = document.createElement('div');
        grid.className = 'grid grid-cols-2 gap-6 justify-items-center';

        grid.appendChild(tile('#', '/assets/DILEMMA_12SEP.png', 'Dilemma', 'today-link'));
        grid.appendChild(tile('/dilemma-argief.html', '/assets/D_ARGIEF_12SEP.png', 'Dilemma Argief'));
        grid.appendChild(tile('#', '/assets/BLITSTIEK_12SEP.png', 'Blitstiek', 'blitstiek-today-link'));
        grid.appendChild(tile('/blitstiek-argief.html', '/assets/B_ARGIEF_12SEP.png', 'Blitstiek Argief'));
        grid.appendChild(tile('/profile.html', '/assets/K_MY_PROFIEL_12SEP.png', 'My Profiel'));
        grid.appendChild(tile('/forum.html', '/assets/K_GESELS_12SEP.png', 'Gesels'));

        tilesGrid.appendChild(grid);

        // hide old single Gesels image to avoid duplication
        if (geselsFallback) geselsFallback.classList.add('hidden');
      }

      if (localStorage.getItem('userRegistered') === 'true') {
        showSignedInView();
      } else {
        showGuestView();
      }
    });

    function acceptCookies() { localStorage.setItem('cookieConsent', 'accepted'); document.getElementById('cookie-banner').style.display = 'none'; }
    function declineCookies() { localStorage.setItem('cookieConsent', 'declined'); document.getElementById('cookie-banner').style.display = 'none'; }
  </script>

  <!-- ZA-safe "today" resolver for DILEMMA -->
  <script type="module">
    import { getFirestore, collection, query, where, limit, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
    const db = getFirestore();

    // YYYY-MM-DD in Africa/Johannesburg
    function todayZA() {
      const now = new Date();
      const p = new Intl.DateTimeFormat('af-ZA', { timeZone: 'Africa/Johannesburg', year: 'numeric', month: '2-digit', day: '2-digit' })
        .formatToParts(now).reduce((a, x) => (a[x.type] = x.value, a), {});
      return `${p.year}-${p.month}-${p.day}`;
    }

    async function resolveTodayGameId() {
      const d = todayZA();

      // 1) Preferred: a 'date' field on /games docs
      try {
        const q = query(collection(db, 'games'), where('date', '==', d), limit(1));
        const snap = await getDocs(q);
        if (!snap.empty) return snap.docs[0].id;
      } catch (_) {}

      // 2) Fallback: doc id "GameYYYY-MM-DD"
      try {
        const ref1 = doc(db, 'games', `Game${d}`);
        const got1 = await getDoc(ref1);
        if (got1.exists()) return got1.id;
      } catch (_) {}

      // 3) Fallback: doc id "YYYY-MM-DD"
      try {
        const ref2 = doc(db, 'games', d);
        const got2 = await getDoc(ref2);
        if (got2.exists()) return got2.id;
      } catch (_) {}

      return null;
    }

    document.addEventListener('DOMContentLoaded', async () => {
      const playBtn = document.getElementById('today-link');
      if (!playBtn) return;
      try {
        const gameId = await resolveTodayGameId();
        if (gameId) {
          playBtn.href = `/dilemmagame.html?gameId=${encodeURIComponent(gameId)}`;
          playBtn.classList.add('btn-pulse');
        } else {
          playBtn.removeAttribute('href');
          playBtn.classList.add('cursor-not-allowed');
          playBtn.title = 'Geen leidraad beskikbaar nie';
        }
      } catch (_) {}
    });
  </script>

  <!-- ZA-safe "today" resolver for BLITSTIEK -->
  <script type="module">
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
    const db = getFirestore();

    function todayZA() {
      const now = new Date();
      const p = new Intl.DateTimeFormat('af-ZA', { timeZone: 'Africa/Johannesburg', year: 'numeric', month: '2-digit', day: '2-digit' })
        .formatToParts(now).reduce((a, x) => (a[x.type] = x.value, a), {});
      return `${p.year}-${p.month}-${p.day}`;
    }

    async function resolveTodayBlitstiekId() {
      const d = todayZA();

      // Prefer doc id "GameYYYY-MM-DD" in /blitstiekGames
      try {
        const ref1 = doc(db, 'blitstiekGames', `Game${d}`);
        const got1 = await getDoc(ref1);
        if (got1.exists()) return got1.id;
      } catch (_) {}

      // Fallback: plain "YYYY-MM-DD"
      try {
        const ref2 = doc(db, 'blitstiekGames', d);
        const got2 = await getDoc(ref2);
        if (got2.exists()) return got2.id;
      } catch (_) {}

      return null;
    }

    document.addEventListener('DOMContentLoaded', async () => {
      const btn = document.getElementById('blitstiek-today-link');
      if (!btn) return;
      try {
        const gameId = await resolveTodayBlitstiekId();
        if (gameId) {
          btn.href = `/blitstiek.html?gameId=${encodeURIComponent(gameId)}`;
          btn.classList.add('btn-pulse');
        } else {
          btn.removeAttribute('href');
          btn.classList.add('cursor-not-allowed');
          btn.title = 'Geen Blitstiek beskikbaar vir vandag nie';
        }
      } catch (_) {}
    });
  </script>
</body>
</html>

