<!DOCTYPE html>
<html lang="af">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-S9V4CMP1FP"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-S9V4CMP1FP');
  </script>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DILEMMA-RANGLYS – Kriptiek</title>

  <!-- Styles -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Montserrat', sans-serif; }

    /* Header logo (matches index.html) */
    .logo-container {
      position: relative; display: flex; justify-content: center; align-items: center;
      width: fit-content; margin: 1rem auto; padding: 1rem; border-radius: 1rem; background-color: white; overflow: hidden;
      isolation: isolate;
    }
    .logo-container::before{
      content:""; position:absolute; inset:-2px; border-radius:1rem;
      background:conic-gradient(from 180deg at 50% 50%, #1e3a8a, #334155, #1e3a8a);
      animation:spin 14s linear infinite; z-index:0; padding:2px;
      mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite: xor; mask-composite: exclude;
    }
    @keyframes spin{ to{ transform:rotate(1turn); } }
    @media (prefers-reduced-motion: reduce){ .logo-container::before{ animation:none; } }

    .crossword-grid { display: grid; grid-template-columns: repeat(8, minmax(40px, 1fr)); gap: 4px; position: relative; z-index: 10; }
    .letter-box {
      width: 50px; height: 50px; display: flex; justify-content: center; align-items: center;
      background-color: #374151; color: white; font-size: 1.8rem; font-weight: bold; border: 2px solid #1f2937; border-radius: 0.375rem;
      text-transform: uppercase; box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.2);
    }
    .flipped-k { transform: scaleX(-1); }

    .background-crossword {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: grid;
      grid-template-columns: repeat(auto-fill, minmax(30px, 1fr)); grid-template-rows: repeat(auto-fill, minmax(30px, 1fr));
      opacity: 0.5; z-index: 1; pointer-events: none; animation: bgFloat 30s linear infinite;
    }
    @keyframes bgFloat{ 0%,100%{ transform:translateY(0); } 50%{ transform:translateY(-12px); } 100%{ transform:translateY(0); } }
    .bg-letter-box { display: flex; justify-content: center; align-items: center; font-size: 1.1rem; font-weight: bold; color: #9ca3af; border: 1px solid #e5e7eb; background-color: transparent; user-select: none; }

    /* Ranglys UI */
    .pill{ background:#f97316; color:#fff; padding:.25rem .6rem; border-radius:9999px; font-weight:700; font-size:.875rem; }
    .leader-card{ max-width:680px; margin:1rem auto 0; background:#fff; border-radius:1rem; box-shadow:0 10px 20px rgba(0,0,0,.06); overflow:hidden; }
    .row{ display:flex; align-items:center; justify-content:space-between; padding:.75rem 1rem; border-bottom:1px solid #e5e7eb; }
    .row:nth-child(odd){ background:#ffffff; }
    .row:nth-child(even){ background:#f9fafb; }
    .rank{ width:2rem; text-align:right; font-weight:700; color:#6b7280; }
    .name{ font-weight:700; color:#111827; }

    .fade-in { animation: fade .35s ease-out; }
    @keyframes fade { from{opacity:0;transform:translateY(4px)} to{opacity:1;transform:translateY(0)} }
  </style>

  <!-- Firebase (v11 modular to match index.html) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import {
      getFirestore, collection, getDocs, doc, getDoc
    } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDH-nVvGkdaheH7pvRHH0M9TbW2f98lMGQ",
      authDomain: "kriptiek-c9ea2.firebaseapp.com",
      projectId: "kriptiek-c9ea2",
      storageBucket: "kriptiek-c9ea2.appspot.com",
      messagingSenderId: "620450620939",
      appId: "1:620450620939:web:e93a18ac23b53b33db890e"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // Fallback if a leaderboard row lacks dailyPoints
    function pointsFromGuesses(guesses){
      const g = Number(guesses);
      if (g === 1) return 50;
      if (g === 2) return 40;
      if (g === 3) return 30;
      if (g === 4) return 20;
      if (g === 5) return 15;
      if (g === 6) return 10;
      return 0; // fail/invalid
    }

    async function loadOverallDilemma(){
      const listEl = document.getElementById('leaderboard');
      listEl.innerHTML = '<div class="p-6 text-center text-gray-500">Laai ranglys…</div>';

      // Aggregate totals from all games/*/leaderboard/*
      const totals = new Map(); // uid -> { name, points }
      try{
        const gamesSnap = await getDocs(collection(db, "games"));
        // For each game, read the leaderboard subcollection
        for (const gameDoc of gamesSnap.docs){
          const lbSnap = await getDocs(collection(db, "games", gameDoc.id, "leaderboard"));
          lbSnap.forEach(rowDoc => {
            const data = rowDoc.data() || {};
            const uid  = rowDoc.id;
            const name = (data.userName || data.name || 'Speler').toString();
            // Prefer stored dailyPoints; otherwise derive from guesses if available
            let pts = Number(data.dailyPoints);
            if (!Number.isFinite(pts) || pts < 0) {
              if (data.guesses != null) pts = pointsFromGuesses(data.guesses);
              else pts = 0;
            }
            if (pts > 0){
              const prev = totals.get(uid) || { name, points:0 };
              // keep most recent non-empty name
              const mergedName = (name && name !== 'Speler') ? name : prev.name;
              totals.set(uid, { name: mergedName, points: prev.points + pts });
            }
          });
        }
      }catch(err){
        console.error('Dilemma-ranglys: lees fout:', err);
        listEl.innerHTML = '<div class="p-6 text-center text-red-600">Kon nie die ranglys laai nie.</div>';
        return;
      }

      // Transform, sort desc, take top 25
      const rows = Array.from(totals.entries())
        .map(([uid, v]) => ({ uid, userName: v.name || 'Speler', total: Number(v.points||0) }))
        .filter(x => x.total > 0)
        .sort((a,b) => b.total - a.total)
        .slice(0, 25);

      // Render
      if (rows.length === 0){
        listEl.innerHTML = '<div class="p-6 text-center text-gray-500">Nog geen inskrywings.</div>';
        return;
      }

      const frag = document.createDocumentFragment();
      rows.forEach((u, i) => {
        const div = document.createElement('div'); div.className = 'row fade-in';
        const left = document.createElement('div'); left.className = 'flex items-center space-x-3';
        const r = document.createElement('div'); r.className = 'rank'; r.textContent = (i+1) + '.';
        const n = document.createElement('div'); n.className = 'name'; n.textContent = u.userName;
        left.appendChild(r); left.appendChild(n);
        const pill = document.createElement('div'); pill.className = 'pill'; pill.textContent = String(u.total);
        div.appendChild(left); div.appendChild(pill);
        frag.appendChild(div);
      });
      listEl.innerHTML = '';
      listEl.appendChild(frag);
    }

    document.addEventListener('DOMContentLoaded', loadOverallDilemma);
  </script>
</head>

<body class="bg-gray-100 min-h-screen flex flex-col">
  <!-- Header (matches index.html) -->
  <header class="bg-white shadow p-4">
    <div class="logo-container">
      <div id="backgroundCrossword" class="background-crossword"></div>
      <div class="crossword-grid">
        <div class="letter-box flipped-k">K</div>
        <div class="letter-box flipped-k">R</div>
        <div class="letter-box">I</div>
        <div class="letter-box flipped-k">P</div>
        <div class="letter-box">T</div>
        <div class="letter-box">I</div>
        <div class="letter-box flipped-k">E</div>
        <div class="letter-box">K</div>
      </div>
    </div>
  </header>

  <main class="flex-grow py-10 sm:py-12 md:py-16 px-6 text-center relative">
    <div class="pointer-events-none absolute inset-0 -z-10 bg-[radial-gradient(80%_50%_at_50%_0%,rgba(30,58,138,.08),transparent_60%)]"></div>

    <h1 class="text-3xl font-bold text-[#1e3a8a] mb-4">DILEMMA-RANGLYS</h1>

    <section class="leader-card">
      <div id="leaderboard" role="list"></div>
    </section>
  </main>

  <!-- Footer (same as index.html) -->
  <footer class="bg-white shadow p-4 text-center text-sm text-gray-500">
    &copy; 2025 Kriptiek. Alle regte voorbehou. |
    <a href="/profile.html" class="underline">My profiel</a> |
    <a href="/forum.html" class="underline">Gesels saam</a> |
    <a href="/privacy.html" class="underline">Privaatheidsbeleid</a> |
    <a href="/terms.html" class="underline">Voorwaardes</a> |
    <a href="/faq.html" class="underline">Gereelde vrae</a> |
    <a href="/about.html" class="underline">Oor Kriptiek</a> |
    <a href="/contact.html" class="underline">Kontak ons</a>
  </footer>

  <!-- Background letters (same as index.html) -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const backgroundCrossword = document.getElementById('backgroundCrossword');
      const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
      function getRandomLetter() { return letters[Math.floor(Math.random() * letters.length)]; }
      function generateBackgroundGrid() {
        if (!backgroundCrossword) return;
        backgroundCrossword.innerHTML = '';
        const numRows = Math.ceil(backgroundCrossword.offsetHeight / 30);
        const numCols = Math.ceil(backgroundCrossword.offsetWidth / 30);
        const totalCells = (numRows * numCols) || 300;
        for (let i = 0; i < totalCells; i++) {
          const bg = document.createElement('div');
          bg.className = 'bg-letter-box';
          bg.textContent = getRandomLetter();
          backgroundCrossword.appendChild(bg);
        }
      }
      generateBackgroundGrid();
      window.addEventListener('resize', generateBackgroundGrid);
    });
  </script>
</body>
</html>
