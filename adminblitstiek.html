<!DOCTYPE html>
<html lang="af">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin – Skep BLITSTIEK Speletjie</title>

  <!-- Tailwind & Font -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&display=swap" rel="stylesheet" />
  <style>
    :root { --brand-dark:#0f2a43; --brand-accent:#0b5ed7; }
    body { font-family: 'Montserrat', sans-serif; background:#f7fafc; }
    .logo-tile{ background:#374151; color:#fff; border:2px solid #1f2937; border-radius:.375rem; }
    .flipped-k{ transform:scaleX(-1); }
    .hidden{ display:none; }
  </style>
</head>
<body class="min-h-screen flex flex-col">

  <!-- Header -->
  <header class="w-full bg-white shadow-sm">
    <div class="max-w-5xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="grid grid-cols-8 gap-1">
          <div class="logo-tile w-7 h-7 flex items-center justify-center flipped-k">K</div>
          <div class="logo-tile w-7 h-7 flex items-center justify-center">R</div>
          <div class="logo-tile w-7 h-7 flex items-center justify-center">I</div>
          <div class="logo-tile w-7 h-7 flex items-center justify-center">P</div>
          <div class="logo-tile w-7 h-7 flex items-center justify-center">T</div>
          <div class="logo-tile w-7 h-7 flex items-center justify-center">I</div>
          <div class="logo-tile w-7 h-7 flex items-center justify-center">E</div>
          <div class="logo-tile w-7 h-7 flex items-center justify-center">K</div>
        </div>
        <h1 class="text-xl md:text-2xl font-bold tracking-wide text-[var(--brand-dark)]">Admin – BLITSTIEK</h1>
      </div>
      <button id="btnSignOut" class="hidden bg-gray-100 hover:bg-gray-200 text-gray-800 px-3 py-1.5 rounded-md text-sm">Meld af</button>
    </div>
  </header>

  <main class="flex-1">
    <div class="max-w-3xl mx-auto px-4 py-6">
      <!-- Single admin banner -->
      <div id="adminAlert" class="hidden border border-red-200 bg-red-50 text-red-800 p-4 rounded-lg mb-6">
        <p class="font-semibold">Net administrateurs</p>
        <p class="text-sm mt-1">Meld as admin aan om hierdie bladsy te gebruik.</p>
      </div>

      <!-- Toasts -->
      <div id="msgOk"  class="hidden border border-green-200 bg-green-50 text-green-800 p-4 rounded-lg mb-4"></div>
      <div id="msgErr" class="hidden border border-red-200 bg-red-50 text-red-800 p-4 rounded-lg mb-4"></div>

      <!-- Create card -->
      <div class="bg-white rounded-2xl shadow-sm border border-gray-100">
        <div class="px-5 py-4 border-b">
          <h2 class="text-lg font-semibold text-[var(--brand-dark)]">Skep nuwe BLITSTIEK speletjie</h2>
          <p class="text-sm text-gray-500 mt-1">Konvensie: GameID = <code>GameYYYY-MM-DD</code>. Die woord word in HOOFLETTERS gestoor.</p>
        </div>

        <div class="p-5 grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="inpDate" class="block text-sm font-medium text-gray-700 mb-1">Datum</label>
            <input id="inpDate" type="date" class="w-full rounded-lg border-gray-300 focus:border-[var(--brand-accent)] focus:ring-[var(--brand-accent)]" />
            <p class="text-xs text-gray-500 mt-1">GameID: <span id="idPreview" class="font-semibold">Game—</span></p>
          </div>

          <div>
            <label for="selStatus" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
            <select id="selStatus" class="w-full rounded-lg border-gray-300 focus:border-[var(--brand-accent)] focus:ring-[var(--brand-accent)]">
              <option value="scheduled">Geskeduleer</option>
              <option value="active">Aktief</option>
              <option value="archived">Gearchiveer</option>
            </select>
          </div>

          <div class="md:col-span-2">
            <label for="inpWord" class="block text-sm font-medium text-gray-700 mb-1">Teikenwoord (HOOFLETTERS)</label>
            <input id="inpWord" type="text" maxlength="12" placeholder="BYLAAG / SKOOL / VRIEND"
                   class="w-full rounded-lg border-gray-300 focus:border-[var(--brand-accent)] focus:ring-[var(--brand-accent)] uppercase tracking-wider" />
            <p class="text-xs text-gray-500 mt-1">Word outomaties na HOOFLETTERS omskep.</p>
          </div>

          <div class="md:col-span-2">
            <label for="inpLeidraad" class="block text-sm font-medium text-gray-700 mb-1">Leidraad (opsioneel)</label>
            <input id="inpLeidraad" type="text" maxlength="140"
                   class="w-full rounded-lg border-gray-300 focus:border-[var(--brand-accent)] focus:ring-[var(--brand-accent)]"
                   placeholder="Kort leidraad (indien van toepassing)" />
          </div>
        </div>

        <div class="px-5 pb-5 flex flex-wrap items-center gap-3">
          <button id="btnCreate" class="bg-[var(--brand-dark)] hover:bg-slate-800 text-white font-semibold px-5 py-2 rounded-xl">Skep speletjie</button>
          <button id="btnCheck"  class="bg-gray-100 hover:bg-gray-200 text-gray-800 font-semibold px-4 py-2 rounded-xl">Toets vir duplikate</button>
          <span id="busy" class="hidden text-sm text-gray-500">Besig…</span>
        </div>
      </div>

      <!-- Recent list -->
      <div class="mt-6 bg-white rounded-2xl shadow-sm border border-gray-100">
        <div class="px-5 py-4 border-b">
          <h3 class="text-base font-semibold text-[var(--brand-dark)]">Onlangse BLITSTIEK speletjies</h3>
        </div>
        <div id="listGames" class="p-5 text-sm text-gray-700"><p class="text-gray-500">Laai…</p></div>
      </div>
    </div>
  </main>

  <footer class="mt-auto bg-[var(--brand-dark)] text-white text-center py-6">
    <div class="max-w-5xl mx-auto px-4"><p class="text-sm opacity-90">Kriptiek – Admin</p></div>
  </footer>

  <!-- Firebase + Logic -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js';
    import {
      getFirestore, serverTimestamp, doc, setDoc, getDoc,
      collection, query, where, orderBy, limit, getDocs
    } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js';

    // ---- CONFIG (from admindilemma) ----
    const firebaseConfig = {
      apiKey: "AIzaSyDH-nVvGkdaheH7pvRHH0M9TbW2f98lMGQ",
      authDomain: "kriptiek-c9ea2.firebaseapp.com",
      projectId: "kriptiek-c9ea2",
      storageBucket: "kriptiek-c9ea2.appspot.com",
      messagingSenderId: "620450620939",
      appId: "1:620450620939:web:e93a18ac23b53b33db890e"
    };
    // Optional: same fallback UID used in admindilemma
    const ADMIN_UID = "jI7f0Wk4MqfPq7p69vjl8OlJUvS2";

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // DOM refs
    const adminAlert = document.getElementById('adminAlert');
    const btnSignOut = document.getElementById('btnSignOut');
    const inpDate = document.getElementById('inpDate');
    const idPreview = document.getElementById('idPreview');
    const inpWord = document.getElementById('inpWord');
    const inpLeidraad = document.getElementById('inpLeidraad');
    const selStatus = document.getElementById('selStatus');
    const btnCreate = document.getElementById('btnCreate');
    const btnCheck = document.getElementById('btnCheck');
    const busy = document.getElementById('busy');
    const msgOk = document.getElementById('msgOk');
    const msgErr = document.getElementById('msgErr');
    const listGames = document.getElementById('listGames');

    const show = el => el.classList.remove('hidden');
    const hide = el => el.classList.add('hidden');
    const toastOk  = (t) => { msgOk.textContent = t; show(msgOk); hide(msgErr); };
    const toastErr = (t) => { msgErr.textContent = t; show(msgErr); hide(msgOk); };

    function pad(n){ return String(n).padStart(2,'0'); }
    function todayISO(){ const d=new Date(); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }
    function toGameId(dateStr){ return `Game${dateStr}`; }
    function sanitizeWord(s){
      return (s||'').toUpperCase().replace(/[^A-ZÁÉÍÓÚÄËÏÖÜÂÊÎÔÛŸ\-]/g,'').trim();
    }
    function updatePreview(){ const ds=inpDate.value||todayISO(); idPreview.textContent=toGameId(ds); }
    inpDate.addEventListener('change', updatePreview);
    inpWord.addEventListener('input', () => { inpWord.value = sanitizeWord(inpWord.value); });

    // Admin check (match admindilemma pattern)
    async function isAdmin(user) {
      try {
        const tok = await user.getIdTokenResult(true); // refresh claims
        if (tok?.claims?.admin === true) return true;
      } catch {}
      if (user.uid === ADMIN_UID) return true; // optional shortcut
      try {
        const snap = await getDoc(doc(db, "admins", user.uid));
        return snap.exists();
      } catch { return false; }
    }

    // Auth gate
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        show(adminAlert);
        btnSignOut.classList.add('hidden');
        return;
      }
      btnSignOut.classList.remove('hidden');

      const ok = await isAdmin(user);
      if (!ok) {
        show(adminAlert);
        return;
      }
      hide(adminAlert);

      if (!inpDate.value) { inpDate.value = todayISO(); updatePreview(); }
      await loadRecent();
    });

    btnSignOut.addEventListener('click', async () => {
      await signOut(auth);
      try { localStorage.clear(); sessionStorage.clear(); } catch {}
      location.href = "/index.html";
    });

    // Duplicate checks
    async function checkDuplicates(dateStr, wordUpper){
      const gameId = toGameId(dateStr);

      const byIdRef = doc(db, 'blitstiekGames', gameId);
      const byIdSnap = await getDoc(byIdRef);
      if (byIdSnap.exists()){
        return {
          existsById:true, existsByDate:true,
          existsByWord:(byIdSnap.data()?.word === wordUpper),
          matches:[{ id:gameId, ...byIdSnap.data() }]
        };
      }

      const colRef = collection(db, 'blitstiekGames');
      const [rDate, rWord] = await Promise.all([
        getDocs(query(colRef, where('activeDate','==',dateStr))),
        getDocs(query(colRef, where('word','==',wordUpper)))
      ]);

      return {
        existsById:false,
        existsByDate:!rDate.empty,
        existsByWord:!rWord.empty
      };
    }

    // Create
    async function createGame(){
      const user = auth.currentUser;
      if (!user || !(await isAdmin(user))) { toastErr('Net administrateurs'); return; }

      const dateStr = inpDate.value || todayISO();
      const wordUpper = sanitizeWord(inpWord.value);
      const leidraad = (inpLeidraad.value || '').trim();
      const status = selStatus.value || 'scheduled';
      if (!wordUpper){ toastErr('Voer ’n geldige teikenwoord in.'); return; }

      show(busy); hide(msgOk); hide(msgErr);
      try{
        const dups = await checkDuplicates(dateStr, wordUpper);
        if (dups.existsById || dups.existsByDate || dups.existsByWord){
          hide(busy);
          const reason = [
            dups.existsById ? 'dieselfde GameID' : null,
            dups.existsByDate ? 'dieselfde datum' : null,
            dups.existsByWord ? 'dieselfde woord' : null
          ].filter(Boolean).join(', ');
          toastErr(`Duplikaat gevind (${reason}).`);
          return;
        }

        const gameId = toGameId(dateStr);
        await setDoc(doc(db, 'blitstiekGames', gameId), {
          word: wordUpper,
          leidraad: leidraad || null,
          status,
          activeDate: dateStr,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        }, { merge:true });

        hide(busy);
        toastOk(`Geskep: ${gameId} (${wordUpper})`);
        inpWord.value=''; inpLeidraad.value='';
        await loadRecent();
      }catch(e){
        hide(busy);
        console.error(e);
        toastErr('Kon nie speletjie skep nie.');
      }
    }

    // List recent
    async function loadRecent(){
      const res = await getDocs(query(collection(db,'blitstiekGames'), orderBy('activeDate','desc'), limit(10)));
      if (res.empty){ listGames.innerHTML = '<p class="text-gray-500">Geen spelletjies nog nie.</p>'; return; }
      let html = `
        <div class="overflow-x-auto">
          <table class="min-w-full text-left text-sm">
            <thead><tr class="text-gray-500">
              <th class="py-2 pr-4">GameID</th><th class="py-2 pr-4">Woord</th><th class="py-2 pr-4">Datum</th><th class="py-2">Status</th>
            </tr></thead><tbody>`;
      res.forEach(d => {
        const v=d.data();
        html += `<tr class="border-t">
          <td class="py-2 pr-4 font-mono">${d.id}</td>
          <td class="py-2 pr-4 font-semibold">${v.word}</td>
          <td class="py-2 pr-4">${v.activeDate || ''}</td>
          <td class="py-2">${v.status || ''}</td>
        </tr>`;
      });
      html += `</tbody></table></div>`;
      listGames.innerHTML = html;
    }

    // Wire up
    btnCreate.addEventListener('click', createGame);
    btnCheck.addEventListener('click', async () => {
      const dateStr = inpDate.value || todayISO();
      const wordUpper = sanitizeWord(inpWord.value);
      if (!wordUpper){ toastErr('Voer eers ’n teikenwoord in.'); return; }
      show(busy); hide(msgOk); hide(msgErr);
      try{
        const d = await checkDuplicates(dateStr, wordUpper);
        hide(busy);
        if (d.existsById || d.existsByDate || d.existsByWord){
          const reason = [
            d.existsById ? 'GameID' : null,
            d.existsByDate ? 'datum'  : null,
            d.existsByWord ? 'woord'  : null
          ].filter(Boolean).join(', ');
          toastErr(`⚠️ Duplikaat: ${reason}`);
        } else {
          toastOk('Geen duplikate gevind nie.');
        }
      }catch(e){
        hide(busy);
        console.error(e);
        toastErr('Kon nie duplikate toets nie.');
      }
    });

    // Init
    if (!inpDate.value) { inpDate.value = todayISO(); }
    updatePreview();
  </script>
</body>
</html>
