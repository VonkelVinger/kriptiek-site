<!DOCTYPE html>
<html lang="af">
<head>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-S9V4CMP1FP"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-S9V4CMP1FP');
  </script>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
  <title>SLIMSTIEK – Kriptiek</title>

  <!-- Open Graph / Twitter -->
  <link rel="canonical" href="https://www.kriptiek.com/slimstiek.html" />
  <meta property="og:title" content="SLIMSTIEK – Kriptiek" />
  <meta property="og:description" content="Kom speel vandag se SLIMSTIEK op Kriptiek." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://www.kriptiek.com/slimstiek.html" />
  <meta property="og:image" content="https://www.kriptiek.com/assets/S_SLIMSTIEK_12SEP.png" />
  <meta property="og:image:alt" content="SLIMSTIEK knoppie" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="SLIMSTIEK – Kriptiek" />
  <meta name="twitter:description" content="Kom speel vandag se SLIMSTIEK op Kriptiek." />
  <meta name="twitter:image" content="https://www.kriptiek.com/assets/S_SLIMSTIEK_12SEP.png" />

  <!-- Tailwind + font -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&display=swap" rel="stylesheet" />

  <style>
    :root{
      --brand:#1e3a8a;
      --cell-bg:#004d40;
      --gridW:320px;
      --cell-font:16px;
      --cellSize:32px;
      --line:1px;
    }
    html,body{height:100%}
    body{font-family:'Montserrat',system-ui,Segoe UI,Roboto,Arial,sans-serif;background:#f9fafb;color:#1f2937}

    /* HEADER */
    header{background:#fff;box-shadow:0 2px 4px rgba(0,0,0,.08);padding:1rem;text-align:center;position:relative;}
    .logo-container{display:flex;justify-content:center;align-items:center;margin-bottom:10px;}
    .logo-container .letter-box{width:40px;height:40px;margin:2px;display:flex;justify-content:center;align-items:center;background:#374151;color:#fff;font-size:1.2rem;font-weight:700;border-radius:6px;}
    .welcome{font-size:.9rem;color:#6b7280}

    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 2px 8px rgba(0,0,0,.05);}
    .headline{text-align:center;font-size:1.125rem;font-weight:700;color:#374151;margin:16px 0 8px;}

    /* Target chips */
    #targetWrap{width:100%;max-width:var(--gridW);margin:0 auto 4px;display:flex;justify-content:center;}
    #target{display:inline-flex;gap:1px;background:var(--cell-bg);color:#fff;padding:2px;border-radius:6px;min-height:34px;align-items:center;transition:box-shadow .3s ease;}
    #target span{width:30px;height:30px;display:grid;place-items:center;font-weight:800;border:1px solid rgba(255,255,255,.12);}
    #target.goal-glow{animation:targetGlow 1.2s ease-out 1;}
    @keyframes targetGlow{
      0%{box-shadow:0 0 0 rgba(255,221,0,0)}
      40%{box-shadow:0 0 22px rgba(255,221,0,.9)}
      100%{box-shadow:0 0 0 rgba(255,221,0,0)}
    }

    .game-wrap{position:relative}

    /* GRID */
    #grid{
      position:relative; display:grid;
      grid-template-columns:repeat(8,1fr); grid-template-rows:repeat(10,1fr);
      gap:0; background:#fff; border:var(--line) solid #0c4a3e; border-radius:8px; overflow:hidden;
      width:var(--gridW); height:400px; margin:6px auto 8px;
    }
    #grid::after{
      content:''; position:absolute; inset:0; pointer-events:none; z-index:5;
      background:
        repeating-linear-gradient(to right, transparent 0 calc(var(--cellSize) - var(--line)), rgba(255,255,255,.28) 0 var(--cellSize)),
        repeating-linear-gradient(to bottom, transparent 0 calc(var(--cellSize) - var(--line)), rgba(255,255,255,.28) 0 var(--cellSize));
    }
    .cell{position:relative;background:var(--cell-bg);transition:transform .15s ease-out,opacity .15s ease-out;}
    .cell.f{display:grid;place-items:center;color:#fff;font-weight:800;font-size:var(--cell-font);text-shadow:0 1px 1px rgba(0,0,0,.35);}
    .cell.pop{transform:scale(1.15);opacity:0;}

    /* FX overlay for floating scores */
    #fx{position:absolute; inset:0; pointer-events:none; overflow:hidden;}
    .float-score{
      position:absolute; transform:translate(-50%,0);
      font-weight:800; font-size:14px; line-height:1;
      color:#fff; text-shadow:0 2px 6px rgba(0,0,0,.55);
      padding:.15rem .35rem; border-radius:.4rem; background:rgba(0,0,0,.18);
      animation:floatUp .9s ease-out forwards;
      will-change:transform,opacity,filter;
    }
    @keyframes floatUp{
      0%{opacity:0; transform:translate(-50%,8px); filter:blur(.2px)}
      15%{opacity:1}
      85%{opacity:1}
      100%{opacity:0; transform:translate(-50%,-18px); filter:blur(1px)}
    }

    /* Row hint */
    #rowHint{margin-top:-2px; text-align:center; font-size:.75rem; color:#6b7280;}
    #rowHint b{color:#065f46}

    /* Modal */
    #over{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);z-index:50;}
    .modal{background:#fff;border-radius:16px;box-shadow:0 20px 50px rgba(0,0,0,.2);width:min(92%,520px);padding:18px;text-align:center;border:1px solid #e5e7eb;}
    .btn{background:#1e3a8a;color:#fff;font-weight:700;padding:10px 16px;border-radius:10px;}
    .btn.gray{background:#6b7280}
    .btn:disabled{opacity:.6;cursor:not-allowed;}

    /* Controls */
    .controls{width:100%;max-width:calc(var(--gridW));margin:8px auto 0;}
    .arrow-row{display:grid;grid-template-columns:repeat(3,1fr);gap:.5rem;}
    .dir-btn{width:100%;aspect-ratio:1/1;min-width:56px;min-height:56px;display:flex;align-items:center;justify-content:center;background:#053a6b;color:#fff;border-radius:14px;font-weight:800;font-size:24px;}
    @media (min-width:460px){.dir-btn{min-width:64px;min-height:64px;font-size:26px}}
    @media (min-width:640px){.dir-btn{min-width:72px;min-height:72px;font-size:28px}}

    .pill{background:#0c4a3e;color:#fff;font-weight:700;padding:6px 10px;border-radius:8px;text-align:center;}
    #leaderboardList li{padding:.35rem .5rem;border-radius:.375rem;display:flex;align-items:center;gap:.5rem;flex-wrap:wrap;}
    #leaderboardList li:nth-child(odd){background:#f3f4f6;}
    #leaderboardList li:first-child{background:#d1fae5;font-weight:700;}

    /* Share dropdown */
    .share-menu-local{
      background:#fff;border:1px solid #e5e7eb;box-shadow:0 8px 24px rgba(0,0,0,.12);
      border-radius:.5rem;width:240px;padding:.5rem;z-index:3000;line-height:1.25;
    }
    .share-menu-local button{
      width:100%;text-align:left;padding:.5rem .75rem;border-radius:.375rem;font-weight:600;
      line-height:1.25rem;display:flex;align-items:center;gap:.5rem;white-space:nowrap;
    }
    .share-menu-local button:hover{background:#f3f4f6;}

    /* ACTION BARS */
    .action-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:.5rem;justify-items:center;align-items:center;}
    .cols-3{ grid-template-columns:repeat(3,1fr); }
    .action-grid > a, .action-grid > button{
      display:grid; place-items:center; width:100%; aspect-ratio:1/1; max-width:120px;
      padding:0; margin:0; background:transparent !important; border:0; border-radius:0; line-height:0;
      appearance:none; -webkit-appearance:none; box-shadow:none; cursor:pointer;
    }
    .btn-img{width:100%;height:100%;display:block;object-fit:contain;border-radius:0;box-shadow:0 6px 15px rgba(0,0,0,.25);}
    .btn-img:hover{transform:translateY(-1px);filter:brightness(1.02)}
    .btn-img:active{transform:translateY(0);filter:brightness(.98)}

    /* N-R gate */
    #nrGate{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);z-index:60;}

    /* Slimstiek K-pill (teal, right-aligned like Blitstiek) */
    .k-pill {
      margin-left: auto;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: #0f766e;
      color: #fff;
      font-weight: 800;
      border-radius: 999px;
      padding: 0.15rem 0.55rem;
      font-size: 0.75rem;
      line-height: 1;
      min-width: 1.8rem;
      text-align: center;
    }

    /* Admin pane (small) */
    #adminPanel{display:none}

    /* Desktop layout: ad + game */
    .game-layout { width: 100%; }
    .ad-slot { display: none; }

    @media (min-width:1024px) {
      .game-layout{
        display:grid;
        grid-template-columns:auto minmax(0,1fr);
        column-gap:1.5rem;
        align-items:flex-start;
      }
      .ad-slot{
        display:flex;
        justify-content:center;
      }
      .ad-tile{
        width:300px;
        height:250px;
        border-radius:16px;
        overflow:hidden;
        box-shadow:0 8px 24px rgba(0,0,0,.25);
      }
      .ad-tile img{
        width:100%;
        height:100%;
        object-fit:cover;
        display:block;
      }
    }
  </style>
</head>
<body class="min-h-screen flex flex-col">

  <!-- HEADER -->
  <header>
    <div class="logo-container" aria-label="SLIMSTIEK">
      <div class="letter-box">S</div><div class="letter-box">L</div>
      <div class="letter-box">I</div><div class="letter-box">M</div>
      <div class="letter-box">S</div><div class="letter-box">T</div>
      <div class="letter-box">I</div><div class="letter-box">E</div>
      <div class="letter-box">K</div>
    </div>
    <p class="welcome" id="welcomeLine">Welkom terug, <span id="playerName" class="font-semibold text-green-700">Speler</span>!</p>
  </header>

  <main class="flex-1">
    <div class="max-w-3xl mx-auto px-4 py-4">

      <!-- Admin backfill mini-panel -->
      <section id="adminPanel" class="mb-3">
        <div class="rounded-lg border border-emerald-200 bg-emerald-50 p-3 text-sm text-emerald-900 flex items-center gap-2 flex-wrap">
          <strong>Admin:</strong>
          <label class="flex items-center gap-1">Datum: <input id="adminDate" type="date" class="border rounded px-2 py-1 text-sm"></label>
          <button id="btnBFOne" class="btn px-3 py-1">Backfill dag</button>
          <label class="flex items-center gap-1">Tot: <input id="adminDateTo" type="date" class="border rounded px-2 py-1 text-sm"></label>
          <button id="btnBFRange" class="btn px-3 py-1">Backfill reeks</button>
          <span id="bfMsg" class="text-xs opacity-80"></span>
        </div>
      </section>

      <!-- GAME STRIP: desktop = ad + game; mobile = game only -->
      <div class="game-layout">

        <!-- Desktop-only ad slot -->
        <aside class="ad-slot">
          <a href="/advertisers.html"
             class="ad-tile"
             aria-label="Meer inligting oor advertensies op Kriptiek">
            <img src="/assets/kriptiek-placeholder-300x250.png"
                 alt="Jou advertensie kan hier wees">
          </a>
        </aside>

        <!-- Game column -->
        <div class="space-y-2">
          <div class="headline">TEIKENWOORD:</div>
          <div id="targetWrap"><div id="target"><span>—</span></div></div>

          <!-- small live row-multiplier hint -->
          <div id="rowHint">Vermeningvuldiger: ×<b id="rowMultVal">1</b></div>

          <!-- GAME card -->
          <section class="card p-4">
            <div class="relative game-wrap">
              <div id="grid"></div>
              <!-- FX overlay for floating scores -->
              <div id="fx" aria-hidden="true"></div>

              <!-- Success modal -->
              <div id="over">
                <div class="modal">
                  <p id="winMsg" class="mb-3 text-base"></p>
                  <div class="actions" style="display:flex;gap:.75rem;justify-content:center;margin-top:12px;">
                    <button id="modalShareBtn" type="button" class="btn">DEEL</button>
                    <button id="modalCloseBtn" type="button" class="btn gray">SLUIT</button>
                  </div>
                  <div id="shareMenu" class="hidden share-menu-local mx-auto mt-2">
                    <div class="px-2 pb-1 text-xs uppercase tracking-wide text-gray-500">Deel via</div>
                    <div class="space-y-1">
                      <button id="mWhatsApp" type="button">WhatsApp</button>
                      <button id="mCopy" type="button">Kopieer skakel</button>
                      <button id="mSystem" type="button">Stelsel-deel</button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- N-R gate -->
              <div id="nrGate">
                <div class="modal">
                  <h3 class="text-lg font-extrabold mb-1">WELKOM BY SLIMSTIEK OP KRIPTIEK</h3>
                  <p class="text-sm text-gray-600 mb-3">Jou opsies:</p>
                  <div class="text-left space-y-2 text-gray-700">
                    <p><strong>1)</strong> Speel Slimstiek as 'n ongeregistreerde speler met beperkte funksies.</p>
                    <p><strong>2)</strong> <a href="/register.html" class="underline" id="gateRegLink">Registreer</a> sodat jy volle toegang tot alles op Kriptiek kan kry, insluitend Slimstiek.</p>
                  </div>
                  <div class="flex gap-2 justify-center mt-4">
                    <button id="gateGuestBtn" class="btn">Speel sonder om te registreer</button>
                    <button id="gateRegBtn"   class="btn gray">Registreer</button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Arrows -->
            <div class="controls mt-3">
              <div class="arrow-row">
                <button id="btnLeft"  class="dir-btn" aria-label="Links">◀</button>
                <button id="btnDown"  class="dir-btn" aria-label="Laat val">▼</button>
                <button id="btnRight" class="dir-btn" aria-label="Regs">▶</button>
              </div>
            </div>

            <!-- Start/Pause -->
            <div class="controls mt-3 flex items-center justify-center gap-2">
              <button id="btnStart" class="btn">BEGIN</button>
              <button id="btnPause" class="btn gray">POUSE</button>
            </div>

            <!-- Score pills -->
            <div class="controls grid grid-cols-2 gap-2 mt-3">
              <div id="bestBox" class="pill">Beste telling: <b>—</b></div>
              <div id="scoreBox" class="pill">Huidige telling: <b>0</b></div>
            </div>

            <!-- ACTION BARS -->
            <div class="controls mt-3" id="actionBars">
              <!-- Guests -->
              <div id="barNR" class="action-grid cols-3">
                <a href="/register.html" title="Registreer">
                  <img class="btn-img" src="/assets/K_REGISTREER_12SEP.png" alt="Registreer" width="120" height="120">
                </a>
                <a href="/forum.html" title="Gesels saam">
                  <img class="btn-img" src="/assets/K_GESELS_12SEP.png" alt="Gesels" width="120" height="120">
                </a>
                <div class="relative share-tile-wrap">
                  <button type="button" class="share-tile" title="Deel">
                    <img class="btn-img" src="/assets/SHARE_12SEP.png" alt="Deel" width="120" height="120">
                  </button>
                  <div class="hidden share-menu-local absolute left-1/2 -translate-x-1/2 mt-2">
                    <div class="px-2 pb-1 text-xs uppercase tracking-wide text-gray-500">Deel via</div>
                    <div class="space-y-1">
                      <button class="wa" type="button">WhatsApp</button>
                      <button class="copy" type="button">Kopieer skakel</button>
                      <button class="sys" type="button">Stelsel-deel</button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Registered -->
              <div id="barR" class="action-grid cols-3 hidden">
                <a href="/forum.html" title="Gesels saam">
                  <img class="btn-img" src="/assets/K_GESELS_12SEP.png" alt="Gesels" width="120" height="120">
                </a>
                <a href="/slimstiek-argief.html" title="Slimstiek-argief">
                  <img class="btn-img" src="/assets/S_ARGIEF_12SEP.png" alt="S Argief" width="120" height="120">
                </a>
                <div class="relative share-tile-wrap">
                  <button type="button" class="share-tile" title="Deel">
                    <img class="btn-img" src="/assets/SHARE_12SEP.png" alt="Deel" width="120" height="120">
                  </button>
                  <div class="hidden share-menu-local absolute left-1/2 -translate-x-1/2 mt-2">
                    <div class="px-2 pb-1 text-xs uppercase tracking-wide text-gray-500">Deel via</div>
                    <div class="space-y-1">
                      <button class="wa" type="button">WhatsApp</button>
                      <button class="copy" type="button">Kopieer skakel</button>
                      <button class="sys" type="button">Stelsel-deel</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>
        </div><!-- /game column -->
      </div><!-- /game-layout -->

      <!-- HOE OM TE SPEEL -->
      <section class="mt-4 bg-white rounded shadow p-4">
        <h2 class="text-xl font-bold mb-2">HOE OM TE SPEEL</h2>
        <ol class="space-y-3 text-gray-700 leading-relaxed">
          <li>
            <p class="font-semibold">1. Doel</p>
            <p>Probeer soveel as moontlik punte aanteken voordat jy die <strong>teikenwoord</strong> met die vallende blokke vorm. Hoe langer jy dit uitrek, hoe beter is jou kans om 'n groter puntetelling te behaal.</p>
          </li>
          <li>
            <p class="font-semibold">2. Reëls vir blokke</p>
            <ul class="list-disc pl-6">
              <li><strong>Blokke met dieselfde letter</strong> of <strong>kleur</strong> wat langs of op mekaar tot stilstand kom, sal verdwyn. <em>MAAR: Letters in die teikenwoord verdwyn nooit nie.</em></li>
              <li>Jy kry punte vir elke <strong>paar blokke</strong> wat verdwyn.</li>
            </ul>
          </li>
          <li>
            <p class="font-semibold">3. Punte</p>
            <ul class="list-disc pl-6">
              <li><strong>+10 punte</strong> vir elke <em>paar</em> blokke wat verdwyn, <strong>vermenigvuldig met die boonste ry</strong> waarin daardie paar voorkom. (<em>Die heel onderste ry is ry 1; as die boonste van die twee blokke in ry 2 is, word die punte met 2 vermenigvuldig.</em>)</li>
              <li><strong>+50 punte ekstra</strong> as <em>die letter en die kleur</em> van die twee blokke dieselfde is, ook vermenigvuldig met die boonste ry.</li>
              <li><strong>+100 bonuspunte</strong> sodra jy die teikenwoord gebou kry – die spel eindig dan ook.</li>
            </ul>
          </li>
          <li>
            <p class="font-semibold">4. Kontroles</p>
            <p>Op jou toetsbord, gebruik die links- en regs-pyltjies om die blokke horisontaal te laat skuif, en die <strong>spasiebalk</strong> om die blok dadelik tot onder te laat val. Op 'n raakskerm, gebruik die knoppies op die skerm.</p>
          </li>
        </ol>
      </section>

      <!-- LEADERBOARD -->
      <section class="card mt-6 p-4">
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-xl font-bold">VANDAG SE TOP-10 (die afsnypunt is om 23:55)</h2>
        </div>
        <ul id="leaderboardList" class="text-gray-700 text-left"><li>Laai...</li></ul>
      </section>
    </div>
  </main>

  <footer class="bg-white shadow p-4 text-center text-sm text-gray-500">
    &copy; 2025 Kriptiek. Alle regte voorbehou. |
    <a href="/index.html" class="underline">Tuis</a> |
    <a href="/profile.html" class="underline">My profiel</a> |
    <a href="/forum.html" class="underline">Gesels saam</a> |
    <a href="/privacy.html" class="underline">Privaatheidsbeleid</a> |
    <a href="/terms.html" class="underline">Voorwaardes</a> |
    <a href="/faq.html" class="underline">Gereelde vrae</a> |
    <a href="/about.html" class="underline">Oor Kriptiek</a> |
    <a href="/contact.html" class="underline">Kontak ons</a>
  </footer>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, getIdTokenResult } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js';
    import {
      getFirestore, serverTimestamp, doc, getDoc, setDoc,
      collection, query, orderBy, limit, onSnapshot, getDocs
    } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js';

    /* ---- Firebase ---- */
    const firebaseConfig = {
      apiKey: "AIzaSyDH-nVvGkdaheH7pvRHH0M9TbW2f98lMGQ",
      authDomain: "kriptiek-c9ea2.firebaseapp.com",
      projectId: "kriptiek-c9ea2",
      storageBucket: "kriptiek-c9ea2.appspot.com",
      messagingSenderId: "620450620939",
      appId: "1:620450620939:web:e93a18ac23b53b33db890e"
    };

    let app, auth, db;
    try{ app = initializeApp(firebaseConfig); auth = getAuth(app); db = getFirestore(app); }catch(e){ console.warn('Firebase init failed (ok for local fallback):', e); }

    /* ---- DOM ---- */
    const welcomeLine   = document.getElementById('welcomeLine');
    const playerNameEl  = document.getElementById('playerName');

    const targetEl   = document.getElementById('target');
    const gridEl     = document.getElementById('grid');
    const fxEl       = document.getElementById('fx');
    const over       = document.getElementById('over');
    const winMsg     = document.getElementById('winMsg');
    const modalShareBtn = document.getElementById('modalShareBtn');
    const modalCloseBtn = document.getElementById('modalCloseBtn');
    const shareMenu  = document.getElementById('shareMenu');

    const lbList     = document.getElementById('leaderboardList');
    const bestText   = document.querySelector('#bestBox b');
    const scoreText  = document.querySelector('#scoreBox b');

    const btnLeft = document.getElementById('btnLeft');
    const btnRight= document.getElementById('btnRight');
    const btnDown = document.getElementById('btnDown');
    const btnStart= document.getElementById('btnStart');
    const btnPause= document.getElementById('btnPause');

    const mWA   = document.getElementById('mWhatsApp');
    const mCopy = document.getElementById('mCopy');
    const mSys  = document.getElementById('mSystem');

    const barNR       = document.getElementById('barNR');
    const barR        = document.getElementById('barR');
    const nrGate      = document.getElementById('nrGate');
    const gateGuestBtn= document.getElementById('gateGuestBtn');
    const gateRegBtn  = document.getElementById('gateRegBtn');
    const gateRegLink = document.getElementById('gateRegLink');

    const rowMultLabel = document.getElementById('rowMultVal');
    const adminPanel = document.getElementById('adminPanel');
    const dAdmin = document.getElementById('adminDate');
    const dAdminTo = document.getElementById('adminDateTo');
    const btnBFOne = document.getElementById('btnBFOne');
    const btnBFRange = document.getElementById('btnBFRange');
    const bfMsg = document.getElementById('bfMsg');

    /* ---- Helpers ---- */
    const SITE_ORIGIN = location.hostname.endsWith('kriptiek.com') ? location.origin : 'https://www.kriptiek.com';
    const qs = new URLSearchParams(location.search);

    function todayKeySAST(){
      const parts = new Intl.DateTimeFormat('en-CA', { timeZone:'Africa/Johannesburg', year:'numeric', month:'2-digit', day:'2-digit' }).formatToParts(new Date());
      const y = parts.find(p=>p.type==='year').value;
      const m = parts.find(p=>p.type==='month').value;
      const d = parts.find(p=>p.type==='day').value;
      return `${y}-${m}-${d}`;
    }

    const dateParam = qs.get('date');
    let currentDate = (/^\d{4}-\d{2}-\d{2}$/.test(dateParam) ? dateParam : todayKeySAST());
    const GAME_ID = `Game${currentDate}`;
    const gameId  = GAME_ID;        // alias for internal code/tests
    window.gameId = GAME_ID;        // lets you type `gameId` in DevTools
    console.log("[Slimstiek] GAME_ID:", GAME_ID);

    // Canonical URL normalization (force ?date=YYYY-MM-DD)
    try {
      const urlObj = new URL(window.location.href);
      urlObj.searchParams.set('date', currentDate);
      urlObj.hash = '';
      const canonical = urlObj.pathname + '?' + urlObj.searchParams.toString();
      const current = window.location.pathname + window.location.search + window.location.hash;
      if (current !== canonical) history.replaceState(null, '', canonical);
    } catch {}

    const shareKey = () => `slimstiekShare:${currentDate}`;
    function buildShareUrl(dateStr=currentDate){
      const url = new URL('/slimstiek.html', SITE_ORIGIN);
      url.searchParams.set('date', dateStr);
      return url.toString();
    }
    function shareTextLinkOnly(){ return `Kyk of jy my telling op vandag se SLIMSTIEK kan klop: ${buildShareUrl(currentDate)}`; }

    /* ==== K mirror config & ZA helpers ==== */
    const K_CONF = {
      EARLY_BIRD_WINDOW_START: "07:00",
      CUTOFF_TIME: "23:55",
      LEADERBOARD_SIZE: 10,
      EARLY_BIRD_POINTS: 20,
      IMPROVE_POINTS: 30,
      FINAL_POINTS: [120,90,70,60,50,40,30,25,20,15],
      DAILY_CAP_PER_GAME: 200,
      SUPPORTER_MULTIPLIER: 1.10
    };
    function zaTimeOn(dateStr, hhmm){
      return new Date(`${dateStr}T${hhmm}:00+02:00`);
    }

    /* ========= (1) Sanitizer + Logger + STS tag (add once) ========= */
    function cleanForFS(obj){
      const out = {};
      for (const [k,v] of Object.entries(obj)){
        if (v === undefined) continue;
        if (typeof v === 'number' && !Number.isFinite(v)) continue;
        out[k] = v;
      }
      return out;
    }
    function logFSWrite(ref, data, label="FS write"){
      const summary = {};
      for (const [k,v] of Object.entries(data)){
        summary[k] = (v && v.__isServerTimestamp) ? 'serverTimestamp()' : (typeof v);
      }
      console.log(`[${label}]`, ref.path, summary, data);
    }
    import { serverTimestamp as __serverTimestampForSTS } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js';
    function STS(){ const s = __serverTimestampForSTS(); s.__isServerTimestamp = true; return s; }

    /* ---- Auth ---- */
    let user=null, currentUserName='Speler', isAdminClient=false;

    function setBarsForUser(u){
      if(u){ barR.classList.remove('hidden'); barNR.classList.add('hidden'); welcomeLine.style.display=''; }
      else{ barNR.classList.remove('hidden'); barR.classList.add('hidden'); welcomeLine.style.display='none'; }
    }
    function showNRGate(){ nrGate.style.display='flex'; }
    function hideNRGate(){ nrGate.style.display='none'; }
    let guestGateBypassOnce=false;
    function chooseGuest(){ guestGateBypassOnce = true; hideNRGate(); }
    function goRegister(){
      const returnUrl = location.pathname + location.search;
      sessionStorage.setItem('returnAfterAuth', returnUrl);
      location.href = `/register.html?return=${encodeURIComponent(returnUrl)}`;
    }
    gateGuestBtn.addEventListener('click', chooseGuest);
    gateRegBtn  .addEventListener('click', goRegister);
    gateRegLink .addEventListener('click', (e)=>{ e.preventDefault(); goRegister(); });

    async function resolveUserName(u){
      if(!db) return u?.displayName || 'Speler';
      try{
        const uref = doc(db,'users',u.uid);
        const snap = await getDoc(uref);
        if(snap.exists() && snap.data().userName) return String(snap.data().userName).slice(0,24);
      }catch{}
      if (u?.displayName) return String(u.displayName).slice(0,24);
      if (u?.email){ const local = u.email.split('@')[0]; return local ? local.slice(0,24) : 'Speler'; }
      return 'Speler';
    }

    if(auth){
      onAuthStateChanged(auth, async (u)=>{
        user=u||null; currentUserName = await resolveUserName(user);
        playerNameEl.textContent=currentUserName; setBarsForUser(user); if(!user) showNRGate();

        // Determine admin: custom claim OR allowlist OR ?admin=1
        isAdminClient = false;
        try{
          if (user) {
            const t = await getIdTokenResult(user, true);
            const claimAdmin = t?.claims?.admin === true;
            const UID_ALLOW = new Set(["jI7f0Wk4MqfPq7p69vjl8OlJUvS2"]);
            const allowlistAdmin = UID_ALLOW.has(user.uid);
            const queryOverride  = (new URLSearchParams(location.search)).get('admin') === '1';
            isAdminClient = claimAdmin || allowlistAdmin || queryOverride;
          }
        } catch (e) { console.warn('Admin check failed:', e); }
        adminPanel.style.display = isAdminClient ? '' : 'none';

        // after auth settles, ensure merged leaderboard subscription is live
        subscribeMergedLeaderboard();
        if (user) mirrorSlimstiekPoints(); // backfill pills if you already have a best
      });
    } else { setBarsForUser(null); showNRGate(); adminPanel.style.display='none'; }

    /* ---- Pixel-perfect grid sizing ---- */
    function resizeGrid(){
      const wrap = gridEl.parentElement;
      const availCss = Math.min(320, Math.floor(wrap.clientWidth));
      const dpr = Math.max(1, window.devicePixelRatio || 1);
      const toDp=v=>Math.round(v*dpr), toCss=v=>v/dpr, snap=v=>Math.floor(v/8)* 8;

      const availDp=toDp(availCss);
      const snappedDp=Math.max(toDp(240), snap(availDp));
      const quantW=toCss(snappedDp);
      const cellCss=Math.floor(quantW/8);
      const quantH=cellCss*10;

      document.documentElement.style.setProperty('--cellSize', `${cellCss}px`);
      document.documentElement.style.setProperty('--line', `${1/dpr}px`);
      gridEl.style.width=quantW+'px'; gridEl.style.height=quantH+'px';
      document.documentElement.style.setProperty('--gridW', quantW+'px');
      const glyph = Math.max(15, Math.min(28, Math.round(cellCss*0.50)));
      document.documentElement.style.setProperty('--cell-font', glyph+'px');
    }
    window.addEventListener('resize', resizeGrid);

    /* ---- Grid/Game ---- */
    const H=10, W=8;
    const COLORS=['#2196f3','#f44336','#4caf50','#ffc107','#9c27b0','#003366','#009688'];
    const CONS='BCDFGHJKLMNPQRSTVWXZ';
    const VOWS='AEIOUY';

    let TARGET='';
    let grid=Array.from({length:H},()=>Array(W).fill(null));
    let cur=null, nxt=null;
    let paused=false, ended=false, moving=false;
    let gInt=null;                 // drop-tick only
    let score=0, bestScore=null;

    function drawGrid(){
      gridEl.innerHTML='';
      for(let y=0;y<H;y++) for(let x=0;x<W;x++){
        const d=document.createElement('div'); d.className='cell'; d.dataset.x=x; d.dataset.y=y;
        gridEl.appendChild(d);
      }
      resizeGrid();
    }
    function drawBlock(b){
      if(!b||b.x<0||b.x>=W||b.y<0||b.y>=H) return;
      const c=gridEl.querySelector(`.cell[data-x="${b.x}"][data-y="${b.y}"]`);
      if(!c) return;
      c.className='cell f'; c.style.background=b.color; c.textContent=b.letter;
    }
    function clearBlock(b){
      if(!b) return;
      const c=gridEl.querySelector(`.cell[data-x="${b.x}"][data-y="${b.y}"]`);
      if(!c) return;
      c.className='cell'; c.style.background='var(--cell-bg)'; c.textContent='';
    }

    const partOfTarget = L => TARGET.includes(L);
    const collide = b => !b || b.x<0||b.x>=W||b.y>=H || (b.y>=0 && grid[b.y][b.x]);

    function createBlock(){
      const color = COLORS[Math.floor(Math.random()*COLORS.length)];
      const letter = Math.random()<0.3 ? VOWS[Math.floor(Math.random()*VOWS.length)]
                                       : CONS[Math.floor(Math.random()*CONS.length)];
      return { color, letter, x:Math.floor(W/2), y:0 };
    }

    /* ---- Scoring ---- */
    const SCORING = Object.freeze({ PAIR_POINTS: 10, BOTH_BONUS: 50, WORD_BONUS: 100 });
    function setScore(v){ score=Math.max(0, v|0); scoreText.textContent=score; }
    function addScore(v){ setScore(score + (v|0)); }

    /* ---- Row hint ---- */
    function updateRowHint(){
      const y = cur ? Math.max(0, Math.min(H-1, cur.y)) : H-1;
      const mult = H - y; // bottom = 1
      rowMultLabel.textContent = String(mult);
    }

    /* ---- Floating score badges ---- */
    function cellSizePx(){
      const raw = getComputedStyle(document.documentElement).getPropertyValue('--cellSize') || '32px';
      return Number(String(raw).replace('px','').trim()) || 32;
    }
    function spawnFloatAt(px, py, text){
      const el = document.createElement('div');
      el.className = 'float-score';
      el.textContent = text;
      el.style.left = px + 'px';
      el.style.top  = py + 'px';
      fxEl.appendChild(el);
      setTimeout(()=>{ el.remove(); }, 950);
    }
    function spawnFloatForPair(x1,y1,x2,y2, points, mult){
      const s = cellSizePx();
      const cx = ((x1 + 0.5) + (x2 + 0.5)) / 2 * s;
      const cy = ((y1 + 0.5) + (y2 + 0.5)) / 2 * s;
      spawnFloatAt(cx, cy, `+${points} ×${mult}`);
    }

    /* ---- Movement ---- */
    async function move(dx,dy){
      if(!cur||paused||ended||moving) return;
      moving=true; clearBlock(cur);
      const test={...cur,x:cur.x+dx,y:cur.y+dy};
      if(!collide(test)){ cur=test; drawBlock(cur); }
      else if(dy>0){ drawBlock(cur); place(); }
      else{ drawBlock(cur); }
      moving=false;
      updateRowHint();
    }
    function hardDrop(){
      if(!cur||paused||ended) return;
      clearBlock(cur);
      while(cur.y<H-1 && !collide({...cur,y:cur.y+1})) cur.y++;
      place();
      updateRowHint();
    }

    async function place(){
      if(!cur||cur.y<0) return;
      grid[cur.y][cur.x]={...cur}; drawBlock(cur);
      await matchAndDrop();
      await checkWin();
      cur=nxt; nxt=createBlock();
      if(cur) drawBlock(cur);
      updateRowHint();
    }
    async function matchAndDrop(){
      const toDel=new Set();
      let pairScoreTotal = 0;
      const rowNumber = (y) => H - y; // bottom row = 1

      for(let y=0;y<H;y++){
        for(let x=0;x<W;x++){
          const a=grid[y][x];
          if(!a || partOfTarget(a.letter)) continue;
          for(const [dx,dy] of [[1,0],[0,1]]){
            const nx=x+dx, ny=y+dy;
            if(nx<0||nx>=W||ny<0||ny>=H) continue;
            const b=grid[ny][nx];
            if(!b || partOfTarget(b.letter)) continue;

            const sameLetter = a.letter===b.letter;
            const sameColor  = a.color===b.color;

            if(sameLetter || sameColor){
              const upperY = Math.min(y, ny);
              const mult   = rowNumber(upperY);

              let pairPts = SCORING.PAIR_POINTS;
              if(sameLetter && sameColor) pairPts += SCORING.BOTH_BONUS;

              const added = pairPts * mult;
              pairScoreTotal += added;

              spawnFloatForPair(x, y, nx, ny, added, mult);

              toDel.add(`${x},${y}`);
              toDel.add(`${nx},${ny}`);
            }
          }
        }
      }

      if(!toDel.size) return;

      addScore(pairScoreTotal);

      // animate & remove
      await Promise.all(Array.from(toDel).map(key=>new Promise(res=>{
        const [x,y]=key.split(',').map(Number);
        const c=gridEl.querySelector(`.cell[data-x="${x}"][data-y="${y}"]`);
        if(c){ c.classList.add('pop'); setTimeout(()=>{ c.classList.remove('pop'); res(); },150);} else res();
        grid[y][x]=null;
      })));

      // gravity
      for(let x=0;x<W;x++){
        let wY=H-1;
        for(let y=H-1;y>=0;y--){
          if(grid[y][x]){
            if(y!==wY){ grid[wY][x]=grid[y][x]; grid[y][x]=null; }
            wY--;
          }
        }
      }
      // redraw
      for(let y=0;y<H;y++) for(let x=0;x<W;x++){
        const c=gridEl.querySelector(`.cell[data-x="${x}"][data-y="${y}"]`);
        c.className='cell'; c.style.background='var(--cell-bg)'; c.textContent='';
        if(grid[y][x]) drawBlock({...grid[y][x],x,y});
      }
    }

    async function checkWin(){
      if(!TARGET) return;
      for(let y=0;y<H;y++) for(let x=0;x<=W-TARGET.length;x++){
        let ok=true;
        for(let i=0;i<TARGET.length;i++){
          const g=grid[y][x+i];
          if(!g || g.letter!==TARGET[i]){ ok=false; break; }
        }
        if(ok){
          for(let i=0;i<TARGET.length;i++){
            const c=gridEl.querySelector(`.cell[data-x="${x+i}"][data-y="${y}"]`);
            if(c) c.style.transform='scale(1.05)';
          }
          targetEl.classList.add('goal-glow');
          setTimeout(()=>targetEl.classList.remove('goal-glow'), 1400);
          addScore(SCORING.WORD_BONUS);
          setTimeout(()=>end(true), 450);
          return;
        }
      }
    }

    /* ---- Control ---- */
    function start(){
      ended=false; over.style.display='none'; shareMenu.classList.add('hidden');
      setScore(0);
      fxEl.innerHTML='';
      grid=Array.from({length:H},()=>Array(W).fill(null));
      drawGrid();
      cur=createBlock(); nxt=createBlock(); drawBlock(cur);
      paused=false; btnPause.textContent='POUSE';
      clearInterval(gInt);
      gInt=setInterval(()=>{ if(!paused && !ended) move(0,1); },1000);
      updateRowHint();
    }
    function togglePause(){ if(ended) return; paused=!paused; btnPause.textContent = paused ? 'HERVAT' : 'POUSE'; }
    btnStart.addEventListener('click', ()=>{ if(!user && !guestGateBypassOnce){ showNRGate(); return; } guestGateBypassOnce=false; start(); });
    btnPause.addEventListener('click', ()=>togglePause());
    btnLeft .addEventListener('click', ()=>move(-1,0));
    btnRight.addEventListener('click',()=>move(1,0));
    btnDown .addEventListener('click', ()=>hardDrop());

    /* ---- Keyboard controls ---- */
    window.addEventListener('keydown', (e) => {
      const gateOpen  = nrGate && nrGate.style.display === 'flex';
      const modalOpen = over   && over.style.display   === 'flex';
      if (gateOpen || modalOpen) return;

      const tag = (document.activeElement && document.activeElement.tagName) || '';
      if (['INPUT','TEXTAREA','SELECT'].includes(tag)) return;

      switch (e.key) {
        case 'ArrowLeft':  e.preventDefault(); move(-1,0); break;
        case 'ArrowRight': e.preventDefault(); move(1,0); break;
        case 'ArrowDown':
        case ' ':
        case 'Spacebar':   e.preventDefault(); hardDrop();  break;
        case 'p':
        case 'P':          e.preventDefault(); togglePause(); break;
      }
    });

    /* ---- Share (points-only) ---- */
    let stickyPayload = null;
    function buildWinShareText(payload){
      const sc = Number(payload?.score ?? score) || 0;
      return `Ek het ${sc} punte gekry met SLIMSTIEK op Kriptiek vandag: ${buildShareUrl(currentDate)}`;
    }
    function toggleShareMenu(){ shareMenu.classList.toggle('hidden'); }
    modalShareBtn.addEventListener('click', (e)=>{ e.stopPropagation(); toggleShareMenu(); });

    document.addEventListener('click', (e)=>{
      if(shareMenu && !shareMenu.contains(e.target) && e.target!==modalShareBtn){ shareMenu.classList.add('hidden'); }
      document.querySelectorAll('#actionBars .share-menu-local').forEach(m=>{ if(!m.contains(e.target)) m.classList.add('hidden'); });
    });
    window.addEventListener('scroll',  ()=>{ shareMenu.classList.add('hidden'); document.querySelectorAll('#actionBars .share-menu-local').forEach(m=>m.classList.add('hidden')); });
    window.addEventListener('resize',  ()=>{ shareMenu.classList.add('hidden'); document.querySelectorAll('#actionBars .share-menu-local').forEach(m=>m.classList.add('hidden')); });

    async function trySystemShare(text){
      try{
        const res = await fetch(`${SITE_ORIGIN}/assets/S_SLIMSTIEK_12SEP.png`);
        const blob = await res.blob();
        const files = [new File([blob],'S_SLIMSTIEK_12SEP.png',{type:blob.type})];
        if(navigator.canShare && navigator.canShare({files})){
          await navigator.share({ title:'SLIMSTIEK – Kriptiek', text, files });
          return true;
        }
      }catch{}
      try{ if(navigator.share){ await navigator.share({ text }); return true; } }catch{}
      return false;
    }
    function openWhatsApp(text){
      const url = `https://wa.me/?text=${encodeURIComponent(text)}`;
      const w = window.open(url,'_blank','noopener,noreferrer');
      if(!w && navigator.clipboard){ navigator.clipboard.writeText(text).then(()=>alert("Skakel gekopieer!")); }
    }

    const mShareText = () => buildWinShareText(stickyPayload || { score });
    mWA.onclick   = () => { openWhatsApp(mShareText()); shareMenu.classList.add('hidden'); };
    mCopy.onclick = async () => { try{ await navigator.clipboard.writeText(mShareText()); alert('Skakel gekopieer!'); }catch{} shareMenu.classList.add('hidden'); };
    mSys.onclick  = async () => { const ok = await trySystemShare(mShareText()); if(!ok) openWhatsApp(mShareText()); shareMenu.classList.add('hidden'); };

    function wireShareTile(wrapper){
      const btn  = wrapper.querySelector('.share-tile');
      const menu = wrapper.querySelector('.share-menu-local');
      const wa   = menu.querySelector('button.wa');
      const cp   = menu.querySelector('button.copy');
      const sys  = menu.querySelector('button.sys');

      btn.addEventListener('click', (e)=>{
        e.preventDefault(); e.stopPropagation();
        document.querySelectorAll('#actionBars .share-menu-local').forEach(m=>{ if(m!==menu) m.classList.add('hidden'); });
        menu.classList.toggle('hidden');
      });

      const txt = () => (stickyPayload ? buildWinShareText(stickyPayload) : shareTextLinkOnly());
      wa.onclick = () => { openWhatsApp(txt()); menu.classList.add('hidden'); };
      cp.onclick = async () => { try{ await navigator.clipboard.writeText(txt()); alert('Skakel gekopieer!'); }catch{} menu.classList.add('hidden'); };
      sys.onclick = async () => { const ok = await trySystemShare(txt()); if(!ok) openWhatsApp(txt()); menu.classList.add('hidden'); };
    }
    function initTileShareDropdowns(){ document.querySelectorAll('.share-tile-wrap').forEach(wireShareTile); }

    function enableStickyShare(payload){
      stickyPayload = { target: TARGET, score: Number(payload?.score ?? score) };
      try{ localStorage.setItem(shareKey(), JSON.stringify({ ...stickyPayload, at: Date.now() })); }catch{}
    }
    function maybeEnableStickyShareFromStorage(){
      try{
        const raw = localStorage.getItem(shareKey());
        if(!raw) return;
        const saved = JSON.parse(raw);
        if(saved && Number.isFinite(saved.score)){ stickyPayload = saved; }
      }catch{}
    }

    /* ---- Local leaderboard (fallback only if both FS paths fail) ---- */
    const LB_LOCAL_KEY = d => `slimstiekLocalLB:${d}`;
    function getLocalLB(date){ try{ return JSON.parse(localStorage.getItem(LB_LOCAL_KEY(date))) || []; }catch{ return []; } }
    function setLocalLB(date, arr){ try{ localStorage.setItem(LB_LOCAL_KEY(date), JSON.stringify(arr)); }catch{} }

    /* ---------- Merged LIVE + LEGACY leaderboard renderer ---------- */
    let unsubLive = null, unsubLegacy = null;
    let liveRows = [], legacyRows = [];

    function rowsToMap(rows){
      const m = new Map();
      rows.forEach(r=>{
        const id = r.id || r.uid || r.userId || r._id;
        if(!id) return;
        const prev = m.get(id) || { id };
        const score = Number(r.score||0);
        const ts = r.ts?.toMillis?.() ? r.ts.toMillis() : (r.ts?.seconds ? r.ts.seconds*1000 : 9e15);
        const userName = (r.userName || prev.userName || 'Onbekend').toString().slice(0,24);
        const kSlim_total = Number(r.kSlim_total || prev.kSlim_total || 0);

        const better = (!prev.score) || (score > (prev.score||0)) || (score === (prev.score||0) && ts < (prev.ts||9e15));
        const merged = better ? { id, score, ts, userName, kSlim_total } : prev;
        m.set(id, merged);
      });
      return m;
    }

    function renderMerged(){
      const map = rowsToMap([...liveRows, ...legacyRows]);
      const combined = Array.from(map.values())
        .sort((a,b)=> (b.score|0)-(a.score|0) || (a.ts||9e15)-(b.ts||9e15))
        .slice(0, 100);

      lbList.innerHTML = '';
      if (!combined.length){
        const local = getLocalLB(currentDate).sort((a,b)=> (b.score|0)-(a.score|0)).slice(0,10);
        if (!local.length){
          bestText.textContent='—';
          lbList.innerHTML = `<li class="bg-green-100 font-medium">Wees eerste op die leierbord!</li>`;
          return;
        }
        bestText.textContent = String(local[0].score);
        local.forEach(row=>{
          const li=document.createElement('li');
          li.innerHTML = `<span class="flex-1"><strong>${row.userName||'Speler'}</strong>: ${row.score|0} punte</span>`;
          lbList.appendChild(li);
        });
        return;
      }

      bestText.textContent = String(combined[0].score ?? '—');

      combined.slice(0,10).forEach(v=>{
        const you = user && v.id === user.uid ? ' <span class="text-xs text-emerald-700 font-bold">(jy)</span>' : '';
        const li  = document.createElement('li');
        const left = `<span class="flex-1"><strong>${(v.userName||'Onbekend')}</strong>${you}: ${(v.score??0)} punte</span>`;
        const pill = (Number(v.kSlim_total||0) > 0) ? `<span class="k-pill">${Number(v.kSlim_total)}</span>` : '';
        li.innerHTML = left + pill;
        lbList.appendChild(li);
      });
    }

    function subscribeMergedLeaderboard(){
      try{ if(typeof unsubLive==='function') unsubLive(); }catch{}
      try{ if(typeof unsubLegacy==='function') unsubLegacy(); }catch{}
      liveRows = []; legacyRows = [];

      if (!db){
        renderMerged();
        return;
      }

      // LIVE: slimstiekGames/GameYYYY-MM-DD/leaderboard
      const colLive = collection(db, 'slimstiekGames', `Game${currentDate}`, 'leaderboard');
      const qLive   = query(colLive, orderBy('score','desc'), orderBy('ts','asc'), limit(200));
      unsubLive = onSnapshot(qLive, (snap)=>{
        liveRows = snap.docs.map(d => ({ id:d.id, ...d.data() }));
        renderMerged();
      }, (err)=>{ console.error('LIVE LB stream failed:', err); liveRows = []; renderMerged(); });

      // LEGACY: leaderboards/slimstiek/dates/YYYY-MM-DD/entries
      const colLegacy = collection(db,'leaderboards','slimstiek','dates', currentDate, 'entries');
      const qLegacy   = query(colLegacy, orderBy('score','desc'), orderBy('ts','asc'), limit(200));
      unsubLegacy = onSnapshot(qLegacy, (snap)=>{
        legacyRows = snap.docs.map(d => ({ id:d.id, ...d.data() }));
        renderMerged();
      }, (err)=>{ console.error('LEGACY LB stream failed:', err); legacyRows = []; renderMerged(); });
    }
    /* ---- Submit to leaderboard (SAFE + LOGGED; LIVE only) ---- */
    async function submitToLB(scoreVal){
      const safeScore = Number.isFinite(scoreVal) ? (scoreVal|0) : 0;
      const safeName  = (currentUserName || 'Speler').toString().slice(0,24);

      // Local fallback remains
      const row = { userName: safeName, score: safeScore };
      const arr = getLocalLB(currentDate);
      const idx = arr.findIndex(r => (r.userName||'') === (row.userName||''));
      if (idx >= 0){
        if (row.score > (arr[idx].score||0)) arr[idx] = row;
      } else {
        arr.push(row);
      }
      setLocalLB(currentDate, arr);

      if(!db || !user) return;

      try{
        const liveRef  = doc(db, 'slimstiekGames', GAME_ID, 'leaderboard', user.uid);
        const liveSnap = await getDoc(liveRef);
        const livePrev = liveSnap.exists() ? liveSnap.data() : null;
        const betterLive = !livePrev || (safeScore > (livePrev.score|0));

        const writeObj = betterLive
          ? { userName: safeName, score: safeScore, ts: STS() }
          : { userName: safeName };

        const cleaned = cleanForFS(writeObj);
        logFSWrite(liveRef, cleaned, "submitToLB");

        await setDoc(liveRef, cleaned, { merge:true });
      } catch (e){
        console.error('FS LB write FAILED (live):', e);
        try { alert('Kon nie jou telling na die leierbord skryf nie. (Sien Console vir detail)'); } catch {}
      }
    }

    /* ==== Mirror Slimstiek K-pill into userGames + expose on LIVE ==== */
    async function mirrorSlimstiekPoints(){
      if (!db || !user) return;

      // supporter flag
      let supporterActive = false;
      try {
        const uSnap = await getDoc(doc(db, "users", user.uid));
        if (uSnap.exists()){
          const u = uSnap.data();
          supporterActive = !!(u?.supporterActive === true ||
            (u?.supporterUntil?.toMillis && u.supporterUntil.toMillis() > Date.now()));
        }
      } catch {}

      // Have a best today?
      const liveBestRef = doc(db,'slimstiekGames', `Game${currentDate}`, 'leaderboard', user.uid);
      const liveBestSnap = await getDoc(liveBestRef);
      const haveBest = liveBestSnap.exists();

      // read existing k fields (daily)
      const S_ID = `Slim${currentDate}`;
      const playRef = doc(db, `userGames/${user.uid}/plays/${S_ID}`);
      const playSnap = await getDoc(playRef);
      let kEarly=0, kImprove=0, kPlace=0, kTotal=0;

      if (playSnap.exists()){
        const d = playSnap.data();
        kEarly   = Number(d?.kSlim_early   || 0);
        kImprove = Number(d?.kSlim_improve || 0);
        kPlace   = Number(d?.kSlim_place   || 0);
        kTotal   = Number(d?.kSlim_total   || 0);
      }

      const now = new Date();

      // EARLY: first 10 entries after 07:00 ZA (legacy list for consistency - read only)
      if (kEarly === 0 && haveBest && now >= zaTimeOn(currentDate, K_CONF.EARLY_BIRD_WINDOW_START)) {
        try {
          const qEarly = query(
            collection(db,'leaderboards','slimstiek','dates', currentDate, 'entries'),
            orderBy('ts','asc'),
            limit(10)
          );
          const eSnap = await getDocs(qEarly);
          const inTop10 = eSnap.docs.some(d => d.id === user.uid);
          if (inTop10) kEarly = K_CONF.EARLY_BIRD_POINTS;
        } catch {}
      }

      // IMPROVE: grant once the first time you have a recorded best
      if (kImprove === 0 && haveBest) kImprove = K_CONF.IMPROVE_POINTS;

      // PLACE: only after cutoff; rank by score DESC then ts ASC (legacy list - read only)
      if (kPlace === 0 && now >= zaTimeOn(currentDate, K_CONF.CUTOFF_TIME)) {
        try {
          const qRank = query(
            collection(db,'leaderboards','slimstiek','dates', currentDate, 'entries'),
            orderBy('score','desc'),
            orderBy('ts','asc'),
            limit(K_CONF.LEADERBOARD_SIZE)
          );
          const rSnap = await getDocs(qRank);
          const pos = rSnap.docs.findIndex(d => d.id === user.uid);
          if (pos >= 0 && pos < K_CONF.FINAL_POINTS.length) kPlace = K_CONF.FINAL_POINTS[pos];
        } catch {}
      }

      // TOTAL with supporter multiplier + daily cap
      const base = kEarly + kImprove + kPlace;
      const mult = supporterActive ? K_CONF.SUPPORTER_MULTIPLIER : 1;
      kTotal = Math.min(Math.round(base * mult), K_CONF.DAILY_CAP_PER_GAME);

      // persist privately
      try {
        await setDoc(playRef, {
          kSlim_early:   kEarly,
          kSlim_improve: kImprove,
          kSlim_place:   kPlace,
          kSlim_total:   kTotal,
          updatedAt: serverTimestamp()
        }, { merge:true });
      } catch (e) { console.warn('Play mirror failed:', e); }

      // === SAFE + LOGGED pill writes (LIVE only; legacy write removed) ===
      const pillObj = cleanForFS({ kSlim_total: Number.isFinite(kTotal) ? kTotal : 0 });

      // BestRef (live)
      try {
        logFSWrite(liveBestRef, pillObj, "mirrorSlimstiekPoints (bestRef)");
        await setDoc(liveBestRef, pillObj, { merge:true });
      } catch (e) { console.warn('Live bestRef pill write failed:', e); }

      // Public exposure on LIVE board (same doc path, kept for clarity)
      try {
        const livePubRef = doc(db,'slimstiekGames', GAME_ID, 'leaderboard', user.uid);
        logFSWrite(livePubRef, pillObj, "mirrorSlimstiekPoints (live public)");
        await setDoc(livePubRef, pillObj, { merge:true });
      } catch (e) { console.warn('Live public pill write failed:', e); }
    }

    /* ---- Game end ---- */
    function end(win){
      clearInterval(gInt);
      ended=true;
      if(!win) return;

      if(bestScore==null || score > bestScore) bestScore = score;
      submitToLB(score);
      mirrorSlimstiekPoints();  // writes pill fields
      enableStickyShare({ score });

      winMsg.innerHTML = `Veels geluk, <strong>${currentUserName}</strong>! Jy het <strong>${TARGET}</strong> voltooi vir <strong>${score}</strong> punte.`;
      over.style.display='flex';
      modalCloseBtn.onclick = ()=>{ over.style.display='none'; };

      if(!user) showNRGate();
    }

    /* ---- Daily word resolver (SINGLE SOURCE OF TRUTH): slimstiekGames → daily_words → games ---- */
    async function resolveTargetWord(){
      const norm = (s) => (s || '')
        .toString()
        .toUpperCase()
        .replace(/[^A-ZÁÂÄÈÉÊËÌÍÎÏÒÓÔÖÙÚÛÜŸ\-]/g,'')
        .trim();

      const pickFromDoc = (d) => {
        if (!d || typeof d !== 'object') return '';
        const keys = Object.keys(d);
        const preferred = ['target','targetWord','word','solution','answer','slimstiek'];
        for (const want of preferred){
          const found = keys.find(k => k.toLowerCase() === want.toLowerCase());
          if (found && typeof d[found] === 'string') {
            const w = norm(d[found]);
            if (w) return w;
          }
        }
        for (const k of keys){
          if (typeof d[k] === 'string'){
            const w = norm(d[k]);
            if (w && w.length >= 3 && w.length <= 12) return w;
          }
        }
        return '';
      };

      if (!db){
        // HARD FAIL in production – handled by loadGame() catcher
        throw new Error('[Slimstiek] Firestore is not available (no db).');
      }

      const gid = `Game${currentDate}`;

      // 1) Primary: slimstiekGames/GameYYYY-MM-DD
      try{
        const liveRef = doc(db, 'slimstiekGames', gid);
        const liveSnap = await getDoc(liveRef);
        if (liveSnap.exists()){
          const d = liveSnap.data() || {};
          const w = pickFromDoc(d);
          console.log('[Slimstiek] slimstiekGames', gid, '→', w, d);
          if (w) return w;
        } else {
          console.log('[Slimstiek] slimstiekGames missing:', gid);
        }
      }catch(e){ console.warn('slimstiekGames fetch failed:', e); }

      // 2) Fallback: daily_words/YYYY-MM-DD
      try{
        const dwRef = doc(db, 'daily_words', currentDate);
        const dwSnap = await getDoc(dwRef);
        if (dwSnap.exists()){
          const d = dwSnap.data() || {};
          const w = pickFromDoc(d);
          console.log('[Slimstiek] daily_words', currentDate, '→', w, d);
          if (w) return w;
        } else {
          console.log('[Slimstiek] daily_words missing:', currentDate);
        }
      }catch(e){ console.warn('daily_words fetch failed:', e); }

      // 3) Safety: games/GameYYYY-MM-DD (in case it was saved there)
      try{
        const gRef = doc(db, 'games', gid);
        const gSnap = await getDoc(gRef);
        if (gSnap.exists()){
          const d = gSnap.data() || {};
          const w = pickFromDoc(d);
          console.log('[Slimstiek] games', gid, '→', w, d);
          if (w) return w;
        } else {
          console.log('[Slimstiek] games missing:', gid);
        }
      }catch(e){ console.warn('games fetch failed:', e); }

      // Surface the problem; caller shows alert
      throw new Error(`Geen teikenwoord gevind vir ${currentDate}.`);
    }

    /* ---- Load ---- */
    async function loadGame(){
      try {
        TARGET = await resolveTargetWord();
      } catch (e) {
        console.error(e);
        alert("Kon nie vandag se teikenwoord laai nie. Maak seker dit is in die admin gestel.");
        TARGET = '????'; // visible error state
      }

      targetEl.innerHTML='';
      (TARGET || '—').split('').forEach(ch=>{ const s=document.createElement('span'); s.textContent=ch; targetEl.appendChild(s); });

      grid = Array.from({length:H},()=>Array(W).fill(null));
      drawGrid();

      maybeEnableStickyShareFromStorage();
      subscribeMergedLeaderboard();
      updateRowHint();

      if (user) { mirrorSlimstiekPoints(); }
    }

    /* ---- Admin backfill helpers ---- */
    function pad(n){ return String(n).padStart(2,'0'); }
    function isoDay(d){ return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }

    async function backfillOne(dateStr){
      if(!db){ alert('Geen Firestore in hierdie omgewing.'); return; }
      bfMsg.textContent = `Backfill ${dateStr}…`;

      const liveCol   = collection(db,'slimstiekGames', `Game${dateStr}`, 'leaderboard');
      const legacyCol = collection(db,'leaderboards','slimstiek','dates', dateStr, 'entries');

      try{
        const [liveSnap, legacySnap] = await Promise.all([
          getDocs(query(liveCol, orderBy('score','desc'), orderBy('ts','asc'), limit(1000))),
          getDocs(query(legacyCol, orderBy('score','desc'), orderBy('ts','asc'), limit(1000)))
        ]);

        const liveMap = new Map(liveSnap.docs.map(d=>[d.id, {id:d.id, ...d.data()}]));
        const legMap  = new Map(legacySnap.docs.map(d=>[d.id, {id:d.id, ...d.data()}]));
        const uids = new Set([...liveMap.keys(), ...legMap.keys()]);

        for (const uid of uids){
          const liveRow = liveMap.get(uid) || {};
          const legRow  = legMap.get(uid)  || {};
          const liveScore = Number(liveRow.score||0);
          const legScore  = Number(legRow.score||0);
          const pickLive  = liveScore >= legScore;
          const base = pickLive ? liveRow : legRow;

          const userName = (base.userName || liveRow.userName || legRow.userName || 'Onbekend').toString().slice(0,24);
          const scoreVal = Number(base.score||0)|0;
          const tsVal    = base.ts || liveRow.ts || legRow.ts || serverTimestamp();

          let kTotal = Number(base.kSlim_total||0);
          if (!kTotal){
            try{
              const playSnap = await getDoc(doc(db, 'userGames', uid, 'plays', `Slim${dateStr}`));
              if (playSnap.exists()){
                const pd = playSnap.data();
                kTotal = Number(pd?.kSlim_total||0);
              }
            }catch{}
          }

          const writeObj = { userName, score:scoreVal, ts:tsVal };
          if (kTotal>0) writeObj.kSlim_total = kTotal;

          try { await setDoc(doc(db,'slimstiekGames', `Game${dateStr}`, 'leaderboard', uid), writeObj, { merge:true }); } catch(e){ console.warn('live set fail', uid, e); }
          try { await setDoc(doc(db,'leaderboards','slimstiek','dates', dateStr, 'entries', uid), writeObj, { merge:true }); } catch(e){ console.warn('legacy set fail', uid, e); }
        }

        bfMsg.textContent = `Klaar vir ${dateStr} ✔`;
      }catch(e){
        console.error('Backfill failed:', e);
        bfMsg.textContent = `Backfill fout – kyk Console`;
        alert('Backfill het misluk. Sien Console vir detail.');
      }
    }

    function eachDayISO(fromISO, toISO){
      const out=[]; const s = new Date(fromISO+'T00:00:00+02:00'); const e = new Date(toISO+'T00:00:00+02:00');
      for(let d=new Date(s); d<=e; d.setDate(d.getDate()+1)) out.push(isoDay(d));
      return out;
    }

    btnBFOne?.addEventListener('click', async ()=>{
      const d = dAdmin.value || currentDate; await backfillOne(d); subscribeMergedLeaderboard();
    });
    btnBFRange?.addEventListener('click', async ()=>{
      const a = dAdmin.value || currentDate;
      const b = dAdminTo.value || a;
      for (const day of eachDayISO(a,b)){ await backfillOne(day); }
      subscribeMergedLeaderboard();
    });

    /* ---- Init ---- */
    function init(){
      initTileShareDropdowns();
      loadGame();
    }
    init();
  </script>

  <!-- Buy Me a Coffee CTA above leaderboard -->
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const list = document.getElementById('leaderboardList');
    const section = list ? list.closest('section') : null;
    if (!section || !section.parentElement) return;

    const wrap = document.createElement('div');
    wrap.className = 'my-4';
    wrap.innerHTML = `
      <div class="rounded-xl border border-slate-200 bg-white/90 shadow p-4 text-slate-800 text-center">
        <a href="https://www.buymeacoffee.com/kriptiek" target="_blank" rel="noopener"
           onclick="window.gtag && gtag('event','bmac_click',{from:'slimstiek-leaderboard'})"
           class="inline-flex items-center justify-center px-5 py-3
                  bg-yellow-500 hover:bg-yellow-600 text-white font-bold
                  rounded-xl shadow-md transition duration-200"
           aria-label="Help ons om Kriptiek gratis te hou">
          <span>HELP ONS OM KRIPTIEK GRATIS TE HOU</span>
        </a>
      </div>
    `;
    section.parentElement.insertBefore(wrap, section);
  });
  </script>

</body>
</html>
