<script>
(function () {
  const DAILY_WORD = "DWAALSPOOR";
  const WORD_LENGTH = DAILY_WORD.length;
  const MAX_GUESSES = 6;
  const STORAGE_KEY = `dilemma-${new Date().toISOString().split("T")[0]}`;
  const colors = {
    correct: "#15803d",
    present: "#ea580c",
    multiple: "#facc15",
    absent: "#6b7280"
  };

  let currentGuess = "";
  let guesses = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
  const grid = document.getElementById("grid");
  const message = document.getElementById("message");

  for (let i = 0; i < MAX_GUESSES; i++) {
    const row = document.createElement("div");
    row.className = "row";
    for (let j = 0; j < WORD_LENGTH; j++) {
      const tile = document.createElement("div");
      tile.className = "tile";
      row.appendChild(tile);
    }
    grid.appendChild(row);
  }

  const KEYS = [
    ["Q", "W", "E", "R", "T", "Y", "U", "I", "O", "P"],
    ["A", "S", "D", "F", "G", "H", "J", "K", "L"],
    ["ENTER", "Z", "X", "C", "V", "B", "N", "M", "âŒ«"]
  ];
  const keyboard = document.getElementById("keyboard");
  const keyButtons = {};

  KEYS.forEach(row => {
    const div = document.createElement("div");
    div.className = "flex justify-center mb-1";
    row.forEach(k => {
      const btn = document.createElement("button");
      const key = k === "âŒ«" ? "â†" : k;
      btn.textContent = key;
      btn.className = "keyboard-button border-2 border-[#a5312f] text-[#a5312f] font-bold px-2 py-1 mx-1";
      btn.onclick = () => handleKey(k);
      keyButtons[k] = btn;
      div.appendChild(btn);
    });
    keyboard.appendChild(div);
  });

  updateGrid();

  function handleKey(key) {
    if (guesses.length >= MAX_GUESSES) return;
    if (key === "âŒ«") {
      currentGuess = currentGuess.slice(0, -1);
    } else if (key === "ENTER") {
      if (currentGuess.length !== WORD_LENGTH) {
        message.textContent = `Gebruik ${WORD_LENGTH} letters.`;
        return;
      }
      guesses.push(currentGuess);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(guesses));
      checkGuess(currentGuess);
      currentGuess = "";
    } else if (/^[A-Z]$/.test(key) && currentGuess.length < WORD_LENGTH) {
      currentGuess += key;
    }
    updateGrid();
  }

  function updateGrid() {
    const rows = grid.children;
    for (let i = 0; i < MAX_GUESSES; i++) {
      const tiles = rows[i].children;
      const guess = guesses[i] || "";
      for (let j = 0; j < WORD_LENGTH; j++) {
        const tile = tiles[j];
        tile.textContent = guess[j] || (i === guesses.length ? currentGuess[j] || "" : "");
        tile.classList.remove("flip");

        if (!guess || guess.length < WORD_LENGTH) continue;

        let letter = guess[j];
        let bg = colors.absent;
        const letterInWord = DAILY_WORD.includes(letter);
        const correctPosition = letter === DAILY_WORD[j];
        const letterMultiple = DAILY_WORD.split(letter).length - 1 > 1;

        if (correctPosition) {
          bg = colors.correct;
        } else if (letterInWord) {
          bg = letterMultiple ? colors.multiple : colors.present;
        }

        setTimeout(() => {
          tile.classList.add("flip");
          tile.style.background = bg;
          tile.style.color = "#fff";
          tile.style.border = `1px solid ${bg}`;
          if (keyButtons[letter]) {
            keyButtons[letter].style.background = bg;
            keyButtons[letter].style.color = "#fff";
            keyButtons[letter].style.border = `1px solid ${bg}`;
          }
        }, j * 200);
      }
    }
  }

  function checkGuess(guess) {
    if (guess === DAILY_WORD) {
      const word = guesses.length === 1 ? "raai" : "raaie";
      showPopup(`KORREK! Jy het dit in ${guesses.length} ${word} reggekry.`);
    } else if (guesses.length >= MAX_GUESSES) {
      showPopup("Jammer, probeer mÃ´re weer.");
    } else {
      message.textContent = "";
    }
  }

  function showPopup(text) {
    document.getElementById("popupText").textContent = text;
    document.getElementById("popup-overlay").classList.add("show");
  }

  window.copyResult = function () {
    const word = guesses.length === 1 ? "raai" : "raaie";
    const result = `Ek het vandag se DILEMMA ðŸ§© in *${guesses.length}* ${word} reggekry. Speel by www.kriptiek.com`;

    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(result).then(() => {
        alert("Jou telling is nou op jou Clipboard");
      });
    } else {
      const textarea = document.createElement("textarea");
      textarea.value = result;
      textarea.setAttribute("readonly", "");
      textarea.style.position = "absolute";
      textarea.style.left = "-9999px";
      document.body.appendChild(textarea);
      textarea.select();
      try {
        document.execCommand("copy");
        alert("Jou telling is nou op jou Clipboard");
      } catch {
        alert("Kopieer het misluk. Probeer asseblief self te kopieer.");
      }
      document.body.removeChild(textarea);
    }
  };

  document.addEventListener("keydown", (e) => {
    let key = e.key.toUpperCase();
    if (key === "BACKSPACE") key = "âŒ«";
    else if (key === "ENTER") key = "ENTER";
    else if (!/^[A-Z]$/.test(key)) return;
    handleKey(key);
  });
})();
</script>
