<!DOCTYPE html>
<html lang="af">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DILEMMA Argief ‚Äì Kriptiek</title>

  <!-- Favicon and App Icons -->
  <link rel="icon" href="/assets/favicon.ico?v=2" type="image/x-icon" />
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png?v=3">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png?v=3">
  <link rel="apple-touch-icon" href="/assets/apple-touch-icon.png?v=3">
  <link rel="manifest" href="/assets/site.webmanifest?v=3">

  <!-- Styles -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&display=swap" rel="stylesheet" />
  <style>
    body { font-family: 'Montserrat', sans-serif; background-color: #f8f5f2; }
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      text-align: center;
    }
    .calendar-grid div { padding: 0.5rem; border-radius: 4px; }
    .calendar-grid a {
      display: block;
      padding: 0.5rem;
      border-radius: 4px;
      font-weight: bold;
      text-decoration: none;
      transition: transform 120ms ease, box-shadow 120ms ease, background-color 120ms ease;
      box-sizing: border-box;
    }
    .calendar-grid a:hover { transform: translateY(-1px); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .day-header { font-weight: bold; color: #374151; }

    /* Legend swatches */
    .legend-swatch {
      width: 20px;
      height: 20px;
      border-radius: 0.375rem;
      display: inline-block;
      box-sizing: border-box;
    }
  </style>
</head>
<body class="min-h-screen p-4 text-gray-100 bg-[#f8f5f2]">

  <!-- ‚úÖ Logo Header -->
  <header class="bg-white shadow p-4 mb-6">
    <div class="logo-container relative flex justify-center items-center w-fit mx-auto p-4 rounded-xl bg-white overflow-hidden">
      <div id="backgroundCrossword" class="background-crossword absolute top-0 left-0 w-full h-full grid opacity-50 pointer-events-none"></div>
      <div class="crossword-grid grid grid-cols-8 gap-1 relative z-10">
        <div class="letter-box transform scale-x-[-1]">K</div>
        <div class="letter-box transform scale-x-[-1]">R</div>
        <div class="letter-box">I</div>
        <div class="letter-box transform scale-x-[-1]">P</div>
        <div class="letter-box">T</div>
        <div class="letter-box">I</div>
        <div class="letter-box transform scale-x-[-1]">E</div>
        <div class="letter-box">K</div>
      </div>
    </div>
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        const backgroundCrossword = document.getElementById('backgroundCrossword');
        const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
        function getRandomLetter() { return letters[Math.floor(Math.random() * letters.length)]; }
        function generateBackgroundGrid() {
          backgroundCrossword.innerHTML = '';
          const numRows = Math.ceil(backgroundCrossword.offsetHeight / 30);
          const numCols = Math.ceil(backgroundCrossword.offsetWidth / 30);
          const totalCells = (numRows * numCols) || 300;
          for (let i = 0; i < totalCells; i++) {
            const bgLetterBox = document.createElement('div');
            bgLetterBox.classList.add('flex','justify-center','items-center','font-bold','text-gray-300','border','border-gray-200');
            bgLetterBox.textContent = getRandomLetter();
            backgroundCrossword.appendChild(bgLetterBox);
          }
        }
        generateBackgroundGrid();
        window.addEventListener('resize', generateBackgroundGrid);
      });
    </script>
  </header>

  <section class="text-center mb-6">
    <h1 class="text-3xl font-bold mb-3 text-[#374151]">Dilemma-argief</h1>

    <!-- ‚úÖ Updated Legend -->
    <div class="max-w-3xl mx-auto text-sm text-gray-700 flex items-center justify-center gap-6">
      <span class="inline-flex items-center gap-2">
        <span class="legend-swatch" style="background-color:#ea580c;"></span>
        Vandag
      </span>
      <span class="inline-flex items-center gap-2">
        <span class="legend-swatch" style="background-color:#374151;"></span>
        Gespeel
      </span>
      <span class="inline-flex items-center gap-2">
        <span class="legend-swatch" style="background-color:#166534;"></span>
        Nog nie gespeel nie
      </span>
    </div>
  </section>

  <main class="max-w-3xl mx-auto">
    <div id="archiveList" class="space-y-10"></div>
    <div id="emptyMsg" class="text-center text-gray-500 hidden">Geen vorige speletjies om te wys nie.</div>

    <!-- ‚úÖ Month navigation moved below -->
    <div id="monthNav" class="flex justify-between mt-6 hidden">
      <button id="prevMonth" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 text-[#374151]">‚Üê Vorige maand</button>
      <button id="nextMonth" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 text-[#374151]">Volgende maand ‚Üí</button>
    </div>
  </main>
  <footer class="bg-white shadow p-4 text-center text-sm text-gray-500 mt-8">
    &copy; 2025 Kriptiek. Alle regte voorbehou. |
    <a href="/index.html" class="underline">Tuis</a> |
    <a href="/profile.html" class="underline">My profiel</a> |
    <a href="/forum.html" class="underline">Gesels saam</a> |
    <a href="/privacy.html" class="underline">Privaatheidsbeleid</a> |
    <a href="/terms.html" class="underline">Voorwaardes</a> |
    <a href="/faq.html" class="underline">Gereelde vrae</a> |
    <a href="/about.html" class="underline">Oor Kriptiek</a> |
    <a href="/contact.html" class="underline">Kontak ons</a>
  </footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import {
      getFirestore, collection, getDocs
    } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDH-nVvGkdaheH7pvRHH0M9TbW2f98lMGQ",
      authDomain: "kriptiek-c9ea2.firebaseapp.com",
      projectId: "kriptiek-c9ea2",
      storageBucket: "kriptiek-c9ea2.appspot.com",
      messagingSenderId: "620450620939",
      appId: "1:620450620939:web:e93a18ac23b53b33db890e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const ORANGE = "#ea580c"; // üî∏ Today
    const BLUE = "#374151";   // Played
    const GREEN = "#166534";  // Not played
    const BASE = "block px-2 py-2 rounded font-bold text-white";

    let monthKeys = [];
    let currentMonthIndex = 0;
    let grouped = {};
    let playedIds = new Set();

    function todayKeySAST() {
      const parts = new Intl.DateTimeFormat('en-CA', {
        timeZone: 'Africa/Johannesburg',
        year: 'numeric', month: '2-digit', day: '2-digit'
      }).formatToParts(new Date());
      const y = parts.find(p => p.type === 'year').value;
      const m = parts.find(p => p.type === 'month').value;
      const d = parts.find(p => p.type === 'day').value;
      return `${y}-${m}-${d}`;
    }
    const todayKey = todayKeySAST();

    function renderMonth(monthKey) {
      const container = document.getElementById("archiveList");
      container.innerHTML = "";

      const [year, month] = monthKey.split("-");
      const monthName = new Date(`${year}-${month}-01`).toLocaleString("af-ZA", { month: "long", year: "numeric" });

      const section = document.createElement("div");

      const heading = document.createElement("h2");
      heading.className = "text-2xl font-semibold text-[#374151] mb-4";
      heading.textContent = `üóìÔ∏è ${monthName}`;
      section.appendChild(heading);

      const calendar = document.createElement("div");
      calendar.className = "calendar-grid";

      ["Ma","Di","Wo","Do","Vr","Sa","So"].forEach(d => {
        const header = document.createElement("div");
        header.className = "day-header";
        header.textContent = d;
        calendar.appendChild(header);
      });

      const firstDay = new Date(`${year}-${month}-01`);
      const totalDays = new Date(year, month, 0).getDate();
      const startDay = (firstDay.getDay() + 6) % 7;

      for (let i = 0; i < startDay; i++) {
        calendar.appendChild(document.createElement("div"));
      }

      for (let day = 1; day <= totalDays; day++) {
        const dateStr = `${year}-${month}-${String(day).padStart(2, "0")}`;
        const cell = document.createElement("div");
        const game = (grouped[monthKey] || []).find(g => g.dateKey === dateStr);

        if (game) {
          const a = document.createElement("a");
          a.href = `/dilemmagame.html?gameId=${game.gameId}`;
          a.textContent = day;
          a.className = BASE;

          const isPlayed = playedIds.has(game.gameId);
          const isToday = dateStr === todayKey;

          if (isToday) {
            a.style.backgroundColor = ORANGE;
          } else if (isPlayed) {
            a.style.backgroundColor = BLUE;
          } else {
            a.style.backgroundColor = GREEN;
          }

          cell.appendChild(a);
        } else {
          const span = document.createElement("span");
          span.textContent = day;
          span.className = "text-gray-400";
          cell.appendChild(span);
        }
        calendar.appendChild(cell);
      }

      section.appendChild(calendar);
      container.appendChild(section);

      updateNavButtons();
    }

    function updateNavButtons() {
      const prevBtn = document.getElementById("prevMonth");
      const nextBtn = document.getElementById("nextMonth");
      prevBtn.disabled = currentMonthIndex === monthKeys.length - 1;
      nextBtn.disabled = currentMonthIndex === 0;
    }

    async function loadArchive() {
      const gamesCol = collection(db, "games");
      const snap = await getDocs(gamesCol);

      const entries = [];
      snap.forEach(docSnap => {
        const data = docSnap.data();
        const dk = data?.dateKey || data?.date || docSnap.id.replace(/^Game/, "");
        if (!dk) return;
        if (dk <= todayKey) entries.push({ dateKey: dk, gameId: docSnap.id });
      });

      grouped = {};
      entries.forEach(({ dateKey, gameId }) => {
        const [y, m] = dateKey.split("-");
        const key = `${y}-${m}`;
        if (!grouped[key]) grouped[key] = [];
        grouped[key].push({ dateKey, gameId });
      });

      monthKeys = Object.keys(grouped).sort((a, b) => b.localeCompare(a));
      monthKeys.forEach(k => grouped[k].sort((a, b) => a.dateKey.localeCompare(b.dateKey)));

      await new Promise(resolve => {
        onAuthStateChanged(auth, async (user) => {
          playedIds = new Set();
          if (user) {
            try {
              const playsSnap = await getDocs(collection(db, `userGames/${user.uid}/plays`));
              playsSnap.forEach(p => playedIds.add(p.id));
            } catch (e) {
              console.warn("Kon nie gespeelde speletjies laai nie:", e);
            }
          }
          resolve();
        });
      });

      if (monthKeys.length) renderMonth(monthKeys[currentMonthIndex]);

      document.getElementById("prevMonth").addEventListener("click", () => {
        if (currentMonthIndex < monthKeys.length - 1) {
          currentMonthIndex++;
          renderMonth(monthKeys[currentMonthIndex]);
        }
      });
      document.getElementById("nextMonth").addEventListener("click", () => {
        if (currentMonthIndex > 0) {
          currentMonthIndex--;
          renderMonth(monthKeys[currentMonthIndex]);
        }
      });

      if (monthKeys.length > 1) {
        document.getElementById("monthNav").classList.remove("hidden");
      }
    }
    loadArchive();
  </script>
</body>
</html>
