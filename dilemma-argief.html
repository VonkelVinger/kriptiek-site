<!DOCTYPE html>
<html lang="af">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DILEMMA Argief ‚Äì Kriptiek</title>
  <!-- Favicon and App Icons -->
  <link rel="icon" href="/assets/favicon.ico" type="image/x-icon" />
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png">
  <link rel="apple-touch-icon" href="/assets/apple-touch-icon.png">
  <link rel="manifest" href="/assets/site.webmanifest">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&display=swap" rel="stylesheet" />
  <style>
    body { font-family: 'Montserrat', sans-serif; background-color: #f8f5f2; }
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      text-align: center;
    }
    .calendar-grid div { padding: 0.5rem; border-radius: 4px; }
    .calendar-grid a {
      display: block;
      padding: 0.5rem;
      border-radius: 4px;
      font-weight: bold;
      text-decoration: none;
      transition: transform 120ms ease, box-shadow 120ms ease, background-color 120ms ease;
      box-sizing: border-box;
    }
    .calendar-grid a:hover { transform: translateY(-1px); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .day-header { font-weight: bold; color: #374151; }

    /* Legend swatches */
    .legend-swatch {
      width: 20px;
      height: 20px;
      border-radius: 0.375rem;
      display: inline-block;
      box-sizing: border-box;
    }
    /* Clear "today" marker: small white dot in the top-right corner */
    .today-indicator {
      background-image: radial-gradient(circle at 85% 20%, #ffffff 0 3px, transparent 4px);
      background-repeat: no-repeat;
    }
  </style>
</head>
<body class="min-h-screen p-4 text-gray-100 bg-[#f8f5f2]">
  <header class="text-center mb-6">
    <h1 class="text-3xl font-bold mb-3 text-[#374151]">Dilemma-argief</h1>

    <!-- Legend moved here -->
    <div class="max-w-3xl mx-auto text-sm text-gray-700 flex items-center justify-center gap-6">
      <span class="inline-flex items-center gap-2">
        <span class="legend-swatch today-indicator" style="background-color:#374151;"></span>
        Vandag
      </span>
      <span class="inline-flex items-center gap-2">
        <span class="legend-swatch" style="background-color:#374151;"></span>
        Gespeel
      </span>
      <span class="inline-flex items-center gap-2">
        <span class="legend-swatch" style="background-color:#166534;"></span>
        Nog nie gespeel nie
      </span>
    </div>
  </header>

  <main class="max-w-3xl mx-auto">
    <!-- Month navigation -->
    <div id="monthNav" class="flex justify-between mb-4 hidden">
      <button id="prevMonth" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 text-[#374151]">‚Üê Vorige maand</button>
      <button id="nextMonth" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 text-[#374151]">Volgende maand ‚Üí</button>
    </div>
    <div id="archiveList" class="space-y-10"></div>
  </main>

  <footer class="bg-white shadow p-4 text-center text-sm text-gray-500 mt-8">
    &copy; 2025 Kriptiek. Alle regte voorbehou. |
    <a href="/index.html" class="underline">Tuis</a> |
    <a href="/profile.html" class="underline">My profiel</a> |
    <a href="/forum.html" class="underline">Gesels saam</a> |
    <a href="/privacy.html" class="underline">Privaatheidsbeleid</a> |
    <a href="/terms.html" class="underline">Voorwaardes</a> |
    <a href="/faq.html" class="underline">Gereelde vrae</a> |
    <a href="/about.html" class="underline">Oor Kriptiek</a> |
    <a href="/contact.html" class="underline">Kontak ons</a>
  </footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDH-nVvGkdaheH7pvRHH0M9TbW2f98lMGQ",
      authDomain: "kriptiek-c9ea2.firebaseapp.com",
      projectId: "kriptiek-c9ea2",
      storageBucket: "kriptiek-c9ea2.appspot.com",
      messagingSenderId: "620450620939",
      appId: "1:620450620939:web:e93a18ac23b53b33db890e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Brand colors
    const BLUE = "#374151";  // dark blue
    const GREEN = "#166534"; // dark green

    // Base classes for day links
    const BASE = "block px-2 py-2 rounded font-bold text-white";

    let monthKeys = [];
    let currentMonthIndex = 0;
    let grouped = {};
    let playedIds = new Set();

    const todayStr = (() => {
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    })();

    function renderMonth(monthKey) {
      const container = document.getElementById("archiveList");
      container.innerHTML = "";

      const [year, month] = monthKey.split("-");
      const monthName = new Date(`${year}-${month}-01`).toLocaleString("af-ZA", { month: "long", year: "numeric" });

      const section = document.createElement("div");

      const heading = document.createElement("h2");
      heading.className = "text-2xl font-semibold text-[#374151] mb-4";
      heading.textContent = `üóìÔ∏è ${monthName}`;
      section.appendChild(heading);

      const calendar = document.createElement("div");
      calendar.className = "calendar-grid";

      // Day headers
      ["Ma","Di","Wo","Do","Vr","Sa","So"].forEach(d => {
        const header = document.createElement("div");
        header.className = "day-header";
        header.textContent = d;
        calendar.appendChild(header);
      });

      // Prepare days
      const firstDay = new Date(`${year}-${month}-01`);
      const totalDays = new Date(year, month, 0).getDate();
      const startDay = (firstDay.getDay() + 6) % 7; // Monday-start

      // Leading blanks
      for (let i = 0; i < startDay; i++) {
        calendar.appendChild(document.createElement("div"));
      }

      // Day cells
      for (let day = 1; day <= totalDays; day++) {
        const dateStr = `${year}-${month}-${String(day).padStart(2, "0")}`;
        const cell = document.createElement("div");
        const game = (grouped[monthKey] || []).find(g => g.date === dateStr);

        if (game) {
          const a = document.createElement("a");
          a.href = `/dilemmagame.html?gameId=${game.gameId}`;
          a.textContent = day;
          a.className = BASE;
          a.style.boxSizing = "border-box";
          a.style.borderRadius = "4px";

          const isPlayed = playedIds.has(game.gameId);
          const isToday = dateStr === todayStr;

          if (isToday) {
            a.style.backgroundColor = BLUE;
            // clear border; use clear dot marker instead
            a.style.border = "none";
            a.classList.add("today-indicator");
          } else if (isPlayed) {
            a.style.backgroundColor = BLUE;
            a.style.border = "none";
          } else {
            a.style.backgroundColor = GREEN;
            a.style.border = "none";
          }

          a.setAttribute(
            "aria-label",
            isToday
              ? `Vandag ‚Äì ${dateStr}`
              : (isPlayed ? `Gespeel op ${dateStr}` : `Nie gespeel op ${dateStr}`)
          );

          cell.appendChild(a);
        } else {
          const span = document.createElement("span");
          span.textContent = day;
          span.className = "text-gray-400";
          cell.appendChild(span);
        }

        calendar.appendChild(cell);
      }

      section.appendChild(calendar);
      container.appendChild(section);

      updateNavButtons();
    }

    function updateNavButtons() {
      const prevBtn = document.getElementById("prevMonth");
      const nextBtn = document.getElementById("nextMonth");
      prevBtn.disabled = currentMonthIndex === monthKeys.length - 1;
      nextBtn.disabled = currentMonthIndex === 0;
    }

    async function loadArchive() {
      // 1) Load all games
      const gamesCol = collection(db, "games");
      const snap = await getDocs(gamesCol);
      if (!snap.empty) {
        const entries = [];
        snap.forEach(doc => {
          const data = doc.data();
          if (data?.date) entries.push({ date: data.date, gameId: doc.id });
        });

        // Sort desc by date
        entries.sort((a, b) => b.date.localeCompare(a.date));

        // Group by YYYY-MM
        grouped = {};
        entries.forEach(({ date, gameId }) => {
          const [y, m] = date.split("-");
          const key = `${y}-${m}`;
          if (!grouped[key]) grouped[key] = [];
          grouped[key].push({ date, gameId });
        });

        monthKeys = Object.keys(grouped).sort((a, b) => b.localeCompare(a));
      }

      // 2) Get played gameIds for signed-in user
      await new Promise(resolve => {
        onAuthStateChanged(auth, async (user) => {
          playedIds = new Set();
          if (user) {
            try {
              const playsCol = collection(db, `userGames/${user.uid}/plays`);
              const playsSnap = await getDocs(playsCol);
              playsSnap.forEach(doc => playedIds.add(doc.id)); // doc.id === gameId
            } catch (e) {
              console.warn("Kon nie gespeelde speletjies laai nie:", e);
            }
          }
          resolve();
        });
      });

      // 3) Initial render (most recent month)
      if (monthKeys.length) {
        renderMonth(monthKeys[currentMonthIndex]);
      }

      // Month nav
      document.getElementById("prevMonth").addEventListener("click", () => {
        if (currentMonthIndex < monthKeys.length - 1) {
          currentMonthIndex++;
          renderMonth(monthKeys[currentMonthIndex]);
        }
      });
      document.getElementById("nextMonth").addEventListener("click", () => {
        if (currentMonthIndex > 0) {
          currentMonthIndex--;
          renderMonth(monthKeys[currentMonthIndex]);
        }
      });

      if (monthKeys.length > 1) {
        document.getElementById("monthNav").classList.remove("hidden");
      }
    }

    loadArchive();
  </script>
</body>
</html>
