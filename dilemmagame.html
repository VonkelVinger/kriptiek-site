<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js';
import { getFirestore, doc, getDoc, collection, addDoc, getDocs, query, orderBy, limit, serverTimestamp } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js';

const firebaseConfig = {
  apiKey: "AIzaSyDH-nVvGkdaheH7pvRHH0M9TbW2f98lMGQ",
  authDomain: "kriptiek-c9ea2.firebaseapp.com",
  projectId: "kriptiek-c9ea2",
  storageBucket: "kriptiek-c9ea2.appspot.com",
  messagingSenderId: "620450620939",
  appId: "1:620450620939:web:e93a18ac23b53b33db890e"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const storedName = localStorage.getItem('userName') || 'Speler';
document.getElementById("playerName").textContent = storedName;

const clueEl = document.getElementById("clue");
const gameGrid = document.getElementById("game-grid");
const keyboard = document.getElementById("keyboard");
const leaderboardList = document.getElementById("leaderboardList");
const lockoutMessage = document.getElementById("lockoutMessage");
const modal = document.getElementById("resultModal");
const resultMsg = document.getElementById("resultMessage");
const shareBtn = document.getElementById("modalShareBtn");
const closeBtn = document.getElementById("closeModalBtn");

const params = new URLSearchParams(window.location.search);
const gameId = params.get("gameId") || `Game${new Date().toISOString().split("T")[0]}`;
const gameUrl = window.location.href;
const localKey = `lastGameTime_${gameId}`;

let targetWord = "";
let gridCols = 5;
let board = [];
let currentRow = 0;
let currentCol = 0;
let gameOver = false;

async function loadGameData() {
  const snap = await getDoc(doc(db, "games", gameId));
  if (snap.exists()) {
    const data = snap.data();
    targetWord = (data.word || "XXXXX").toUpperCase();
    clueEl.textContent = data.clue || "Geen leidraad beskikbaar nie.";
    gridCols = targetWord.length;
  }
}

function createGrid() {
  board = [];
  for (let r = 0; r < 6; r++) {
    const rowDiv = document.createElement("div");
    rowDiv.className = "tile-row";
    const row = [];
    for (let c = 0; c < gridCols; c++) {
      const tile = document.createElement("div");
      tile.className = "letter-tile";
      rowDiv.appendChild(tile);
      row.push(tile);
    }
    gameGrid.appendChild(rowDiv);
    board.push(row);
  }
}

function createKeyboard() {
  keyboard.innerHTML = "";
  const layout = ["QWERTYUIOP", "ASDFGHJKL", "ZXCVBNM"];
  layout.forEach(row => {
    const rowDiv = document.createElement("div");
    rowDiv.className = "keyboard-row";
    [...row].forEach(letter => {
      const key = document.createElement("button");
      key.className = "key";
      key.textContent = letter;
      key.onclick = () => handleKey(letter);
      rowDiv.appendChild(key);
    });
    if (row === "ZXCVBNM") {
      const enter = document.createElement("button");
      enter.className = "key bg-green-600";
      enter.textContent = "Enter";
      enter.onclick = handleEnter;
      rowDiv.appendChild(enter);
      const back = document.createElement("button");
      back.className = "key bg-red-600";
      back.textContent = "‚Üê";
      back.onclick = handleBackspace;
      rowDiv.appendChild(back);
    }
    keyboard.appendChild(rowDiv);
  });
}

function handleKey(letter) {
  if (gameOver) return;
  if (currentCol < gridCols) {
    board[currentRow][currentCol].textContent = letter;
    currentCol++;
  }
}

function handleBackspace() {
  if (currentCol > 0) {
    currentCol--;
    board[currentRow][currentCol].textContent = "";
  }
}

function buildEmojiGrid() {
  return board.slice(0, currentRow + 1).map(row =>
    row.map(cell =>
      cell.classList.contains("correct") ? "üü©" :
      cell.classList.contains("present") ? "üü®" : "‚¨ú"
    ).join("")
  ).join("\n");
}

function updateKeyboard(letter, state) {
  const key = [...document.querySelectorAll(".key")].find(k => k.textContent === letter);
  if (!key) return;
  if (state === "correct" || (state === "present" && !key.classList.contains("correct"))) {
    key.classList.remove("present", "absent");
    key.classList.add(state);
  } else if (state === "absent" && !key.classList.contains("correct") && !key.classList.contains("present")) {
    key.classList.add("absent");
  }
}

function handleEnter() {
  if (currentCol < gridCols) {
    alert("Vul al die letters in!");
    return;
  }
  const guess = board[currentRow].map(tile => tile.textContent).join("");
  const states = new Array(gridCols).fill("absent");
  const letterCounts = {};
  for (let ch of targetWord) letterCounts[ch] = (letterCounts[ch] || 0) + 1;
  for (let i = 0; i < gridCols; i++) {
    if (guess[i] === targetWord[i]) {
      states[i] = "correct";
      letterCounts[guess[i]]--;
    }
  }
  for (let i = 0; i < gridCols; i++) {
    if (states[i] !== "correct" && letterCounts[guess[i]] > 0) {
      states[i] = "present";
      letterCounts[guess[i]]--;
    }
  }
  states.forEach((state, i) => {
    const tile = board[currentRow][i];
    tile.classList.add("flip", state);
    updateKeyboard(guess[i], state);
  });
  const won = guess === targetWord;
  setTimeout(() => finishGame(won), gridCols * 350);
}

function finishGame(success) {
  gameOver = true;
  const emoji = buildEmojiGrid();
  const message = success
    ? `Ek het vandag se DILEMMA in ${currentRow + 1} raaiskote opgelos. Speel by www.kriptiek.com\n${emoji}`
    : `Ek kon nie vandag se DILEMMA oplos nie. Speel by www.kriptiek.com\n${emoji}`;

  resultMsg.textContent = success
    ? `Veels geluk, ${storedName}, jy het die woord met ${currentRow + 1} raaiskote opgelos.`
    : `Jammer, ${storedName}! Die woord was ${targetWord}.`;

  shareBtn.onclick = () => navigator.clipboard.writeText(message);
  modal.style.display = "flex";
  addDoc(collection(db, "games", gameId, "leaderboard"), {
    name: storedName,
    score: success ? currentRow + 1 : 6,
    timestamp: serverTimestamp()
  });
  localStorage.setItem(localKey, Date.now());
  lockoutMessage.style.display = "block";
}

closeBtn.onclick = () => modal.style.display = "none";
document.addEventListener("keydown", e => {
  if (e.key === "Enter") handleEnter();
  else if (e.key === "Backspace") handleBackspace();
  else if (/^[a-zA-Z]$/.test(e.key)) handleKey(e.key.toUpperCase());
});

loadGameData().then(() => {
  createGrid();
  createKeyboard();
});
</script>
