<!DOCTYPE html>
<html lang="af">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DILEMMA â€“ Kriptiek</title>

  <!-- Favicon and Meta -->
  <link rel="icon" href="/assets/favicon.ico" type="image/x-icon" />
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png">
  <link rel="apple-touch-icon" href="/assets/apple-touch-icon.png">
  <link rel="manifest" href="/assets/site.webmanifest">
  <meta property="og:title" content="KRIPTIEK" />
  <meta property="og:description" content="Tuiste van DILEMMA en ander Afrikaanse woordraaisels" />
  <meta property="og:url" content="https://www.kriptiek.com/" />
  <meta property="og:type" content="website" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta property="og:image" content="https://www.kriptiek.com/assets/WAshare-logo.png" />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="630" />

  <!-- Fonts and Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&display=swap" rel="stylesheet">

  <!-- Core Styles -->
  <style>
    body { font-family: 'Montserrat', sans-serif; background-color: #f9fafb; color: #1f2937; }
    header { background-color: #ffffff; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); padding: 1rem; text-align: center; }
    .logo-container { display: flex; justify-content: center; align-items: center; margin-bottom: 10px; }
    .logo-container .letter-box {
      width: 40px; height: 40px; margin: 2px;
      display: flex; justify-content: center; align-items: center;
      background-color: #374151; color: white;
      font-size: 1.5rem; font-weight: bold; border-radius: 4px;
    }
    .game-container { max-width: 640px; margin: 0 auto; padding: 1rem; }
    .tile-row { display: flex; justify-content: center; margin-bottom: 5px; }
    .letter-tile {
      width: 50px; height: 50px;
      display: flex; justify-content: center; align-items: center;
      border: 2px solid #374151;
      font-size: 1.5rem; font-weight: bold; text-transform: uppercase;
      margin: 2px; background-color: white; color: #1f2937;
      transition: transform 0.3s ease;
    }
    .letter-tile.flip { animation: flipAnim 0.5s ease forwards; }
    @keyframes flipAnim {
      0% { transform: rotateX(0); }
      50% { transform: rotateX(90deg); }
      100% { transform: rotateX(0); }
    }
    .correct { background-color: #16a34a !important; color: white !important; }
    .present { background-color: #facc15 !important; color: black !important; }
    .absent { background-color: #9ca3af !important; color: white !important; }
    .keyboard-row { display: flex; justify-content: center; margin: 5px 0; }
    .key {
      min-width: 30px; padding: 10px 12px; margin: 2px;
      border-radius: 4px; background-color: #374151;
      color: white; font-weight: bold; cursor: pointer; text-transform: uppercase;
    }
    .key.bg-green-600 { background-color: #16a34a !important; }
    .key.bg-red-600 { background-color: #1e3a8a !important; }
    #lockoutMessage {
      display: none; text-align: center; margin-top: 10px;
      font-weight: bold; color: #1e3a8a; font-size: 1.1rem;
      opacity: 0; animation: fadeIn 1s forwards;
    }
    #lockoutMessage .icon { margin-right: 6px; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-5px);}
      to { opacity: 1; transform: translateY(0);}
    }
    #leaderboard {
      border: 1px solid #e5e7eb;
    }
    #leaderboardList li {
      padding: 6px 8px;
      transition: background-color 0.2s ease;
    }
    #leaderboardList li:nth-child(odd) { background-color: #f9fafb; }
    #leaderboardList li:nth-child(even) { background-color: #ffffff; }
    #leaderboardList li:hover { background-color: #e0e7ff; }
    #leaderboardList li:first-child {
      background-color: #d1fae5;
      font-weight: bold;
    }
    #resultModal {
      display: none;
      position: fixed;
      inset: 0;
      background-color: rgba(0, 0, 0, 0.5);
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    #resultModal .modal-content {
      background: white;
      padding: 1.5rem;
      border-radius: 8px;
      text-align: center;
      max-width: 300px;
      width: 100%;
    }
    #resultModal button {
      margin: 5px;
      padding: 8px 16px;
      border-radius: 4px;
      font-weight: bold;
    }
    .btn-share { background-color: #1e3a8a; color: white; }
    .btn-close { background-color: #6b7280; color: white; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

<header>
  <div class="logo-container">
    <div class="letter-box">D</div><div class="letter-box">I</div><div class="letter-box">L</div>
    <div class="letter-box">E</div><div class="letter-box">M</div><div class="letter-box">M</div>
    <div class="letter-box">A</div>
  </div>
  <p class="text-sm text-gray-500">
    Welkom terug, <span id="playerName" class="font-semibold text-green-700"></span>!
  </p>
</header>

<main class="flex-grow game-container">
  <div id="clue" class="text-center text-lg mb-4 text-gray-700 font-semibold">Laai die leidraad...</div>
  <div id="game-grid" class="mb-6"></div>
  <div id="keyboard" class="mb-6"></div>
  <p id="lockoutMessage"><span class="icon">ðŸ”’</span>Jy kan mÃ´re weer speel</p>

  <!-- HOE OM TE SPEEL section -->
  <div class="mt-6 bg-white rounded shadow p-4">
    <h2 class="text-xl font-bold mb-2">HOE OM DILEMMA TE SPEEL</h2>
    <p class="text-gray-700 leading-relaxed mb-2">
      Jy het ses kanse om die woord te raai.<br>
      Jy mag vir elke probeerslag enige letters in enige volgorde kies, maar elke raaiskoot moet dieselfde aantal letters hÃª as die woord waarna jy soek. Dit hoef nie ook 'n woord te vorm nie.<br>
      Gebruik jou toetsbord of die een op die skerm om jou raaiskoot in te tik, dan ENTER.
    </p>
    <p class="text-gray-700 italic mb-2">
      WENK: Op kleiner skerms kan jy Dilemma soos 'n foto met jou vingers kleiner trek totdat dit heeltemal inpas.
    </p>
    <p class="text-gray-700 leading-relaxed">
      <span class="font-bold text-green-700">GROEN</span>: Die letter is in die antwoord en in die regte blokkie.<br>
      <span class="font-bold text-yellow-600">GEEL</span>: Die letter is in die antwoord, maar nie in die regte blokkie nie.<br>
      <span class="font-bold text-gray-500">GRYS</span>: Die letter is glad nie in die antwoord nie.
    </p>
  </div>

  <!-- CTA row (button you asked for) -->
  <div class="mt-4 flex justify-center">
    <a href="/forum.html"
       class="inline-block bg-[#1e3a8a] text-white font-bold px-4 py-2 rounded shadow hover:bg-[#1a2d74] transition">
      GESELS SAAM
    </a>
  </div>

  <!-- LEADERBOARD -->
  <div id="leaderboard" class="mt-6 bg-white rounded shadow p-4">
    <h2 class="text-xl font-bold mb-2">Vandag se beste spelers</h2>
    <ul id="leaderboardList" class="text-gray-700 text-left">
      <li>Laai...</li>
    </ul>
  </div>
</main>

<footer class="bg-white shadow p-4 text-center text-sm text-gray-500">
  &copy; 2025 Kriptiek. Alle regte voorbehou. |
  <a href="/index.html" class="underline">Tuis</a>
  <a href="/forum.html" class="underline">Gesels saam</a>
  <a href="/privacy.html" class="underline">Privaatheidsbeleid</a> |
  <a href="/terms.html" class="underline">Voorwaardes</a> |
  <a href="/faq.html" class="underline">Gereelde vrae</a> |
  <a href="/about.html" class="underline">Oor Kriptiek</a> |
  <a href="/contact.html" class="underline">Kontak ons</a>
</footer>

<!-- RESULT MODAL -->
<div id="resultModal">
  <div class="modal-content">
    <p id="resultMessage" class="mb-4 font-bold"></p>
    <button id="modalShareBtn" class="btn-share">DEEL</button>
    <button id="closeModalBtn" class="btn-close">SLUIT</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
import {
  getFirestore, doc, getDoc, collection, getDocs, setDoc,
  query, orderBy, limit, serverTimestamp
} from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDH-nVvGkdaheH7pvRHH0M9TbW2f98lMGQ",
  authDomain: "kriptiek-c9ea2.firebaseapp.com",
  projectId: "kriptiek-c9ea2",
  storageBucket: "kriptiek-c9ea2.appspot.com",
  messagingSenderId: "620450620939",
  appId: "1:620450620939:web:e93a18ac23b53b33db890e"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
let currentUser = null;
onAuthStateChanged(auth, u => currentUser = u || null);

const gameGrid = document.getElementById("game-grid");
const keyboard = document.getElementById("keyboard");
const lockoutMessage = document.getElementById("lockoutMessage");
const modal = document.getElementById("resultModal");
const resultMsg = document.getElementById("resultMessage");
const shareBtn = document.getElementById("modalShareBtn");
const closeBtn = document.getElementById("closeModalBtn");
const leaderboardList = document.getElementById("leaderboardList");

const storedName = localStorage.getItem("userName") || "Speler";
document.getElementById("playerName").textContent = storedName;

let gridRows = 6, gridCols = 5;
let currentRow = 0, currentCol = 0;
let board = [], targetWord = "", gameOver = false;

const params = new URLSearchParams(window.location.search);
const gameId = params.get("gameId") || `Game${new Date().toISOString().split('T')[0]}`;
const gameUrl = window.location.href;

function disableGame(message = "Jy het hierdie een reeds vandag gespeel") {
  gameOver = true;
  document.getElementById("clue").textContent = message;
  lockoutMessage.style.display = "block";
  document.querySelectorAll(".key").forEach(key => key.disabled = true);
}

async function loadGameData() {
  const gameRef = doc(db, "games", gameId);
  const snap = await getDoc(gameRef);
  if (snap.exists()) {
    const data = snap.data();
    targetWord = (data.word || "").toUpperCase();
    gridCols = targetWord.length || gridCols;
    document.getElementById("clue").textContent = data.clue || "Geen leidraad beskikbaar nie.";
  } else {
    targetWord = "MAKLIK";
    gridCols = targetWord.length;
    document.getElementById("clue").textContent = "Geen leidraad beskikbaar nie.";
  }
}

function createGrid() {
  gameGrid.innerHTML = "";
  board = [];
  for (let r = 0; r < gridRows; r++) {
    const row = document.createElement("div");
    row.className = "tile-row";
    const rowTiles = [];
    for (let c = 0; c < gridCols; c++) {
      const tile = document.createElement("div");
      tile.className = "letter-tile";
      row.appendChild(tile);
      rowTiles.push(tile);
    }
    board.push(rowTiles);
    gameGrid.appendChild(row);
  }
}

function createKeyboard() {
  keyboard.innerHTML = "";
  const layout = ["QWERTYUIOP", "ASDFGHJKL", "ZXCVBNM"];
  layout.forEach(row => {
    const rowDiv = document.createElement("div");
    rowDiv.className = "keyboard-row";
    [...row].forEach(letter => {
      const key = document.createElement("button");
      key.className = "key";
      key.textContent = letter;
      key.onclick = () => handleKey(letter);
      rowDiv.appendChild(key);
    });
    if (row === "ZXCVBNM") {
      const enter = document.createElement("button");
      enter.className = "key bg-green-600";
      enter.textContent = "Enter";
      enter.onclick = handleEnter;
      rowDiv.appendChild(enter);

      const back = document.createElement("button");
      back.className = "key bg-red-600";
      back.textContent = "â†";
      back.onclick = handleBackspace;
      rowDiv.appendChild(back);
    }
    keyboard.appendChild(rowDiv);
  });
}
function updateKeyboard(letter, state) {
  const keyBtn = [...document.querySelectorAll(".key")].find(k => k.textContent === letter);
  if (!keyBtn) return;
  if (state === "correct" || (state === "present" && !keyBtn.classList.contains("correct"))) {
    keyBtn.classList.remove("present", "absent");
    keyBtn.classList.add(state);
  } else if (state === "absent" && !keyBtn.classList.contains("correct") && !keyBtn.classList.contains("present")) {
    keyBtn.classList.add("absent");
  }
}

function handleKey(letter) {
  if (gameOver) return;
  if (currentCol < gridCols && currentRow < gridRows) {
    board[currentRow][currentCol].textContent = letter;
    currentCol++;
  }
}

function handleBackspace() {
  if (gameOver || currentCol === 0) return;
  currentCol--;
  board[currentRow][currentCol].textContent = "";
}

function handleEnter() {
  if (gameOver) return;
  if (currentCol < gridCols) return alert("Vul al die letters in!");
  const guess = board[currentRow].map(t => t.textContent).join("");
  checkGuessWithFlip(guess);
}

function checkGuessWithFlip(guess) {
  const guessLetters = guess.split("");
  const states = new Array(gridCols).fill("absent");
  const letterCounts = {};
  for (let ch of targetWord) letterCounts[ch] = (letterCounts[ch] || 0) + 1;

  for (let i = 0; i < gridCols; i++) {
    if (guess[i] === targetWord[i]) {
      states[i] = "correct";
      letterCounts[guess[i]]--;
    }
  }

  for (let i = 0; i < gridCols; i++) {
    if (states[i] === "correct") continue;
    if (letterCounts[guess[i]] > 0) {
      states[i] = "present";
      letterCounts[guess[i]]--;
    }
  }

  states.forEach((s, i) => {
    const tile = board[currentRow][i];
    setTimeout(() => {
      tile.classList.add("flip", s);
      updateKeyboard(guess[i], s);
    }, i * 350);
  });

  // Save progress (letters + states) so it survives refresh
  saveLocalProgress();

  setTimeout(() => {
    if (guess === targetWord) gameCompleted(currentRow + 1);
    else {
      currentRow++;
      currentCol = 0;
      if (currentRow >= gridRows) gameFailed();
    }
  }, gridCols * 350);
}

function saveLocalProgress() {
  const localGuesses = [];
  for (let r = 0; r <= currentRow; r++) {
    const guess = board[r].map(t => t.textContent).join("");
    const states = board[r].map(t =>
      t.classList.contains("correct") ? "correct" :
      t.classList.contains("present") ? "present" : t.classList.contains("absent") ? "absent" : ""
    );
    if (guess.trim()) localGuesses.push({ guess, states });
  }
  localStorage.setItem(`dilemma-${gameId}`, JSON.stringify(localGuesses));
}
function restoreLocalProgress() {
  const saved = localStorage.getItem(`dilemma-${gameId}`);
  if (!saved) return;

  const data = JSON.parse(saved);
  data.forEach(({ guess, states }) => {
    const letters = guess.split("");
    for (let i = 0; i < letters.length; i++) {
      const tile = board[currentRow][i];
      tile.textContent = letters[i];
      tile.classList.remove("correct", "present", "absent");
      if (states[i]) {
        tile.classList.add(states[i]);
        tile.classList.add("flip");
        updateKeyboard(letters[i], states[i]);
      }
    }
    currentRow++;
    currentCol = 0;
  });
}

// --- Leaderboard loading (best first; tie = earliest recorded) ---
async function loadLeaderboard() {
  // Get recent entries ordered by date asc for stable tieâ€‘breakers (no composite index needed)
  const qDate = query(
    collection(db, "games", gameId, "leaderboard"),
    orderBy("date", "asc"),
    limit(200)
  );
  const snapshot = await getDocs(qDate);

  const entries = [];
  snapshot.forEach(docSnap => {
    const d = docSnap.data();
    const validName = typeof d.userName === "string";
    const validGuesses = d.guesses >= 1 && d.guesses <= gridRows;
    if (validName && validGuesses) {
      // keep raw timestamp for tieâ€‘break
      entries.push({ name: d.userName, guesses: d.guesses, when: d.date?.seconds || 0 });
    }
  });

  // Now sort: best guesses first, and for equal guesses, earliest first
  entries.sort((a, b) => (a.guesses - b.guesses) || (a.when - b.when));

  leaderboardList.innerHTML = "";
  if (entries.length === 0) {
    leaderboardList.innerHTML = `<li>Jy kan eerste op die leierbord wees!</li>`;
    return;
  }

  const seen = new Set();
  entries.forEach((entry, index) => {
    if (seen.has(entry.name)) return;
    seen.add(entry.name);
    const li = document.createElement("li");
    li.className = index === 0 ? "font-bold bg-green-100" : "";
    li.innerHTML = `<strong>${entry.name}</strong>: ${entry.guesses} raaiskote`;
    leaderboardList.appendChild(li);
  });
}

// --- Stats + leaderboard write ---
async function submitScore(guessCount, didWin) {
  try {
    if (!currentUser) {
      console.warn("No user signed in; skipping leaderboard write.");
      return;
    }

    const uid = currentUser.uid;
    const displayName = (localStorage.getItem("userName") || currentUser.displayName || "Speler").trim() || "Speler";

    // Pull current aggregates
    const userRef = doc(db, "users", uid);
    const snap = await getDoc(userRef);
    const today = new Date().toISOString().split("T")[0];
    const yd = new Date(); yd.setDate(yd.getDate() - 1);
    const yesterday = yd.toISOString().split("T")[0];

    let u = snap.exists() ? snap.data() : {
      userName: displayName,
      email: currentUser.email || "",
      gamesPlayed: 0, wins: 0,
      streak: 0, bestStreak: 0,
      guessDist: { "1":0,"2":0,"3":0,"4":0,"5":0,"6":0 },
      lastPlayedDate: null
    };

    const alreadyPlayedToday = u.lastPlayedDate === today;

    if (!alreadyPlayedToday) {
      u.gamesPlayed += 1;
      if (didWin) {
        u.wins += 1;
        if (u.lastPlayedDate === yesterday) u.streak = (u.streak || 0) + 1;
        else u.streak = 1;
        u.bestStreak = Math.max(u.bestStreak || 0, u.streak || 0);
        const bucket = String(Math.min(Math.max(guessCount, 1), 6));
        u.guessDist[bucket] = (u.guessDist[bucket] || 0) + 1;
      } else {
        u.streak = 0;
      }
      u.lastPlayedDate = today;

      await setDoc(userRef, {
        userName: displayName,
        email: currentUser.email || "",
        gamesPlayed: u.gamesPlayed,
        wins: u.wins,
        streak: u.streak,
        bestStreak: u.bestStreak,
        guessDist: u.guessDist,
        lastPlayedDate: u.lastPlayedDate,
        updatedAt: serverTimestamp()
      }, { merge: true });
    }

    const successRate = u.gamesPlayed ? Math.round((u.wins / u.gamesPlayed) * 100) : 0;

    // leaderboard doc id must equal uid and include successRate
    const lbRef = doc(db, "games", gameId, "leaderboard", uid);
    await setDoc(lbRef, {
      userName: displayName,
      guesses: Math.min(Math.max(guessCount, 1), 6),
      successRate,
      date: serverTimestamp()
    }, { merge: true });

  } catch (e) {
    console.error("Kon nie telling/leaderboard stoor nie:", e);
  }
}

async function gameCompleted(guessCount) {
  gameOver = true;
  resultMsg.textContent = `Veels geluk, ${storedName}, jy het die woord in ${guessCount} raaiskote gekry!`;
  modal.style.display = "flex";
  shareBtn.onclick = () =>
    navigator.clipboard.writeText(`Ek het DILEMMA in ${guessCount} raaiskote opgelos: ${gameUrl}`);
  lockoutMessage.style.display = "block";
  localStorage.setItem(`dilemma-${gameId}-finished`, "true");

  await submitScore(guessCount, true);
  await loadLeaderboard();
  document.querySelectorAll(".key").forEach(k => k.disabled = true);
}

async function gameFailed() {
  gameOver = true;
  resultMsg.textContent = `Jammer, ${storedName}! Vandag se oplossing is ${targetWord}.`;
  modal.style.display = "flex";
  shareBtn.onclick = () =>
    navigator.clipboard.writeText(`Ek kon nie DILEMMA oplos nie. Probeer self: ${gameUrl}`);
  lockoutMessage.style.display = "block";
  localStorage.setItem(`dilemma-${gameId}-finished`, "true");

  await submitScore(gridRows, false);
  await loadLeaderboard();
  document.querySelectorAll(".key").forEach(k => k.disabled = true);
}

closeBtn.onclick = () => { modal.style.display = "none"; };

document.addEventListener("keydown", e => {
  if (e.key === "Enter") handleEnter();
  else if (e.key === "Backspace") handleBackspace();
  else if (/^[a-zA-Z]$/.test(e.key)) handleKey(e.key.toUpperCase());
});

// INIT
await loadGameData();
createGrid();
createKeyboard();
await restoreLocalProgress();

// If we previously finished this game, lock out immediately on load
if (localStorage.getItem(`dilemma-${gameId}-finished`) === "true") {
  disableGame();
}

await loadLeaderboard();
</script>
</body>
</html>
