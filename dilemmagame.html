<!DOCTYPE html>
<html lang="af">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DILEMMA ‚Äì Kriptiek</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Montserrat', sans-serif; background-color: #f9fafb; color: #1f2937; }
    .logo-container { display: flex; justify-content: center; align-items: center; margin: 1rem 0; }
    .letter-box { width: 40px; height: 40px; margin: 2px; background: #374151; color: white; font-size: 1.5rem; font-weight: bold; display: flex; align-items: center; justify-content: center; border-radius: 4px; }
    .tile-row { display: flex; justify-content: center; margin-bottom: 5px; }
    .letter-tile { width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; border: 2px solid #374151; font-size: 1.5rem; font-weight: bold; text-transform: uppercase; margin: 2px; background-color: white; color: #1f2937; transition: transform 0.3s ease; }
    .letter-tile.flip { animation: flipAnim 0.5s ease forwards; }
    @keyframes flipAnim { 0% { transform: rotateX(0); } 50% { transform: rotateX(90deg); } 100% { transform: rotateX(0); } }
    .correct { background-color: #16a34a !important; color: white !important; }
    .present { background-color: #facc15 !important; color: black !important; }
    .absent { background-color: #9ca3af !important; color: white !important; }
    .keyboard-row { display: flex; justify-content: center; margin: 5px 0; }
    .key { min-width: 30px; padding: 10px 12px; margin: 2px; border-radius: 4px; background-color: #374151; color: white; font-weight: bold; cursor: pointer; text-transform: uppercase; }
    .key.bg-green-600 { background-color: #16a34a !important; }
    .key.bg-red-600 { background-color: #1e3a8a !important; }
    #lockoutMessage { display: none; text-align: center; margin-top: 10px; font-weight: bold; color: #1e3a8a; font-size: 1.1rem; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

<header>
  <div class="logo-container">
    <div class="letter-box">K</div><div class="letter-box">R</div><div class="letter-box">I</div>
    <div class="letter-box">P</div><div class="letter-box">T</div><div class="letter-box">I</div>
    <div class="letter-box">E</div><div class="letter-box">K</div>
  </div>
  <p class="text-sm text-gray-500">Welkom, <span id="playerName" class="font-semibold text-green-700"></span>!</p>
</header>

<main class="flex-grow game-container p-4">
  <div id="clue" class="text-center text-lg mb-4 text-gray-700 font-semibold">Laai die leidraad...</div>
  <div id="game-grid" class="mb-6"></div>
  <div id="keyboard" class="mb-6"></div>
  <p id="lockoutMessage"><span class="icon">üîí</span>Jy kan m√¥re weer speel</p>

  <div class="mt-6 bg-white rounded shadow p-4">
    <h2 class="text-xl font-bold mb-2">HOE OM TE SPEEL</h2>
    <p class="text-gray-700 leading-relaxed mb-2">
      Jy het ses kanse om die woord te raai.<br>
      Jy mag vir elke probeerslag enige letters in enige volgorde kies, maar elke raaiskoot moet dieselfde aantal letters h√™ as die woord waarna jy soek. Dit hoef nie ook 'n woord te vorm nie.<br>
      Gebruik jou toetsbord of die een op die skerm om jou raaiskoot in te tik, dan ENTER.
    </p>
    <p class="text-gray-700 italic mb-2">
      WENK: Op kleiner skerms sal jy soms lekkerder speel in landskap-formaat ("Landscape Format" of "Auto-Rotate").
    </p>
    <p class="text-gray-700 leading-relaxed">
      <span class="font-bold text-green-700">GROEN</span>: Die letter is in die antwoord en in die regte blokkie.<br>
      <span class="font-bold text-yellow-600">GEEL</span>: Die letter is in die antwoord, maar nie in die regte blokkie nie.<br>
      <span class="font-bold text-gray-500">GRYS</span>: Die letter is glad nie in die antwoord nie.
    </p>
  </div>

  <div id="leaderboard" class="mt-6 bg-white rounded shadow p-4">
    <h2 class="text-xl font-bold mb-2">Vandag se beste spelers</h2>
    <ul id="leaderboardList" class="text-gray-700 text-left">
      <li>Jy kan eerste op die leierbord wees!</li>
    </ul>
  </div>
</main>

<footer class="bg-white shadow p-4 text-center text-sm text-gray-500">
  &copy; 2025 Kriptiek. Alle regte voorbehou. |
  <a href="/index.html" class="underline">Tuis</a>
  <a href="/privacy.html" class="underline">Privaatheidsbeleid</a> |
  <a href="/terms.html" class="underline">Voorwaardes</a> |
  <a href="/faq.html" class="underline">Gereelde vrae</a> |
  <a href="/about.html" class="underline">Oor Kriptiek</a> |
  <a href="/contact.html" class="underline">Kontak ons</a>
</footer>

<div id="resultModal" style="display: none; position: fixed; inset: 0; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 1000;">
  <div class="modal-content" style="background: white; padding: 1.5rem; border-radius: 8px; text-align: center; max-width: 300px; width: 100%;">
    <p id="resultMessage" class="mb-4 font-bold"></p>
    <button id="modalShareBtn" class="btn-share" style="background-color: #1e3a8a; color: white; margin: 5px; padding: 8px 16px; border-radius: 4px; font-weight: bold;">DEEL</button>
    <button id="closeModalBtn" class="btn-close" style="background-color: #6b7280; color: white; margin: 5px; padding: 8px 16px; border-radius: 4px; font-weight: bold;">SLUIT</button>
  </div>
</div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js';
import { getFirestore, doc, getDoc, collection, addDoc, getDocs, query, orderBy, limit, serverTimestamp } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js';

const firebaseConfig = {
  apiKey: "AIzaSyDH-nVvGkdaheH7pvRHH0M9TbW2f98lMGQ",
  authDomain: "kriptiek-c9ea2.firebaseapp.com",
  projectId: "kriptiek-c9ea2",
  storageBucket: "kriptiek-c9ea2.appspot.com",
  messagingSenderId: "620450620939",
  appId: "1:620450620939:web:e93a18ac23b53b33db890e"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const storedName = localStorage.getItem('userName') || 'Speler';
document.getElementById("playerName").textContent = storedName;

const clueEl = document.getElementById("clue");
const gameGrid = document.getElementById("game-grid");
const keyboard = document.getElementById("keyboard");
const leaderboardList = document.getElementById("leaderboardList");
const lockoutMessage = document.getElementById("lockoutMessage");
const modal = document.getElementById("resultModal");
const resultMsg = document.getElementById("resultMessage");
const shareBtn = document.getElementById("modalShareBtn");
const closeBtn = document.getElementById("closeModalBtn");

const params = new URLSearchParams(window.location.search);
const gameId = params.get("gameId") || `Game${new Date().toISOString().split("T")[0]}`;
const gameUrl = window.location.href;
const localKey = `lastGameTime_${gameId}`;

let targetWord = "";
let gridCols = 5;
let board = [];
let currentRow = 0;
let currentCol = 0;
let gameOver = false;

async function loadGameData() {
  const snap = await getDoc(doc(db, "games", gameId));
  if (snap.exists()) {
    const data = snap.data();
    targetWord = (data.word || "XXXXX").toUpperCase();
    clueEl.textContent = data.clue || "Geen leidraad beskikbaar nie.";
    gridCols = targetWord.length;
  }
}

function createGrid() {
  board = [];
  for (let r = 0; r < 6; r++) {
    const rowDiv = document.createElement("div");
    rowDiv.className = "tile-row";
    const row = [];
    for (let c = 0; c < gridCols; c++) {
      const tile = document.createElement("div");
      tile.className = "letter-tile";
      rowDiv.appendChild(tile);
      row.push(tile);
    }
    gameGrid.appendChild(rowDiv);
    board.push(row);
  }
}

function createKeyboard() {
  keyboard.innerHTML = "";
  const layout = ["QWERTYUIOP", "ASDFGHJKL", "ZXCVBNM"];
  layout.forEach(row => {
    const rowDiv = document.createElement("div");
    rowDiv.className = "keyboard-row";
    [...row].forEach(letter => {
      const key = document.createElement("button");
      key.className = "key";
      key.textContent = letter;
      key.onclick = () => handleKey(letter);
      rowDiv.appendChild(key);
    });
    if (row === "ZXCVBNM") {
      const enter = document.createElement("button");
      enter.className = "key bg-green-600";
      enter.textContent = "Enter";
      enter.onclick = handleEnter;
      rowDiv.appendChild(enter);
      const back = document.createElement("button");
      back.className = "key bg-red-600";
      back.textContent = "‚Üê";
      back.onclick = handleBackspace;
      rowDiv.appendChild(back);
    }
    keyboard.appendChild(rowDiv);
  });
}

function handleKey(letter) {
  if (gameOver) return;
  if (currentCol < gridCols) {
    board[currentRow][currentCol].textContent = letter;
    currentCol++;
  }
}

function handleBackspace() {
  if (currentCol > 0) {
    currentCol--;
    board[currentRow][currentCol].textContent = "";
  }
}

function buildEmojiGrid() {
  return board.slice(0, currentRow + 1).map(row =>
    row.map(cell =>
      cell.classList.contains("correct") ? "üü©" :
      cell.classList.contains("present") ? "üü®" : "‚¨ú"
    ).join("")
  ).join("\n");
}

function updateKeyboard(letter, state) {
  const key = [...document.querySelectorAll(".key")].find(k => k.textContent === letter);
  if (!key) return;
  if (state === "correct" || (state === "present" && !key.classList.contains("correct"))) {
    key.classList.remove("present", "absent");
    key.classList.add(state);
  } else if (state === "absent" && !key.classList.contains("correct") && !key.classList.contains("present")) {
    key.classList.add("absent");
  }
}

function handleEnter() {
  if (currentCol < gridCols) {
    alert("Vul al die letters in!");
    return;
  }
  const guess = board[currentRow].map(tile => tile.textContent).join("");
  const states = new Array(gridCols).fill("absent");
  const letterCounts = {};
  for (let ch of targetWord) letterCounts[ch] = (letterCounts[ch] || 0) + 1;
  for (let i = 0; i < gridCols; i++) {
    if (guess[i] === targetWord[i]) {
      states[i] = "correct";
      letterCounts[guess[i]]--;
    }
  }
  for (let i = 0; i < gridCols; i++) {
    if (states[i] !== "correct" && letterCounts[guess[i]] > 0) {
      states[i] = "present";
      letterCounts[guess[i]]--;
    }
  }
  states.forEach((state, i) => {
    const tile = board[currentRow][i];
    tile.classList.add("flip", state);
    updateKeyboard(guess[i], state);
  });
  const won = guess === targetWord;
  setTimeout(() => finishGame(won), gridCols * 350);
}

function finishGame(success) {
  gameOver = true;
  const emoji = buildEmojiGrid();
  const resultText = success ? `Veels geluk, ${storedName}, jy het die woord in ${currentRow + 1} raaiskote gekry!` : `Jammer, ${storedName}! Die woord was ${targetWord}.`;
  const header = success ? `${gameId.replace("Game", "")} ${currentRow + 1}/6` : `${gameId.replace("Game", "")} X/6`;
  resultMsg.textContent = resultText;
  shareBtn.onclick = () => navigator.clipboard.writeText(`DILEMMA ${header}\n${emoji}\nwww.kriptiek.com`);
  modal.style.display = "flex";
  addDoc(collection(db, "games", gameId, "leaderboard"), {
    name: storedName,
    score: success ? currentRow + 1 : 6,
    timestamp: serverTimestamp()
  });
  localStorage.setItem(localKey, Date.now());
  lockoutMessage.style.display = "block";
}

closeBtn.onclick = () => modal.style.display = "none";
document.addEventListener("keydown", e => {
  if (e.key === "Enter") handleEnter();
  else if (e.key === "Backspace") handleBackspace();
  else if (/^[a-zA-Z]$/.test(e.key)) handleKey(e.key.toUpperCase());
});

loadGameData().then(() => {
  createGrid();
  createKeyboard();
});
</script>
</body>
</html>
