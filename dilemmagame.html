<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
import { getFirestore, doc, getDoc, collection, addDoc, getDocs, query, orderBy, limit, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDH-nVvGkdaheH7pvRHH0M9TbW2f98lMGQ",
  authDomain: "kriptiek-c9ea2.firebaseapp.com",
  projectId: "kriptiek-c9ea2",
  storageBucket: "kriptiek-c9ea2.appspot.com",
  messagingSenderId: "620450620939",
  appId: "1:620450620939:web:e93a18ac23b53b33db890e"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const gameGrid = document.getElementById("game-grid");
const keyboard = document.getElementById("keyboard");
const leaderboardList = document.getElementById("leaderboardList");
const lockoutMessage = document.getElementById("lockoutMessage");
const modal = document.getElementById("resultModal");
const resultMsg = document.getElementById("resultMessage");
const shareBtn = document.getElementById("modalShareBtn");
const closeBtn = document.getElementById("closeModalBtn");

const storedName = localStorage.getItem('userName') || 'Speler';
document.getElementById("playerName").textContent = storedName;

let gridRows = 6, gridCols = 5;
let currentRow = 0, currentCol = 0;
let board = [];
let targetWord = "";
let gameOver = false;

const params = new URLSearchParams(window.location.search);
const gameId = params.get("gameId") || `Game${new Date().toISOString().split('T')[0]}`;
const localKey = `lastGameTime_${gameId}`;

function disableGame(message = "Jy het hierdie een reeds vandag gespeel") {
  gameOver = true;
  document.getElementById('clue').textContent = message;
  lockoutMessage.style.display = "block";
  document.querySelectorAll('.key').forEach(key => key.disabled = true);
}

async function checkDailyLimit() {
  const lastGameTime = localStorage.getItem(localKey);
  if (lastGameTime && Date.now() - parseInt(lastGameTime) < 86400000) {
    disableGame();
    return false;
  }
  return true;
}

async function loadGameData() {
  const gameDocRef = doc(db, 'games', gameId);
  const gameDocSnap = await getDoc(gameDocRef);
  if (gameDocSnap.exists()) {
    const data = gameDocSnap.data();
    targetWord = (data.word || "XXXXX").toUpperCase();
    gridCols = targetWord.length;
    document.getElementById('clue').textContent = data.clue || "Geen leidraad beskikbaar nie.";
  }
}

function createGrid() {
  gameGrid.innerHTML = "";
  board = [];
  for (let r = 0; r < gridRows; r++) {
    const rowDiv = document.createElement("div");
    rowDiv.className = "tile-row";
    const row = [];
    for (let c = 0; c < gridCols; c++) {
      const tile = document.createElement("div");
      tile.className = "letter-tile";
      rowDiv.appendChild(tile);
      row.push(tile);
    }
    gameGrid.appendChild(rowDiv);
    board.push(row);
  }
}

const keyLayout = ["QWERTYUIOP", "ASDFGHJKL", "ZXCVBNM"];
function createKeyboard() {
  keyboard.innerHTML = "";
  keyLayout.forEach(row => {
    const rowDiv = document.createElement("div");
    rowDiv.className = "keyboard-row";
    [...row].forEach(letter => {
      const key = document.createElement("button");
      key.className = "key";
      key.textContent = letter;
      key.onclick = () => handleKey(letter);
      rowDiv.appendChild(key);
    });
    if (row === "ZXCVBNM") {
      const enter = document.createElement("button");
      enter.className = "key bg-green-600";
      enter.textContent = "Enter";
      enter.onclick = handleEnter;
      rowDiv.appendChild(enter);
      const back = document.createElement("button");
      back.className = "key bg-red-600";
      back.textContent = "‚Üê";
      back.onclick = handleBackspace;
      rowDiv.appendChild(back);
    }
    keyboard.appendChild(rowDiv);
  });
}

function handleKey(letter) {
  if (gameOver) return;
  if (currentCol < gridCols && currentRow < gridRows) {
    board[currentRow][currentCol].textContent = letter;
    currentCol++;
  }
}

function handleBackspace() {
  if (gameOver) return;
  if (currentCol > 0) {
    currentCol--;
    board[currentRow][currentCol].textContent = "";
  }
}

function handleEnter() {
  if (gameOver) return;
  if (currentCol < gridCols) {
    alert("Vul al die letters in!");
    return;
  }
  const guess = board[currentRow].map(tile => tile.textContent).join("");
  checkGuessWithFlip(guess);
}

function checkGuessWithFlip(guess) {
  const target = targetWord;
  const guessLetters = guess.split("");
  const letterCounts = {};
  for (let ch of target) letterCounts[ch] = (letterCounts[ch] || 0) + 1;

  const states = new Array(gridCols).fill("absent");
  for (let i = 0; i < gridCols; i++) {
    if (guessLetters[i] === target[i]) {
      states[i] = "correct";
      letterCounts[guessLetters[i]]--;
    }
  }
  for (let i = 0; i < gridCols; i++) {
    if (states[i] === "correct") continue;
    const letter = guessLetters[i];
    if (letterCounts[letter] > 0) {
      states[i] = "present";
      letterCounts[letter]--;
    }
  }

  states.forEach((state, i) => {
    const tile = board[currentRow][i];
    const letter = guessLetters[i];
    setTimeout(() => {
      tile.classList.add("flip");
      tile.classList.add(state);
      updateKeyboard(letter, state);
    }, i * 350);
  });

  setTimeout(() => {
    if (guess === target) gameCompleted(currentRow + 1);
    else {
      currentRow++;
      currentCol = 0;
      if (currentRow >= gridRows) gameFailed();
    }
  }, gridCols * 350);
}

function updateKeyboard(letter, state) {
  const keyBtn = [...document.querySelectorAll('.key')].find(k => k.textContent === letter);
  if (keyBtn) {
    if (state === "correct" || (state === "present" && !keyBtn.classList.contains("correct"))) {
      keyBtn.classList.remove("present", "absent");
      keyBtn.classList.add(state);
    } else if (state === "absent" && !keyBtn.classList.contains("correct") && !keyBtn.classList.contains("present")) {
      keyBtn.classList.add("absent");
    }
  }
}

function buildEmojiGrid() {
  return board.slice(0, currentRow + 1).map(row =>
    row.map(tile => tile.classList.contains("correct") ? "üü©" : tile.classList.contains("present") ? "üü®" : "‚¨ú").join("")
  ).join("\n");
}

async function loadLeaderboard() {
  leaderboardList.innerHTML = '';
  const q = query(collection(db, 'games', gameId, 'leaderboard'), orderBy('score', 'asc'), limit(10));
  const querySnapshot = await getDocs(q);
  let entries = 0;
  querySnapshot.forEach((docSnap, index) => {
    const data = docSnap.data();
    entries++;
    const li = document.createElement('li');
    li.className = "leaderboard-entry";
    const crown = index === 0 ? '<span class="crown">üëë</span>' : '';
    li.innerHTML = `${crown}<strong>${data.name}</strong>: ${data.score} ${data.score === 1 ? 'raaiskoot' : 'raaiskote'}`;
    leaderboardList.appendChild(li);
  });
  if (entries === 0) leaderboardList.innerHTML = "<li>Jy kan eerste op die leierbord wees!</li>";
}

async function submitScore(score) {
  await addDoc(collection(db, 'games', gameId, 'leaderboard'), {
    name: storedName,
    score,
    timestamp: serverTimestamp()
  });
  localStorage.setItem(localKey, Date.now());
  await loadLeaderboard();
}

function gameCompleted(attempts) {
  gameOver = true;
  const plural = attempts === 1 ? "raaiskoot" : "raaiskote";
  const emojiGrid = buildEmojiGrid();
  const shortLink = "www.kriptiek.com";
  const fullLink = window.location.href;
  resultMsg.textContent = `Veels geluk, ${storedName}, jy het die woord in ${attempts} ${plural} gekry!`;
  modal.style.display = "flex";
  const shareMessage = `Ek het vandag se DILEMMA in ${attempts} ${plural} opgelos. Speel by ${shortLink}\n${emojiGrid}`;
  shareBtn.onclick = () => navigator.clipboard.writeText(shareMessage);
  submitScore(attempts);
  lockoutMessage.style.display = "block";
}

function gameFailed() {
  gameOver = true;
  const emojiGrid = buildEmojiGrid();
  const shortLink = "www.kriptiek.com";
  const fullLink = window.location.href;
  resultMsg.textContent = `Jammer, ${storedName}! Vandag se oplossing is ${targetWord}.`;
  modal.style.display = "flex";
  const shareMessage = `Ek kon nie vandag se DILEMMA oplos nie. Speel by ${shortLink}\n${emojiGrid}`;
  shareBtn.onclick = () => navigator.clipboard.writeText(shareMessage);
  submitScore(gridRows);
  lockoutMessage.style.display = "block";
}

closeBtn.onclick = () => modal.style.display = "none";

document.addEventListener("keydown", e => {
  if (e.key === "Enter") handleEnter();
  else if (e.key === "Backspace") handleBackspace();
  else if (/^[a-zA-Z]$/.test(e.key)) handleKey(e.key.toUpperCase());
});

await loadGameData();
createGrid();
createKeyboard();
await loadLeaderboard();
await checkDailyLimit();
</script>
