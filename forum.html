<!DOCTYPE html>
<html lang="af">
<head>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-S9V4CMP1FP"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-S9V4CMP1FP');
</script>
  
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Kriptiek Gesels</title>

<!-- Canonical & Open Graph / Twitter (purple GESELS tile) -->
<link rel="canonical" href="https://www.kriptiek.com/forum.html" />
<meta property="og:site_name" content="Kriptiek" />
<meta property="og:title" content="GESELS SAAM ‚Äì Kriptiek" />
<meta property="og:description" content="Deel jou resultate en gesels saam op Kriptiek." />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://www.kriptiek.com/forum.html" />
<meta property="og:image" content="https://www.kriptiek.com/assets/K_GESELS_12SEP.png" />
<meta property="og:image:alt" content="GESELS SAAM" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://www.kriptiek.com/assets/K_GESELS_12SEP.png" />

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&display=swap" rel="stylesheet" />
<style>
  body { font-family: 'Montserrat', sans-serif; background-color: #f9fafb; position: relative; }
  .background-crossword { position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    display: grid; grid-template-columns: repeat(auto-fill, minmax(30px, 1fr));
    grid-template-rows: repeat(auto-fill, minmax(30px, 1fr)); opacity: 0.5; z-index: 1; pointer-events: none; }
  .bg-letter-box { display: flex; justify-content: center; align-items: center; font-size: 1.1rem; font-weight: bold;
    color: #9ca3af; border: 1px solid #e5e7eb; background-color: transparent; user-select: none; }
  .logo-container { position: relative; display: flex; justify-content: center; align-items: center; width: fit-content;
    margin: 1rem auto; padding: 1rem; border-radius: 1rem; background-color: white; overflow: hidden; }
  .crossword-grid { display: grid; grid-template-columns: repeat(8, minmax(40px, 1fr)); gap: 4px; position: relative; z-index: 10; }
  .letter-box { width: 50px; height: 50px; display: flex; justify-content: center; align-items: center; background-color: #374151; color: white;
    font-size: 1.8rem; font-weight: bold; border: 2px solid #1f2937; border-radius: 0.375rem; text-transform: uppercase; box-shadow: inset 0 0 5px rgba(0,0,0,.2); }
  .flipped-k { transform: scaleX(-1); }
  @media (max-width: 640px) { .letter-box { width: 38px; height: 38px; font-size: 1.2rem; } .crossword-grid { gap: 2px; } .logo-container { padding: 0.5rem; } }
</style>
</head>
<body class="relative">
  <header class="bg-white shadow p-4 text-center z-10 relative">
    <a href="/index.html" class="logo-container">
      <div id="backgroundCrossword" class="background-crossword"></div>
      <div class="crossword-grid">
        <div class="letter-box flipped-k">K</div><div class="letter-box flipped-k">R</div>
        <div class="letter-box">I</div><div class="letter-box flipped-k">P</div>
        <div class="letter-box">T</div><div class="letter-box">I</div>
        <div class="letter-box flipped-k">E</div><div class="letter-box">K</div>
      </div>
    </a>
    <h1 class="text-2xl font-bold text-gray-800 mt-2">GESELS SAAM, <span id="userDisplayName">BESOEKER</span></h1>
    <p class="text-sm text-gray-600">Spog, skinder of kla, maar gedra jou of jy word verwyder. Jy moet geregistreer wees om kommentaar te kan plaas.</p>
  </header>

  <!-- üîî Live new-post banner (hidden by default) -->
  <div id="liveBanner"
       class="hidden sticky top-0 z-20 bg-green-600 text-white text-center px-4 py-2 cursor-pointer">
    Nuwe plasing beskikbaar ‚Äî kliek om te laai
  </div>

  <!-- üü° BMaC CTA (same as other pages) -->
  <section class="max-w-xl mx-auto px-6 mt-3">
    <div class="rounded-xl border border-slate-200 bg-white/90 shadow p-4 text-slate-800">
      <a href="https://www.buymeacoffee.com/kriptiek"
   class="flex items-center justify-center w-full px-5 py-3
          bg-yellow-500 hover:bg-yellow-600 text-white font-bold
          rounded-xl shadow-md transition duration-200 text-center">
  <span class="block leading-tight">HELP ONS OM KRIPTIEK GRATIS TE HOU</span>
</a>
      <p class="text-xs text-slate-600 mt-2 text-center">
        Kliek bo as jy Kriptiek.com finansieel kan ondersteun. Daarsonder sal ons nie kan voortbestaan nie!
      </p>
    </div>
  </section>

  <main class="max-w-xl mx-auto p-6 relative z-10">
    <!-- üëá Dilemma Top-25 REMOVED -->

    <div id="new-post" class="mb-6">
      <h2 class="text-lg font-semibold mb-2">Jou nuwe plasing</h2>
      <input type="text" id="postTitle" maxlength="80" placeholder="Titel" class="w-full p-2 border rounded mb-2">
      <textarea id="postContent" maxlength="500" rows="4" placeholder="Tik jou boodskap (maks. 500 karakters)" class="w-full p-2 border rounded mb-1"></textarea>
      <div class="text-sm text-gray-500 mb-2"><span id="charCount">0</span>/500 karakters</div>
      <button id="submitBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">Stuur</button>
      <p id="formMsg" class="text-sm text-red-600 mt-2"></p>
    </div>

    <div id="post-tools" class="mb-6 flex items-center justify-between gap-2">
      <input type="text" id="searchInput" placeholder="Soek titels of inhoud..." class="w-full p-2 border rounded" />
    </div>

    <div id="postsList">
      <h2 class="text-lg font-semibold mb-4">Onlangse gesprekke</h2>
      <div id="forumPosts"></div>
      <button id="loadMoreBtn" class="hidden mt-4 w-full text-center text-sm text-blue-700 hover:underline">Laai meer...</button>
    </div>
  </main>

  <footer class="bg-white shadow p-4 text-center text-sm text-gray-500 z-10 relative">
    &copy; 2025 Kriptiek. Alle regte voorbehou. |
    <a href="/index.html" class="underline">Tuis</a> |
    <a href="/profile.html" class="underline">My profiel</a> |
    <a href="/privacy.html" class="underline">Privaatheidsbeleid</a> |
    <a href="/terms.html" class="underline">Voorwaardes</a> |
    <a href="/faq.html" class="underline">Gereelde vrae</a> |
    <a href="/about.html" class="underline">Oor Kriptiek</a> |
    <a href="/contact.html" class="underline">Kontak ons</a>
  </footer>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, addDoc, getDocs, serverTimestamp,
      query, orderBy, updateDoc, doc, deleteDoc, limit, startAfter,
      getDoc, setDoc, getCountFromServer, increment,
      onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDH-nVvGkdaheH7pvRHH0M9TbW2f98lMGQ",
      authDomain: "kriptiek-c9ea2.firebaseapp.com",
      projectId: "kriptiek-c9ea2",
      storageBucket: "kriptiek-c9ea2.appspot.com",
      messagingSenderId: "620450620939",
      appId: "1:620450620939:web:e93a18ac23b53b33db890e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let currentUser = null;
    onAuthStateChanged(auth, (u) => {
      const wasNull = currentUser === null;
      currentUser = u;
      if (wasNull) loadPosts(true); // refresh when auth resolves
      document.getElementById("new-post").style.display =
        (localStorage.getItem("userRegistered") === "true" && !!currentUser) ? "block" : "none";
    });

    const postsRef = collection(db, "forumPosts");
    const userName = localStorage.getItem("userName") || "Anoniem";
    document.getElementById("userDisplayName").textContent = (localStorage.getItem("userName") || "BESOEKER");

    // ====== Top-25 code REMOVED ======

    const postLimit = 5;
    let lastVisible = null;
    let allLoaded = false;

    // Track rendered posts to avoid duplicates when loadPosts fires more than once
    const renderedIds = new Set();

    // üîî Live watcher state
    let latestDocId = null;
    let liveUnsub = null;

    function relativeTime(date) {
      const now = new Date();
      const seconds = Math.floor((now - date) / 1000);
      const days = Math.floor(seconds / 86400);

      if (days >= 30) {
        const options = { day:'2-digit', month:'long', year:'numeric', hour:'2-digit', minute:'2-digit' };
        return date.toLocaleString('af-ZA', options).replace(',', ' om');
      }
      if (seconds < 60) return "nou";
      const minutes = Math.floor(seconds / 60);
      if (minutes < 60) return minutes === 1 ? "1 minuut gelede" : `${minutes} minute gelede`;
      const hours = Math.floor(minutes / 60);
      if (hours < 24) return `${hours} uur gelede`;
      return days === 1 ? "1 dag gelede" : `${days} dae gelede`;
    }

    function applyFormatting(text) {
      return text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                 .replace(/_(.*?)_/g, '<em>$1</em>')
                 .replace(/\n/g, "<br>");
    }

    async function submitPost() {
      const title = document.getElementById('postTitle').value.trim();
      const content = document.getElementById('postContent').value.trim();
      const msg = document.getElementById('formMsg');
      const btn = document.getElementById('submitBtn');

      if (!title || !content) { msg.textContent = 'Titel en boodskap is verpligtend.'; return; }
      if (!currentUser) { msg.textContent = 'Jy moet aangemeld wees om te plaas.'; return; }

      msg.textContent = '';
      btn.disabled = true;

      try {
        const ref = await addDoc(postsRef, {
          title, content, userName,
          authorId: currentUser.uid,         // required by rules
          timestamp: serverTimestamp()
        });

        // voorkom dat jou eie nuwe plasing die banner laat wys
        latestDocId = ref.id;

        document.getElementById('postTitle').value = '';
        document.getElementById('postContent').value = '';
        document.getElementById('charCount').textContent = '0';
        lastVisible = null;
        loadPosts(true);
        window.scrollTo({ top: 0, behavior: 'smooth' });
      } finally {
        btn.disabled = false;
      }
    }

    async function loadReplies(postId) {
      const repliesBox = document.getElementById(`replies-${postId}`);
      if (!repliesBox) return;
      repliesBox.innerHTML = `<div class="text-gray-400 text-xs">Laai antwoorde‚Ä¶</div>`;
      try {
        const repliesRef = collection(db, "forumPosts", postId, "replies");
        const rs = await getDocs(query(repliesRef, orderBy("createdAt", "asc")));
        if (rs.empty) {
          repliesBox.innerHTML = "";
          return;
        }
        const items = [];
        rs.forEach(r => {
          const rr = r.data();
          items.push(
            `<div class="border-l-4 border-blue-300 pl-2">
               <span class="font-semibold">${(rr.userName || "Anoniem")}</span>: ${applyFormatting(rr.content || "")}
             </div>`
          );
        });
        repliesBox.innerHTML = items.join("");
      } catch (e) {
        repliesBox.innerHTML = `<div class="text-red-500 text-xs">Kon nie antwoorde laai nie.</div>`;
      }
    }

    async function refreshLikeUI(postId) {
      const countEl = document.getElementById(`like-count-${postId}`);
      const btn = document.querySelector(`.like-btn[data-id="${postId}"]`);

      try {
        const likesRef = collection(db, "forumPosts", postId, "likes");
        const agg = await getCountFromServer(likesRef);
        countEl.textContent = agg.data().count;
      } catch {
        const likesRef = collection(db, "forumPosts", postId, "likes");
        const snap = await getDocs(likesRef);
        countEl.textContent = snap.size;
      }

      if (currentUser) {
        const likeRef = doc(db, "forumPosts", postId, "likes", currentUser.uid);
        const likeDoc = await getDoc(likeRef);
        const already = likeDoc.exists();
        btn.disabled = already;
        btn.classList.toggle("opacity-50", already);
        btn.classList.toggle("cursor-not-allowed", already);
        btn.title = already ? "Jy het reeds gestem" : "Stem vir hierdie plasing";
      } else {
        btn.title = "Meld aan om te stem";
      }
    }

    async function loadPosts(reset = false) {
      const container = document.getElementById("forumPosts");
      const searchTerm = document.getElementById("searchInput").value.trim().toLowerCase();
      const loadMoreBtn = document.getElementById("loadMoreBtn");

      if (reset) {
        container.innerHTML = "";
        lastVisible = null;
        allLoaded = false;
        renderedIds.clear();
      }
      if (allLoaded) return;

      let qRef = query(postsRef, orderBy("timestamp", "desc"), limit(postLimit));
      if (lastVisible) qRef = query(postsRef, orderBy("timestamp", "desc"), startAfter(lastVisible), limit(postLimit));
      const snap = await getDocs(qRef);

      // On the very first load, remember current "top" so the banner doesn't flash
      if (reset && !lastVisible && snap.docs.length && latestDocId === null) {
        latestDocId = snap.docs[0].id;
      }

      if (snap.empty) {
        loadMoreBtn.classList.add("hidden");
        allLoaded = true;
        return;
      }

      lastVisible = snap.docs[snap.docs.length - 1];
      loadMoreBtn.classList.remove("hidden");

      snap.forEach(docSnap => {
        if (renderedIds.has(docSnap.id)) return;
        const post = docSnap.data();

        if (searchTerm &&
            !post.title?.toLowerCase().includes(searchTerm) &&
            !post.content?.toLowerCase().includes(searchTerm)) return;

        renderedIds.add(docSnap.id);

        const div = document.createElement("div");
        div.className = "mb-6 p-4 border rounded bg-white shadow";
        const initials = (post.userName || "??").slice(0, 2).toUpperCase();

        let ts = new Date();
        if (post.timestamp?.toDate) ts = post.timestamp.toDate();
        else if (typeof post.timestamp === "string") ts = new Date(post.timestamp);

        const canDelete = (post.authorId && currentUser && post.authorId === currentUser.uid)
                          || (!post.authorId && post.userName === userName);

        div.innerHTML = `
          <div class="flex items-center justify-between mb-2">
            <div class="flex items-center gap-2">
              <div class="w-8 h-8 rounded-full bg-blue-700 text-white text-sm flex items-center justify-center font-bold">${initials}</div>
              <div class="text-xs text-gray-500">${post.userName} ‚Ä¢ ${relativeTime(ts)}</div>
            </div>
            ${canDelete ? `<button class="text-red-500 text-xs delete-btn" data-id="${docSnap.id}">Verwyder</button>` : ""}
          </div>
          <h3 class="text-lg font-bold text-gray-800 mb-1">${post.title || ''}</h3>
          <p class="text-gray-700 whitespace-pre-line mb-2">${applyFormatting(post.content || '')}</p>
          <div class="flex items-center gap-4 text-sm text-gray-600 mb-2">
            <button class="like-btn flex items-center gap-1" data-id="${docSnap.id}">
              üëç <span class="like-count" id="like-count-${docSnap.id}">0</span>
            </button>
            <button class="reply-toggle" data-id="${docSnap.id}">üí¨ Reageer</button>
          </div>
          <div class="reply-box hidden mt-2" id="reply-${docSnap.id}">
            <textarea class="w-full p-2 border rounded mb-1 reply-input" rows="2" maxlength="500" placeholder="Jou antwoord..."></textarea>
            <button class="send-reply bg-blue-600 text-white px-2 py-1 rounded text-sm" data-id="${docSnap.id}">Stuur</button>
          </div>
          <div class="replies text-sm mt-2 space-y-1" id="replies-${docSnap.id}"></div>
        `;
        container.appendChild(div);

        loadReplies(docSnap.id);
        refreshLikeUI(docSnap.id);
      });

      attachPostEvents();
    }

    function attachPostEvents() {
      document.querySelectorAll(".reply-toggle").forEach(btn => {
        btn.onclick = () => {
          const box = document.getElementById("reply-" + btn.dataset.id);
          box.classList.toggle("hidden");
        };
      });

      document.querySelectorAll(".send-reply").forEach(btn => {
        btn.onclick = async () => {
          const id = btn.dataset.id;
          const input = document.querySelector(`#reply-${id} .reply-input`);
          const content = (input.value || "").trim();
          if (!content) return;
          if (!currentUser) {
            alert("Jy moet aangemeld wees om te antwoord.");
            return;
          }

          // 1) Create reply in subcollection
          await addDoc(collection(db, "forumPosts", id, "replies"), {
            authorId: currentUser.uid,      // required by rules
            userName,
            content,
            createdAt: serverTimestamp()
          });

          // 2) Atomically increment replyCount on parent
          try {
            await updateDoc(doc(db, "forumPosts", id), { replyCount: increment(1) });
          } catch (_) {}

          input.value = "";
          loadReplies(id);
        };
      });

      document.querySelectorAll(".like-btn").forEach(btn => {
        btn.onclick = async () => {
          const id = btn.dataset.id;
          if (!currentUser) {
            alert("Meld asseblief aan om te stem.");
            return;
          }
          try {
            const likeRef = doc(db, "forumPosts", id, "likes", currentUser.uid);
            await setDoc(likeRef, { createdAt: serverTimestamp(), userName });
          } finally {
            await refreshLikeUI(id);
          }
        };
      });

      document.querySelectorAll(".delete-btn").forEach(btn => {
        btn.onclick = async () => {
          if (confirm("Is jy seker jy wil hierdie plasing verwyder?")) {
            await deleteDoc(doc(db, "forumPosts", btn.dataset.id));
            loadPosts(true);
          }
        };
      });
    }

    // üîî Start a light real-time watcher that only tracks the newest doc
    function startLiveWatcher() {
      const latestQ = query(postsRef, orderBy("timestamp", "desc"), limit(1));
      liveUnsub = onSnapshot(
        latestQ,
        { includeMetadataChanges: true },
        (snap) => {
          const top = snap.docs[0];
          if (!top) return;
          if (top.metadata.hasPendingWrites) return; // ignore local writes

          const newTopId = top.id;

          // First attach: set the baseline
          if (latestDocId === null) {
            latestDocId = newTopId;
            return;
          }

          // If a new doc arrives at the top and we haven't rendered it yet -> show banner
          if (newTopId !== latestDocId && !renderedIds.has(newTopId)) {
            const b = document.getElementById("liveBanner");
            b.classList.remove("hidden");
          }
        }
      );
    }

    // Clicking the banner loads newest posts and hides the banner
    document.getElementById("liveBanner").addEventListener("click", () => {
      document.getElementById("liveBanner").classList.add("hidden");
      loadPosts(true);
      window.scrollTo({ top: 0, behavior: "smooth" });
    });

    document.getElementById("postContent").addEventListener("input", e => {
      document.getElementById("charCount").textContent = e.target.value.length;
    });

    document.getElementById("submitBtn").addEventListener("click", submitPost);
    document.getElementById("loadMoreBtn").addEventListener("click", () => loadPosts());
    document.getElementById("searchInput").addEventListener("input", () => loadPosts(true));
    document.getElementById("searchInput").value = "";

    // Initial load + start the live watcher
    loadPosts(true);
    startLiveWatcher();
  </script>
  <script>
    const backgroundCrossword = document.getElementById('backgroundCrossword');
    const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
    function getRandomLetter(){ return letters[Math.floor(Math.random()*letters.length)]; }
    function generateBackgroundGrid() {
      backgroundCrossword.innerHTML = '';
      const numRows = Math.ceil(backgroundCrossword.offsetHeight / 30);
      const numCols = Math.ceil(backgroundCrossword.offsetWidth / 30);
      const totalCells = (numRows * numCols) || 300;
      for (let i = 0; i < totalCells; i++) {
        const bgLetterBox = document.createElement('div');
        bgLetterBox.classList.add('bg-letter-box');
        bgLetterBox.textContent = getRandomLetter();
        backgroundCrossword.appendChild(bgLetterBox);
      }
    }
    generateBackgroundGrid();
    window.addEventListener('resize', generateBackgroundGrid);
  </script>
</body>
</html>
