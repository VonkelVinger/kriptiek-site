<!DOCTYPE html>
<html lang="af">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Meld aan – Kriptiek</title>

  <!-- Tailwind & Font -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&display=swap" rel="stylesheet" />

  <style>
    :root { --brand:#1e3a8a; }
    body { font-family: 'Montserrat', sans-serif; }
    /* Crossword logo */
    .logo-grid { display:grid; grid-template-columns: repeat(9, 1fr); gap:4px; }
    .logo-cell {
      width:28px;height:28px;display:flex;align-items:center;justify-content:center;
      background:#0b2459;color:#dbeafe;border-radius:6px;font-weight:700;
      transform: rotateX(0deg); transition: transform .6s;
    }
    .logo-cell.flip { transform: rotateX(180deg); }
    /* Soft background letter grid */
    .bg-letters::before{
      content:"";position:fixed;inset:0;pointer-events:none;opacity:.05;background:
      radial-gradient(circle at 20% 30%, #1e3a8a 0 1px, transparent 2px) 0 0/40px 40px,
      radial-gradient(circle at 80% 70%, #1e3a8a 0 1px, transparent 2px) 20px 20px/40px 40px;
      z-index:0;
    }
  </style>
</head>

<body class="min-h-screen flex flex-col bg-gray-50 bg-letters">

  <!-- Header (matches index.html style) -->
  <header class="sticky top-0 z-10 bg-white/90 backdrop-blur border-b border-gray-100">
    <div class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between">
      <a href="/index.html" class="flex items-center space-x-3 group">
        <div class="logo-grid">
          <!-- K R I P T I E K • -->
          <div class="logo-cell">K</div><div class="logo-cell">R</div><div class="logo-cell">I</div>
          <div class="logo-cell">P</div><div class="logo-cell">T</div><div class="logo-cell">I</div>
          <div class="logo-cell">E</div><div class="logo-cell">K</div><div class="logo-cell flip">•</div>
        </div>
        <span class="text-xl font-extrabold tracking-wide text-[color:var(--brand)]">KRIPTIEK</span>
      </a>
      <nav class="hidden sm:flex items-center gap-4 text-sm">
        <a href="/index.html" class="text-gray-700 hover:text-[color:var(--brand)]">Tuis</a>
        <a href="/dilemmagame.html" class="text-gray-700 hover:text-[color:var(--brand)]">DILEMMA</a>
        <a href="/dilemma-argief.html" class="text-gray-700 hover:text-[color:var(--brand)]">Argief</a>
        <a href="/forum.html" class="text-gray-700 hover:text-[color:var(--brand)]">Gesels saam</a>
        <a id="nav-register" href="/register.html" class="text-gray-700 hover:text-[color:var(--brand)]">Registreer</a>
        <a id="nav-login" href="/login.html" class="text-gray-700 hover:text-[color:var(--brand)]">Meld aan</a>
        <button id="nav-logout" class="hidden text-gray-700 hover:text-red-700">Meld af</button>
      </nav>
    </div>
  </header>

  <!-- Main -->
  <main class="flex-1">
    <div class="max-w-md mx-auto px-4 py-10 relative z-10">
      <div class="bg-white shadow-xl rounded-2xl p-6 border border-gray-100">
        <h1 class="text-2xl font-bold text-center text-[color:var(--brand)] mb-2">Meld aan</h1>
        <p class="text-center text-gray-600 mb-6">Meld aan om te speel en jou vordering te stoor.</p>

        <!-- Alerts -->
        <div id="alertBox" class="hidden mb-4 rounded-lg border px-3 py-2 text-sm"></div>

        <form id="loginForm" class="space-y-4">
          <label class="block">
            <span class="text-gray-700 font-semibold">E-posadres</span>
            <input id="email" type="email" required
                   class="mt-1 block w-full border border-gray-300 rounded-lg p-2.5 focus:outline-none focus:ring-2 focus:ring-[color:var(--brand)]"/>
          </label>

          <label class="block">
            <span class="text-gray-700 font-semibold">Wagwoord</span>
            <div class="mt-1 relative">
              <input id="password" type="password" required
                     class="block w-full border border-gray-300 rounded-lg p-2.5 pr-12 focus:outline-none focus:ring-2 focus:ring-[color:var(--brand)]"/>
              <button type="button" id="togglePw"
                      class="absolute inset-y-0 right-2 my-auto px-2 text-gray-500 hover:text-gray-800 text-sm">
                Wys
              </button>
            </div>
          </label>

          <button id="loginBtn" type="submit"
                  class="w-full bg-gray-900 hover:bg-black text-white py-2.5 rounded-lg transition disabled:opacity-60 disabled:cursor-not-allowed">
            MELD AAN
          </button>

          <div class="flex items-center justify-between text-sm">
            <button type="button" id="forgotBtn" class="text-[color:var(--brand)] hover:underline">
              Wagwoord vergeet?
            </button>
            <a href="/register.html" class="text-gray-700 hover:text-[color:var(--brand)]">
              Geen rekening? <span class="underline">Registreer</span>
            </a>
          </div>
        </form>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="mt-auto bg-white border-t border-gray-100">
    <div class="max-w-5xl mx-auto px-4 py-6 text-sm text-gray-600 flex flex-col sm:flex-row items-center justify-between gap-3">
      <p>&copy; <span id="year"></span> Kriptiek. Alle regte voorbehou.</p>
      <div class="flex items-center gap-4">
        <a href="/index.html#speletjies" class="hover:text-[color:var(--brand)]">Speletjies</a>
        <a href="/privacy.html" class="hover:text-[color:var(--brand)]">Privaatheid</a>
        <a href="/terms.html" class="hover:text-[color:var(--brand)]">Bepalings</a>
      </div>
    </div>
  </footer>

  <!-- Firebase + Auth Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import {
      getAuth,
      signInWithEmailAndPassword,
      onAuthStateChanged,
      setPersistence,
      browserLocalPersistence,
      sendPasswordResetEmail,
      signOut
    } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDH-nVvGkdaheH7pvRHH0M9TbW2f98lMGQ",
      authDomain: "kriptiek-c9ea2.firebaseapp.com",
      projectId: "kriptiek-c9ea2",
      storageBucket: "kriptiek-c9ea2.appspot.com",
      messagingSenderId: "620450620939",
      appId: "1:620450620939:web:e93a18ac23b53b33db890e"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // UI helpers
    const el = (id) => document.getElementById(id);
    const showAlert = (msg, kind = "error") => {
      const box = el("alertBox");
      box.classList.remove("hidden");
      box.textContent = msg;
      box.className = "mb-4 rounded-lg border px-3 py-2 text-sm " +
        (kind === "ok" ? "border-green-300 bg-green-50 text-green-800" : "border-red-300 bg-red-50 text-red-800");
    };

    // Durable sessions
    try { await setPersistence(auth, browserLocalPersistence); } catch (e) { /* ignore */ }

    // Toggle password visibility
    el("togglePw").addEventListener("click", () => {
      const pw = el("password");
      const isPw = pw.type === "password";
      pw.type = isPw ? "text" : "password";
      el("togglePw").textContent = isPw ? "Verberg" : "Wys";
      pw.focus();
    });

    // Auth-state header toggles + early redirect
    const updateHeader = (user) => {
      const reg = el("nav-register"), log = el("nav-login"), out = el("nav-logout");
      if (user) {
        reg?.classList.add("hidden"); log?.classList.add("hidden"); out?.classList.remove("hidden");
      } else {
        reg?.classList.remove("hidden"); log?.classList.remove("hidden"); out?.classList.add("hidden");
      }
    };

    onAuthStateChanged(auth, async (user) => {
      updateHeader(user);
      if (user) {
        // Populate cache from profile and bounce to home
        const uid = user.uid;
        let userName = user.displayName || "";
        let userEmail = user.email || "";

        // Prefer users/{uid}
        const userRef = doc(db, "users", uid);
        const userSnap = await getDoc(userRef);
        if (userSnap.exists()) {
          userName = userSnap.data()?.userName || userName;
          userEmail = userSnap.data()?.email || userEmail;
        } else {
          // Fallback to registrations/{uid}
          const regRef = doc(db, "registrations", uid);
          const regSnap = await getDoc(regRef);
          if (regSnap.exists()) {
            userName = regSnap.data()?.userName || userName;
            userEmail = regSnap.data()?.email || userEmail;
          }
        }

        if (userName) localStorage.setItem("userName", userName);
        localStorage.setItem("userId", uid);
        if (userEmail) localStorage.setItem("userEmail", userEmail);

        window.location.replace("/index.html");
      }
    });

    // Login flow
    el("loginForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      el("alertBox").classList.add("hidden");
      el("loginBtn").disabled = true;

      const email = el("email").value.trim();
      const password = el("password").value;

      try {
        const { user } = await signInWithEmailAndPassword(auth, email, password);

        // Fetch profile -> cache -> merge lastLogin
        const uid = user.uid;
        let userName = user.displayName || "";
        let userEmail = user.email || email;

        const userRef = doc(db, "users", uid);
        const userSnap = await getDoc(userRef);
        if (userSnap.exists()) {
          userName = userSnap.data()?.userName || userName;
          userEmail = userSnap.data()?.email || userEmail;
        } else {
          const regRef = doc(db, "registrations", uid);
          const regSnap = await getDoc(regRef);
          if (regSnap.exists()) {
            userName = regSnap.data()?.userName || userName;
            userEmail = regSnap.data()?.email || userEmail;
          }
        }

        if (userName) localStorage.setItem("userName", userName);
        localStorage.setItem("userId", uid);
        localStorage.setItem("userEmail", userEmail || "");

        // Non-blocking: update users/{uid}
        try { await setDoc(userRef, { userName: userName || null, email: userEmail || null, lastLogin: serverTimestamp() }, { merge: true }); } catch {}

        const redirectUrl = localStorage.getItem("redirectAfterLogin");
        if (redirectUrl) { localStorage.removeItem("redirectAfterLogin"); window.location.href = redirectUrl; }
        else { window.location.href = "/index.html"; }
      } catch (err) {
        console.error(err);
        let msg = "Kon nie aanmeld nie. Kontroleer jou besonderhede.";
        const code = err?.code || "";
        if (code.includes("invalid-credential") || code.includes("wrong-password")) msg = "Verkeerde e-pos of wagwoord.";
        else if (code.includes("user-not-found")) msg = "Geen gebruiker met dié e-pos is gevind nie.";
        else if (code.includes("too-many-requests")) msg = "Te veel pogings. Probeer weer later.";
        showAlert(msg, "error");
      } finally {
        el("loginBtn").disabled = false;
      }
    });

    // Forgot password
    el("forgotBtn").addEventListener("click", async () => {
      const email = el("email").value.trim();
      if (!email) { showAlert("Tik eers jou e-pos in om 'n herstel-skakel te ontvang."); return; }
      try {
        await sendPasswordResetEmail(auth, email);
        showAlert("Herstel-skakel is gestuur. Gaan jou e-pos na.", "ok");
      } catch (err) {
        let msg = "Kon nie herstel-skakel stuur nie.";
        if ((err?.code || "").includes("user-not-found")) msg = "Geen gebruiker met dié e-pos is gevind nie.";
        showAlert(msg);
        console.error(err);
      }
    });

    // Header "Meld af"
    el("nav-logout")?.addEventListener("click", async () => {
      try { await signOut(auth); localStorage.clear(); window.location.href = "/index.html"; } catch (e) {}
    });

    // Footer year
    document.getElementById("year").textContent = new Date().getFullYear();

    // Simple logo animation
    setInterval(() => {
      document.querySelectorAll(".logo-cell").forEach((c, i) => {
        setTimeout(() => c.classList.toggle("flip"), i * 30);
      });
    }, 4000);
  </script>
</body>
</html>
