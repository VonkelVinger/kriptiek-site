<!DOCTYPE html>
<html lang="af">
<head>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-S9V4CMP1FP"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-S9V4CMP1FP');
  </script>

  <!-- AdSense verification -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8199352351586797"
          crossorigin="anonymous"></script>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Profiel â€“ Kriptiek</title>

  <!-- Favicons -->
  <link rel="icon" href="/assets/favicon.ico?v=2" type="image/x-icon" />
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png?v=3">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png?v=3">
  <link rel="apple-touch-icon" href="/assets/apple-touch-icon.png?v=3">
  <link rel="manifest" href="/assets/site.webmanifest?v=3">

  <!-- Fonts & Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700;800;900&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Montserrat', sans-serif; background-color: #f3f4f6; }

    /* --- Header/logo styles --- */
    .logo-container {
      position: relative; display: flex; justify-content: center; align-items: center;
      width: fit-content; margin: 1rem auto; padding: 1rem; border-radius: 1rem;
      background-color: white; overflow: hidden; isolation: isolate;
    }
    .logo-container::before{
      content:""; position:absolute; inset:-2px; border-radius:1rem;
      background:conic-gradient(from 180deg at 50% 50%, #1e3a8a, #334155, #1e3a8a);
      animation:spin 14s linear infinite; z-index:0; padding:2px;
      mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite: xor; mask-composite: exclude;
    }
    @keyframes spin{ to{ transform:rotate(1turn); } }
    @media (prefers-reduced-motion: reduce){ .logo-container::before{ animation:none; } }

    .crossword-grid {
      display: grid; grid-template-columns: repeat(8, minmax(40px, 1fr));
      gap: 4px; position: relative; z-index: 10;
    }
    .letter-box {
      width: 50px; height: 50px; display: flex; justify-content: center; align-items: center;
      background-color: #374151; color: white; font-size: 1.8rem; font-weight: bold;
      border: 2px solid #1f2937; border-radius: 0.375rem;
      text-transform: uppercase; box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.2);
    }
    .flipped-k { transform: scaleX(-1); }

    .background-crossword {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(30px, 1fr));
      grid-template-rows: repeat(auto-fill, minmax(30px, 1fr));
      opacity: 0.5; z-index: 1; pointer-events: none;
      animation: bgFloat 30s linear infinite;
    }
    @keyframes bgFloat{ 0%{ transform:translateY(0); } 50%{ transform:translateY(-12px); } 100%{ transform:translateY(0); } }

    .bg-letter-box {
      display: flex; justify-content: center; align-items: center; font-size: 1.1rem;
      font-weight: bold; color: #9ca3af; border: 1px solid #e5e7eb;
      background-color: transparent; user-select: none;
    }

    /* --- Card + pill styling --- */
    .card { background:#fff; border:1px solid #e5e7eb; border-radius:0.75rem; box-shadow:0 2px 6px rgba(2,6,23,.04); }
    .pill { display:inline-flex; align-items:center; border-radius:999px; padding:.3rem .75rem; font-weight:800; font-size:.85rem; }
    .pill-lg { padding:.45rem .95rem; font-size:1rem; }
    .mono { font-variant-numeric: tabular-nums; font-feature-settings: 'tnum' 1, 'lnum' 1; }
    .mini { background:#f8fafc; border:1px solid #e5e7eb; border-radius:.75rem; padding:.5rem .6rem; text-align:center; }
  </style>
  <!-- Firebase setup -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, sendPasswordResetEmail, deleteUser, updateProfile } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc,
      collection, query, orderBy, limit, getDocs, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDH-nVvGkdaheH7pvRHH0M9TbW2f98lMGQ",
      authDomain: "kriptiek-c9ea2.firebaseapp.com",
      projectId: "kriptiek-c9ea2",
      storageBucket: "kriptiek-c9ea2.appspot.com",
      messagingSenderId: "620450620939",
      appId: "1:620450620939:web:e93a18ac23b53b33db890e"
    };

    const $ = (id) => document.getElementById(id);
    const fmt = (n) => (typeof n === "number" ? n.toLocaleString("af-ZA") : n);
    const toInt = (v) => (typeof v === "number" ? Math.trunc(v) : (v == null ? 0 : Math.trunc(Number(v) || 0)));

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    function setWbName(name){
      const el = $("wbName");
      if (el) el.textContent = (name || "Gebruiker").toUpperCase();
    }

    function getSupporterState(u){
      let active = false, untilTs = null;
      if (u?.supporterActive === true) active = true;
      if (u?.isPaid === true) active = true;
      if (u?.isSupporter === true) active = true;

      const until =
        (u?.supporterUntil?.toMillis && u.supporterUntil.toMillis()) ||
        (typeof u?.supporterUntil === 'number' ? u.supporterUntil :
          (u?.supporterUntil ? Date.parse(u.supporterUntil) : null)) ||
        (typeof u?.paidUntil === 'number' ? u.paidUntil :
          (u?.paidUntil ? Date.parse(u.paidUntil) : null));

      if (Number.isFinite(until) && until > Date.now()) { active = true; untilTs = until; }
      return { active, untilTs };
    }

    function renderSupporterStarIcon(isSupporter){
      return isSupporter === true
        ? '<span class="inline-block ml-1 align-middle text-yellow-400" aria-label="Ondersteuner">â˜…</span>'
        : "";
    }

    function renderProfileNameLine(name, supporterActive){
      const target = $("profileNameLine");
      if (!target) return;

      const safeName = String(name || "Gebruiker")
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;');

      target.innerHTML =
        `<span class="font-black text-slate-900">${safeName}</span>` +
        renderSupporterStarIcon(!!supporterActive);
    }

    function renderSupporterPill(state){
      const el = $("supporterPillTop");
      if(!el) return;

      if(state.active){
        const extra = state.untilTs ? ` â€” tot ${new Date(state.untilTs).toLocaleDateString("af-ZA")}` : "";
        el.textContent = "ONDERSTEUNER: JA" + extra;
        el.style.background = "#dcfce7";
        el.style.color = "#065f46";
        el.style.border = "1px solid #bbf7d0";
        el.classList.add("font-extrabold");
      }else{
        el.textContent = "ONDERSTEUNER: NOG NIE";
        el.style.background = "#fef2f2";
        el.style.color = "#991b1b";
        el.style.border = "1px solid #fecaca";
        el.classList.add("font-extrabold");
      }
    }
    /* === Medaljes (profile summary) === */

    async function loadBlitstiekMedalsFromPlacements(uid){
      const out = { gold: 0, silver: 0, bronze: 0 };
      if (!uid) return out;

      try{
        let gamesSnap = null;
        try{
          gamesSnap = await getDocs(query(
            collection(db, "blitstiekGames"),
            orderBy("createdAt", "desc"),
            limit(400)
          ));
        }catch{
          gamesSnap = await getDocs(query(
            collection(db, "blitstiekGames"),
            limit(400)
          ));
        }

        const reads = [];
        gamesSnap.forEach(g => {
          reads.push(getDoc(doc(db, "blitstiekGames", g.id, "leaderboard", uid)));
        });

        const snaps = await Promise.all(reads);

        snaps.forEach(s => {
          if (!s.exists()) return;
          const p = Number(s.data()?.placementPlace);
          if (p === 1) out.gold++;
          else if (p === 2) out.silver++;
          else if (p === 3) out.bronze++;
        });

      }catch(e){
        console.warn("MEDALS_PLACE_QUERY_FAILED", e);
      }

      return out;
    }

    async function loadDilemmaMedalsFromPlacements(uid){
      const out = { gold: 0, silver: 0, bronze: 0 };
      if (!uid) return out;

      try{
        let gamesSnap = null;
        try{
          gamesSnap = await getDocs(query(
            collection(db, "games"),
            orderBy("createdAt", "desc"),
            limit(400)
          ));
        }catch{
          gamesSnap = await getDocs(query(
            collection(db, "games"),
            limit(400)
          ));
        }

        const reads = [];
        gamesSnap.forEach(g => {
          reads.push(getDoc(doc(db, "games", g.id, "leaderboard", uid)));
        });

        const snaps = await Promise.all(reads);

        snaps.forEach(s => {
          if (!s.exists()) return;
          const p = Number(s.data()?.placementPlace);
          if (p === 1) out.gold++;
          else if (p === 2) out.silver++;
          else if (p === 3) out.bronze++;
        });

      }catch(e){
        console.warn("DILEMMA_MEDALS_PLACE_QUERY_FAILED", e);
      }

      return out;
    }

    function renderDilemmaMedalCounts(derived){
      const line = $("medalsDilLine");
      const breakdown = $("medalsDilBreakdown");
      const empty = $("medalsDilEmpty");

      const gold = toInt(derived?.gold);
      const silver = toInt(derived?.silver);
      const bronze = toInt(derived?.bronze);
      const total = gold + silver + bronze;

      if (line) line.textContent = `Medaljes: ${fmt(total)}`;

      if (total > 0) {
        if (breakdown) {
          breakdown.textContent = `ðŸ¥‡ ${fmt(gold)}  â€¢  ðŸ¥ˆ ${fmt(silver)}  â€¢  ðŸ¥‰ ${fmt(bronze)}`;
          breakdown.classList.remove("hidden");
        }
        if (empty) empty.classList.add("hidden");
      } else {
        if (breakdown) breakdown.classList.add("hidden");
        if (empty) empty.classList.remove("hidden");
      }
    }

    function renderBlitstiekMedalCounts(derived){
      const line = $("medalsBlitLine");
      const breakdown = $("medalsBlitBreakdown");
      const empty = $("medalsBlitEmpty");

      const gold = toInt(derived?.gold);
      const silver = toInt(derived?.silver);
      const bronze = toInt(derived?.bronze);
      const total = gold + silver + bronze;

      if (line) line.textContent = `Medaljes: ${fmt(total)}`;

      if (total > 0) {
        if (breakdown) {
          breakdown.textContent = `ðŸ¥‡ ${fmt(gold)}  â€¢  ðŸ¥ˆ ${fmt(silver)}  â€¢  ðŸ¥‰ ${fmt(bronze)}`;
          breakdown.classList.remove("hidden");
        }
        if (empty) empty.classList.add("hidden");
      } else {
        if (breakdown) breakdown.classList.add("hidden");
        if (empty) empty.classList.remove("hidden");
      }
    }

    async function hydrateProfile(user){
      const nameEl  = $("nameInput");
      const emailEl = $("emailInput");
      if(nameEl)  nameEl.value  = user.displayName || "";
      if(emailEl) emailEl.value = user.email || "";

      // Ensure users doc exists
      const uref = doc(db, "users", user.uid);
      let userDocSnap = await getDoc(uref);
      if (!userDocSnap.exists()) {
        await setDoc(
          uref,
          { userName: user.displayName || "Gebruiker", createdAt: serverTimestamp(), updatedAt: serverTimestamp() },
          { merge: true }
        );
        userDocSnap = await getDoc(uref);
      }
      const userDoc = userDocSnap.data() || {};

      const supporter = getSupporterState(userDoc);
      renderSupporterPill(supporter);

      // Hide "Word â€™n Ondersteuner" if already active
      const cta = document.getElementById("supporterCtaWrap");
      if (cta) cta.style.display = supporter.active ? "none" : "";

      const displayName = user.displayName || userDoc.userName || "Gebruiker";
      setWbName(displayName);
      renderProfileNameLine(displayName, supporter.active);

      // Medals
      const blit = await loadBlitstiekMedalsFromPlacements(user.uid);
      renderBlitstiekMedalCounts(blit);

      const dil = await loadDilemmaMedalsFromPlacements(user.uid);
      renderDilemmaMedalCounts(dil);

      // Supporter banner
      const supporterBanner = document.getElementById("supporterBanner");
      if (supporterBanner) {
        if (supporter.active) {
          supporterBanner.className = "block text-center font-bold rounded-lg p-3 mb-4 bg-green-50 border border-green-200 text-green-800";
          supporterBanner.textContent = "Jy is 'n betalende ondersteuner â€” dankie!";
        } else {
          supporterBanner.className = "block text-center font-bold rounded-lg p-3 mb-4 bg-red-50 border border-red-200 text-red-800";
          supporterBanner.textContent = "Kliek hier om 'n betalende ondersteuner te word";
        }
      }

      if (typeof gtag === 'function') gtag('event','profile_view',{ uid: user.uid });
    }

    function wireProfileForm(user){
      const form = $("profileForm");
      const resetBtn = $("resetPwBtn");
      const delBtn = $("deleteBtn");

      if(form){
        form.addEventListener("submit", async (e)=>{
          e.preventDefault();
          try{
            const newName = ($("nameInput").value||"").trim().slice(0,40);
            if(newName && newName !== (user.displayName||"")){
              await updateProfile(user, { displayName: newName });
              await updateDoc(doc(db,"users",user.uid), { userName: newName, updatedAt: serverTimestamp() });
              alert("Profiel gestoor.");
            } else {
              alert("Geen veranderinge om te stoor nie.");
            }
          }catch(err){ console.error(err); alert("Kon nie jou profiel opdateer nie."); }
        });
      }

      if(resetBtn){
        resetBtn.addEventListener("click", async ()=>{
          try{
            await sendPasswordResetEmail(auth, auth.currentUser.email);
            alert("â€™n Wagwoordherstel-skakel is per e-pos gestuur.");
          }catch(err){ console.error(err); alert("Kon nie wagwoordherstel stuur nie."); }
        });
      }

      if(delBtn){
        delBtn.addEventListener("click", async ()=>{
          if(!confirm("Is jy seker? Jou rekening sal verwyder word.")) return;
          try{
            await deleteUser(auth.currentUser);
            alert("Rekening verwyder.");
            window.location.href = "/";
          }catch(err){
            console.error(err);
            alert(String(err.code||"").includes("requires-recent-login")
              ? "Meld asseblief weer aan en probeer dan weer."
              : "Kon nie jou rekening verwyder nie.");
          }
        });
      }
    }

    // ---- Auth gate + bootstrap ----
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        const ret = encodeURIComponent("/profile.html");
        window.location.href = `/login.html?return=${ret}`;
        return;
      }
      try{
        await hydrateProfile(user);
        wireProfileForm(user);
      }catch(e){
        console.error(e);
      }
    });
  </script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">
  <!-- Header -->
  <header class="bg-white shadow p-4">
    <div class="logo-container">
      <div id="backgroundCrossword" class="background-crossword"></div>
      <div class="crossword-grid">
        <div class="letter-box flipped-k">K</div>
        <div class="letter-box flipped-k">R</div>
        <div class="letter-box">I</div>
        <div class="letter-box flipped-k">P</div>
        <div class="letter-box">T</div>
        <div class="letter-box">I</div>
        <div class="letter-box flipped-k">E</div>
        <div class="letter-box">K</div>
      </div>
    </div>
  </header>

  <div class="max-w-6xl mx-auto px-4 pt-2 text-center text-2xl font-bold text-[#1e3a8a]">
    WELKOM TERUG, <span id="wbName">GEBRUIKER</span>
  </div>

  <main class="flex-grow p-4 pb-16">
    <div class="max-w-6xl mx-auto flex flex-col gap-6 items-stretch">

      <!-- PROFILE CARD -->
      <section class="card p-5 md:p-6">
        <a id="supporterBanner" href="https://buymeacoffee.com/kriptiek" target="_blank" rel="noopener"
           class="block text-center font-bold rounded-lg p-3 mb-4 bg-red-50 border border-red-200 text-red-800">
          Kliek hier om 'n betalende ondersteuner te word
        </a>

        <h2 class="text-lg font-bold mb-1">Profiel</h2>
        <div id="profileNameLine" class="flex flex-wrap items-center gap-1 mb-3 text-base"></div>

        <form id="profileForm" class="space-y-4" novalidate>
          <div>
            <label for="nameInput" class="block text-sm font-semibold text-gray-700">Naam (kan â€™n skuilnaam wees)</label>
            <input id="nameInput" type="text" minlength="2" maxlength="40" required class="mt-1 w-full border border-gray-300 rounded p-2" value="Speler"/>
          </div>

          <div>
            <label for="emailInput" class="block text-sm font-semibold text-gray-700">E-posadres</label>
            <input id="emailInput" type="email" required class="mt-1 w-full border border-gray-300 rounded p-2" value="speler@example.com" disabled/>
            <p class="text-xs text-slate-500 mt-1">Jou e-pos kan nie hier verander word nie.</p>
          </div>

          <div class="flex flex-wrap items-center gap-2">
            <button type="submit" class="px-4 py-2 rounded-xl bg-blue-900 text-white font-bold">BÃŠRE</button>
            <button id="resetPwBtn" type="button" class="px-4 py-2 rounded-xl bg-slate-800 text-white font-bold">VRA NUWE WAGWOORD</button>
            <button id="deleteBtn" type="button" class="px-4 py-2 rounded-xl bg-red-700 text-white font-bold">VERWYDER MY REKENING</button>

            <!-- Supporter pill moved next to delete -->
            <span id="supporterPillTop" class="pill pill-lg rounded-xl"
                  style="background:#f1f5f9;color:#0f172a;border:1px solid #e2e8f0">
              ONDERSTEUNER: â€”
            </span>
          </div>
        </form>
      </section>

      <!-- MEDALJES -->
      <section class="card p-5 md:p-6">
        <header class="flex flex-col gap-1 mb-3">
          <div class="h-1 w-full bg-yellow-400 rounded-full"></div>
          <h2 class="text-xl font-extrabold text-slate-900">MEDALJES</h2>
        </header>

        <p class="text-sm text-slate-700 mb-3">
          â€™n Ondersteuner-ster (â˜…) wys langs jou naam as jy â€™n betalende Ondersteuner is.
          Die syfers onder wys jou getal en soort medaljes per speletjie.
        </p>

        <!-- Only visible if NOT supporter -->
        <div id="supporterCtaWrap">
          <a href="https://buymeacoffee.com/kriptiek" target="_blank" rel="noopener"
             class="inline-flex items-center px-4 py-2 rounded-xl bg-yellow-500 hover:bg-yellow-600 text-white font-bold mb-4">
            Word â€™n Ondersteuner
          </a>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <div class="mini">
            <div class="text-xs uppercase tracking-wide text-slate-500 font-extrabold">Dilemma</div>
            <div id="medalsDilLine" class="mt-1 text-lg font-extrabold text-slate-900">Medaljes: 0</div>
            <div id="medalsDilBreakdown" class="hidden text-sm font-bold text-slate-700 mt-1">ðŸ¥‡ 0  â€¢  ðŸ¥ˆ 0  â€¢  ðŸ¥‰ 0</div>
            <div id="medalsDilEmpty" class="text-sm text-slate-500 mt-1">Kom binnekort</div>
          </div>

          <div class="mini">
            <div class="text-xs uppercase tracking-wide text-slate-500 font-extrabold">Blitstiek</div>
            <div id="medalsBlitLine" class="mt-1 text-lg font-extrabold text-slate-900">Medaljes: 0</div>
            <div id="medalsBlitBreakdown" class="hidden text-sm font-bold text-slate-700 mt-1">ðŸ¥‡ 0  â€¢  ðŸ¥ˆ 0  â€¢  ðŸ¥‰ 0</div>
            <div id="medalsBlitEmpty" class="text-sm text-slate-500 mt-1">Nog geen medaljes in Blitstiek nie</div>
          </div>

          <div class="mini">
            <div class="text-xs uppercase tracking-wide text-slate-500 font-extrabold">Slimstiek</div>
            <div class="mt-1 text-lg font-extrabold text-slate-900">Medaljes: BINNEKORT</div>
            <div class="text-sm text-slate-500 mt-1">Kom binnekort</div>
          </div>
        </div>
      </section>

      <!-- HOE DIE MEDALJES WERK -->
      <section class="card p-5 md:p-6">
        <header class="flex flex-col gap-1 mb-3">
          <div class="h-1 w-full bg-slate-300 rounded-full"></div>
          <h2 class="text-xl font-extrabold text-slate-900">HOE MEDALJES WERK</h2>
        </header>

        <div class="text-sm text-slate-700 space-y-2 leading-relaxed">
          <p><strong>DILEMMA:</strong> Medaljes word om <strong>23:55</strong> elke dag toegeken op grond van jou <strong>aantal raaiskote</strong>:</p>
            <strong>ðŸ¥‡ vir 1</strong>, <strong>ðŸ¥ˆ vir 2</strong>, <strong>ðŸ¥‰ 3 vir </strong>.
          </p>
          <p><strong>BLITSTIEK:</strong> Medaljes word om <strong>23:55</strong> toegeken op grond van die dag se <strong>beste tye</strong> op die ranglys.</p>
          <p><strong>SLIMSTIEK:</strong> Kom binnekort.</p>
        </div>
      </section>

    </div>
  </main>

  <footer class="bg-white shadow p-4 text-center text-sm text-gray-500">
    &copy; 2025 Kriptiek. Alle regte voorbehou. |
    <a href="/index.html" class="underline">Tuis</a> |
    <a href="/forum.html" class="underline">Gesels saam</a> |
    <a href="/privacy.html" class="underline">Privaatheidsbeleid</a> |
    <a href="/terms.html" class="underline">Voorwaardes</a> |
    <a href="/faq.html" class="underline">Gereelde vrae</a> |
    <a href="/about.html" class="underline">Oor Kriptiek</a> |
    <a href="/contact.html" class="underline">Kontak ons</a>
  </footer>

  <!-- Background crossword init -->
  <script>
    document.addEventListener('DOMContentLoaded', function(){
      const bg = document.getElementById('backgroundCrossword'); if(!bg)return;
      const letters='ABCDEFGHIJKLMNOPQRSTUVWXYZ';
      const rand=()=>letters[Math.floor(Math.random()*letters.length)];
      function regen(){
        bg.innerHTML='';
        const rows=Math.ceil(bg.offsetHeight/30);
        const cols=Math.ceil(bg.offsetWidth/30);
        const total=(rows*cols)||300;
        for(let i=0;i<total;i++){
          const d=document.createElement('div');
          d.className='bg-letter-box';
          d.textContent=rand();
          bg.appendChild(d);
        }
      }
      regen(); window.addEventListener('resize', regen);
    });
  </script>

</body>
</html>


  
