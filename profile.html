<!DOCTYPE html>
<html lang="af">
<head>

<!-- GA4 -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-S9V4CMP1FP"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-S9V4CMP1FP');
</script>

<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>My Profiel – Kriptiek</title>

<!-- Favicons -->
<link rel="icon" href="/assets/favicon.ico?v=2" type="image/x-icon" />
<link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png?v=3">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png?v=3">
<link rel="apple-touch-icon" href="/assets/apple-touch-icon.png?v=3">
<link rel="manifest" href="/assets/site.webmanifest?v=3">

<!-- Tailwind & Fonts -->
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700;800;900&display=swap" rel="stylesheet">

<style>
  body { font-family: 'Montserrat', sans-serif; background-color: #f3f4f6; }
  .logo-container { position:relative; display:flex; justify-content:center; align-items:center; width:fit-content; margin:1rem auto; padding:1rem; border-radius:1rem; background:#fff; overflow:hidden; isolation:isolate; }
  .logo-container::before{ content:""; position:absolute; inset:-2px; border-radius:1rem; background:conic-gradient(from 180deg at 50% 50%, #1e3a8a, #334155, #1e3a8a); animation:spin 14s linear infinite; z-index:0; padding:2px; mask:linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0); -webkit-mask-composite:xor; mask-composite:exclude; }
  @keyframes spin{ to{ transform:rotate(1turn); } }
  @media (prefers-reduced-motion: reduce){ .logo-container::before{ animation:none; } }
  .crossword-grid{ display:grid; grid-template-columns:repeat(8, minmax(40px,1fr)); gap:4px; position:relative; z-index:10; }
  .letter-box{ width:50px; height:50px; display:flex; justify-content:center; align-items:center; background:#374151; color:#fff; font-size:1.8rem; font-weight:bold; border:2px solid #1f2937; border-radius:.375rem; text-transform:uppercase; }
  .flipped-k{ transform:scaleX(-1); }
  .background-crossword{ position:absolute; top:0; left:0; width:100%; height:100%; display:grid; grid-template-columns:repeat(auto-fill,minmax(30px,1fr)); grid-template-rows:repeat(auto-fill,minmax(30px,1fr)); opacity:.5; z-index:1; pointer-events:none; animation:bgFloat 30s linear infinite; }
  @keyframes bgFloat{ 0%{ transform:translateY(0);} 50%{ transform:translateY(-12px);} 100%{ transform:translateY(0);} }
  .bg-letter-box{ display:flex; justify-content:center; align-items:center; font-size:1.1rem; font-weight:bold; color:#9ca3af; border:1px solid #e5e7eb; background:transparent; user-select:none; }

  .card{ background:#fff; border:1px solid #e5e7eb; border-radius:.75rem; box-shadow:0 2px 6px rgba(2,6,23,.04); }
  .pill{ display:inline-flex; align-items:center; border-radius:999px; padding:.35rem .9rem; font-weight:800; font-size:.9rem; }
  .pill-lg{ padding:.45rem .95rem; font-size:1rem; }
  .pill-blue{ background:#e0e7ff; color:#1e3a8a; }
  .pill-orange{ background:#fff1e6; color:#c2410c; }
  .pill-green{ background:#e8fff3; color:#065f46; }
  .pill-green-dark{ background:#e6fffb; color:#115e59; }
  .mono{ font-variant-numeric: tabular-nums; font-feature-settings:'tnum' 1,'lnum' 1; }
</style>

<!-- Feature toggles (Option B) -->
<script>
  const FEATURES = { blitstiek: true, slimstiek: false };
  function applyFeatureToggles(){
    const known = new Set(Object.keys(FEATURES));
    document.querySelectorAll('[data-section]').forEach(el=>{
      const key = el.getAttribute('data-section');
      if(!known.has(key)) return;
      const on = !!FEATURES[key];
      el.style.display = on ? '' : 'none';
      el.setAttribute('aria-hidden', on ? 'false' : 'true');
    });
  }
  document.addEventListener('DOMContentLoaded', applyFeatureToggles);
</script>

<!-- Firebase -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, sendPasswordResetEmail, deleteUser, updateProfile } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
  import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

  const app = initializeApp({
    apiKey:"AIzaSyDH-nVvGkdaheH7pvRHH0M9TbW2f98lMGQ",
    authDomain:"kriptiek-c9ea2.firebaseapp.com",
    projectId:"kriptiek-c9ea2",
    storageBucket:"kriptiek-c9ea2.appspot.com",
    messagingSenderId:"620450620939",
    appId:"1:620450620939:web:e93a18ac23b53b33db890e"
  });
  const auth = getAuth(app);
  const db   = getFirestore(app);

  // --- tiny DOM helpers (avoid null crashes)
  const $ = id => document.getElementById(id);
  const setText = (id, v) => { const el=$(id); if(el) el.textContent = v; };

  // --- supporter banner/pill
  function setSupporterPill(active, extra=""){
    const el = $('supporterPill');
    if(!el) return;
    if(active){
      el.textContent = "ONDERSTEUNER: AKTIEF" + (extra?` — ${extra}`:"");
      el.style.background = "#dcfce7"; el.style.color="#065f46"; el.style.border="1px solid #bbf7d0";
    }else{
      el.textContent = "ONDERSTEUNER: NIE AKTIEF NIE";
      el.style.background = "#fef2f2"; el.style.color="#991b1b"; el.style.border="1px solid #fecaca";
    }
    el.classList.add("font-extrabold");
  }
  function showSupporterBanner(show){ const b=$('supporterBanner'); if(b) b.style.display = show ? '' : 'none'; }

  // Accept multiple field shapes for supporter status
  function isSupporter(u){
    const now = Date.now();
    const paidUntil =
      (u?.paidUntil?.seconds ? u.paidUntil.seconds*1000 :
       typeof u?.paidUntil === 'number' ? u.paidUntil :
       (u?.supporterUntil?.seconds ? u.supporterUntil.seconds*1000 :
        typeof u?.supporterUntil === 'number' ? u.supporterUntil : null));
    return Boolean(
      u?.isPaid === true ||
      u?.isSupporter === true ||
      u?.supporter === true ||
      u?.roles?.supporter === true ||
      (paidUntil && paidUntil > now)
    );
  }

  function renderSupporter(u){
    let extra = "";
    const now = Date.now();
    const until =
      (u?.paidUntil?.seconds ? u.paidUntil.seconds*1000 :
       typeof u?.paidUntil === 'number' ? u.paidUntil :
       (u?.supporterUntil?.seconds ? u.supporterUntil.seconds*1000 :
        typeof u?.supporterUntil === 'number' ? u.supporterUntil : null));
    if(until && until > now) extra = `tot ${new Date(until).toLocaleDateString("af-ZA")}`;

    const active = isSupporter(u);
    setSupporterPill(active, extra);
    showSupporterBanner(!active);
  }

  function renderTotals(u){
    const kD = u?.kDilemma_total ?? 0;
    const kB = u?.kBlit_total ?? 0;
    setText("dilOverallScore", kD);
    setText("blitOverallScore", kB);
    setText("pillDilemmaLive", `JOU DILEMMA-TELLING: ${kD}`);
    setText("pillBlitLive", `JOU BLITSTIEK-TELLING: ${kB}`);
    if(u?.kScore !== undefined) setText("pillOverall", `JOU KRIPTIEK-TELLING: ${u.kScore}`);
  }

  function renderWelcome(user){
    const name = (user?.displayName || '').trim();
    setText('welcomeLine', name ? `WELKOM TERUG, ${name.toUpperCase()}` : 'WELKOM TERUG!');
  }

  // Profile form wiring (safe/minimal)
  function wireProfileForm(user){
    const form = $('profileForm'), resetBtn = $('resetPwBtn'), delBtn=$('deleteBtn'), nameInput=$('nameInput');
    if(form){
      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        try{
          const newName = (nameInput?.value||'').trim();
          if(newName && newName.length>=2){
            await updateProfile(user, { displayName:newName });
            renderWelcome(user);
            alert('Jou naam is opgedateer.');
          }
        }catch(err){ console.error(err); alert('Kon nie jou naam opdateer nie.'); }
      });
    }
    if(resetBtn){
      resetBtn.addEventListener('click', async ()=>{
        try{ await sendPasswordResetEmail(auth, user.email); alert('Skakel om jou wagwoord te herstel is na jou e-pos gestuur.'); }
        catch(err){ console.error(err); alert('Kon nie wagwoord-epos stuur nie.'); }
      });
    }
    if(delBtn){
      delBtn.addEventListener('click', async ()=>{
        if(!confirm("Is jy seker jy wil jou rekening permanent verwyder?")) return;
        try{ await deleteUser(user); alert('Jou rekening is verwyder.'); window.location.href='/'; }
        catch(err){ console.error(err); alert('Kon nie rekening verwyder nie. Meld asseblief weer aan en probeer weer.'); }
      });
    }
  }

  async function readUserDoc(uid){
    const snap = await getDoc(doc(db,'users',uid));
    return snap.exists() ? snap.data() : null;
  }

  onAuthStateChanged(auth, async (user)=>{
    if(!user) return;
    // Prefill basics
    renderWelcome(user);
    if($('nameInput')) $('nameInput').value = user.displayName || '';
    if($('emailInput')) $('emailInput').value = user.email || '';

    try{
      const u = await readUserDoc(user.uid);
      if(u){
        renderTotals(u);
        renderSupporter(u);
        // Today cards: show '—' until we add daily fields (kept simple)
        setText("totalPoints", "—"); setText("calcTime", "—");
        const t = (u.blit_todayPoints !== undefined) ? u.blit_todayPoints : null;
        setText("totalPointsBlit", t===null ? "—" : String(t));
        setText("calcTimeBlit", "—");
        setText("totalPointsSlim", "—"); setText("calcTimeSlim", "—");
      }else{
        renderSupporter({});
      }
    }catch(err){ console.error(err); }
    // GA4
    if(typeof gtag==='function'){ gtag('event','profile_view',{uid:user.uid}); }
  });
</script>
</head>

<body class="bg-gray-100 min-h-screen flex flex-col">
  <!-- Header -->
  <header class="bg-white shadow p-4">
    <div class="logo-container">
      <div id="backgroundCrossword" class="background-crossword"></div>
      <div class="crossword-grid">
        <div class="letter-box flipped-k">K</div><div class="letter-box flipped-k">R</div>
        <div class="letter-box">I</div><div class="letter-box flipped-k">P</div>
        <div class="letter-box">T</div><div class="letter-box">I</div>
        <div class="letter-box flipped-k">E</div><div class="letter-box">K</div>
      </div>
    </div>
    <h1 id="welcomeLine" class="text-center text-xl md:text-2xl font-extrabold text-blue-900 tracking-tight mt-2"></h1>
  </header>

  <main class="flex-grow p-4 pb-16">
    <div class="max-w-6xl mx-auto flex flex-col gap-6 items-stretch">

      <!-- PROFILE CARD -->
      <section class="card p-5 md:p-6">
        <a id="supporterBanner" href="https://buymeacoffee.com/kriptiek" target="_blank" rel="noopener"
           class="block text-center font-bold rounded-lg p-3 mb-4 bg-red-50 border border-red-200 text-red-800">
          Kliek hier om 'n betalende ondersteuner te word
        </a>

        <h2 class="text-lg font-bold mb-2">Profiel</h2>

        <form id="profileForm" class="space-y-4" novalidate>
          <div>
            <label for="nameInput" class="block text-sm font-semibold text-gray-700">Naam (kan ’n skuilnaam wees)</label>
            <input id="nameInput" type="text" minlength="2" maxlength="40" required class="mt-1 w-full border border-gray-300 rounded p-2"/>
          </div>
          <div>
            <label for="emailInput" class="block text-sm font-semibold text-gray-700">E-posadres</label>
            <input id="emailInput" type="email" disabled class="mt-1 w-full border border-gray-300 rounded p-2"/>
            <p class="text-xs text-slate-500 mt-1">Jou e-pos kan nie hier verander word nie.</p>
          </div>

          <div class="flex flex-wrap items-center gap-2">
            <button type="submit" class="px-4 py-2 rounded-xl bg-blue-900 text-white font-bold">BÊRE</button>
            <button id="resetPwBtn" type="button" class="px-4 py-2 rounded-xl bg-slate-800 text-white font-bold">VRA NUWE WAGWOORD</button>
            <button id="deleteBtn" type="button" class="px-4 py-2 rounded-xl bg-red-700 text-white font-bold">VERWYDER MY REKENING</button>
          </div>
        </form>
      </section>

      <!-- OVERVIEW -->
      <section class="card p-5 md:p-6">
        <div class="mb-2">
          <span id="supporterPill" class="pill pill-lg" style="background:#f1f5f9;color:#0f172a;border:1px solid #e2e8f0">ONDERSTEUNER: NIE AKTIEF NIE</span>
        </div>
        <div class="mb-4">
          <span id="pillOverall" class="pill pill-lg pill-blue">JOU KRIPTIEK-TELLING: 0</span>
        </div>
        <div class="flex flex-wrap gap-2 mb-4 items-start">
          <span id="pillDilemmaLive" class="pill pill-lg pill-orange">JOU DILEMMA-TELLING: 0</span>
          <span id="pillBlitLive" class="pill pill-lg pill-green">JOU BLITSTIEK-TELLING: 0</span>
          <span class="pill pill-lg pill-green-dark">JOU SLIMSTIEK-TELLING: BINNEKORT</span>
        </div>
        <p class="text-sm text-slate-600">
          Jou Kriptiek-telling is die som van jou <strong>Dilemma</strong>- en <strong>Blitstiek</strong>-tellings (Slimstiek volg later).
        </p>
      </section>

      <!-- DILEMMA -->
      <section class="card p-5 md:p-6" data-section="dilemma">
        <header class="flex flex-col gap-1 mb-3">
          <div class="h-1 w-full bg-orange-500 rounded-full"></div>
          <h2 class="text-xl font-extrabold text-slate-900">DILEMMA</h2>
        </header>

        <div class="rounded-xl border border-slate-200 bg-white p-4 mb-3">
          <div class="flex items-end justify-between">
            <div>
              <div id="dilOverallScore" class="text-6xl font-black mono text-slate-900 tracking-tight">0</div>
              <div class="text-xs uppercase tracking-wide text-slate-500">Algeheel (totaal)</div>
            </div>
            <div class="text-right">
              <div class="text-xs text-slate-500">Laas opgedateer</div>
              <div id="dilOverallUpdated" class="text-sm mono">—</div>
            </div>
          </div>
        </div>

        <div class="rounded-xl border border-orange-200 bg-orange-50 p-4 mb-4">
          <div class="flex items-end justify-between">
            <div>
              <div id="totalPoints" class="text-4xl font-extrabold mono text-orange-900">—</div>
              <div class="text-xs uppercase tracking-wide text-orange-900/70">Vandag</div>
            </div>
            <div class="text-right">
              <div class="text-xs text-orange-900/70">Laas bereken</div>
              <div id="calcTime" class="text-sm mono">—</div>
            </div>
          </div>
        </div>
      </section>

      <!-- BLITSTIEK -->
      <section class="card p-5 md:p-6" data-section="blitstiek">
        <header class="flex flex-col gap-1 mb-3">
          <div class="h-1 w-full bg-emerald-500 rounded-full"></div>
          <h2 class="text-xl font-extrabold text-slate-900">BLITSTIEK</h2>
        </header>

        <div class="rounded-xl border border-slate-200 bg-white p-4 mb-3">
          <div class="flex items-end justify-between">
            <div>
              <div id="blitOverallScore" class="text-6xl font-black mono text-slate-900 tracking-tight">0</div>
              <div class="text-xs uppercase tracking-wide text-slate-500">Algeheel (totaal)</div>
            </div>
            <div class="text-right">
              <div class="text-xs text-slate-500">Laas opgedateer</div>
              <div id="blitOverallUpdated" class="text-sm mono">—</div>
            </div>
          </div>
        </div>

        <div class="rounded-xl border border-emerald-200 bg-emerald-50 p-4 mb-3">
          <div class="flex items-end justify-between">
            <div>
              <div id="totalPointsBlit" class="text-4xl font-extrabold mono text-emerald-900">—</div>
              <div class="text-xs uppercase tracking-wide text-emerald-900/70">Vandag</div>
            </div>
            <div class="text-right">
              <div class="text-xs text-emerald-900/70">Laas bereken</div>
              <div id="calcTimeBlit" class="text-sm mono">—</div>
            </div>
          </div>
        </div>

        <!-- Rules -->
        <div class="rounded-xl bg-gray-50 p-4 border border-gray-200 mt-3">
          <h3 class="font-semibold text-gray-800 mb-2">Blitstiek – Telling & Ranglys</h3>
          <ul class="list-disc list-inside text-gray-700 space-y-1">
            <li>Die ranglys wys nooit meer as die dag se <strong>10 beste tye</strong> nie. Jou naam verskyn net een keer; ’n beter tyd vervang ’n swakker tyd.</li>
            <li>Jy kry <strong>onmiddellik 100 bonuspunte</strong> as jy Blitstiek in <strong>onder 60 sekondes</strong> wen.</li>
            <li>Verder kry jy <strong>plaas-punte</strong> om 23:55 volgens jou finale plek op die dag-ranglys (1–10 = 200, 175, 150, 125, 100, 75, 50, 40, 30, 20).</li>
            <li><strong>Geen</strong> ekstra punte meer vir vroeg speel of eerste op die bord nie.</li>
            <li>Betalende ondersteuners kry ’n <strong>10% bonus</strong> op die dag se plek-punte.</li>
            <li>Daar is <strong>geen daaglikse maksimum</strong> meer op Blitstiek-punte nie.</li>
          </ul>
        </div>
      </section>

      <!-- SLIMSTIEK (hidden for now) -->
      <section class="card p-5 md:p-6" data-section="slimstiek" aria-hidden="true" style="display:none">
        <header class="flex flex-col gap-1 mb-3">
          <div class="h-1 w-full bg-teal-500 rounded-full"></div>
          <h2 class="text-xl font-extrabold text-slate-900">SLIMSTIEK</h2>
        </header>

        <div class="rounded-xl border border-slate-200 bg-white p-4 mb-3">
          <div class="flex items-end justify-between">
            <div>
              <div id="slimOverallScore" class="text-6xl font-black mono text-slate-900 tracking-tight">0</div>
              <div class="text-xs uppercase tracking-wide text-slate-500">Algeheel (totaal)</div>
            </div>
            <div class="text-right">
              <div class="text-xs text-slate-500">Laas opgedateer</div>
              <div id="slimOverallUpdated" class="text-sm mono">—</div>
            </div>
          </div>
        </div>

        <div class="rounded-xl border border-teal-200 bg-teal-50 p-4 mb-4">
          <div class="flex items-end justify-between">
            <div>
              <div id="totalPointsSlim" class="text-4xl font-extrabold mono text-teal-900">—</div>
              <div class="text-xs uppercase tracking-wide text-teal-900/70">Vandag</div>
            </div>
            <div class="text-right">
              <div class="text-xs text-teal-900/70">Laas bereken</div>
              <div id="calcTimeSlim" class="text-sm mono">—</div>
            </div>
          </div>
        </div>
      </section>

    </div>
  </main>

  <footer class="bg-white shadow p-4 text-center text-sm text-gray-500">
    &copy; 2025 Kriptiek. Alle regte voorbehou. |
    <a href="/profile.html" class="underline">My profiel</a> |
    <a href="/forum.html" class="underline">Gesels saam</a> |
    <a href="/privacy.html" class="underline">Privaatheidsbeleid</a> |
    <a href="/terms.html" class="underline">Voorwaardes</a> |
    <a href="/faq.html" class="underline">Gereelde vrae</a> |
    <a href="/about.html" class="underline">Oor Kriptiek</a> |
    <a href="/contact.html" class="underline">Kontak ons</a>
  </footer>

  <!-- Background crossword init -->
  <script>
    document.addEventListener('DOMContentLoaded', function(){
      const bg = document.getElementById('backgroundCrossword'); if(!bg)return;
      const letters='ABCDEFGHIJKLMNOPQRSTUVWXYZ';
      const rand=()=>letters[Math.floor(Math.random()*letters.length)];
      function regen(){
        bg.innerHTML='';
        const rows=Math.ceil(bg.offsetHeight/30), cols=Math.ceil(bg.offsetWidth/30);
        const total=(rows*cols)||300;
        for(let i=0;i<total;i++){ const d=document.createElement('div'); d.className='bg-letter-box'; d.textContent=rand(); bg.appendChild(d); }
      }
      regen(); window.addEventListener('resize', regen);
    });
  </script>

</body>
</html>
