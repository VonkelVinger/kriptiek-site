<!DOCTYPE html>
<html lang="af">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-S9V4CMP1FP"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-S9V4CMP1FP');
  </script>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>SLIMSTIEK ADMIN – Kriptiek</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body{font-family:'Montserrat',sans-serif}
    input,button{outline:none}
  </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen">

  <header class="bg-slate-900 text-white py-4">
    <h1 class="text-center text-2xl font-bold">SLIMSTIEK – ADMIN</h1>
  </header>

  <main class="max-w-lg mx-auto p-6">
    <p class="mb-4 text-sm text-slate-600">Gebruik hierdie paneel om die volgende dag se teikenwoord vir Slimstiek en Blitstiek te stel.</p>

    <label class="block mb-2 font-semibold text-slate-700">Datum (YYYY-MM-DD):</label>
    <input id="dateInput" type="date" class="w-full border border-slate-300 rounded-xl px-3 py-2 mb-4">

    <label class="block mb-2 font-semibold text-slate-700">Nuwe teikenwoord:</label>
    <input id="targetInput" type="text" maxlength="12" class="w-full border border-slate-300 rounded-xl px-3 py-2 uppercase mb-4" placeholder="bv. WOORD">

    <div class="flex gap-2">
      <button id="saveSlimstiek" class="flex-1 bg-blue-700 hover:bg-blue-800 text-white font-semibold py-2 rounded-xl">Stel vir Slimstiek</button>
      <button id="saveBoth" class="flex-1 bg-green-700 hover:bg-green-800 text-white font-semibold py-2 rounded-xl">Stel vir Beide</button>
    </div>

    <p id="status" class="mt-4 text-sm text-slate-700"></p>
  </main>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // Uses the global config already present on Kriptiek pages
    const app = initializeApp(window.firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    const statusEl = document.getElementById('status');
    const dateInput = document.getElementById('dateInput');
    const targetInput = document.getElementById('targetInput');
    const saveSlimstiek = document.getElementById('saveSlimstiek');
    const saveBoth = document.getElementById('saveBoth');

    // default date = tomorrow in ZA
    const tz = 'Africa/Johannesburg';
    const now = new Date();
    const tomorrow = new Date(now.getTime() + 24*60*60*1000);
    dateInput.value = new Intl.DateTimeFormat('en-CA',{timeZone:tz,year:'numeric',month:'2-digit',day:'2-digit'}).format(tomorrow);

    function ok(msg){ statusEl.textContent = msg; statusEl.className = "mt-4 text-green-700 font-semibold"; }
    function err(msg){ statusEl.textContent = msg; statusEl.className = "mt-4 text-red-700 font-semibold"; }

    // Write legacy daily_words to avoid any TUTS fallback
    async function writeDailyWords(dateStr, word, forBoth){
      const ref = doc(db,"daily_words", dateStr);
      const payload = {
        slimstiek: word,
        updatedAt: serverTimestamp(),
        source: "slimstiek-admin v2025-10-24"
      };
      if (forBoth) payload.blitstiek = word;
      await setDoc(ref, payload, { merge: true });
    }

    // Single canonical writer that fills ALL common field names
    function wordPayload(word){
      return {
        // canonical
        target: word,
        word: word,
        status: "active",
        updatedAt: serverTimestamp(),
        source: "slimstiek-admin v2025-10-24",
        // aliases used by older/newer clients
        targetWord: word,
        answer: word,
        solution: word,
      };
    }

    async function saveWord(forBoth){
      const date = (dateInput.value || "").trim();
      const raw = (targetInput.value || "").trim();
      const word = raw.toUpperCase();

      if(!date) return err("Datum ontbreek.");
      if(!word) return err("Woord ontbreek.");
      if(!/^[A-ZÁÂÄÈÉÊËÌÍÎÏÒÓÔÖÙÚÛÜŸ\-]+$/.test(word)) return err("Gebruik slegs letters (A–Z).");

      const gid = "Game"+date;

      try{
        // Slimstiek
        await setDoc(doc(db,"slimstiekGames",gid), wordPayload(word), { merge:true });

        // Legacy/fallback daily_words
        await writeDailyWords(date, word, forBoth);

        if (forBoth){
          // Blitstiek
          await setDoc(doc(db,"blitstiekGames",gid), wordPayload(word), { merge:true });
          ok(`Teikenwoord “${word}” gestel vir Slimstiek én Blitstiek (${date}).`);
        } else {
          ok(`Teikenwoord “${word}” gestel vir Slimstiek (${date}).`);
        }
      }catch(e){
        console.error(e);
        err("Kon nie skryf nie: " + (e.message || e));
      }
    }

    saveSlimstiek.onclick = ()=>saveWord(false);
    saveBoth.onclick = ()=>saveWord(true);

    onAuthStateChanged(auth, user=>{
      if(!user){ err("Meld asseblief aan as admin op Kriptiek."); }
      else { console.log("Signed in as:", user.email); }
    });
  </script>
</body>
</html>
