<!DOCTYPE html>
<html lang="af">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>SLIMSTIEK Admin – Kriptiek</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&display=swap" rel="stylesheet"/>
  <style>body{font-family:'Montserrat',sans-serif;background:#f8f5f2}</style>
</head>
<body class="min-h-screen p-4">
  <main class="max-w-xl mx-auto bg-white rounded-xl shadow p-4">
    <h1 class="text-2xl font-bold mb-4">SLIMSTIEK: Stel dag se woord</h1>

    <div id="adminGate" class="hidden p-3 mb-4 rounded bg-red-50 text-red-700 text-sm">
      Jy is nie aangemeld as admin nie. Meld asb. aan met jou admin-rekening.
    </div>

    <label class="block mb-3">Datum (ZA):
      <input id="date" type="date" class="mt-1 w-full border rounded px-3 py-2"/>
    </label>

    <label class="block mb-3">Slimstiek woord:
      <input id="sword" type="text" maxlength="8" placeholder="bv. TUTS" class="mt-1 w-full border rounded px-3 py-2 uppercase"/>
    </label>

    <label class="inline-flex items-center gap-2 mb-4">
      <input id="copyBoth" type="checkbox" class="h-4 w-4">
      <span>Gebruik dieselfde woord vir Blitstiek</span>
    </label>

    <div class="flex gap-2">
      <button id="save" class="px-4 py-2 bg-green-700 text-white rounded font-bold">Stoor</button>
      <button id="load" class="px-4 py-2 bg-gray-700 text-white rounded font-bold">Laai</button>
    </div>

    <p id="msg" class="mt-3 text-sm text-gray-700"></p>

    <hr class="my-4"/>

    <div class="text-sm text-gray-600">
      <p class="font-semibold mb-1">Wat gebeur wanneer jy stoor?</p>
      <ul class="list-disc pl-5 space-y-1">
        <li><code>daily_words/{YYYY-MM-DD}</code> kry <code>{ slimstiek, blitstiek?, word? }</code></li>
        <li><code>slimstiekGames/GameYYYY-MM-DD</code> kry die kanonieke Slimstiek-dokument met admin-metadata</li>
        <li>(As gekies) <code>blitstiekGames/GameYYYY-MM-DD</code> kry ’n minimale mirrordokument vir Blitstiek</li>
      </ul>
    </div>
  </main>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js';
    import {
      getFirestore, doc, getDoc, setDoc, serverTimestamp
    } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js';
    import { getAuth, onAuthStateChanged, getIdTokenResult } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js';

    const config = {
      apiKey: "AIzaSyDH-nVvGkdaheH7pvRHH0M9TbW2f98lMGQ",
      authDomain: "kriptiek-c9ea2.firebaseapp.com",
      projectId: "kriptiek-c9ea2",
      storageBucket: "kriptiek-c9ea2.appspot.com",
      messagingSenderId: "620450620939",
      appId: "1:620450620939:web:e93a18ac23b53b33db890e"
    };

    const app  = initializeApp(config);
    const db   = getFirestore(app);
    const auth = getAuth(app);

    const ADMIN_UID = "jI7f0Wk4MqfPq7p69vjl8OlJUvS2";

    const dateEl = document.getElementById('date');
    const swordEl= document.getElementById('sword');
    const bothEl = document.getElementById('copyBoth');
    const saveEl = document.getElementById('save');
    const loadEl = document.getElementById('load');
    const msgEl  = document.getElementById('msg');
    const adminGate = document.getElementById('adminGate');

    function todayKeySAST(){
      const parts = new Intl.DateTimeFormat('en-CA',{
        timeZone:'Africa/Johannesburg',year:'numeric',month:'2-digit',day:'2-digit'
      }).formatToParts(new Date());
      const y = parts.find(p=>p.type==='year').value;
      const m = parts.find(p=>p.type==='month').value;
      const d = parts.find(p=>p.type==='day').value;
      return `${y}-${m}-${d}`;
    }
    dateEl.value = todayKeySAST();

    function normWord(v){ return (v||'').toUpperCase().replace(/[^A-Z]/g,'').slice(1-1,8); }

    let currentUser = null;
    let isAdminUser = false;

    onAuthStateChanged(auth, async (u)=>{
      currentUser = u || null;
      isAdminUser = false;
      if(!u){
        adminGate.classList.remove('hidden');
        msgEl.textContent = 'Meld asseblief aan om te kan stoor.';
        return;
      }
      try{
        const token = await getIdTokenResult(u);
        isAdminUser = (u.uid === ADMIN_UID) || !!token.claims.admin;
      }catch{ /* ignore */ }
      if(!isAdminUser){
        adminGate.classList.remove('hidden');
        msgEl.textContent = 'Jy is aangemeld, maar nie as admin nie.';
      }else{
        adminGate.classList.add('hidden');
        msgEl.textContent = '';
      }
    });

    function gameIdFromDate(date){ return `Game${date}`; }

    // Prefer canonical Slimstiek doc; fall back to daily_words
    loadEl.onclick = async ()=>{
      const date = dateEl.value;
      msgEl.textContent='Laai...';
      if(!date){ msgEl.textContent='Kies eers ’n datum.'; return; }

      const gid = gameIdFromDate(date);
      const slimRef = doc(db,'slimstiekGames', gid);
      const dailyRef = doc(db,'daily_words', date);

      try{
        const slimSnap = await getDoc(slimRef);
        if(slimSnap.exists()){
          const d = slimSnap.data()||{};
          swordEl.value = (d.target || d.word || '').toUpperCase();
          msgEl.textContent = 'Gelaai uit slimstiekGames ✅';
          return;
        }
        const dailySnap = await getDoc(dailyRef);
        if(dailySnap.exists()){
          const d = dailySnap.data()||{};
          swordEl.value = (d.slimstiek || d.word || '').toUpperCase();
          msgEl.textContent = 'Gelaai uit daily_words ✅';
          return;
        }
        swordEl.value = '';
        msgEl.textContent='Geen inskrywing vir dié datum nie.';
      }catch(e){
        console.warn(e);
        msgEl.textContent='Kon nie laai nie.';
      }
    };

    saveEl.onclick = async ()=>{
      const date = dateEl.value;
      let w = normWord(swordEl.value);
      if(!date){ msgEl.textContent='Kies eers ’n datum.'; return; }
      if(!/^[A-Z]{1,8}$/.test(w)){ msgEl.textContent='Gee ’n woord (A–Z, tot 8).'; return; }
      if(!currentUser || !isAdminUser){ msgEl.textContent='Slegs admin kan stoor.'; return; }

      const gid = gameIdFromDate(date);
      const nowTS = serverTimestamp();

      // 1) daily_words mirror (what you had before)
      const dailyPayload = { slimstiek: w, word: w, updatedAt: nowTS };
      if(bothEl.checked){ dailyPayload.blitstiek = w; }

      // 2) canonical Slimstiek game doc (used by archive & future game page)
      const slimPayload = {
        adminCreated: true,
        createdBy: currentUser.uid,
        date,
        gameId: gid,
        target: w,
        word: w,
        status: 'active',
        createdAtMs: nowTS,
        updatedAtMs: nowTS
      };

      // 3) optional Blitstiek mirror (minimal)
      const blitsPayload = {
        adminCreated: true,
        createdBy: currentUser.uid,
        date,
        gameId: gid,
        target: w,
        word: w,
        status: 'active',
        createdAtMs: nowTS,
        updatedAtMs: nowTS
      };

      try{
        // writes
        await Promise.all([
          setDoc(doc(db,'daily_words', date), dailyPayload, { merge:true }),
          setDoc(doc(db,'slimstiekGames', gid), slimPayload, { merge:true }),
          bothEl.checked ? setDoc(doc(db,'blitstiekGames', gid), blitsPayload, { merge:true }) : Promise.resolve()
        ]);
        msgEl.textContent='Gestoor ✅';
      }catch(e){
        console.warn(e);
        msgEl.textContent='Kon nie stoor nie.';
      }
    };
  </script>
</body>
</html>
